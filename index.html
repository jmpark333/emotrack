<!DOCTYPE html>
<html>
<head>
    <title>정서적 독립 트래커</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7"></script>
    <style>
        :root {
            --primary: #6C5CE7;
            --secondary: #A29BFE;
            --success: #00B894;
            --warning: #FDCB6E;
            --danger: #FF7675;
            --light: #DFE6E9;
            --dark: #2D3436;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            color: var(--dark);
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            color: var(--primary);
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            flex: 1;
            margin: 0 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.6s, box-shadow 0.2s;
            transform-style: preserve-3d;
            position: relative;
            height: 120px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-card.flipped {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 15px;
            padding: 15px;
            box-sizing: border-box;
        }

        .card-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            padding: 10px;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .check-item {
            background: var(--light);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        .check-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .check-item.completed {
            background: rgba(0,184,148,0.1);
            border-left: 5px solid var(--success);
        }
        .check-input {
            margin-right: 10px;
            transform: scale(1.3);
        }
        .emergency-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            margin: 15px 0;
            transition: all 0.3s;
        }
        .emergency-btn:hover {
            background: #e84393;
            transform: scale(1.02);
        }
        .progress-bar {
            height: 8px;
            background: var(--light);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--warning));
            transition: width 0.5s;
        }
        .diary-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(108,92,231,0.1);
            border-radius: 15px;
        }
        .diary-input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 0.9rem;
        }
        .diary-label {
            display: block;
            font-size: 0.8rem;
            color: #666;
            margin-top: 10px;
            margin-bottom: 2px;
        }
        .diary-item {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            font-size: 0.85rem;
        }
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 5px 0;
        }
        .btn-danger {
            background: var(--danger);
        }
        .badge {
            display: inline-block;
            background: var(--warning);
            color: var(--dark);
            padding: 3px 10px;
            border-radius: 15px;
            margin: 3px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        /* 모바일 뷰를 위한 추가 스타일 */
        body.mobile-view {
            padding: 10px;
        }
        
        body.mobile-view .container {
            padding: 15px;
        }
        
        body.mobile-view .header h1 {
            font-size: 1.5rem;
        }
        
        body.mobile-view .stat-card {
            padding: 12px 8px;
            margin: 0 3px;
        }
        
        body.mobile-view .stat-value {
            font-size: 1.2rem;
        }
        
        body.mobile-view .check-item {
            padding: 10px;
            margin-bottom: 6px;
        }
        
        body.mobile-view .check-input {
            transform: scale(1.2);
        }
        
        body.mobile-view .diary-input {
            font-size: 1rem;
            padding: 10px;
        }
        
        body.mobile-view .btn, body.mobile-view .emergency-btn {
            padding: 12px 15px;
            font-size: 1rem;
        }
        
        body.mobile-view .diary-item {
            font-size: 0.9rem;
            padding: 12px;
        }
        
        /* 홈 화면 아이콘 추가를 위한 메타 태그 */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #8B7CF6;
                --secondary: #A29BFE;
            }
        }

        /* 인증 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .close {
            position: absolute;
            right: 15px;
            top: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .close:hover {
            color: #000;
        }

        #authTabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--light);
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: bold;
        }

        .auth-form {
            text-align: center;
        }

        .auth-form h2 {
            margin-bottom: 20px;
            color: var(--dark);
        }

        .auth-form input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .auth-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .auth-btn:hover {
            background: var(--secondary);
        }

        .auth-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .auth-message.success {
            background: var(--success);
            color: white;
        }

        .auth-message.error {
            background: var(--danger);
            color: white;
        }

        #userSection {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }

        #loginSection {
            text-align: center;
            margin-top: 10px;
        }
    </style>
    
    <!-- 홈 화면에 추가하기 위한 설정 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="정서적 독립 트래커">
    <meta name="mobile-web-app-capable" content="yes">
    </head>
<body>
    <div class="container">
        <!-- 로그인/회원가입 모달 -->
        <div id="authModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeAuthModal()">&times;</span>
                <div id="authTabs">
                    <button class="tab-btn active" onclick="switchTab('login')">로그인</button>
                    <button class="tab-btn" onclick="switchTab('signup')">회원가입</button>
                </div>

                <!-- 로그인 폼 -->
                <div id="loginForm" class="auth-form">
                    <h2>로그인</h2>
                    <form onsubmit="login(); return false;">
                        <label for="loginEmail">이메일</label>
                        <input type="email" id="loginEmail" placeholder="이메일" required autocomplete="email">
                        <label for="loginPassword">비밀번호</label>
                        <input type="password" id="loginPassword" placeholder="비밀번호" required autocomplete="current-password">
                        <button type="submit" class="auth-btn">로그인</button>
                    </form>
                    <div id="loginMessage" class="auth-message"></div>
                </div>

                <!-- 회원가입 폼 -->
                <div id="signupForm" class="auth-form" style="display: none;">
                    <h2>회원가입</h2>
                    <form onsubmit="signup(); return false;">
                        <label for="signupEmail">이메일</label>
                        <input type="email" id="signupEmail" placeholder="이메일" required autocomplete="email">
                        <label for="signupPassword">비밀번호 (6자 이상)</label>
                        <input type="password" id="signupPassword" placeholder="비밀번호 (6자 이상)" required autocomplete="new-password">
                        <label for="signupConfirmPassword">비밀번호 확인</label>
                        <input type="password" id="signupConfirmPassword" placeholder="비밀번호 확인" required autocomplete="new-password">
                        <button type="submit" class="auth-btn">회원가입</button>
                    </form>
                    <div id="signupMessage" class="auth-message"></div>
                </div>
            </div>
        </div>

        <div class="header">
            <h1>🧘‍♂️ 정서적 독립 트래커</h1>
            <p>오늘도 당신의 평온함을 지키는 하루가 되길</p>
            <div id="userSection" style="display: none;">
                <span id="userEmail"></span>
                <button onclick="logout()" style="margin-left: 10px; padding: 5px 10px; background: var(--danger); color: white; border: none; border-radius: 5px; cursor: pointer;">로그아웃</button>
            </div>
            <div id="loginSection">
                <button onclick="openAuthModal()" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">로그인/회원가입</button>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card" id="streakCard" onclick="flipCard()" title="클릭하여 시작일 확인">
                <div class="card-front">
                    <div class="stat-value" id="streak" style="margin-bottom: 5px;">0</div>
                    <div style="font-size: 0.9rem;">연속 일수</div>
                </div>
                <div class="card-back">
                    <div style="font-size: 0.9rem; font-weight: bold; margin-bottom: 8px;">📅 시작일</div>
                    <div id="startDateDisplay" style="font-size: 0.8rem; margin-bottom: 10px;">시작일 없음</div>
                    <button onclick="resetStreak(event)" style="background: #ff6b6b; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.7rem; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#ff5252'" onmouseout="this.style.background='#ff6b6b'">
                        🔄 리셋
                    </button>
                </div>
            </div>
            <div class="stat-card" id="levelCard" onclick="flipLevelCard()" title="클릭하여 레벨 진행도 확인">
                <div class="card-front">
                    <div class="stat-value" id="level" style="margin-bottom: 5px;">1</div>
                    <div style="font-size: 0.9rem;">평온 레벨</div>
                </div>
                <div class="card-back">
                    <div id="levelProgressDisplay" style="font-size: 1.0rem; font-weight: bold;">다음 레벨까지: 100포인트</div>
                </div>
            </div>
            <div class="stat-card" id="pointsCard" onclick="flipPointsCard()" title="클릭하여 포인트 정보 확인">
                <div class="card-front">
                    <div class="stat-value" id="points" style="margin-bottom: 5px;">0</div>
                    <div style="font-size: 0.9rem;">평온 포인트</div>
                </div>
                <div class="card-back">
                    <div style="font-size: 1.0rem; font-weight: bold; margin-bottom: 10px;">📈 평온 포인트</div>
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.9);">
                        총 획득 포인트
                    </div>
                </div>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress" id="dailyProgress" style="width: 0%"></div>
        </div>
        
        <h3>🌅 아침 훈련</h3>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="morning1">
            <label for="morning1">감정 분리 선언 ("오늘 아내의 감정은 나의 것이 아님" 3번)</label>
        </div>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="morning2">
            <label for="morning2">오늘 지킬 핵심 가치 선택 (평온/존중/자존감)</label>
        </div>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="morning3">
            <label for="morning3">오늘의 '나만의 30분' 계획 세우기</label>
        </div>
        
        <h3>🌞 점심 훈련</h3>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="noon1">
            <label for="noon1">비판적 말 들었을 때 "이건 사실인가?" 필터링</label>
        </div>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="noon2">
            <label for="noon2">"지금은 어렵다"고 말하기 (아니오 연습)</label>
        </div>
        
        <h3>🌙 저녁 훈련</h3>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="evening1">
            <label for="evening1">감정 폭발 시 4-7-8 호흡법 3회</label>
        </div>
        
        <div class="check-item">
            <input type="checkbox" class="check-input" id="evening2">
            <label for="evening2">📖 감정 일기 작성</label>
            <label for="wifeAction" class="diary-label">아내의 행동</label>
            <input type="text" id="wifeAction" class="diary-input" placeholder="아내의 행동 (예: 고성 질문)" aria-label="아내의 행동">
            <label for="myReaction" class="diary-label">내 첫 반응</label>
            <input type="text" id="myReaction" class="diary-input" placeholder="내 첫 반응 (예: 죄책감 + 분노)" aria-label="내 첫 반응">
            <label for="reinterpretation" class="diary-label">재해석</label>
            <input type="text" id="reinterpretation" class="diary-input" placeholder="재해석 (예: 그녀는 불안해서 그런 거야)" aria-label="재해석">
            <button class="btn" onclick="saveDiary()">💾 저장하고 체크 완료</button>
        </div>
        
        <div class="check-item">
            <input type="checkbox" class="check-input" id="evening3">
            <label for="evening3">오늘 나를 지킨 행동 1가지 칭찬하기</label>
        </div>
        
        <button class="emergency-btn" onclick="startBreathing()">
            🚨 긴급 호흡법 시작 (4-7-8)
        </button>
        
        <div class="diary-section">
            <h3>📚 최근 감정 일기</h3>
            <div id="diaryList"></div>
            <button class="btn btn-danger" onclick="clearDiaries()">🗑️ 모든 일기 삭제</button>
        </div>
        
        <div class="reward">
            <h3>🏆 오늘의 보상</h3>
            <div id="badges"></div>
            <div style="text-align: center; margin: 10px 0;">
                <div style="font-size: 0.9rem; color: #666;">오늘 획득 포인트</div>
                <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary);" id="dailyPoints">0</div>
            </div>
            <p id="rewardText">모든 체크리스트를 완료하면 보상이 열립니다!</p>
        </div>
    </div>

    <script>
        // Supabase 클라이언트 (전역 변수)
        let supabaseClient = null;
        let currentUser = null;

        // Supabase 초기화 함수
        function initializeSupabase() {
            // Supabase SDK 로딩 확인
            if (typeof supabase === 'undefined') {
                console.error('Supabase SDK가 로드되지 않았습니다. CDN을 확인해주세요.');
                return false;
            }

            // Supabase 초기화
            const supabaseUrl = 'https://hpejebnqhgojfxttfbal.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwZWplYm5xaGdvamZ4dHRmYmFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NTA4MTIsImV4cCI6MjA3MzMyNjgxMn0.AibxZdVe1INo5e3voeA6lVkdI9nY46_MuWJWFl2_JAg';

            try {
                supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                console.log('Supabase 클라이언트 초기화 성공');
                return true;
            } catch (error) {
                console.error('Supabase 클라이언트 초기화 실패:', error);
                return false;
            }
        }

        // 데이터 초기화
        let userData = JSON.parse(localStorage.getItem('emotionalIndependence')) || {
            streak: 0,
            level: 1,
            points: 0,
            lastCheck: null,
            completedToday: [],
            totalPoints: 0,  // 총 누적 포인트 추가
            startDate: null,  // 연속 사용 시작일 추가
            lastCompletedDate: null  // 마지막으로 모든 항목을 완료한 날짜
        };

        let diaries = JSON.parse(localStorage.getItem('emotionDiaries')) || [];

        // ================ 인증 관련 함수 ================

        // 인증 모달 열기
        function openAuthModal() {
            document.getElementById('authModal').style.display = 'block';
        }

        // 인증 모달 닫기
        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            clearMessages();
        }

        // 탭 전환
        function switchTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const tabBtns = document.querySelectorAll('.tab-btn');

            tabBtns.forEach(btn => btn.classList.remove('active'));

            if (tab === 'login') {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
                tabBtns[0].classList.add('active');
            } else {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
                tabBtns[1].classList.add('active');
            }

            clearMessages();
        }

        // 메시지 지우기
        function clearMessages() {
            document.getElementById('loginMessage').textContent = '';
            document.getElementById('loginMessage').className = 'auth-message';
            document.getElementById('signupMessage').textContent = '';
            document.getElementById('signupMessage').className = 'auth-message';
        }

        // 메시지 표시
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `auth-message ${type}`;
        }

        // 회원가입
        async function signup() {
            if (!supabaseClient) {
                showMessage('signupMessage', 'Supabase가 설정되지 않았습니다. 관리자에게 문의해주세요.', 'error');
                return;
            }

            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;

            if (!email || !password || !confirmPassword) {
                showMessage('signupMessage', '모든 필드를 입력해주세요.', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('signupMessage', '비밀번호는 6자 이상이어야 합니다.', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showMessage('signupMessage', '비밀번호가 일치하지 않습니다.', 'error');
                return;
            }

            try {
                console.log('📝 회원가입 시도:', { email, passwordLength: password.length });

                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password
                });

                console.log('📋 Supabase 응답:', { data, error });

                if (error) {
                    console.error('❌ Supabase 회원가입 오류:', error);
                    showMessage('signupMessage', `오류: ${error.message}`, 'error');
                    return;
                }

                if (data && data.user && !data.user.email_confirmed_at) {
                    console.log('✅ 회원가입 성공 (이메일 확인 필요)');
                    showMessage('signupMessage', '회원가입이 완료되었습니다. 이메일을 확인해주세요.', 'success');
                } else if (data && data.user) {
                    console.log('✅ 회원가입 성공 (즉시 로그인)');
                    showMessage('signupMessage', '회원가입이 완료되었습니다.', 'success');
                } else {
                    console.log('⚠️ 응답 데이터 없음');
                    showMessage('signupMessage', '회원가입이 처리되었습니다.', 'success');
                }

                // 3초 후 로그인 탭으로 전환
                setTimeout(() => {
                    switchTab('login');
                    document.getElementById('loginEmail').value = email;
                }, 3000);

            } catch (error) {
                console.error('💥 회원가입 시스템 오류:', error);
                showMessage('signupMessage', `시스템 오류: ${error.message}`, 'error');
            }
        }

        // 로그인
        async function login() {
            if (!supabaseClient) {
                showMessage('loginMessage', 'Supabase가 설정되지 않았습니다. 관리자에게 문의해주세요.', 'error');
                return;
            }

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showMessage('loginMessage', '이메일과 비밀번호를 입력해주세요.', 'error');
                return;
            }

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    showMessage('loginMessage', error.message, 'error');
                    return;
                }

                currentUser = data.user;
                await loadUserData();

                // UI 업데이트
                document.getElementById('userEmail').textContent = email;
                document.getElementById('userSection').style.display = 'flex';
                document.getElementById('loginSection').style.display = 'none';

                closeAuthModal();
                updateUI();

            } catch (error) {
                showMessage('loginMessage', '로그인 중 오류가 발생했습니다.', 'error');
            }
        }

        // 로그아웃
        async function logout() {
            if (!supabase) return;

            try {
                await supabase.auth.signOut();
                currentUser = null;

                // UI 업데이트
                document.getElementById('userSection').style.display = 'none';
                document.getElementById('loginSection').style.display = 'block';

                // 기본 데이터로 초기화
                userData = {
                    streak: 0,
                    level: 1,
                    points: 0,
                    lastCheck: null,
                    completedToday: [],
                    totalPoints: 0,
                    startDate: null,
                    lastCompletedDate: null
                };

                updateUI();

            } catch (error) {
                console.error('로그아웃 오류:', error);
            }
        }

        // 사용자 데이터 로드
        async function loadUserData() {
            if (!currentUser || !supabaseClient) {
                // 로그인하지 않은 경우 localStorage에서 로드
                userData = JSON.parse(localStorage.getItem('emotionalIndependence')) || {
                    streak: 0,
                    level: 1,
                    points: 0,
                    lastCheck: null,
                    completedToday: [],
                    totalPoints: 0,
                    startDate: null,
                    lastCompletedDate: null
                };
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('user_data')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116: 데이터 없음
                    console.error('데이터 로드 오류:', error);
                    return;
                }

                if (data) {
                    userData = {
                        streak: data.streak || 0,
                        level: data.level || 1,
                        points: data.points || 0,
                        lastCheck: data.last_check,
                        completedToday: data.completed_today || [],
                        totalPoints: data.total_points || 0,
                        startDate: data.start_date,
                        lastCompletedDate: data.last_completed_date
                    };
                } else {
                    // 새 사용자 데이터 생성
                    await saveUserData();
                }

            } catch (error) {
                console.error('사용자 데이터 로드 오류:', error);
            }
        }

        // 사용자 데이터 저장 (Supabase)
        async function saveUserDataToSupabase() {
            if (!currentUser || !supabase) return;

            try {
                const { data, error } = await supabase
                    .from('user_data')
                    .upsert({
                        user_id: currentUser.id,
                        streak: userData.streak,
                        level: userData.level,
                        points: userData.points,
                        last_check: userData.lastCheck,
                        completed_today: userData.completedToday,
                        total_points: userData.totalPoints,
                        start_date: userData.startDate,
                        last_completed_date: userData.lastCompletedDate,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id'
                    });

                if (error) {
                    console.error('데이터 저장 오류:', error);
                }

            } catch (error) {
                console.error('사용자 데이터 저장 오류:', error);
            }
        }
        
        // 스마트폰 환경 감지
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // 스마트폰에서의 사용성 개선
        if (isMobile) {
            document.body.classList.add('mobile-view');
        }

        // 화면 업데이트
        function updateUI() {
            // 연속 일수 표시
            document.getElementById('streak').textContent = userData.streak;
            document.getElementById('level').textContent = userData.level;
            document.getElementById('points').textContent = userData.points;

            // 레벨 진행도 표시 업데이트
            updateLevelProgress();

            // 오늘 획득 포인트 표시
            updateDailyPoints();

            // 체크리스트 상태 복원
            document.querySelectorAll('.check-input').forEach(checkbox => {
                checkbox.checked = userData.completedToday.includes(checkbox.id);
                checkbox.addEventListener('change', handleCheck);
            });

            updateProgress();
            updateBadges();
            displayDiaries();
        }

        // 체크 이벤트 처리
        function handleCheck(e) {
            const id = e.target.id;
            const parent = e.target.parentElement;
            
            if(e.target.checked) {
                if(!userData.completedToday.includes(id)) {
                    userData.completedToday.push(id);
                    userData.points += 10;
                    userData.totalPoints = (userData.totalPoints || 0) + 10; // 총 누적 포인트 증가
                    parent.classList.add('completed');
                }
            } else {
                userData.completedToday = userData.completedToday.filter(item => item !== id);
                userData.points -= 10;
                parent.classList.remove('completed');
            }
            
            // 현재 날짜를 lastCheck에 설정하여 하루 중에 체크 상태 유지
            userData.lastCheck = new Date().toDateString();
            
            // 데이터 저장 및 백업
            saveUserData();
            updateProgress();
            updateBadges();

            // 오늘 획득 포인트 업데이트
            updateDailyPoints();

            // 레벨업 체크
            if(userData.points >= userData.level * 100) {
                userData.level++;
                alert(`🎉 레벨업! 평온 레벨 ${userData.level} 달성!`);
                saveUserData();
                updateLevelProgress();
            } else {
                updateLevelProgress();
            }
        }
        
        // 사용자 데이터 저장 (통합 함수)
        async function saveUserData() {
            // localStorage에도 저장 (호환성 유지)
            localStorage.setItem('emotionalIndependence', JSON.stringify(userData));

            // 세션 스토리지에도 백업 (로컬 스토리지가 클리어되는 경우 대비)
            try {
                sessionStorage.setItem('emotionalIndependence_backup', JSON.stringify(userData));
            } catch (e) {
                console.log('세션 스토리지 백업 실패:', e);
            }

            // Supabase에 저장 (로그인한 경우)
            if (currentUser && supabaseClient) {
                await saveUserDataToSupabase();
            }
        }

        // 사용자 데이터 저장 및 백업 (로컬 전용)
        function saveUserDataLocal() {
            localStorage.setItem('emotionalIndependence', JSON.stringify(userData));

            // 세션 스토리지에도 백업 (로컬 스토리지가 클리어되는 경우 대비)
            try {
                sessionStorage.setItem('emotionalIndependence_backup', JSON.stringify(userData));
            } catch (e) {
                console.log('세션 스토리지 백업 실패:', e);
            }
        }
        
        // 데이터 복구 함수
        function recoverUserData() {
            try {
                const backup = sessionStorage.getItem('emotionalIndependence_backup');
                if (backup && !localStorage.getItem('emotionalIndependence')) {
                    localStorage.setItem('emotionalIndependence', backup);
                    return JSON.parse(backup);
                }
            } catch (e) {
                console.log('데이터 복구 실패:', e);
            }
            return null;
        }

        // 레벨 진행도 업데이트
        function updateLevelProgress() {
            const pointsNeeded = userData.level * 100;
            const pointsRemaining = Math.max(0, pointsNeeded - userData.points);
            const progressPercentage = userData.points >= pointsNeeded ? 100 : (userData.points / pointsNeeded) * 100;

            // 앞면에서는 레벨 진행도 표시 제거 (뒷면에서만 표시)
        }

        // 레벨 진행도 디스플레이 업데이트 함수
        function updateLevelProgressDisplay() {
            const pointsNeeded = userData.level * 100;
            const pointsRemaining = Math.max(0, pointsNeeded - userData.points);

            document.getElementById('levelProgressDisplay').textContent = `다음 레벨까지: ${pointsRemaining}포인트`;
        }

        // 오늘 획득 포인트 업데이트
        function updateDailyPoints() {
            const dailyPoints = userData.completedToday.length * 10;
            document.getElementById('dailyPoints').textContent = dailyPoints;
        }

        // 연속일수 카드 뒤집기 함수
        function flipCard() {
            const card = document.getElementById('streakCard');
            card.classList.toggle('flipped');

            // 뒷면이 보일 때 시작일 정보 업데이트
            if (card.classList.contains('flipped')) {
                updateStartDateDisplay();
            }
        }

        // 평온레벨 카드 뒤집기 함수
        function flipLevelCard() {
            const card = document.getElementById('levelCard');
            card.classList.toggle('flipped');

            // 뒷면이 보일 때 레벨 진행도 정보 업데이트
            if (card.classList.contains('flipped')) {
                updateLevelProgressDisplay();
            }
        }

        // 평온포인트 카드 뒤집기 함수
        function flipPointsCard() {
            const card = document.getElementById('pointsCard');
            card.classList.toggle('flipped');
        }

        // 시작일 표시 업데이트 함수
        function updateStartDateDisplay() {
            const startDateDisplay = document.getElementById('startDateDisplay');

            if (userData.startDate) {
                const startDate = new Date(userData.startDate);
                const formattedDate = startDate.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                startDateDisplay.textContent = formattedDate;
            } else {
                startDateDisplay.textContent = '시작일 없음';
            }
        }

        // 연속일수 리셋 함수
        function resetStreak(event) {
            event.stopPropagation(); // 카드 뒤집기 이벤트 방지

            if (confirm('연속일수를 리셋하시겠습니까?\\n시작일이 오늘로 변경되고 연속일수는 0이 됩니다.')) {
                const today = new Date().toDateString();

                // 데이터 리셋 (시작일은 오늘로 설정)
                userData.startDate = today;
                userData.lastCompletedDate = null;
                userData.streak = 0;
                userData.completedToday = [];
                userData.lastCheck = null;

                // localStorage에 저장
                localStorage.setItem('emotrack-data', JSON.stringify(userData));

                // UI 업데이트
                document.getElementById('streak').textContent = '0';
                updateStartDateDisplay();
                updateProgress();

                // 카드 앞면으로 돌아가기
                document.getElementById('streakCard').classList.remove('flipped');

                alert('연속일수가 리셋되었습니다.\\n오늘부터 새로 시작합니다!');
            }
        }

        // 연속 일수 자동 계산 함수
        function calculateStreak() {
            if (!userData.startDate) {
                return 0; // 시작일이 없으면 0 반환
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const startDate = new Date(userData.startDate);
            startDate.setHours(0, 0, 0, 0);

            // 날짜 차이 계산 (밀리초 → 일)
            const diffTime = Math.abs(today - startDate);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            // 연속 사용 확인: 마지막 완료일로부터 하루가 지났는지 확인
            if (userData.lastCompletedDate) {
                const lastCompleted = new Date(userData.lastCompletedDate);
                lastCompleted.setHours(0, 0, 0, 0);
                const daysSinceLastComplete = Math.floor((today - lastCompleted) / (1000 * 60 * 60 * 24));

                // 하루 이상 지났으면 연속이 끊김
                if (daysSinceLastComplete > 1) {
                    return 0;
                }
            }

            return diffDays + 1; // 시작일 포함
        }

        // 연속 일수 업데이트 함수
        function updateStreak() {
            const today = new Date().toDateString();
            const completed = userData.completedToday.length;
            const total = document.querySelectorAll('.check-input').length;
            const isAllCompleted = completed === total;

            // 시작일 설정
            if (!userData.startDate && isAllCompleted) {
                userData.startDate = today;
                userData.streak = 1;
            } else if (userData.startDate && isAllCompleted) {
                // 모든 항목 완료 시 마지막 완료일 업데이트
                userData.lastCompletedDate = today;
            }

            // 자동으로 연속일수 계산
            if (userData.startDate) {
                userData.streak = calculateStreak();
            }
        }

        // 진행도 업데이트
        function updateProgress() {
            const total = document.querySelectorAll('.check-input').length;
            const completed = userData.completedToday.length;
            const percentage = (completed / total) * 100;
            document.getElementById('dailyProgress').style.width = percentage + '%';

            // 연속 일수 업데이트
            updateStreak();
        }

        // 뱃지 업데이트
        function updateBadges() {
            const badgesContainer = document.getElementById('badges');
            badgesContainer.innerHTML = '';
            
            if(userData.streak >= 3) {
                badgesContainer.innerHTML += '<span class="badge">🔥 3일 연속</span>';
            }
            if(userData.streak >= 7) {
                badgesContainer.innerHTML += '<span class="badge">⭐ 평온 수호자</span>';
            }
            if(userData.level >= 3) {
                badgesContainer.innerHTML += '<span class="badge">🛡️ 정신의 방패</span>';
            }
            
            // 보상 메시지
            const total = document.querySelectorAll('.check-input').length;
            const completed = userData.completedToday.length;
            if(completed === total) {
                document.getElementById('rewardText').innerHTML = 
                    `🎉 완료! 오늘의 보상: <strong>${getRandomReward()}</strong>`;
            }
        }

        // 랜덤 보상
        function getRandomReward() {
            const rewards = [
                "따뜻한 차 한잔의 여유",
                "좋아하는 노래 3곡 듣기",
                "15분 추가 휴식",
                "작은 간식 먹기",
                "오늘은 칭찬 일기 쓰지 않기"
            ];
            return rewards[Math.floor(Math.random() * rewards.length)];
        }

        // 호흡법 타이머
        function startBreathing() {
            alert("🌬️ 4초 들이마시기 → 7초 참기 → 8초 내쉬기\n\n지금 시작합니다. 화면을 보며 따라해주세요!");
            
            let step = 0;
            const steps = [
                { text: "들이마시기 (4초)", duration: 4000 },
                { text: "참기 (7초)", duration: 7000 },
                { text: "내쉬기 (8초)", duration: 8000 }
            ];
            
            const interval = setInterval(() => {
                alert(steps[step].text);
                step++;
                if(step >= steps.length) {
                    clearInterval(interval);
                    alert("✅ 호흡법 완료! 이제 조금 더 평온해지셨나요?");
                }
            }, steps[step]?.duration || 0);
        }

        // 감정 일기 저장
        function saveDiary() {
            const wifeAction = document.getElementById('wifeAction').value;
            const myReaction = document.getElementById('myReaction').value;
            const reinterpretation = document.getElementById('reinterpretation').value;
            
            if(!wifeAction || !myReaction || !reinterpretation) {
                alert('모든 필드를 작성해주세요!');
                return;
            }
            
            const diary = {
                date: new Date().toLocaleString(),
                wifeAction,
                myReaction,
                reinterpretation
            };
            
            diaries.unshift(diary);
            localStorage.setItem('emotionDiaries', JSON.stringify(diaries));
            
            // 일기 데이터 백업
            try {
                sessionStorage.setItem('emotionDiaries_backup', JSON.stringify(diaries));
            } catch (e) {
                console.log('일기 백업 실패:', e);
            }
            
            // 체크박스 자동 완료
            document.getElementById('evening2').checked = true;
            handleCheck({target: document.getElementById('evening2')});
            
            // 입력 필드 초기화
            document.getElementById('wifeAction').value = '';
            document.getElementById('myReaction').value = '';
            document.getElementById('reinterpretation').value = '';
            
            displayDiaries();
            alert('✅ 감정 일기가 저장되었습니다!');
        }

        // 일기 목록 표시
        function displayDiaries() {
            const diaryList = document.getElementById('diaryList');
            diaryList.innerHTML = '';
            
            if(diaries.length === 0) {
                diaryList.innerHTML = '<p style="color: #666;">저장된 일기가 없습니다</p>';
                return;
            }
            
            diaries.slice(0, 7).forEach(diary => {
                const diaryItem = document.createElement('div');
                diaryItem.className = 'diary-item';
                diaryItem.innerHTML = `
                    <div style="font-size: 0.8rem; color: #666; margin-bottom: 5px;">📅 ${diary.date}</div>
                    <div><strong>👩 아내:</strong> ${diary.wifeAction}</div>
                    <div><strong>👨 나:</strong> ${diary.myReaction}</div>
                    <div><strong>💡 재해석:</strong> <span style="color: var(--success);">${diary.reinterpretation}</span></div>
                `;
                diaryList.appendChild(diaryItem);
            });
        }

        // 일기 삭제
        function clearDiaries() {
            if(confirm('정말 모든 감정 일기를 삭제하시겠습니까?')) {
                diaries = [];
                localStorage.setItem('emotionDiaries', JSON.stringify(diaries));
                displayDiaries();
                alert('모든 일기가 삭제되었습니다.');
            }
        }

        
        
        // 날짜 변경 확인 및 completedToday 배열 초기화
        function checkDateChangeAndReset() {
            const today = new Date().toDateString();
            const lastCheck = userData.lastCheck;

            if (lastCheck && lastCheck !== today) {
                // 날짜가 변경된 경우
                const yesterday = new Date(lastCheck);
                const currentDate = new Date(today);
                const daysDiff = Math.floor((currentDate - yesterday) / (1000 * 60 * 60 * 24));

                if (daysDiff === 1) {
                    // 하루가 지난 경우: 어제 활동했으면 연속 유지
                    if (userData.lastCompletedDate === lastCheck) {
                        console.log('연속 사용 중입니다.');
                    } else {
                        // 어제 모든 항목을 완료하지 않았으면 연속 초기화
                        userData.startDate = today;
                        userData.streak = 0;
                        console.log('어제 모든 항목을 완료하지 않았습니다. 연속이 초기화됩니다.');
                    }
                } else if (daysDiff > 1) {
                    // 여러 날이 지난 경우: 연속 초기화
                    userData.startDate = null;
                    userData.streak = 0;
                    userData.lastCompletedDate = null;
                    console.log('여러 날이 지났습니다. 연속이 초기화됩니다.');
                }

                // completedToday 배열 초기화
                userData.completedToday = [];
                userData.points = 0; // 매일 포인트도 초기화

                // 변경된 데이터 저장
                saveUserData();

                // UI 업데이트
                updateUI();

                console.log('completedToday 배열이 초기화되었습니다.');
            } else if (!lastCheck && userData.completedToday.length > 0) {
                // lastCheck가 없지만 completedToday에 데이터가 있는 경우
                // 오늘 날짜로 lastCheck 설정하여 데이터 유지
                userData.lastCheck = today;
                saveUserData();
                console.log('lastCheck를 오늘 날짜로 설정했습니다.');
            }
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            // Supabase 초기화
            if (!initializeSupabase()) {
                console.error('Supabase 초기화에 실패했습니다. 인증 기능이 작동하지 않을 수 있습니다.');
            }

            // 데이터 복구 시도
            const recoveredData = recoverUserData();
            if (recoveredData) {
                userData = recoveredData;
                console.log('데이터가 복구되었습니다.');
            }
            
            // 일기 데이터 복구 시도
            try {
                const diaryBackup = sessionStorage.getItem('emotionDiaries_backup');
                if (diaryBackup && diaries.length === 0) {
                    diaries = JSON.parse(diaryBackup);
                    console.log('일기 데이터가 복구되었습니다.');
                }
            } catch (e) {
                console.log('일기 데이터 복구 실패:', e);
            }
            
            // 날짜 변경 확인 및 초기화
            checkDateChangeAndReset();

            // Supabase 인증 상태 확인 (임시로 비활성화)
            checkAuthState();

            updateUI();
        });

        // 인증 상태 확인
        async function checkAuthState() {
            if (!supabaseClient || !supabaseClient.auth) {
                console.log('Supabase 클라이언트 또는 auth 모듈을 사용할 수 없음');
                return;
            }

            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();

                if (error) {
                    console.log('인증된 사용자 없음:', error.message);
                    return;
                }

                if (session && session.user) {
                    currentUser = session.user;
                    document.getElementById('userEmail').textContent = session.user.email;
                    document.getElementById('userSection').style.display = 'flex';
                    document.getElementById('loginSection').style.display = 'none';

                    await loadUserData();
                    console.log('사용자 로그인됨:', user.email);
                }
            } catch (error) {
                console.error('인증 상태 확인 오류:', error);
            }
        }
    </script>
</body>
</html>