<!DOCTYPE html>
<!--
  정서적 독립 트래커 v1.4.1
  - 모든 로그인 성공 메시지 제거 완료
  - 로그인 성공! 데이터를 불러오는 중... 메시지 제거됨
-->
<html>
<head>
    <title>정서적 독립 트래커</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7?v=1.4.1"></script>
    <script>
        // Supabase SDK 로딩 확인
        console.log('Supabase SDK 로딩 상태:', typeof supabase);
        console.log('Supabase SDK 상세 정보:', supabase);

        // SDK가 로드될 때까지 대기
        function waitForSupabase(callback, maxAttempts = 50) {
            let attempts = 0;

            function check() {
                attempts++;
                console.log(`Supabase SDK 확인 시도 ${attempts}/${maxAttempts}:`, typeof supabase);

                if (typeof supabase !== 'undefined') {
                    console.log('✅ Supabase SDK 로드 완료');
                    console.log('Supabase 버전:', supabase.version);
                    console.log('Supabase auth 객체:', supabase.auth);
                    console.log('Supabase createClient 함수:', typeof supabase.createClient);
                    callback();
                } else if (attempts < maxAttempts) {
                    setTimeout(check, 100);
                } else {
                    console.error('❌ Supabase SDK 로드 실패');
                }
            }

            check();
        }
    </script>
    <style>
        :root {
            --primary: #6C5CE7;
            --secondary: #A29BFE;
            --success: #00B894;
            --warning: #FDCB6E;
            --danger: #FF7675;
            --light: #DFE6E9;
            --dark: #2D3436;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            color: var(--dark);
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            color: var(--primary);
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            flex: 1;
            margin: 0 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.6s, box-shadow 0.2s;
            transform-style: preserve-3d;
            position: relative;
            height: 120px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-card.flipped {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 15px;
            padding: 15px;
            box-sizing: border-box;
        }

        .card-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            padding: 10px;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .check-item {
            background: var(--light);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        .check-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .check-item.completed {
            background: rgba(0,184,148,0.1);
            border-left: 5px solid var(--success);
        }
        .check-input {
            margin-right: 10px;
            transform: scale(1.3);
        }
        .emergency-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            margin: 15px 0;
            transition: all 0.3s;
        }
        .emergency-btn:hover {
            background: #e84393;
            transform: scale(1.02);
        }
        .progress-bar {
            height: 8px;
            background: var(--light);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--warning));
            transition: width 0.5s;
        }
        .diary-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(108,92,231,0.1);
            border-radius: 15px;
        }
        .diary-input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 0.9rem;
        }
        .diary-label {
            display: block;
            font-size: 0.8rem;
            color: #666;
            margin-top: 10px;
            margin-bottom: 2px;
        }
        .diary-item {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            font-size: 0.85rem;
        }
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 5px 0;
        }
        .btn-danger {
            background: var(--danger);
        }

        .delete-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1rem;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
            opacity: 0.6;
        }

        .delete-btn:hover {
            background: var(--danger);
            color: white;
            opacity: 1;
            transform: scale(1.1);
        }
        .badge {
            display: inline-block;
            background: var(--warning);
            color: var(--dark);
            padding: 3px 10px;
            border-radius: 15px;
            margin: 3px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        /* 모바일 뷰를 위한 추가 스타일 */
        body.mobile-view {
            padding: 10px;
        }
        
        body.mobile-view .container {
            padding: 15px;
        }
        
        body.mobile-view .header h1 {
            font-size: 1.5rem;
        }
        
        body.mobile-view .stat-card {
            padding: 12px 8px;
            margin: 0 3px;
        }
        
        body.mobile-view .stat-value {
            font-size: 1.2rem;
        }
        
        body.mobile-view .check-item {
            padding: 10px;
            margin-bottom: 6px;
        }
        
        body.mobile-view .check-input {
            transform: scale(1.2);
        }
        
        body.mobile-view .diary-input {
            font-size: 1rem;
            padding: 10px;
        }
        
        body.mobile-view .btn, body.mobile-view .emergency-btn {
            padding: 12px 15px;
            font-size: 1rem;
        }
        
        body.mobile-view .diary-item {
            font-size: 0.9rem;
            padding: 12px;
        }
        
        /* 홈 화면 아이콘 추가를 위한 메타 태그 */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #8B7CF6;
                --secondary: #A29BFE;
            }
        }

        /* 인증 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .close {
            position: absolute;
            right: 15px;
            top: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .close:hover {
            color: #000;
        }

        #authTabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--light);
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: bold;
        }

        .auth-form {
            text-align: center;
        }

        .auth-form h2 {
            margin-bottom: 20px;
            color: var(--dark);
        }

        .auth-form input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .auth-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .auth-btn:hover {
            background: var(--secondary);
        }

        .auth-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .auth-message.success {
            background: var(--success);
            color: white;
        }

        .auth-message.error {
            background: var(--danger);
            color: white;
        }

        #userSection {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }

        #loginSection {
            text-align: center;
            margin-top: 10px;
        }
    </style>
    
    <!-- 홈 화면에 추가하기 위한 설정 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="정서적 독립 트래커">
    <meta name="mobile-web-app-capable" content="yes">
    </head>
<body>
    <div class="container">
        <!-- 로그인/회원가입 모달 -->
        <div id="authModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeAuthModal()">&times;</span>
                <div id="authTabs">
                    <button class="tab-btn active" onclick="switchTab('login')">로그인</button>
                    <button class="tab-btn" onclick="switchTab('signup')">회원가입</button>
                </div>

                <!-- 로그인 폼 -->
                <div id="loginForm" class="auth-form">
                    <h2>로그인</h2>
                    <form id="loginFormElement">
                        <label for="loginEmail">이메일</label>
                        <input type="email" id="loginEmail" placeholder="이메일" required autocomplete="email">
                        <label for="loginPassword">비밀번호</label>
                        <input type="password" id="loginPassword" placeholder="비밀번호" required autocomplete="current-password">
                        <button type="submit" class="auth-btn">로그인</button>
                    </form>
                    <div id="loginMessage" class="auth-message"></div>
                </div>

                <!-- 회원가입 폼 -->
                <div id="signupForm" class="auth-form" style="display: none;">
                    <h2>회원가입</h2>
                    <form id="signupFormElement">
                        <label for="signupEmail">이메일</label>
                        <input type="email" id="signupEmail" placeholder="이메일" required autocomplete="email">
                        <label for="signupPassword">비밀번호 (6자 이상)</label>
                        <input type="password" id="signupPassword" placeholder="비밀번호 (6자 이상)" required autocomplete="new-password">
                        <label for="signupConfirmPassword">비밀번호 확인</label>
                        <input type="password" id="signupConfirmPassword" placeholder="비밀번호 확인" required autocomplete="new-password">
                        <button type="submit" class="auth-btn">회원가입</button>
                    </form>
                    <div id="signupMessage" class="auth-message"></div>
                </div>
            </div>
        </div>

        <div class="header">
            <h1>🧘‍♂️ 정서적 독립 트래커</h1>
            <p>오늘도 당신의 평온함을 지키는 하루가 되길</p>
            <div id="userSection" style="display: none;">
                <span id="userEmail"></span>
                <button onclick="logout()" style="margin-left: 10px; padding: 5px 10px; background: var(--danger); color: white; border: none; border-radius: 5px; cursor: pointer;">로그아웃</button>
            </div>
            <div id="loginSection">
                <button onclick="openAuthModal()" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">로그인/회원가입</button>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card" id="streakCard" onclick="flipCard()" title="클릭하여 시작일 확인">
                <div class="card-front">
                    <div class="stat-value" id="streak" style="margin-bottom: 5px;">0</div>
                    <div style="font-size: 0.9rem;">연속 일수</div>
                </div>
                <div class="card-back">
                    <div style="font-size: 0.9rem; font-weight: bold; margin-bottom: 8px;">📅 시작일</div>
                    <div id="startDateDisplay" style="font-size: 0.8rem; margin-bottom: 10px;">시작일 없음</div>
                    <button onclick="resetStreak(event)" style="background: #ff6b6b; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.7rem; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#ff5252'" onmouseout="this.style.background='#ff6b6b'">
                        🔄 리셋
                    </button>
                </div>
            </div>
            <div class="stat-card" id="levelCard" onclick="flipLevelCard()" title="클릭하여 레벨 진행도 확인">
                <div class="card-front">
                    <div class="stat-value" id="level" style="margin-bottom: 5px;">1</div>
                    <div style="font-size: 0.9rem;">평온 레벨</div>
                </div>
                <div class="card-back">
                    <div id="levelProgressDisplay" style="font-size: 1.0rem; font-weight: bold;">다음 레벨까지: 100포인트</div>
                </div>
            </div>
            <div class="stat-card" id="pointsCard" onclick="flipPointsCard()" title="클릭하여 포인트 정보 확인">
                <div class="card-front">
                    <div class="stat-value" id="points" style="margin-bottom: 5px;">0</div>
                    <div style="font-size: 0.9rem;">평온 포인트</div>
                </div>
                <div class="card-back">
                    <div style="font-size: 1.0rem; font-weight: bold; margin-bottom: 10px;">📈 평온 포인트</div>
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.9);">
                        총 획득 포인트
                    </div>
                </div>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress" id="dailyProgress" style="width: 0%"></div>
        </div>
        
        <h3>🌅 아침 훈련</h3>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="morning1">
            <label for="morning1">감정 분리 선언 ("오늘 타인의 감정은 나의 것이 아님" 3번)</label>
        </div>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="morning2">
            <label for="morning2">오늘 지킬 핵심 가치 선택 (평온/존중/자존감)</label>
        </div>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="morning3">
            <label for="morning3">오늘의 '나만의 30분' 계획 세우기</label>
        </div>
        
        <h3>🌞 점심 훈련</h3>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="noon1">
            <label for="noon1">비판적 말 들었을 때 "이건 사실인가?" 필터링</label>
        </div>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="noon2">
            <label for="noon2">"지금은 어렵다"고 말하기 (아니오 연습)</label>
        </div>
        
        <h3>🌙 저녁 훈련</h3>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="evening1">
            <label for="evening1">감정 폭발 시 4-7-8 호흡법 3회</label>
        </div>
        
        <div class="check-item">
            <input type="checkbox" class="check-input" id="evening2">
            <label for="evening2">📖 감정 일기 작성</label>
            <div id="diarySection" style="margin-top: 10px;">
                <!-- 로그인하지 않은 경우 표시될 메시지 -->
                <div id="diaryLoginPrompt" style="color: #666; padding: 10px; background: #f5f5f5; border-radius: 5px; margin-bottom: 10px;">
                    감정 일기를 작성하려면 로그인이 필요합니다.
                </div>
                <!-- 로그인한 경우 표시될 일기 입력 폼 -->
                <div id="diaryForm" style="display: none;">
                    <label for="otherPersonAction" class="diary-label">타인의 행동</label>
                    <input type="text" id="otherPersonAction" class="diary-input" placeholder="타인의 행동 (예: 고성 질문)" aria-label="타인의 행동">
                    <label for="myReaction" class="diary-label">내 첫 반응</label>
                    <input type="text" id="myReaction" class="diary-input" placeholder="내 첫 반응 (예: 죄책감 + 분노)" aria-label="내 첫 반응">
                    <label for="reinterpretation" class="diary-label">재해석</label>
                    <input type="text" id="reinterpretation" class="diary-input" placeholder="재해석 (예: 그녀는 불안해서 그런 거야)" aria-label="재해석">
                    <button class="btn" onclick="saveDiary()">💾 저장하고 체크 완료</button>
                </div>
            </div>
        </div>
        
        <div class="check-item">
            <input type="checkbox" class="check-input" id="evening3">
            <label for="evening3">오늘 나를 지킨 행동 1가지 칭찬하기</label>
        </div>
        
        <button class="emergency-btn" onclick="handleBreathing()">
            🚨 긴급 호흡법 시작 (4-7-8)
        </button>
        
        <div class="diary-section" id="recentDiarySection">
            <h3>📚 최근 감정 일기</h3>
            <div id="diaryList"></div>
            <button class="btn btn-danger" onclick="clearDiaries()">🗑️ 모든 일기 삭제</button>
        </div>
        
        <div class="reward">
            <h3>🏆 오늘의 보상</h3>
            <div id="badges"></div>
            <p id="rewardText">모든 체크리스트를 완료하면 보상이 열립니다!</p>

            <!-- 리셋 버튼 추가 -->
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="resetAllPointsAndLevels()" style="background: var(--danger); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">
                    🔄 모든 포인트와 레벨 리셋
                </button>
            </div>
        </div>

        <!-- 오늘 획득 포인트 상세 정보 -->
        <div class="daily-points-summary" style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 10px; border: 2px solid #dee2e6;">
            <h4 style="margin: 0 0 15px 0; text-align: center; color: #495057; font-size: 1.1rem;">
                📊 오늘 획득 포인트 요약
            </h4>
            <div style="display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div style="text-align: center; min-width: 120px;">
                    <div style="font-size: 1.5rem; margin-bottom: 5px;">📋</div>
                    <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">체크 완료</div>
                    <div style="font-size: 1.3rem; font-weight: bold; color: #28a745;" id="checklistPoints">0</div>
                    <div style="font-size: 0.8rem; color: #6c757d;">포인트</div>
                </div>
                <div style="text-align: center; min-width: 120px;">
                    <div style="font-size: 1.5rem; margin-bottom: 5px;">🧘</div>
                    <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">긴급 호흡법</div>
                    <div style="font-size: 1.3rem; font-weight: bold; color: #17a2b8;" id="breathingPointsDisplay">0</div>
                    <div style="font-size: 0.8rem; color: #6c757d;">포인트</div>
                </div>
                <div style="text-align: center; min-width: 120px; background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 10px; border-radius: 8px;">
                    <div style="font-size: 1.8rem; margin-bottom: 5px;">🏆</div>
                    <div style="font-size: 0.9rem; margin-bottom: 5px;">총 획득 포인트</div>
                    <div style="font-size: 1.5rem; font-weight: bold;" id="totalDailyPoints">0</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">포인트</div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 15px; font-size: 0.85rem; color: #6c757d;">
                <span id="dailyBreakdown">체크리스트 0개 완료 (0점) + 긴급호흡법 0회 완료 (0점) = 총 0점</span>
            </div>
        </div>
    </div>

    <script>
        // Supabase 클라이언트 (전역 변수)
        let supabaseClient = null;
        let currentUser = null;

        // Netlify 환경 변수에서 Supabase 설정 가져오기
        async function getSupabaseConfig() {
            try {
                const response = await fetch('/.netlify/functions/get-supabase-config');
                if (!response.ok) {
                    throw new Error(`Netlify 함수 호출 실패: ${response.statusText}`);
                }
                const config = await response.json();
                console.log('Supabase 설정 로드 성공:', config);
                return config;
            } catch (error) {
                console.error('Supabase 설정 로드 오류:', error);
                alert('앱 설정을 불러오는 데 실패했습니다. 페이지를 새로고침하거나 관리자에게 문의하세요.');
                return null;
            }
        }

        // Supabase 초기화 함수
        async function initializeSupabase() {
            const config = await getSupabaseConfig();
            if (!config || !config.supabaseUrl || !config.supabaseAnonKey) {
                console.error('Supabase 설정이 유효하지 않습니다.');
                return false;
            }

            const supabaseUrl = config.supabaseUrl;
            const supabaseKey = config.supabaseAnonKey;

            return new Promise((resolve) => {
                waitForSupabase(() => {
                    try {
                        // Supabase v2 올바른 초기화 방식
                        const { createClient } = supabase;
                        supabaseClient = createClient(supabaseUrl, supabaseKey);

                        console.log('Supabase 클라이언트 초기화 성공');
                        console.log('클라이언트 타입:', typeof supabaseClient);
                        console.log('클라이언트 전체 구조:', Object.keys(supabaseClient));
                        console.log('from 메소드 존재 여부:', 'from' in supabaseClient);
                        console.log('from 메소드 타입:', typeof supabaseClient.from);
                        console.log('클라이언트 auth 객체:', supabaseClient.auth);
                        console.log('클라이언트 auth 타입:', typeof supabaseClient.auth);

                        resolve(true);
                    } catch (error) {
                        console.error('Supabase 클라이언트 초기화 실패:', error);
                        resolve(false);
                    }
                });
            });
        }

        // 데이터 초기화 - 데이터베이스 전용
        let userData = {
            streak: 0,
            level: 1,
            points: 0,
            lastCheck: null,
            completedToday: [],
            totalPoints: 0,
            startDate: null,
            lastCompletedDate: null,
            breathingPoints: 0
        };

        let diaries = []; // 데이터베이스 전용

        // ================ 인증 관련 함수 ================

        // 인증 모달 열기
        function openAuthModal() {
            document.getElementById('authModal').style.display = 'block';
        }

        // 인증 모달 닫기
        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            clearMessages();
        }

        // 탭 전환
        function switchTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const tabBtns = document.querySelectorAll('.tab-btn');

            tabBtns.forEach(btn => btn.classList.remove('active'));

            if (tab === 'login') {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
                tabBtns[0].classList.add('active');
            } else {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
                tabBtns[1].classList.add('active');
            }

            clearMessages();
        }

        // 메시지 지우기
        function clearMessages() {
            document.getElementById('loginMessage').textContent = '';
            document.getElementById('loginMessage').className = 'auth-message';
            document.getElementById('signupMessage').textContent = '';
            document.getElementById('signupMessage').className = 'auth-message';
        }

        // 메시지 표시
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `auth-message ${type}`;
        }

        // 회원가입
        async function signup() {
            if (!supabaseClient) {
                showMessage('signupMessage', 'Supabase가 설정되지 않았습니다. 관리자에게 문의해주세요.', 'error');
                return;
            }

            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;

            if (!email || !password || !confirmPassword) {
                showMessage('signupMessage', '모든 필드를 입력해주세요.', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('signupMessage', '비밀번호는 6자 이상이어야 합니다.', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showMessage('signupMessage', '비밀번호가 일치하지 않습니다.', 'error');
                return;
            }

            try {
                console.log('📝 회원가입 시도:', { email, passwordLength: password.length });

                // auth 객체 다시 확인
                if (!supabaseClient || !supabaseClient.auth) {
                    throw new Error('Supabase 클라이언트가 초기화되지 않았습니다.');
                }

                console.log('auth 객체 상태:', {
                    exists: !!supabaseClient.auth,
                    hasSignUp: typeof supabaseClient.auth.signUp === 'function',
                    signUpFunction: supabaseClient.auth.signUp
                });

                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password
                });

                console.log('📋 Supabase 응답:', { data, error });

                if (error) {
                    console.error('❌ Supabase 회원가입 오류:', error);
                    showMessage('signupMessage', `오류: ${error.message}`, 'error');
                    return;
                }

                if (data && data.user && !data.user.email_confirmed_at) {
                    console.log('✅ 회원가입 성공 (이메일 확인 필요)');
                    showMessage('signupMessage', '회원가입이 완료되었습니다. 이메일을 확인해주세요.', 'success');
                } else if (data && data.user) {
                    console.log('✅ 회원가입 성공 (즉시 로그인)');
                    showMessage('signupMessage', '회원가입이 완료되었습니다.', 'success');
                } else {
                    console.log('⚠️ 응답 데이터 없음');
                    showMessage('signupMessage', '회원가입이 처리되었습니다.', 'success');
                }

                // 3초 후 로그인 탭으로 전환
                setTimeout(() => {
                    switchTab('login');
                    document.getElementById('loginEmail').value = email;
                }, 3000);

            } catch (error) {
                console.error('💥 회원가입 시스템 오류:', error);
                showMessage('signupMessage', `시스템 오류: ${error.message}`, 'error');
            }
        }

        // 로그인
        async function login() {
            if (!supabaseClient) {
                showMessage('loginMessage', 'Supabase가 설정되지 않았습니다. 관리자에게 문의해주세요.', 'error');
                return;
            }

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showMessage('loginMessage', '이메일과 비밀번호를 입력해주세요.', 'error');
                return;
            }

            try {
                console.log('🔐 로그인 시도:', { email });

                // Supabase 클라이언트 상태 확인
                console.log('로그인 전 클라이언트 상태:', {
                    supabaseClient: !!supabaseClient,
                    auth: !!supabaseClient?.auth,
                    signInWithPassword: typeof supabaseClient?.auth?.signInWithPassword
                });

                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                console.log('로그인 응답:', { data, error });

                if (error) {
                    showMessage('loginMessage', error.message, 'error');
                    return;
                }

                currentUser = data.user;

                // 로그인 성공 - UI 업데이트
                document.getElementById('userEmail').textContent = email;
                document.getElementById('userSection').style.display = 'flex';
                document.getElementById('loginSection').style.display = 'none';
                closeAuthModal();

                // 데이터 로드 (동기적으로 처리 - 실패 시 로그아웃)
                try {
                    await loadUserData();
                    console.log('데이터 로드 성공');
                    updateUI();
                    await loadDiaries(); // 로그인 후 감정일기 로드
                    updateDiarySection(); // 일기 섹션 UI 업데이트
                    updateChecklistSection(); // 체크리스트 섹션 UI 업데이트
                } catch (loadError) {
                    console.error('데이터 로드 실패:', loadError);
                    alert('데이터 로드에 실패했습니다. 다시 로그인해주세요.');

                    // 로그아웃 처리
                    currentUser = null;
                    document.getElementById('userSection').style.display = 'none';
                    document.getElementById('loginSection').style.display = 'block';
                    showMessage('loginMessage', '로그인 실패: 서버 연결 오류', 'error');
                }

            } catch (error) {
                console.error('💥 로그인 시스템 오류:', error);
                showMessage('loginMessage', `시스템 오류: ${error.message}`, 'error');
            }
        }

        // 새 사용자 데이터 생성
        async function createNewUserData() {
            if (!currentUser || !supabaseClient) return;

            try {
                const newUserData = {
                    user_id: currentUser.id,
                    streak: 0,
                    level: 1,
                    points: 0,
                    last_check: null,
                    completed_today: [],
                    total_points: 0,
                    start_date: null,
                    last_completed_date: null,
                    breathing_points: 0
                };

                const { data, error } = await supabaseClient
                    .from('user_data')
                    .insert([newUserData])
                    .select()
                    .single();

                if (error) {
                    console.error('사용자 데이터 생성 오류:', error);
                    return;
                }

                console.log('새 사용자 데이터 생성 성공:', data);

                // userData 업데이트
                userData = {
                    streak: data.streak || 0,
                    level: data.level || 1,
                    points: data.points || 0,
                    lastCheck: data.last_check,
                    completedToday: data.completed_today || [],
                    totalPoints: data.total_points || 0,
                    startDate: data.start_date,
                    lastCompletedDate: data.last_completed_date
                };

                updateUI();
            } catch (error) {
                console.error('사용자 데이터 생성 중 예외 오류:', error);
            }
        }

        // 로그아웃
        async function logout() {
            console.log('logout 함수 호출됨');

            // 로그아웃 버튼 비활성화 (중복 클릭 방지)
            const logoutBtn = document.querySelector('button[onclick="logout()"]');
            if (logoutBtn) {
                logoutBtn.disabled = true;
                logoutBtn.textContent = '로그아웃 중...';
            }

            try {
                // Supabase 로그아웃 시도
                if (supabaseClient && supabaseClient.auth) {
                    await supabaseClient.auth.signOut();
                    console.log('Supabase signOut 완료');
                }
            } catch (error) {
                console.error('Supabase 로그아웃 오류:', error);
            } finally {
                // 항상 로컬 데이터 초기화
                performLocalLogout();
            }
        }

        // 로컬 로그아웃 수행 함수
        function performLocalLogout() {
            console.log('로컬 로그아웃 수행 시작');

            // 데이터 초기화
            currentUser = null;
            userData = {
                streak: 0,
                level: 1,
                points: 0,
                lastCheck: null,
                completedToday: [],
                totalPoints: 0,
                startDate: null,
                lastCompletedDate: null,
                breathingPoints: 0
            };
            diaries = [];

            // UI 업데이트 (데이터 저장 호출 없이 직접 업데이트)
            document.getElementById('userSection').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';

            // 일기 섹션 직접 업데이트
            const diaryLoginPrompt = document.getElementById('diaryLoginPrompt');
            const diaryForm = document.getElementById('diaryForm');
            const recentDiarySection = document.getElementById('recentDiarySection');
            if (diaryLoginPrompt) diaryLoginPrompt.style.display = 'block';
            if (diaryForm) diaryForm.style.display = 'none';
            // 최근 감정 일기 섹션만 숨기기
            if (recentDiarySection) recentDiarySection.style.display = 'none';

            // 체크리스트 섹션 직접 업데이트
            const checklistMessage = document.getElementById('checklistMessage');
            if (checklistMessage) {
                checklistMessage.innerHTML = '🔒 체크리스트를 사용하려면 로그인이 필요합니다.<br>모든 데이터는 안전하게 데이터베이스에 저장됩니다.';
                checklistMessage.style.display = 'block';
            }

            // 모든 체크박스 직접 업데이트
            document.querySelectorAll('.check-input').forEach(checkbox => {
                checkbox.disabled = true;
                checkbox.checked = false;
                checkbox.setAttribute('title', '로그인이 필요합니다');
                checkbox.parentElement.classList.remove('completed');
            });

            // 통계 카드 직접 초기화
            document.getElementById('streak').textContent = '0';
            document.getElementById('level').textContent = '1';
            document.getElementById('points').textContent = '0';
            // document.getElementById('dailyPoints').textContent = '0'; // 요소 제거됨
            const progressBar = document.getElementById('progressBar');
            if (progressBar) progressBar.style.width = '0%';

            // 일기 목록 직접 비우기
            const diariesList = document.getElementById('diariesList');
            if (diariesList) diariesList.innerHTML = '';

            // 로그아웃 버튼 상태 복원
            const logoutBtn = document.querySelector('button[onclick="logout()"]');
            if (logoutBtn) {
                logoutBtn.disabled = false;
                logoutBtn.textContent = '로그아웃';
            }

            console.log('로그아웃 완료 - 모든 데이터 초기화됨');
            alert('로그아웃이 완료되었습니다.');
    }

        // 일기 섹션 UI 업데이트
        function updateDiarySection() {
            const loginPrompt = document.getElementById('diaryLoginPrompt');
            const diaryForm = document.getElementById('diaryForm');
            const recentDiarySection = document.getElementById('recentDiarySection');

            if (currentUser && supabaseClient) {
                loginPrompt.style.display = 'none';
                diaryForm.style.display = 'block';
                // 최근 감정 일기 섹션 표시
                if (recentDiarySection) recentDiarySection.style.display = 'block';
            } else {
                loginPrompt.style.display = 'block';
                diaryForm.style.display = 'none';
                // 최근 감정 일기 섹션 숨기기
                if (recentDiarySection) recentDiarySection.style.display = 'none';
            }
        }

        // 체크리스트 섹션 UI 업데이트
        function updateChecklistSection() {
            const isLoggedIn = currentUser && supabaseClient;
            const checkboxes = document.querySelectorAll('.check-input');
            const emergencyBtn = document.querySelector('.emergency-btn');

            checkboxes.forEach(checkbox => {
                checkbox.disabled = !isLoggedIn;
                if (!isLoggedIn) {
                    checkbox.checked = false;
                }
            });

            if (emergencyBtn) {
                emergencyBtn.disabled = !isLoggedIn;
            }

            // 비로그인 상태 메시지 표시
            let checklistMessage = document.getElementById('checklistMessage');
            if (!checklistMessage) {
                checklistMessage = document.createElement('div');
                checklistMessage.id = 'checklistMessage';
                checklistMessage.style.cssText = 'color: #666; padding: 15px; background: #f5f5f5; border-radius: 8px; margin-bottom: 20px; text-align: center;';

                const checklistContainer = document.querySelector('.checklist');
                if (checklistContainer) {
                    checklistContainer.parentNode.insertBefore(checklistMessage, checklistContainer);
                }
            }

            if (isLoggedIn) {
                checklistMessage.style.display = 'none';
            } else {
                checklistMessage.innerHTML = '🔒 체크리스트를 사용하려면 로그인이 필요합니다.<br>모든 데이터는 안전하게 데이터베이스에 저장됩니다.';
                checklistMessage.style.display = 'block';
            }
        }

        // 일기 데이터 로드 (데이터베이스 전용)
        async function loadDiaries() {
            if (!currentUser || !supabaseClient) {
                diaries = [];
                displayDiaries();
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('emotion_diaries')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('일기 로드 오류:', error);
                    diaries = [];
                } else {
                    // 데이터베이스 형식을 기존 형식으로 변환 (하위 호환성 지원)
                    diaries = (data || []).map(diary => ({
                        id: diary.id, // 일기 ID 추가
                        date: new Date(diary.created_at).toLocaleString(),
                        otherPersonAction: diary.other_person_action,
                        myReaction: diary.my_reaction,
                        reinterpretation: diary.reinterpretation
                    }));
                    console.log('데이터베이스에서 로드된 일기:', diaries.length, '개');
                }

                displayDiaries();
            } catch (error) {
                console.error('일기 로드 시스템 오류:', error);
                diaries = [];
                displayDiaries();
            }
        }

        // 사용자 데이터 로드
        async function loadUserData() {
            if (!currentUser || !supabaseClient) {
                // 로그인하지 않은 경우 - 데이터 초기화는 checkAuthState에서 처리
                console.log('loadUserData: 로그인하지 않은 상태');
                return;
            }

            try {
                console.log('사용자 데이터 조회 시작:', { userId: currentUser.id, email: currentUser.email });
                console.log('Supabase 클라이언트 상태:', {
                    supabaseClient: !!supabaseClient,
                    auth: !!supabaseClient?.auth,
                    from: typeof supabaseClient?.from
                });

                // 쿼리 실행 전 상세 로깅
                console.log('DB 쿼리 실행 직전 - user_id:', currentUser.id);
                console.log('쿼리 파라미터 확인:', {
                    table: 'user_data',
                    userId: currentUser.id,
                    userIdType: typeof currentUser.id
                });

                // 네트워크 연결성 테스트
                console.log('네트워크 연결성 테스트 시작...');
                try {
                    const networkTest = await fetch('https://hpejebnqhgojfxttfbal.supabase.co/rest/v1/', {
                        method: 'GET',
                        headers: {
                            'apikey': supabaseKey,
                            'Authorization': `Bearer ${supabaseKey}`
                        }
                    });
                    console.log('네트워크 테스트 결과:', {
                        status: networkTest.status,
                        ok: networkTest.ok,
                        statusText: networkTest.statusText
                    });
                } catch (networkError) {
                    console.error('네트워크 연결성 테스트 실패:', networkError);
                }

                const queryStartTime = Date.now();
                console.log('쿼리 시작 시간:', queryStartTime);

                // 쿼리 최적화: 필요한 필드만 선택
                const optimizedQuery = supabaseClient
                    .from('user_data')
                    .select('streak, level, points, last_check, completed_today, total_points, start_date, last_completed_date, breathing_points')
                    .eq('user_id', currentUser.id)
                    .single();

                // 간단한 타임아웃 처리 - 재시도 없이 바로 실패 처리
                let data, error;
                try {
                    console.log('데이터베이스 쿼리 시작');

                    // 타임아웃 메커니즘
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => {
                            reject(new Error('Database query timeout after 10 seconds'));
                        }, 10000); // 10초 타임아웃
                    });

                    const result = await Promise.race([optimizedQuery, timeoutPromise]);
                    data = result.data;
                    error = result.error;

                    if (error) {
                        throw error;
                    }

                    console.log('쿼리 성공');

                } catch (queryError) {
                    console.error('데이터베이스 쿼리 실패:', queryError);
                    if (queryError.message && queryError.message.includes('timeout')) {
                        error = { code: 'TIMEOUT', message: 'Database query timeout' };
                    } else {
                        error = queryError;
                    }
                    data = null;
                }

                const queryEndTime = Date.now();
                console.log('쿼리 완료 시간:', queryEndTime);
                console.log('쿼리 소요 시간:', queryEndTime - queryStartTime, 'ms');
                console.log('데이터 조회 결과:', { data, error });
                console.log('데이터 조회 완료 - 다음 단계 진행');
                if (data) {
                    console.log('조회된 데이터 필드:', Object.keys(data));
                    console.log('diaries 필드:', data.diaries);
                    console.log('breathing_points 필드:', data.breathing_points);
                }

                if (error && error.code !== 'PGRST116') { // PGRST116: 데이터 없음
                    console.error('데이터 로드 오류:', error);

                    // 데이터베이스 타임아웃 에러 처리
                    if (error.code === 'TIMEOUT') {
                        console.error('데이터베이스 연결 타임아웃:', error);
                        alert('서버 연결이 불안정합니다. 잠시 후 다시 로그인해주세요.');

                        // 로그아웃 처리
                        currentUser = null;
                        document.getElementById('userSection').style.display = 'none';
                        document.getElementById('loginSection').style.display = 'block';
                        closeAuthModal();
                        return;
                    }

                    // 406 오류인 경우 새 사용자 데이터 생성
                    if (error.code === '406') {
                        console.log('새 사용자 데이터 생성...');
                        await createNewUserData();
                    }
                    return;
                }

                if (data) {
                    // DB에서 가져온 데이터로 업데이트 (완전히 덮어쓰지 않음)
                    const dbCompletedToday = data.completed_today || [];
                    const today = new Date();
                    const dbLastCheck = data.last_check ? new Date(data.last_check) : null;

                    const isSameDay = dbLastCheck &&
                        today.getFullYear() === dbLastCheck.getFullYear() &&
                        today.getMonth() === dbLastCheck.getMonth() &&
                        today.getDate() === dbLastCheck.getDate();

                    console.log('DB 데이터 로드 (날짜 비교):', {
                        dbCompletedToday,
                        dbLastCheck: data.last_check,
                        today: today.toISOString(),
                        isSameDay
                    });

                    // 오늘 날짜의 데이터인 경우에만 completedToday 유지
                    if (isSameDay) {
                        userData.completedToday = dbCompletedToday;
                        console.log('오늘 날짜의 체크리스트 상태 복원:', dbCompletedToday);
                    } else {
                        // 날짜가 다른 경우 빈 배열으로 초기화
                        userData.completedToday = [];
                        console.log('다른 날짜의 데이터: 체크리스트 초기화');
                    }

                    // 다른 필드들은 DB 데이터로 업데이트
                    userData.streak = data.streak || 0;
                    userData.level = data.level || 1;
                    userData.points = data.points || 0;
                    userData.lastCheck = data.last_check;
                    userData.totalPoints = data.total_points || 0;
                    userData.startDate = data.start_date;
                    userData.lastCompletedDate = data.last_completed_date;
                    userData.breathingPoints = data.breathing_points || 0;

                    console.log('DB에서 사용자 데이터 로드 완료');

                    } else {
                    // 새 사용자 데이터 생성
                    await saveUserData();
                }

            } catch (error) {
                console.error('사용자 데이터 로드 오류:', error);
            }

            // 오늘 획득 포인트 UI 업데이트
            updateDailyPoints();
        }

        // 사용자 데이터 저장 (Supabase)
        async function saveUserDataToSupabase() {
            if (!currentUser || !supabaseClient) {
                console.log('saveUserDataToSupabase: 로그인하지 않음 또는 Supabase 클라이언트 없음');
                return;
            }

            try {
                console.log('데이터 저장 시작:', {
                    userId: currentUser.id,
                    completedToday: userData.completedToday,
                    points: userData.points
                });

                // 저장 쿼리 실행 전 상세 로깅
                console.log('DB 저장 쿼리 실행 직전');
                console.log('저장할 데이터 확인:', {
                    user_id: currentUser.id,
                    streak: userData.streak,
                    level: userData.level,
                    points: userData.points,
                    completed_today: userData.completedToday,
                    breathing_points: userData.breathingPoints
                });

                const saveStartTime = Date.now();
                console.log('저장 쿼리 시작 시간:', saveStartTime);

                // 저장 쿼리 최적화: 작은 데이터셋으로
                const optimizedSaveQuery = supabaseClient
                    .from('user_data')
                    .upsert({
                        user_id: currentUser.id,
                        streak: userData.streak,
                        level: userData.level,
                        points: userData.points,
                        last_check: userData.lastCheck,
                        completed_today: userData.completedToday,
                        total_points: userData.totalPoints,
                        start_date: userData.startDate,
                        last_completed_date: userData.lastCompletedDate,
                        breathing_points: userData.breathingPoints || 0,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id'
                    });

                // 간단한 타임아웃 처리 - 재시도 없이 바로 실패 처리
                let data, error;
                try {
                    console.log('데이터베이스 저장 시작');

                    // 타임아웃 메커니즘
                    const saveTimeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => {
                            reject(new Error('Database save timeout after 10 seconds'));
                        }, 10000); // 10초 타임아웃
                    });

                    const result = await Promise.race([optimizedSaveQuery, saveTimeoutPromise]);
                    data = result.data;
                    error = result.error;

                    if (error) {
                        throw error;
                    }

                    console.log('저장 성공');

                } catch (saveError) {
                    console.error('데이터베이스 저장 실패:', saveError);
                    if (saveError.message && saveError.message.includes('timeout')) {
                        error = { code: 'TIMEOUT', message: 'Database save timeout' };
                    } else {
                        error = saveError;
                    }
                    data = null;
                }

                const saveEndTime = Date.now();
                console.log('저장 쿼리 완료 시간:', saveEndTime);
                console.log('저장 쿼리 소요 시간:', saveEndTime - saveStartTime, 'ms');

                console.log('데이터 저장 결과:', { data, error });

                if (error) {
                    console.error('데이터 저장 오류:', error);
                    if (error.code === 'TIMEOUT') {
                        throw new Error('Database save timeout');
                    } else {
                        throw error;
                    }
                } else {
                    console.log('데이터 저장 성공');
                }

            } catch (error) {
                console.error('사용자 데이터 저장 오류:', error);
            }
        }
        
        // 스마트폰 환경 감지
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // 스마트폰에서의 사용성 개선
        if (isMobile) {
            document.body.classList.add('mobile-view');
        }

        // 화면 업데이트
        function updateUI() {
            // 연속 일수 표시
            document.getElementById('streak').textContent = userData.streak;
            document.getElementById('level').textContent = userData.level;
            document.getElementById('points').textContent = userData.points;

            // 레벨 진행도 표시 업데이트
            updateLevelProgress();

            // 오늘 획득 포인트 표시
            updateDailyPoints();

            // 체크리스트 상태 복원 (이벤트 리스너 중복 추가 방지)
            document.querySelectorAll('.check-input').forEach(checkbox => {
                const isChecked = userData.completedToday.includes(checkbox.id);
                checkbox.checked = isChecked;

                // 로그인 상태 확인 및 체크박스 상태 설정
                if (!currentUser || !supabaseClient) {
                    // 비로그인 상태: 모든 체크박스 비활성화
                    checkbox.disabled = true;
                    checkbox.checked = false;
                    checkbox.setAttribute('title', '로그인이 필요합니다');
                    checkbox.parentElement.classList.remove('completed');
                } else {
                    // 로그인 상태: 체크된 항목만 비활성화
                    if (isChecked) {
                        checkbox.disabled = true;
                        checkbox.setAttribute('title', '오늘은 다시 해제할 수 없습니다');
                        checkbox.parentElement.classList.add('completed');
                    } else {
                        checkbox.disabled = false;
                        checkbox.removeAttribute('title');
                        checkbox.parentElement.classList.remove('completed');
                    }
                }

                // 이벤트 리스너가 없는 경우에만 추가
                if (!checkbox.hasAttribute('data-event-added')) {
                    checkbox.addEventListener('change', handleCheck);
                    checkbox.setAttribute('data-event-added', 'true');
                }
            });

            updateProgress();
            updateBadges();
            displayDiaries();
        }

        // 체크 이벤트 처리
          async function handleCheck(e) {
            console.log('handleCheck 호출됨:', {
                checked: e.target.checked,
                id: e.target.id,
                currentUser: !!currentUser,
                supabaseClient: !!supabaseClient
            });

            // 비로그인 상태에서는 체크 불가
            if (!currentUser || !supabaseClient) {
                e.target.checked = false;
                alert('로그인이 필요합니다!');
                return;
            }

            const id = e.target.id;
            const parent = e.target.parentElement;
            console.log('체크 항목 정보:', { id, currentUser: currentUser.email });

            if(e.target.checked) {
                // 이미 완료된 항목이 아닌 경우에만 포인트 추가
                if(!userData.completedToday.includes(id)) {
                    userData.completedToday.push(id);
                    userData.points += 10;
                    userData.totalPoints = (userData.totalPoints || 0) + 10; // 총 누적 포인트 증가
                    parent.classList.add('completed');

                    // 체크 완료 후 비활성화
                    e.target.disabled = true;
                    e.target.setAttribute('title', '오늘은 다시 해제할 수 없습니다');

                    console.log(`체크 완료: ${id}, 포인트 +10 (현재: ${userData.points})`);
                } else {
                    // 이미 체크된 항목을 다시 체크하려는 경우 (중복 방지)
                    console.log(`이미 체크된 항목입니다: ${id}`);
                    e.target.checked = false;
                }
            } else {
                // 체크 해제 방지 - 하루 동안은 체크한 항목을 해제할 수 없음
                if (userData.completedToday.includes(id)) {
                    e.target.checked = true;
                    alert('⏰ 한 번 체크한 항목은 오늘 하루 동안 해제할 수 없습니다.');
                    return;
                } else {
                    // 아직 완료하지 않은 항목의 체크 해제는 허용
                    parent.classList.remove('completed');
                    console.log(`체크 해제 허용: ${id} (아직 완료하지 않은 항목)`);
                }
            }

            // 현재 날짜를 lastCheck에 설정하여 하루 중에 체크 상태 유지
            userData.lastCheck = new Date().toISOString();

            // 데이터 즉시 저장 (데이터베이스에 바로 저장)
            await saveUserDataToSupabase(); // 즉시 DB 저장
            await updateProgress();
            updateBadges();

            // 오늘 획득 포인트 업데이트
            updateDailyPoints();

            // UI 업데이트 (평온포인트 카드 포함)
            document.getElementById('points').textContent = userData.points;

            // 레벨업 체크
            if(userData.points >= userData.level * 100) {
                userData.level++;
                console.log('🎉 레벨업! 레벨:', userData.level);
                alert(`🎉 레벨업! 평온 레벨 ${userData.level} 달성!`);
                await saveUserDataToSupabase(); // 레벨업 시 DB 저장
                updateLevelProgress();
            } else {
                updateLevelProgress();
            }
        }
        
        // 사용자 데이터 저장 (데이터베이스 전용)
        async function saveUserData() {
            console.log('saveUserData 호출됨:', {
                currentUser: !!currentUser,
                supabaseClient: !!supabaseClient,
                email: currentUser?.email
            });

            // Supabase에 저장 (로그인한 경우만)
            if (currentUser && supabaseClient) {
                console.log('Supabase에 데이터 저장 시도...');
                try {
                    await saveUserDataToSupabase();
                    console.log('Supabase 데이터 저장 완료');
                } catch (saveError) {
                    console.error('Supabase 저장 실패:', saveError);
                    alert('데이터 저장에 실패했습니다. 서버 연결을 확인해주세요.');
                }
            } else {
                console.log('비로그인 상태에서는 데이터를 저장하지 않음');
            }
        }
        
      
        // 레벨 진행도 업데이트
        function updateLevelProgress() {
            const pointsNeeded = userData.level * 100;
            const pointsRemaining = Math.max(0, pointsNeeded - userData.points);
            const progressPercentage = userData.points >= pointsNeeded ? 100 : (userData.points / pointsNeeded) * 100;

            // 앞면에서는 레벨 진행도 표시 제거 (뒷면에서만 표시)
        }

        // 레벨 진행도 디스플레이 업데이트 함수
        function updateLevelProgressDisplay() {
            const pointsNeeded = userData.level * 100;
            const pointsRemaining = Math.max(0, pointsNeeded - userData.points);

            document.getElementById('levelProgressDisplay').textContent = `다음 레벨까지: ${pointsRemaining}포인트`;
        }

        // 오늘 획득 포인트 업데이트
        function updateDailyPoints() {
            const checklistPoints = userData.completedToday.length * 10;
            const breathingPoints = userData.breathingPoints || 0;
            const totalDailyPoints = checklistPoints + breathingPoints;

            // 기존 오늘 획득 포인트 표시 업데이트 (요소 제거됨)
            // document.getElementById('dailyPoints').textContent = totalDailyPoints;

            // 상세 정보 업데이트
            document.getElementById('checklistPoints').textContent = checklistPoints;
            document.getElementById('breathingPointsDisplay').textContent = breathingPoints;
            document.getElementById('totalDailyPoints').textContent = totalDailyPoints;

            // 세부 내용 텍스트 업데이트
            const completedCount = userData.completedToday.length;
            const breathingCount = breathingPoints / 5; // 호흡법 완료 횟수 (5점당 1회)
            document.getElementById('dailyBreakdown').textContent =
                `체크리스트 ${completedCount}개 완료 (${checklistPoints}점) + 긴급호흡법 ${breathingCount}회 완료 (${breathingPoints}점) = 총 ${totalDailyPoints}점`;
        }

        // 연속일수 카드 뒤집기 함수
        function flipCard() {
            const card = document.getElementById('streakCard');
            card.classList.toggle('flipped');

            // 뒷면이 보일 때 시작일 정보 업데이트
            if (card.classList.contains('flipped')) {
                updateStartDateDisplay();
            }
        }

        // 평온레벨 카드 뒤집기 함수
        function flipLevelCard() {
            const card = document.getElementById('levelCard');
            card.classList.toggle('flipped');

            // 뒷면이 보일 때 레벨 진행도 정보 업데이트
            if (card.classList.contains('flipped')) {
                updateLevelProgressDisplay();
            }
        }

        // 평온포인트 카드 뒤집기 함수
        function flipPointsCard() {
            const card = document.getElementById('pointsCard');
            card.classList.toggle('flipped');
        }

        // 시작일 표시 업데이트 함수
        function updateStartDateDisplay() {
            const startDateDisplay = document.getElementById('startDateDisplay');

            if (userData.startDate) {
                const startDate = new Date(userData.startDate);
                const formattedDate = startDate.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                startDateDisplay.textContent = formattedDate;
            } else {
                startDateDisplay.textContent = '시작일 없음';
            }
        }

        // 연속일수 리셋 함수
        async function resetStreak(event) {
            event.stopPropagation(); // 카드 뒤집기 이벤트 방지

            if (confirm('연속일수를 리셋하시겠습니까?\\n시작일이 오늘로 변경되고 연속일수는 0이 됩니다.')) {
                const today = new Date().toISOString();

                // 데이터 리셋 (시작일은 오늘로 설정)
                userData.startDate = today;
                userData.lastCompletedDate = null;
                userData.streak = 0;
                userData.completedToday = [];
                userData.lastCheck = null;

                // DB에 저장
                if (currentUser && supabaseClient) {
                    await saveUserDataToSupabase();
                }

                // UI 업데이트
                document.getElementById('streak').textContent = '0';
                updateStartDateDisplay();
                updateProgress();

                // 카드 앞면으로 돌아가기
                document.getElementById('streakCard').classList.remove('flipped');

                alert('연속일수가 리셋되었습니다.\\n오늘부터 새로 시작합니다!');
            }
        }

        // 연속 일수 자동 계산 함수
        function calculateStreak() {
            if (!userData.startDate) {
                return 0; // 시작일이 없으면 0 반환
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const startDate = new Date(userData.startDate);
            startDate.setHours(0, 0, 0, 0);

            // 날짜 차이 계산 (밀리초 → 일)
            const diffTime = Math.abs(today - startDate);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            // 연속 사용 확인: 마지막 완료일로부터 하루가 지났는지 확인
            if (userData.lastCompletedDate) {
                const lastCompleted = new Date(userData.lastCompletedDate);
                lastCompleted.setHours(0, 0, 0, 0);
                const daysSinceLastComplete = Math.floor((today - lastCompleted) / (1000 * 60 * 60 * 24));

                // 하루 이상 지났으면 연속이 끊김
                if (daysSinceLastComplete > 1) {
                    return 0;
                }
            }

            return diffDays + 1; // 시작일 포함
        }

        // 연속 일수 업데이트 함수
        async function updateStreak() {
            const today = new Date().toISOString();
            const completed = userData.completedToday.length;
            const total = document.querySelectorAll('.check-input').length;
            const isAllCompleted = completed === total;

            console.log('🔄 연속일수 업데이트:', { today, completed, total, isAllCompleted });

            // 시작일 설정
            if (!userData.startDate && isAllCompleted) {
                userData.startDate = today;
                userData.streak = 1;
                console.log('🎯 첫 전체 완료! 시작일 설정:', userData.startDate);
            } else if (userData.startDate && isAllCompleted) {
                // 모든 항목 완료 시 마지막 완료일 업데이트
                userData.lastCompletedDate = today;
            }

            // 자동으로 연속일수 계산
            if (userData.startDate) {
                userData.streak = calculateStreak();
            }

            // 연속일수 변경 시 DB에 저장
            console.log('💾 연속일수 변경 후 DB 저장:', { streak: userData.streak, startDate: userData.startDate });
            await saveUserDataToSupabase();
        }

        // 진행도 업데이트
        async function updateProgress() {
            const total = document.querySelectorAll('.check-input').length;
            const completed = userData.completedToday.length;
            const percentage = (completed / total) * 100;
            document.getElementById('dailyProgress').style.width = percentage + '%';

            // 연속 일수 업데이트
            await updateStreak();
        }

        // 뱃지 업데이트
        function updateBadges() {
            const badgesContainer = document.getElementById('badges');
            badgesContainer.innerHTML = '';
            
            if(userData.streak >= 3) {
                badgesContainer.innerHTML += '<span class="badge">🔥 3일 연속</span>';
            }
            if(userData.streak >= 7) {
                badgesContainer.innerHTML += '<span class="badge">⭐ 평온 수호자</span>';
            }
            if(userData.level >= 3) {
                badgesContainer.innerHTML += '<span class="badge">🛡️ 정신의 방패</span>';
            }
            
            // 보상 메시지
            const total = document.querySelectorAll('.check-input').length;
            const completed = userData.completedToday.length;
            if(completed === total) {
                document.getElementById('rewardText').innerHTML = 
                    `🎉 완료! 오늘의 보상: <strong>${getRandomReward()}</strong>`;
            }
        }

        // 랜덤 보상
        function getRandomReward() {
            const rewards = [
                "따뜻한 차 한잔의 여유",
                "좋아하는 노래 3곡 듣기",
                "15분 추가 휴식",
                "작은 간식 먹기",
                "오늘은 칭찬 일기 쓰지 않기"
            ];
            return rewards[Math.floor(Math.random() * rewards.length)];
        }

        // 호흡법 핸들러
        function handleBreathing() {
            // 비로그인 상태에서는 사용 불가
            if (!currentUser || !supabaseClient) {
                alert('로그인이 필요합니다!');
                return;
            }
            startBreathing();
        }

        // 호흡법 타이머
        function startBreathing() {
            alert("🌬️ 4초 들이마시기 → 7초 참기 → 8초 내쉬기\n\n지금 시작합니다. 화면을 보며 따라해주세요!");

            let step = 0;
            const steps = [
                { text: "들이마시기 (4초)", duration: 4000 },
                { text: "참기 (7초)", duration: 7000 },
                { text: "내쉬기 (8초)", duration: 8000 }
            ];

            const interval = setInterval(() => {
                alert(steps[step].text);
                step++;
                if(step >= steps.length) {
                    clearInterval(interval);

                    // 호흡법 완료 시 10포인트 지급
                    userData.points += 10;
                    userData.totalPoints = (userData.totalPoints || 0) + 10; // 총 누적 포인트도 증가
                    userData.breathingPoints = (userData.breathingPoints || 0) + 10;

                    // DB에 저장 (async 처리)
                    saveUserDataToSupabase().then(() => {
                        // UI 업데이트
                        updateUI();
                        updateLevelProgress();
                        updateDailyPoints();
                    });

                    alert("✅ 호흡법 완료! 평온 포인트 10점 획득!\n이제 조금 더 평온해지셨나요?");
                }
            }, steps[step]?.duration || 0);
        }

        // 감정 일기 저장
        async function saveDiary() {
            if (!currentUser || !supabaseClient) {
                alert('로그인이 필요합니다!');
                return;
            }

            const otherPersonAction = document.getElementById('otherPersonAction').value;
            const myReaction = document.getElementById('myReaction').value;
            const reinterpretation = document.getElementById('reinterpretation').value;

            if(!otherPersonAction || !myReaction || !reinterpretation) {
                alert('모든 필드를 작성해주세요!');
                return;
            }

            try {
                // Supabase에 일기 저장
                const { data, error } = await supabaseClient
                    .from('emotion_diaries')
                    .insert([{
                        user_id: currentUser.id,
                        other_person_action: otherPersonAction,
                        my_reaction: myReaction,
                        reinterpretation: reinterpretation
                    }])
                    .select()
                    .single();

                if (error) {
                    console.error('일기 저장 오류:', error);
                    alert('일기 저장에 실패했습니다.');
                    return;
                }

                console.log('일기 저장 성공:', data);

                // 체크박스 자동 완료
                document.getElementById('evening2').checked = true;
                await handleCheck({target: document.getElementById('evening2')});

                // 입력 필드 초기화
                document.getElementById('otherPersonAction').value = '';
                document.getElementById('myReaction').value = '';
                document.getElementById('reinterpretation').value = '';

                // 일기 목록 새로고침
                await loadDiaries();
                alert('✅ 감정 일기가 저장되었습니다!');

            } catch (error) {
                console.error('일기 저장 시스템 오류:', error);
                alert('일기 저장에 실패했습니다.');
            }
        }

        // 일기 목록 표시
        function displayDiaries() {
            const diaryList = document.getElementById('diaryList');
            diaryList.innerHTML = '';

            console.log('displayDiaries 호출됨, diaries 길이:', diaries.length);
            console.log('diaries 내용:', diaries);

            if(diaries.length === 0) {
                diaryList.innerHTML = '<p style="color: #666;">저장된 일기가 없습니다</p>';
                return;
            }

            diaries.slice(0, 7).forEach(diary => {
                const diaryItem = document.createElement('div');
                diaryItem.className = 'diary-item';

                // 날짜와 삭제 버튼을 위한 컨테이너
                const headerDiv = document.createElement('div');
                headerDiv.style.display = 'flex';
                headerDiv.style.justifyContent = 'space-between';
                headerDiv.style.alignItems = 'flex-start';
                headerDiv.style.marginBottom = '8px';

                // 날짜 표시
                const dateDiv = document.createElement('div');
                dateDiv.style.fontSize = '0.8rem';
                dateDiv.style.color = '#666';
                dateDiv.textContent = `📅 ${diary.date}`;

                // 삭제 버튼
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.title = '일기 삭제';
                deleteBtn.textContent = '🗑️';
                deleteBtn.onclick = function() {
                    deleteDiary(diary.id);
                };

                headerDiv.appendChild(dateDiv);
                headerDiv.appendChild(deleteBtn);

                // 내용 추가
                const contentDiv1 = document.createElement('div');
                contentDiv1.innerHTML = `<strong>👥 타인:</strong> ${diary.otherPersonAction}`;

                const contentDiv2 = document.createElement('div');
                contentDiv2.innerHTML = `<strong>👨 나:</strong> ${diary.myReaction}`;

                const contentDiv3 = document.createElement('div');
                contentDiv3.innerHTML = `<strong>💡 재해석:</strong> <span style="color: var(--success);">${diary.reinterpretation}</span>`;

                diaryItem.appendChild(headerDiv);
                diaryItem.appendChild(contentDiv1);
                diaryItem.appendChild(contentDiv2);
                diaryItem.appendChild(contentDiv3);

                diaryList.appendChild(diaryItem);
            });
        }

        // 개별 일기 삭제
        async function deleteDiary(diaryId) {
            if(!confirm('정말 이 감정 일기를 삭제하시겠습니까?')) {
                return;
            }

            if (currentUser && supabaseClient) {
                // DB에서 해당 일기 삭제
                try {
                    const { error } = await supabaseClient
                        .from('emotion_diaries')
                        .delete()
                        .eq('id', diaryId)
                        .eq('user_id', currentUser.id); // 보안: 자신의 일기만 삭제 가능

                    if (error) {
                        console.error('일기 삭제 오류:', error);
                        alert('일기 삭제에 실패했습니다.');
                        return;
                    }
                } catch (error) {
                    console.error('일기 삭제 시스템 오류:', error);
                    alert('일기 삭제에 실패했습니다.');
                    return;
                }
            }

            // 배열에서 해당 일기 제거
            diaries = diaries.filter(diary => diary.id !== diaryId);
            displayDiaries();
            alert('일기가 삭제되었습니다.');
        }

        // 일기 삭제
        async function clearDiaries() {
            if(confirm('정말 모든 감정 일기를 삭제하시겠습니까?')) {
                if (currentUser && supabaseClient) {
                    // DB에서 일기 삭제
                    try {
                        const { error } = await supabaseClient
                            .from('emotion_diaries')
                            .delete()
                            .eq('user_id', currentUser.id);

                        if (error) {
                            console.error('일기 삭제 오류:', error);
                            alert('일기 삭제에 실패했습니다.');
                            return;
                        }
                    } catch (error) {
                        console.error('일기 삭제 시스템 오류:', error);
                        alert('일기 삭제에 실패했습니다.');
                        return;
                    }
                }
                diaries = [];
                displayDiaries();
                alert('모든 일기가 삭제되었습니다.');
            }
        }

        // 모든 포인트와 레벨 리셋 함수
        async function resetAllPointsAndLevels() {
            if (confirm('정말 모든 포인트와 레벨을 리셋하시겠습니까?\n⚠️ 이 작업은 되돌릴 수 없습니다.')) {
                // 모든 포인트와 레벨을 0으로 초기화
                userData.points = 0;
                userData.totalPoints = 0;
                userData.level = 1;
                userData.breathingPoints = 0;

                // 체크리스트는 유지하지만 오늘의 포인트는 초기화
                userData.completedToday = [];
                userData.lastCheck = null;

                // DB에 저장
                if (currentUser && supabaseClient) {
                    await saveUserDataToSupabase();
                }

                // UI 업데이트
                updateUI();
                updateLevelProgress();
                updateDailyPoints();

                alert('✅ 모든 포인트와 레벨이 리셋되었습니다.\n오늘부터 새로 시작하세요!');
            }
        }

        
        
        // 날짜 변경 확인 및 completedToday 배열 초기화
        async function checkDateChangeAndReset() {
            const today = new Date();
            const lastCheck = userData.lastCheck ? new Date(userData.lastCheck) : null;

            const isSameDay = lastCheck &&
                today.getFullYear() === lastCheck.getFullYear() &&
                today.getMonth() === lastCheck.getMonth() &&
                today.getDate() === lastCheck.getDate();

            console.log('날짜 변경 확인:', {
                today: today.toISOString(),
                lastCheck: userData.lastCheck,
                isSameDay,
                completedToday: userData.completedToday
            });

            if (lastCheck && !isSameDay) {
                // 날짜가 변경된 경우
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);

                const isLastCheckYesterday = lastCheck.getFullYear() === yesterday.getFullYear() &&
                    lastCheck.getMonth() === yesterday.getMonth() &&
                    lastCheck.getDate() === yesterday.getDate();

                console.log('날짜 변경 감지:', { isLastCheckYesterday });

                if (!isLastCheckYesterday) {
                    // 마지막 체크가 어제가 아니면 연속 기록 초기화
                    userData.streak = 0;
                    userData.startDate = null; // 시작일도 리셋
                    console.log('연속 기록이 끊겼습니다. 연속 일수를 초기화합니다.');
                }

                // completedToday 배열과 오늘의 포인트 초기화
                userData.completedToday = [];
                userData.breathingPoints = 0;

                // 모든 체크박스 활성화 및 상태 초기화
                document.querySelectorAll('.check-input').forEach(checkbox => {
                    checkbox.disabled = false;
                    checkbox.checked = false;
                    checkbox.removeAttribute('title');
                    checkbox.parentElement.classList.remove('completed');
                });

                // 변경된 데이터 저장
                if (currentUser && supabaseClient) {
                    await saveUserDataToSupabase();
                }

                // UI 업데이트
                updateUI();

                console.log('날짜 변경으로 completedToday 배열이 초기화되고 모든 체크박스가 활성화되었습니다.');
            } else {
                console.log('오늘 날짜이거나 첫 사용입니다. 체크리스트 상태를 유지합니다.');
            }
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', async function() {
            // 폼 이벤트 리스너 추가
            document.getElementById('loginFormElement')?.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('로그인 폼 제출됨');
                login();
            });

            document.getElementById('signupFormElement')?.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('회원가입 폼 제출됨');
                signup();
            });

            // Supabase 초기화
            const supabaseInitialized = await initializeSupabase();
            if (!supabaseInitialized) {
                console.error('Supabase 초기화에 실패했습니다. 인증 기능이 작동하지 않을 수 있습니다.');
            }

            // 인증 상태 변경 리스너 비활성화 - checkAuthState만으로 처리
            // onAuthStateChange 리스너는 페이지 새로고침 시 데이터 리셋 문제를 일으킴

            // 초기 인증 상태 확인
            await checkAuthState();

            // 최종 UI 업데이트 (데이터 저장 호출 없이 직접 업데이트)
            if (currentUser && supabaseClient) {
                // 로그인 상태: 현재 데이터로 UI 업데이트
                document.getElementById('streak').textContent = userData.streak;
                document.getElementById('level').textContent = userData.level;
                document.getElementById('points').textContent = userData.points;
                // document.getElementById('dailyPoints').textContent = '0'; // 요소 제거됨
                updateLevelProgress();
            } else {
                // 로그아웃 상태: 기본값으로 UI 업데이트
                document.getElementById('streak').textContent = '0';
                document.getElementById('level').textContent = '1';
                document.getElementById('points').textContent = '0';
                // document.getElementById('dailyPoints').textContent = '0'; // 요소 제거됨
                const progressBar = document.getElementById('progressBar');
                if (progressBar) progressBar.style.width = '0%';
            }

            // 일기 섹션 초기 UI 설정
            const diaryLoginPrompt = document.getElementById('diaryLoginPrompt');
            const diaryForm = document.getElementById('diaryForm');
            const recentDiarySection = document.getElementById('recentDiarySection');
            if (currentUser && supabaseClient) {
                diaryLoginPrompt.style.display = 'none';
                diaryForm.style.display = 'block';
                // 최근 감정 일기 섹션 표시
                if (recentDiarySection) recentDiarySection.style.display = 'block';
            } else {
                diaryLoginPrompt.style.display = 'block';
                diaryForm.style.display = 'none';
                // 최근 감정 일기 섹션 숨기기
                if (recentDiarySection) recentDiarySection.style.display = 'none';
            }

            // 체크리스트 섹션 초기 UI 설정
            const isLoggedIn = currentUser && supabaseClient;
            const checklistMessage = document.getElementById('checklistMessage');
            const checkboxes = document.querySelectorAll('.check-input');
            const emergencyBtn = document.querySelector('.emergency-btn');

            if (checklistMessage) {
                if (isLoggedIn) {
                    checklistMessage.style.display = 'none';
                } else {
                    checklistMessage.innerHTML = '🔒 체크리스트를 사용하려면 로그인이 필요합니다.<br>모든 데이터는 안전하게 데이터베이스에 저장됩니다.';
                    checklistMessage.style.display = 'block';
                }
            }

            checkboxes.forEach(checkbox => {
                checkbox.disabled = !isLoggedIn;
                if (!isLoggedIn) {
                    checkbox.checked = false;
                    checkbox.setAttribute('title', '로그인이 필요합니다');
                    checkbox.parentElement.classList.remove('completed');
                }
            });

            if (emergencyBtn) {
                emergencyBtn.disabled = !isLoggedIn;
            }
        });

        // 인증 상태 확인
        async function checkAuthState() {
            if (!supabaseClient || !supabaseClient.auth) {
                console.log('Supabase 클라이언트 또는 auth 모듈을 사용할 수 없음');
                return;
            }

            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();

                if (error) {
                    console.log('인증된 사용자 없음:', error.message);
                    return;
                }

                if (session && session.user) {
                    // 세션이 있으면 자동으로 데이터 로드 (새로고침 시 데이터 유지)
                    currentUser = session.user;
                    document.getElementById('userEmail').textContent = session.user.email;
                    document.getElementById('userSection').style.display = 'flex';
                    document.getElementById('loginSection').style.display = 'none';

                    try {
                        await loadUserData();
                        await loadDiaries();
                        updateUI();
                        console.log('세션 확인 및 데이터 자동 로드 완료:', session.user.email);
                    } catch (error) {
                        console.error('데이터 자동 로드 실패:', error);
                        // 데이터 로드 실패시에도 세션은 유지
                        showMessage('loginMessage', '데이터 로드에 실패했습니다. 다시 시도해주세요.', 'error');
                    }
                } else {
                    // 비로그인 상태인 경우 UI만 초기화 (데이터는 보존)
                    currentUser = null;
                    document.getElementById('userSection').style.display = 'none';
                    document.getElementById('loginSection').style.display = 'block';
                    console.log('비로그인 상태: UI 초기화됨');
                }
            } catch (error) {
                console.error('인증 상태 확인 오류:', error);
            }
        }
    </script>

<!--
개별 감정일기 삭제 기능 추가 - 2025-09-14

수정한 내용:
1. loadDiaries() 함수 (1095-1131번 라인): 일기 ID 저장 기능 추가
2. displayDiaries() 함수 (1887-1914번 라인): 개별 삭제 버튼 추가
3. deleteDiary(diaryId) 함수 (1916-1947번 라인): 개별 삭제 로직 구현
4. CSS 스타일 (222-239번 라인): 삭제 버튼 디자인 추가

원래대로 복구하는 방법:
1. 1116번 라인에서 "id: diary.id," 제거
2. 1903-1907번 라인 삭제 버튼 HTML 코드 제거
3. 1916-1947번 라인 deleteDiary 함수 전체 삭제
4. 222-239번 라인 .delete-btn CSS 스타일 전체 삭제
5. displayDiaries() 함수를 원래 형태로 복원:
   diaries.slice(0, 7).forEach(diary => {
       const diaryItem = document.createElement('div');
       diaryItem.className = 'diary-item';
       diaryItem.innerHTML = `
           <div style="font-size: 0.8rem; color: #666; margin-bottom: 5px;">📅 ${diary.date}</div>
           <div><strong>👥 타인:</strong> ${diary.otherPersonAction}</div>
           <div><strong>👨 나:</strong> ${diary.myReaction}</div>
           <div><strong>💡 재해석:</strong> <span style="color: var(--success);">${diary.reinterpretation}</span></div>
       `;
       diaryList.appendChild(diaryItem);
   });
-->
</body>
</html>