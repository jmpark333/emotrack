<!--
// ìˆ˜ì • ì •ë³´: 2025-09-14 20:16:05 KST
// ë°°í¬ë‚´ìš©: fix: ë¡œê·¸ì¸ ì‹œ ë„¤íŠ¸ì›Œí¬ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜ ìˆ˜ì •
// ì»¤ë°‹ID: ba6ab89
// ë³µêµ¬ ë°©ë²•: git revert ba6ab89
-->
<!DOCTYPE html>
<html>
<head>
    <title>ì •ì„œì  ë…ë¦½ íŠ¸ë˜ì»¤</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7?v=1.4.1"></script>
    <script>
        // Supabase SDK ë¡œë”© í™•ì¸
        console.log('Supabase SDK ë¡œë”© ìƒíƒœ:', typeof supabase);
        console.log('Supabase SDK ìƒì„¸ ì •ë³´:', supabase);

        // SDKê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
        function waitForSupabase(callback, maxAttempts = 50) {
            let attempts = 0;

            function check() {
                attempts++;
                console.log(`Supabase SDK í™•ì¸ ì‹œë„ ${attempts}/${maxAttempts}:`, typeof supabase);

                if (typeof supabase !== 'undefined') {
                    console.log('âœ… Supabase SDK ë¡œë“œ ì™„ë£Œ');
                    console.log('Supabase ë²„ì „:', supabase.version);
                    console.log('Supabase auth ê°ì²´:', supabase.auth);
                    console.log('Supabase createClient í•¨ìˆ˜:', typeof supabase.createClient);
                    callback();
                } else if (attempts < maxAttempts) {
                    setTimeout(check, 100);
                } else {
                    console.error('âŒ Supabase SDK ë¡œë“œ ì‹¤íŒ¨');
                }
            }

            check();
        }
    </script>
    <style>
        :root {
            --primary: #6C5CE7;
            --secondary: #A29BFE;
            --success: #00B894;
            --warning: #FDCB6E;
            --danger: #FF7675;
            --light: #DFE6E9;
            --dark: #2D3436;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            color: var(--dark);
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            color: var(--primary);
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        #datetime {
            background-color: var(--light);
            color: var(--dark);
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            margin-bottom: 10px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            flex: 1;
            margin: 0 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.6s, box-shadow 0.2s;
            transform-style: preserve-3d;
            position: relative;
            height: 120px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-card.flipped {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 15px;
            padding: 15px;
            box-sizing: border-box;
        }

        .card-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            padding: 10px;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .check-item {
            background: var(--light);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        .check-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .check-item.completed {
            background: rgba(0,184,148,0.1);
            border-left: 5px solid var(--success);
        }
        .check-input {
            margin-right: 10px;
            transform: scale(1.3);
        }
        .emergency-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            margin: 15px 0;
            transition: all 0.3s;
        }
        .emergency-btn:hover {
            background: #e84393;
            transform: scale(1.02);
        }
        .progress-bar {
            height: 8px;
            background: var(--light);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--warning));
            transition: width 0.5s;
        }
        .diary-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(108,92,231,0.1);
            border-radius: 15px;
        }
        .diary-input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 0.9rem;
        }
        .diary-label {
            display: block;
            font-size: 0.8rem;
            color: #666;
            margin-top: 10px;
            margin-bottom: 2px;
        }
        .diary-item {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            font-size: 0.85rem;
        }
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 5px 0;
        }
        .btn-danger {
            background: var(--danger);
        }

        .delete-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1rem;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
            opacity: 0.6;
        }

        .delete-btn:hover {
            background: var(--danger);
            color: white;
            opacity: 1;
            transform: scale(1.1);
        }
        .badge {
            display: inline-block;
            background: var(--warning);
            color: var(--dark);
            padding: 3px 10px;
            border-radius: 15px;
            margin: 3px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        /* ëª¨ë°”ì¼ ë·°ë¥¼ ìœ„í•œ ì¶”ê°€ ìŠ¤íƒ€ì¼ */
        body.mobile-view {
            padding: 10px;
        }
        
        body.mobile-view .container {
            padding: 15px;
        }
        
        body.mobile-view .header h1 {
            font-size: 1.5rem;
        }
        
        body.mobile-view .stat-card {
            padding: 12px 8px;
            margin: 0 3px;
        }
        
        body.mobile-view .stat-value {
            font-size: 1.2rem;
        }
        
        body.mobile-view .check-item {
            padding: 10px;
            margin-bottom: 6px;
        }
        
        body.mobile-view .check-input {
            transform: scale(1.2);
        }
        
        body.mobile-view .diary-input {
            font-size: 1rem;
            padding: 10px;
        }
        
        body.mobile-view .btn, body.mobile-view .emergency-btn {
            padding: 12px 15px;
            font-size: 1rem;
        }
        
        body.mobile-view .diary-item {
            font-size: 0.9rem;
            padding: 12px;
        }
        
        /* í™ˆ í™”ë©´ ì•„ì´ì½˜ ì¶”ê°€ë¥¼ ìœ„í•œ ë©”íƒ€ íƒœê·¸ */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #8B7CF6;
                --secondary: #A29BFE;
            }
        }

        /* ì¸ì¦ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .close {
            position: absolute;
            right: 15px;
            top: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .close:hover {
            color: #000;
        }

        #authTabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--light);
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: bold;
        }

        .auth-form {
            text-align: center;
        }

        .auth-form h2 {
            margin-bottom: 20px;
            color: var(--dark);
        }

        .auth-form input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .auth-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .auth-btn:hover {
            background: var(--secondary);
        }

        .auth-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .auth-message.success {
            background: var(--success);
            color: white;
        }

        .auth-message.error {
            background: var(--danger);
            color: white;
        }

        #userSection {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }

        #loginSection {
            text-align: center;
            margin-top: 10px;
        }
    </style>
    
    <!-- í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ê¸° ìœ„í•œ ì„¤ì • -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ì •ì„œì  ë…ë¦½ íŠ¸ë˜ì»¤">
    <meta name="mobile-web-app-capable" content="yes">
    </head>
<body>
    <div class="container">
        <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… ëª¨ë‹¬ -->
        <div id="authModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeAuthModal()">&times;</span>
                <div id="authTabs">
                    <button class="tab-btn active" onclick="switchTab('login')">ë¡œê·¸ì¸</button>
                    <button class="tab-btn" onclick="switchTab('signup')">íšŒì›ê°€ì…</button>
                </div>

                <!-- ë¡œê·¸ì¸ í¼ -->
                <div id="loginForm" class="auth-form">
                    <h2>ë¡œê·¸ì¸</h2>
                    <form id="loginFormElement">
                        <label for="loginEmail">ì´ë©”ì¼</label>
                        <input type="email" id="loginEmail" placeholder="ì´ë©”ì¼" required autocomplete="email">
                        <label for="loginPassword">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" required autocomplete="current-password">
                        <button type="submit" class="auth-btn">ë¡œê·¸ì¸</button>
                    </form>
                    <div id="loginMessage" class="auth-message"></div>
                </div>

                <!-- íšŒì›ê°€ì… í¼ -->
                <div id="signupForm" class="auth-form" style="display: none;">
                    <h2>íšŒì›ê°€ì…</h2>
                    <form id="signupFormElement">
                        <label for="signupEmail">ì´ë©”ì¼</label>
                        <input type="email" id="signupEmail" placeholder="ì´ë©”ì¼" required autocomplete="email">
                        <label for="signupPassword">ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label>
                        <input type="password" id="signupPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" required autocomplete="new-password">
                        <label for="signupConfirmPassword">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <input type="password" id="signupConfirmPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" required autocomplete="new-password">
                        <button type="submit" class="auth-btn">íšŒì›ê°€ì…</button>
                    </form>
                    <div id="signupMessage" class="auth-message"></div>
                </div>
            </div>
        </div>

        <div class="header">
            <h1>ğŸ§˜â€â™‚ï¸ ì •ì„œì  ë…ë¦½ íŠ¸ë˜ì»¤</h1>
            <p id="datetime"></p>
            <p id="randomQuote" style="font-weight: bold; font-size: 1rem; color: white; background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 12px; border-radius: 10px; margin-bottom: 15px; cursor: pointer;" onclick="displayRandomQuote()"></p>
            <p>í‰ì˜¨í•œ í•˜ë£¨ì˜ ì‹œì‘ì„ ì‘ì›í•©ë‹ˆë‹¤</p>
            <div id="userSection" style="display: none;">
                <span id="userEmail"></span>
                <button onclick="logout()" style="margin-left: 10px; padding: 5px 10px; background: var(--danger); color: white; border: none; border-radius: 5px; cursor: pointer;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <div id="loginSection">
                <button onclick="openAuthModal()" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">ë¡œê·¸ì¸/íšŒì›ê°€ì…</button>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card" id="attendanceCard" onclick="flipAttendanceCard()" title="í´ë¦­í•˜ì—¬ ì¶œì„ ì •ë³´ í™•ì¸">
                <div class="card-front">
                    <div class="stat-value" id="attendanceCount" style="margin-bottom: 8px;">0</div>
                    <div style="font-size: 0.9rem; margin-bottom: 8px;">ì¶œì„ ì¼ìˆ˜</div>
                    <button id="attendanceBtn" onclick="attend(event)" style="background: #00B894; color: white; border: none; padding: 6px 10px; border-radius: 5px; font-size: 0.7rem; cursor: pointer; transition: background 0.2s; margin-top: 5px;" onmouseover="this.style.background='#00a085'" onmouseout="this.style.background='#00B894'">
                        âœ… ì¶œì„í•˜ê¸°
                    </button>
                </div>
                <div class="card-back">
                    <div id="lastAttendanceDate" style="font-size: 1.0rem;">ë§ˆì§€ë§‰ ì¶œì„: ì—†ìŒ</div>
                </div>
            </div>
            <div class="stat-card" id="levelCard" onclick="flipLevelCard()" title="í´ë¦­í•˜ì—¬ ë ˆë²¨ ì§„í–‰ë„ í™•ì¸">
                <div class="card-front">
                    <div class="stat-value" id="level" style="margin-bottom: 5px;">1</div>
                    <div style="font-size: 0.9rem;">í‰ì˜¨ ë ˆë²¨</div>
                </div>
                <div class="card-back">
                    <div id="levelProgressDisplay" style="font-size: 1.0rem; font-weight: bold;">ë‹¤ìŒ ë ˆë²¨ê¹Œì§€: 100í¬ì¸íŠ¸</div>
                </div>
            </div>
            <div class="stat-card" id="pointsCard" onclick="flipPointsCard()" title="í´ë¦­í•˜ì—¬ í¬ì¸íŠ¸ ì •ë³´ í™•ì¸">
                <div class="card-front">
                    <div class="stat-value" id="points" style="margin-bottom: 5px;">0</div>
                    <div style="font-size: 0.9rem;">í‰ì˜¨ í¬ì¸íŠ¸</div>
                </div>
                <div class="card-back">
                    <div style="font-size: 1.0rem; font-weight: bold; margin-bottom: 10px;">ğŸ“ˆ í‰ì˜¨ í¬ì¸íŠ¸</div>
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.9);">
                        ì´ íšë“ í¬ì¸íŠ¸
                    </div>
                </div>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress" id="dailyProgress" style="width: 0%"></div>
        </div>
        
        <h3>ğŸŒ… ì•„ì¹¨ í›ˆë ¨</h3>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="morning1">
            <label for="morning1">ê°ì • ë¶„ë¦¬ ì„ ì–¸ ("ì˜¤ëŠ˜ íƒ€ì¸ì˜ ê°ì •ì€ ë‚˜ì˜ ê²ƒì´ ì•„ë‹˜" 3ë²ˆ)</label>
        </div>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="morning2">
            <label for="morning2">ì˜¤ëŠ˜ ì§€í‚¬ í•µì‹¬ ê°€ì¹˜ ì„ íƒ (í‰ì˜¨/ì¡´ì¤‘/ìì¡´ê°)</label>
        </div>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="morning3">
            <label for="morning3">ì˜¤ëŠ˜ì˜ 'ë‚˜ë§Œì˜ 30ë¶„' ê³„íš ì„¸ìš°ê¸°</label>
        </div>
        
        <h3>ğŸŒ ì ì‹¬ í›ˆë ¨</h3>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="noon1">
            <label for="noon1">ë¹„íŒì  ë§ ë“¤ì—ˆì„ ë•Œ "ì´ê±´ ì‚¬ì‹¤ì¸ê°€?" í•„í„°ë§</label>
        </div>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="noon2">
            <label for="noon2">"ì§€ê¸ˆì€ ì–´ë µë‹¤"ê³  ë§í•˜ê¸° (ì•„ë‹ˆì˜¤ ì—°ìŠµ)</label>
        </div>
        
        <h3>ğŸŒ™ ì €ë… í›ˆë ¨</h3>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="evening1">
            <label for="evening1">ê°ì • í­ë°œ ì‹œ 4-7-8 í˜¸í¡ë²• 3íšŒ</label>
        </div>
        
        <div class="check-item">
            <input type="checkbox" class="check-input" id="evening2">
            <label for="evening2">ğŸ“– ê°ì • ì¼ê¸° ì‘ì„±</label>
            <div id="diarySection" style="margin-top: 10px;">
                <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° í‘œì‹œë  ë©”ì‹œì§€ -->
                <div id="diaryLoginPrompt" style="color: #666; padding: 10px; background: #f5f5f5; border-radius: 5px; margin-bottom: 10px;">
                    ê°ì • ì¼ê¸°ë¥¼ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
                </div>
                <!-- ë¡œê·¸ì¸í•œ ê²½ìš° í‘œì‹œë  ì¼ê¸° ì…ë ¥ í¼ -->
                <div id="diaryForm" style="display: none;">
                    <label for="otherPersonAction" class="diary-label">íƒ€ì¸ì˜ í–‰ë™</label>
                    <input type="text" id="otherPersonAction" class="diary-input" placeholder="íƒ€ì¸ì˜ í–‰ë™ (ì˜ˆ: ê³ ì„± ì§ˆë¬¸)" aria-label="íƒ€ì¸ì˜ í–‰ë™">
                    <label for="myReaction" class="diary-label">ë‚´ ì²« ë°˜ì‘</label>
                    <input type="text" id="myReaction" class="diary-input" placeholder="ë‚´ ì²« ë°˜ì‘ (ì˜ˆ: ì£„ì±…ê° + ë¶„ë…¸)" aria-label="ë‚´ ì²« ë°˜ì‘">
                    <label for="reinterpretation" class="diary-label">ì¬í•´ì„</label>
                    <input type="text" id="reinterpretation" class="diary-input" placeholder="ì¬í•´ì„ (ì˜ˆ: ê·¸ë…€ëŠ” ë¶ˆì•ˆí•´ì„œ ê·¸ëŸ° ê±°ì•¼)" aria-label="ì¬í•´ì„">
                    <button class="btn" onclick="saveDiary()">ğŸ’¾ ì €ì¥í•˜ê³  ì²´í¬ ì™„ë£Œ</button>
                </div>
            </div>
        </div>
        
        <div class="check-item">
            <input type="checkbox" class="check-input" id="evening3">
            <label for="evening3">ì˜¤ëŠ˜ ë‚˜ë¥¼ ì§€í‚¨ í–‰ë™ 1ê°€ì§€ ì¹­ì°¬í•˜ê¸°</label>
        </div>
        
        <button class="emergency-btn" onclick="handleBreathing()">
            ğŸŒ¬ï¸ ëª…ìƒ í˜¸í¡ë²• ì‹œì‘ (4-7-8)
        </button>
        
        <div class="diary-section" id="recentDiarySection">
            <h3>ğŸ“š ìµœê·¼ ê°ì • ì¼ê¸°</h3>
            <div id="diaryList"></div>
            <button class="btn btn-danger" onclick="clearDiaries()">ğŸ—‘ï¸ ëª¨ë“  ì¼ê¸° ì‚­ì œ</button>
        </div>
        
        <div class="reward">
            <h3>ğŸ† ì§€ê¸ˆê¹Œì§€ íšë“í•œ ë³´ìƒ</h3>
            <div id="badges"></div>
            <p id="rewardText">ëª¨ë“  ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ì™„ë£Œí•˜ë©´ ë³´ìƒì´ ì—´ë¦½ë‹ˆë‹¤!</p>

            <!-- ë¦¬ì…‹ ë²„íŠ¼ ì¶”ê°€ -->
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="resetAllPointsAndLevels()" style="background: var(--danger); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">
                    ğŸ”„ ëª¨ë“  í¬ì¸íŠ¸ì™€ ë ˆë²¨ ë¦¬ì…‹
                </button>
            </div>
        </div>

        <!-- ì˜¤ëŠ˜ íšë“ í¬ì¸íŠ¸ ìƒì„¸ ì •ë³´ -->
        <div class="daily-points-summary" style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 10px; border: 2px solid #dee2e6;">
            <h4 style="margin: 0 0 15px 0; text-align: center; color: #495057; font-size: 1.1rem;">
                ğŸ“Š ì˜¤ëŠ˜ íšë“ í¬ì¸íŠ¸ ìš”ì•½
            </h4>
            <div style="display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div style="text-align: center; min-width: 120px;">
                    <div style="font-size: 1.5rem; margin-bottom: 5px;">ğŸ“‹</div>
                    <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">ì²´í¬ ì™„ë£Œ</div>
                    <div style="font-size: 1.3rem; font-weight: bold; color: #28a745;" id="checklistPoints">0</div>
                    <div style="font-size: 0.8rem; color: #6c757d;">í¬ì¸íŠ¸</div>
                </div>
                <div style="text-align: center; min-width: 120px;">
                    <div style="font-size: 1.5rem; margin-bottom: 5px;">ğŸ§˜</div>
                    <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">ëª…ìƒ í˜¸í¡ë²•</div>
                    <div style="font-size: 1.3rem; font-weight: bold; color: #17a2b8;" id="breathingPointsDisplay">0</div>
                    <div style="font-size: 0.8rem; color: #6c757d;">í¬ì¸íŠ¸</div>
                </div>
                <div style="text-align: center; min-width: 120px; background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 10px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);"
                   onclick="showPointHistory()"
                   onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 123, 255, 0.4)'"
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 123, 255, 0.3)'">
                    <div style="font-size: 1.8rem; margin-bottom: 5px;">ğŸ†</div>
                    <div style="font-size: 0.9rem; margin-bottom: 5px;">ì´ íšë“ í¬ì¸íŠ¸</div>
                    <div style="font-size: 1.5rem; font-weight: bold;" id="totalDailyPoints">0</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">í¬ì¸íŠ¸</div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 15px; font-size: 0.85rem; color: #6c757d;">
                <span id="dailyBreakdown">ì²´í¬ë¦¬ìŠ¤íŠ¸ 0ê°œ ì™„ë£Œ (0ì ) + ê¸´ê¸‰í˜¸í¡ë²• 0íšŒ ì™„ë£Œ (0ì ) = ì´ 0ì </span>
                <div style="margin-top: 5px; font-style: italic; opacity: 0.7;">
                    ğŸ’¡ ì´ íšë“ í¬ì¸íŠ¸ë¥¼ í´ë¦­í•˜ë©´ ìƒì„¸ ë‚´ì—­ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase í´ë¼ì´ì–¸íŠ¸ (ì „ì—­ ë³€ìˆ˜)
        let supabaseClient = null;
        let currentUser = null;

        // Netlify í™˜ê²½ ë³€ìˆ˜ì—ì„œ Supabase ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        async function getSupabaseConfig() {
            try {
                const response = await fetch('/.netlify/functions/get-supabase-config');
                if (!response.ok) {
                    throw new Error(`Netlify í•¨ìˆ˜ í˜¸ì¶œ ì‹¤íŒ¨: ${response.statusText}`);
                }
                const config = await response.json();
                console.log('Supabase ì„¤ì • ë¡œë“œ ì„±ê³µ:', config);
                return config;
            } catch (error) {
                console.error('Supabase ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì•± ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                return null;
            }
        }

        // Supabase ì´ˆê¸°í™” í•¨ìˆ˜
        async function initializeSupabase() {
            const config = await getSupabaseConfig();
            if (!config || !config.supabaseUrl || !config.supabaseAnonKey) {
                console.error('Supabase ì„¤ì •ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return false;
            }

            const supabaseUrl = config.supabaseUrl;
            const supabaseKey = config.supabaseAnonKey;

            return new Promise((resolve) => {
                waitForSupabase(() => {
                    try {
                        // Supabase v2 ì˜¬ë°”ë¥¸ ì´ˆê¸°í™” ë°©ì‹
                        const { createClient } = supabase;
                        supabaseClient = createClient(supabaseUrl, supabaseKey);

                        console.log('Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì„±ê³µ');
                        console.log('í´ë¼ì´ì–¸íŠ¸ íƒ€ì…:', typeof supabaseClient);
                        console.log('í´ë¼ì´ì–¸íŠ¸ ì „ì²´ êµ¬ì¡°:', Object.keys(supabaseClient));
                        console.log('from ë©”ì†Œë“œ ì¡´ì¬ ì—¬ë¶€:', 'from' in supabaseClient);
                        console.log('from ë©”ì†Œë“œ íƒ€ì…:', typeof supabaseClient.from);
                        console.log('í´ë¼ì´ì–¸íŠ¸ auth ê°ì²´:', supabaseClient.auth);
                        console.log('í´ë¼ì´ì–¸íŠ¸ auth íƒ€ì…:', typeof supabaseClient.auth);

                        resolve(true);
                    } catch (error) {
                        console.error('Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                        resolve(false);
                    }
                });
            });
        }

        // ë°ì´í„° ì´ˆê¸°í™” - ë°ì´í„°ë² ì´ìŠ¤ ì „ìš©
        let userData = {
            attendanceCount: 0,
            level: 1,
            points: 0,
            lastCheck: null,
            completedToday: [],
            totalPoints: 0,
            lastAttendanceDate: null,
            attendancePoints: 0,
            breathingPoints: 0, // breathing_pointsê°€ ì˜¤ëŠ˜ì˜ í˜¸í¡ë²• í¬ì¸íŠ¸ (ì¼ì¼ ì´ˆê¸°í™”)
            lastBreathingTime: null
        };

        let diaries = []; // ë°ì´í„°ë² ì´ìŠ¤ ì „ìš©

        // ================ ì¸ì¦ ê´€ë ¨ í•¨ìˆ˜ ================ 

        // ì¸ì¦ ëª¨ë‹¬ ì—´ê¸°
        function openAuthModal() {
            document.getElementById('authModal').style.display = 'block';
        }

        // ì¸ì¦ ëª¨ë‹¬ ë‹«ê¸°
        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            clearMessages();
        }

        // íƒ­ ì „í™˜
        function switchTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const tabBtns = document.querySelectorAll('.tab-btn');

            tabBtns.forEach(btn => btn.classList.remove('active'));

            if (tab === 'login') {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
                tabBtns[0].classList.add('active');
            } else {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
                tabBtns[1].classList.add('active');
            }

            clearMessages();
        }

        // ë©”ì‹œì§€ ì§€ìš°ê¸°
        function clearMessages() {
            document.getElementById('loginMessage').textContent = '';
            document.getElementById('loginMessage').className = 'auth-message';
            document.getElementById('signupMessage').textContent = '';
            document.getElementById('signupMessage').className = 'auth-message';
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `auth-message ${type}`;
        }

        // íšŒì›ê°€ì…
        async function signup() {
            if (!supabaseClient) {
                showMessage('signupMessage', 'Supabaseê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;

            if (!email || !password || !confirmPassword) {
                showMessage('signupMessage', 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('signupMessage', 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showMessage('signupMessage', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            try {
                console.log('ğŸ“ íšŒì›ê°€ì… ì‹œë„:', { email, passwordLength: password.length });

                // auth ê°ì²´ ë‹¤ì‹œ í™•ì¸
                if (!supabaseClient || !supabaseClient.auth) {
                    throw new Error('Supabase í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }

                console.log('auth ê°ì²´ ìƒíƒœ:', {
                    exists: !!supabaseClient.auth,
                    hasSignUp: typeof supabaseClient.auth.signUp === 'function',
                    signUpFunction: supabaseClient.auth.signUp
                });

                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password
                });

                console.log('ğŸ“‹ Supabase ì‘ë‹µ:', { data, error });

                if (error) {
                    console.error('âŒ Supabase íšŒì›ê°€ì… ì˜¤ë¥˜:', error);
                    showMessage('signupMessage', `ì˜¤ë¥˜: ${error.message}`, 'error');
                    return;
                }

                if (data && data.user && !data.user.email_confirmed_at) {
                    console.log('âœ… íšŒì›ê°€ì… ì„±ê³µ (ì´ë©”ì¼ í™•ì¸ í•„ìš”)');
                    showMessage('signupMessage', 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'success');
                } else if (data && data.user) {
                    console.log('âœ… íšŒì›ê°€ì… ì„±ê³µ (ì¦‰ì‹œ ë¡œê·¸ì¸)');
                    showMessage('signupMessage', 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } else {
                    console.log('âš ï¸ ì‘ë‹µ ë°ì´í„° ì—†ìŒ');
                    showMessage('signupMessage', 'íšŒì›ê°€ì…ì´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                }

                // 3ì´ˆ í›„ ë¡œê·¸ì¸ íƒ­ìœ¼ë¡œ ì „í™˜
                setTimeout(() => {
                    switchTab('login');
                    document.getElementById('loginEmail').value = email;
                }, 3000);

            } catch (error) {
                console.error('ğŸ’¥ íšŒì›ê°€ì… ì‹œìŠ¤í…œ ì˜¤ë¥˜:', error);
                showMessage('signupMessage', `ì‹œìŠ¤í…œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ë¡œê·¸ì¸
        async function login() {
            if (!supabaseClient) {
                showMessage('loginMessage', 'Supabaseê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showMessage('loginMessage', 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                console.log('ğŸ” ë¡œê·¸ì¸ ì‹œë„:', { email });

                // Supabase í´ë¼ì´ì–¸íŠ¸ ìƒíƒœ í™•ì¸
                console.log('ë¡œê·¸ì¸ ì „ í´ë¼ì´ì–¸íŠ¸ ìƒíƒœ:', {
                    supabaseClient: !!supabaseClient,
                    auth: !!supabaseClient?.auth,
                    signInWithPassword: typeof supabaseClient?.auth?.signInWithPassword
                });

                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                console.log('ë¡œê·¸ì¸ ì‘ë‹µ:', { data, error });

                if (error) {
                    showMessage('loginMessage', error.message, 'error');
                    return;
                }

                currentUser = data.user;

                // ë¡œê·¸ì¸ ì„±ê³µ - UI ì—…ë°ì´íŠ¸
                document.getElementById('userEmail').textContent = email;
                document.getElementById('userSection').style.display = 'flex';
                document.getElementById('loginSection').style.display = 'none';
                closeAuthModal();

                // ë¡œê·¸ì¸ ëª…ì–¸ íŒì—… í‘œì‹œ
                showLoginWisdomQuote();

                // ë°ì´í„° ë¡œë“œ (ë™ê¸°ì ìœ¼ë¡œ ì²˜ë¦¬ - ì‹¤íŒ¨ ì‹œ ë¡œê·¸ì•„ì›ƒ)
                try {
                    await loadUserData();
                    console.log('ë°ì´í„° ë¡œë“œ ì„±ê³µ');
                    updateUI();
                    await loadDiaries(); // ë¡œê·¸ì¸ í›„ ê°ì •ì¼ê¸° ë¡œë“œ
                    updateDiarySection(); // ì¼ê¸° ì„¹ì…˜ UI ì—…ë°ì´íŠ¸
                    updateChecklistSection(); // ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ UI ì—…ë°ì´íŠ¸
                } catch (loadError) {
                    console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', loadError);
                    alert('ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');

                    // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
                    currentUser = null;
                    document.getElementById('userSection').style.display = 'none';
                    document.getElementById('loginSection').style.display = 'block';
                    showMessage('loginMessage', 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ì„œë²„ ì—°ê²° ì˜¤ë¥˜', 'error');
                }

            } catch (error) {
                console.error('ğŸ’¥ ë¡œê·¸ì¸ ì‹œìŠ¤í…œ ì˜¤ë¥˜:', error);
                showMessage('loginMessage', `ì‹œìŠ¤í…œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ìƒˆ ì‚¬ìš©ì ë°ì´í„° ìƒì„±
        async function createNewUserData() {
            if (!currentUser || !supabaseClient) return;

            try {
                const newUserData = {
                    user_id: currentUser.id,
                    streak: 0, // attendance_count ëŒ€ì‹  streak ì‚¬ìš©
                    level: 1,
                    points: 0,
                    last_check: null,
                    completed_today: [],
                    total_points: 0,
                    start_date: null // last_attendance_date ëŒ€ì‹  start_date ì‚¬ìš©
                    // attendance_pointsì™€ breathing_points ì»¬ëŸ¼ì´ ì—†ìœ¼ë¯€ë¡œ ì œì™¸
                };

                const { data, error } = await supabaseClient
                    .from('user_data')
                    .insert([newUserData])
                    .select()
                    .single();

                if (error) {
                    console.error('ì‚¬ìš©ì ë°ì´í„° ìƒì„± ì˜¤ë¥˜:', error);
                    return;
                }

                console.log('ìƒˆ ì‚¬ìš©ì ë°ì´í„° ìƒì„± ì„±ê³µ:', data);

                // userData ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ì»¬ëŸ¼ë§Œ ì‚¬ìš©)
                userData = {
                    attendanceCount: data.streak || 0, // streakë¥¼ attendanceCountë¡œ ì‚¬ìš©
                    level: data.level || 1,
                    points: data.points || 0,
                    lastCheck: data.last_check,
                    completedToday: data.completed_today || [],
                    totalPoints: data.total_points || 0,
                    lastAttendanceDate: data.start_date, // start_dateë¥¼ lastAttendanceDateë¡œ ì‚¬ìš©
                    attendancePoints: 0, // attendance_points ì»¬ëŸ¼ì´ ì—†ìœ¼ë¯€ë¡œ 0ìœ¼ë¡œ ì´ˆê¸°í™”
                    breathingPoints: data.breathing_points || 0, // breathing_points ì»¬ëŸ¼ì—ì„œ ê°’ ë¡œë“œ
                    lastBreathingTime: data.last_breathing_time // í˜¸í¡ë²• ë§ˆì§€ë§‰ ì‹¤í–‰ ì‹œê°„ ë¡œë“œ
                };

                updateUI();
            } catch (error) {
                console.error('ì‚¬ìš©ì ë°ì´í„° ìƒì„± ì¤‘ ì˜ˆì™¸ ì˜¤ë¥˜:', error);
            }
        }

        // ë¡œê·¸ì•„ì›ƒ
        async function logout() {
            console.log('logout í•¨ìˆ˜ í˜¸ì¶œë¨');

            // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
            const logoutBtn = document.querySelector('button[onclick="logout()"]');
            if (logoutBtn) {
                logoutBtn.disabled = true;
                logoutBtn.textContent = 'ë¡œê·¸ì•„ì›ƒ ì¤‘...';
            }

            try {
                // Supabase ë¡œê·¸ì•„ì›ƒ ì‹œë„
                if (supabaseClient && supabaseClient.auth) {
                    await supabaseClient.auth.signOut();
                    console.log('Supabase signOut ì™„ë£Œ');
                }
            } catch (error) {
                console.error('Supabase ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
            } finally {
                // í•­ìƒ ë¡œì»¬ ë°ì´í„° ì´ˆê¸°í™”
                performLocalLogout();
            }
        }

        // ë¡œì»¬ ë¡œê·¸ì•„ì›ƒ ìˆ˜í–‰ í•¨ìˆ˜
        function performLocalLogout() {
            console.log('ë¡œì»¬ ë¡œê·¸ì•„ì›ƒ ìˆ˜í–‰ ì‹œì‘');

            // ë°ì´í„° ì´ˆê¸°í™”
            currentUser = null;
            userData = {
                attendanceCount: 0,
                level: 1,
                points: 0,
                lastCheck: null,
                completedToday: [],
                totalPoints: 0,
                lastAttendanceDate: null,
                attendancePoints: 0,
                breathingPoints: 0
            };
            diaries = [];

            // UI ì—…ë°ì´íŠ¸ (ë°ì´í„° ì €ì¥ í˜¸ì¶œ ì—†ì´ ì§ì ‘ ì—…ë°ì´íŠ¸)
            document.getElementById('userSection').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';

            // ì¼ê¸° ì„¹ì…˜ ì§ì ‘ ì—…ë°ì´íŠ¸
            const diaryLoginPrompt = document.getElementById('diaryLoginPrompt');
            const diaryForm = document.getElementById('diaryForm');
            const recentDiarySection = document.getElementById('recentDiarySection');
            if (diaryLoginPrompt) diaryLoginPrompt.style.display = 'block';
            if (diaryForm) diaryForm.style.display = 'none';
            // ìµœê·¼ ê°ì • ì¼ê¸° ì„¹ì…˜ë§Œ ìˆ¨ê¸°ê¸°
            if (recentDiarySection) recentDiarySection.style.display = 'none';

            // ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ ì§ì ‘ ì—…ë°ì´íŠ¸
            const checklistMessage = document.getElementById('checklistMessage');
            if (checklistMessage) {
                checklistMessage.innerHTML = 'ğŸ”’ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>ëª¨ë“  ë°ì´í„°ëŠ” ì•ˆì „í•˜ê²Œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë©ë‹ˆë‹¤.';
                checklistMessage.style.display = 'block';
            }

            // ëª¨ë“  ì²´í¬ë°•ìŠ¤ ì§ì ‘ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.check-input').forEach(checkbox => {
                checkbox.disabled = true;
                checkbox.checked = false;
                checkbox.setAttribute('title', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
                checkbox.parentElement.classList.remove('completed');
            });

            // í†µê³„ ì¹´ë“œ ì§ì ‘ ì´ˆê¸°í™”
            document.getElementById('attendanceCount').textContent = '0';
            document.getElementById('level').textContent = '1';
            document.getElementById('points').textContent = '0';
            // document.getElementById('dailyPoints').textContent = '0'; // ìš”ì†Œ ì œê±°ë¨
            const progressBar = document.getElementById('progressBar');
            if (progressBar) progressBar.style.width = '0%';

            // ì¼ê¸° ëª©ë¡ ì§ì ‘ ë¹„ìš°ê¸°
            const diariesList = document.getElementById('diariesList');
            if (diariesList) diariesList.innerHTML = '';

            // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ìƒíƒœ ë³µì›
            const logoutBtn = document.querySelector('button[onclick="logout()"]');
            if (logoutBtn) {
                logoutBtn.disabled = false;
                logoutBtn.textContent = 'ë¡œê·¸ì•„ì›ƒ';
            }

            console.log('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ - ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”ë¨');
            alert('ë¡œê·¸ì•„ì›ƒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

        // ì¼ê¸° ì„¹ì…˜ UI ì—…ë°ì´íŠ¸
        function updateDiarySection() {
            const loginPrompt = document.getElementById('diaryLoginPrompt');
            const diaryForm = document.getElementById('diaryForm');
            const recentDiarySection = document.getElementById('recentDiarySection');

            if (currentUser && supabaseClient) {
                loginPrompt.style.display = 'none';
                diaryForm.style.display = 'block';
                // ìµœê·¼ ê°ì • ì¼ê¸° ì„¹ì…˜ í‘œì‹œ
                if (recentDiarySection) recentDiarySection.style.display = 'block';
            } else {
                loginPrompt.style.display = 'block';
                diaryForm.style.display = 'none';
                // ìµœê·¼ ê°ì • ì¼ê¸° ì„¹ì…˜ ìˆ¨ê¸°ê¸°
                if (recentDiarySection) recentDiarySection.style.display = 'none';
            }
        }

        // ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ UI ì—…ë°ì´íŠ¸
        function updateChecklistSection() {
            const isLoggedIn = currentUser && supabaseClient;
            const checkboxes = document.querySelectorAll('.check-input');
            const emergencyBtn = document.querySelector('.emergency-btn');

            console.log('updateChecklistSection í˜¸ì¶œ:', {
                isLoggedIn,
                completedToday: userData.completedToday,
                checkboxCount: checkboxes.length
            });

            checkboxes.forEach(checkbox => {
                checkbox.disabled = !isLoggedIn;

                if (!isLoggedIn) {
                    checkbox.checked = false;
                } else {
                    // ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” completedToday ë°°ì—´ì— ìˆëŠ” í•­ëª©ë“¤ ì²´í¬
                    const checklistId = checkbox.id;
                    const isChecked = userData.completedToday && userData.completedToday.includes(checklistId);
                    checkbox.checked = isChecked;

                    console.log(`ì²´í¬ë°•ìŠ¤ ${checklistId}:`, {
                        checked: isChecked,
                        inCompletedToday: userData.completedToday.includes(checklistId)
                    });
                }
            });

            if (emergencyBtn) {
                emergencyBtn.disabled = !isLoggedIn;
            }

            // ë¹„ë¡œê·¸ì¸ ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
            let checklistMessage = document.getElementById('checklistMessage');
            if (!checklistMessage) {
                checklistMessage = document.createElement('div');
                checklistMessage.id = 'checklistMessage';
                checklistMessage.style.cssText = 'color: #666; padding: 15px; background: #f5f5f5; border-radius: 8px; margin-bottom: 20px; text-align: center;';

                const checklistContainer = document.querySelector('.checklist');
                if (checklistContainer) {
                    checklistContainer.parentNode.insertBefore(checklistMessage, checklistContainer);
                }
            }

            if (isLoggedIn) {
                checklistMessage.style.display = 'none';
            } else {
                checklistMessage.innerHTML = 'ğŸ”’ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>ëª¨ë“  ë°ì´í„°ëŠ” ì•ˆì „í•˜ê²Œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë©ë‹ˆë‹¤.';
                checklistMessage.style.display = 'block';
            }
        }

        // ì¼ê¸° ë°ì´í„° ë¡œë“œ (ë°ì´í„°ë² ì´ìŠ¤ ì „ìš©)
        async function loadDiaries() {
            if (!currentUser || !supabaseClient) {
                diaries = [];
                displayDiaries();
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('emotion_diaries')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('ì¼ê¸° ë¡œë“œ ì˜¤ë¥˜:', error);
                    diaries = [];
                } else {
                    // ë°ì´í„°ë² ì´ìŠ¤ í˜•ì‹ì„ ê¸°ì¡´ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (í•˜ìœ„ í˜¸í™˜ì„± ì§€ì›)
                    diaries = (data || []).map(diary => ({
                        id: diary.id, // ì¼ê¸° ID ì¶”ê°€
                        date: new Date(diary.created_at).toLocaleString(),
                        otherPersonAction: diary.other_person_action,
                        myReaction: diary.my_reaction,
                        reinterpretation: diary.reinterpretation
                    }));
                    console.log('ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë¡œë“œëœ ì¼ê¸°:', diaries.length, 'ê°œ');
                }

                displayDiaries();
            } catch (error) {
                console.error('ì¼ê¸° ë¡œë“œ ì‹œìŠ¤í…œ ì˜¤ë¥˜:', error);
                diaries = [];
                displayDiaries();
            }
        }

        // ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ
        async function loadUserData() {
            console.group('ğŸ“¥ ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ì‹œì‘');

            console.log('loadUserData í•¨ìˆ˜ í˜¸ì¶œ ì‹œì‘:', {
                currentUser: !!currentUser,
                userId: currentUser?.id,
                supabaseClient: !!supabaseClient
            });

            if (!currentUser || !supabaseClient) {
                // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° - ë°ì´í„° ì´ˆê¸°í™”ëŠ” checkAuthStateì—ì„œ ì²˜ë¦¬
                console.log('âŒ ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ìƒíƒœ - ë°ì´í„° ë¡œë“œ ì¤‘ë‹¨');
                console.groupEnd();
                return;
            }

            try {
                console.log('ğŸ” ì‚¬ìš©ì ë°ì´í„° ì¡°íšŒ ì‹œì‘:', {
                    userId: currentUser.id,
                    email: currentUser.email
                });
                console.log('ğŸ”§ Supabase í´ë¼ì´ì–¸íŠ¸ ìƒíƒœ:', {
                    supabaseClient: !!supabaseClient,
                    auth: !!supabaseClient?.auth,
                    from: typeof supabaseClient?.from
                });

                // ì¿¼ë¦¬ ì‹¤í–‰ ì „ ìƒì„¸ ë¡œê¹…
                console.log('ğŸ“‹ DB ì¿¼ë¦¬ ì‹¤í–‰ ì§ì „ - user_id:', currentUser.id);
                console.log('ğŸ“‹ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° í™•ì¸:', {
                    table: 'user_data',
                    userId: currentUser.id,
                    userIdType: typeof currentUser.id
                });

                const queryStartTime = Date.now();
                console.log('â±ï¸ ì¿¼ë¦¬ ì‹œì‘ ì‹œê°„:', queryStartTime);

                // ì¿¼ë¦¬ ìµœì í™”: ì¡´ì¬í•˜ëŠ” í•„ë“œë§Œ ì„ íƒ (ì»¬ëŸ¼ ëˆ„ë½ ë¬¸ì œ í•´ê²°)
                const optimizedQuery = supabaseClient
                    .from('user_data')
                    .select('streak, level, points, last_check, completed_today, total_points, start_date, breathing_points, last_breathing_time')
                    .eq('user_id', currentUser.id)
                    .single();

                // ê°„ë‹¨í•œ íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬ - ì¬ì‹œë„ ì—†ì´ ë°”ë¡œ ì‹¤íŒ¨ ì²˜ë¦¬
                let data, error;
                try {
                    console.log('ğŸš€ ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ì‹œì‘');

                    // íƒ€ì„ì•„ì›ƒ ë©”ì»¤ë‹ˆì¦˜
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => {
                            reject(new Error('Database query timeout after 10 seconds'));
                        }, 10000); // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
                    });

                    const result = await Promise.race([optimizedQuery, timeoutPromise]);
                    data = result.data;
                    error = result.error;

                    if (error) {
                        throw error;
                    }

                    console.log('âœ… ì¿¼ë¦¬ ì„±ê³µ');

                } catch (queryError) {
                    console.error('âŒ ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ì‹¤íŒ¨:', queryError);
                    if (queryError.message && queryError.message.includes('timeout')) {
                        error = { code: 'TIMEOUT', message: 'Database query timeout' };
                    } else {
                        error = queryError;
                    }
                    data = null;
                }

                const queryEndTime = Date.now();
                console.log('â±ï¸ ì¿¼ë¦¬ ì™„ë£Œ ì‹œê°„:', queryEndTime);
                console.log('â±ï¸ ì¿¼ë¦¬ ì†Œìš” ì‹œê°„:', queryEndTime - queryStartTime, 'ms');
                console.log('ğŸ“Š ë°ì´í„° ì¡°íšŒ ê²°ê³¼:', {
                    hasData: !!data,
                    error: error?.message || 'No error'
                });

                if (data) {
                    console.log('ğŸ“‹ ì¡°íšŒëœ ë°ì´í„° í•„ë“œ:', Object.keys(data));
                    console.log('ğŸ“‹ breathing_points í•„ë“œ:', data.breathing_points);
                    console.log('ğŸ“‹ completed_today í•„ë“œ:', data.completed_today);
                }

                if (error && error.code !== 'PGRST116') { // PGRST116: ë°ì´í„° ì—†ìŒ
                    console.error('âŒ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);

                    // ë°ì´í„°ë² ì´ìŠ¤ íƒ€ì„ì•„ì›ƒ ì—ëŸ¬ ì²˜ë¦¬
                    if (error.code === 'TIMEOUT') {
                        console.error('âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° íƒ€ì„ì•„ì›ƒ:', error);
                        alert('ì„œë²„ ì—°ê²°ì´ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');

                        // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
                        currentUser = null;
                        document.getElementById('userSection').style.display = 'none';
                        document.getElementById('loginSection').style.display = 'block';
                        closeAuthModal();
                        console.groupEnd();
                        return;
                    }

                    // 406 ì˜¤ë¥˜ì¸ ê²½ìš° ìƒˆ ì‚¬ìš©ì ë°ì´í„° ìƒì„±
                    if (error.code === '406') {
                        console.log('ğŸ†• ìƒˆ ì‚¬ìš©ì ë°ì´í„° ìƒì„±...');
                        await createNewUserData();
                    }
                    console.groupEnd();
                    return;
                }

                if (data) {
                    console.log('âœ… DBì—ì„œ ì‚¬ìš©ì ë°ì´í„° ë°œê²¬ - ì—…ë°ì´íŠ¸ ì‹œì‘');

                    // DBì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸ (ì™„ì „íˆ ë®ì–´ì“°ì§€ ì•ŠìŒ)
                    const dbCompletedToday = data.completed_today || [];
                    const today = new Date();
                    const dbLastCheck = data.last_check ? new Date(data.last_check) : null;

                    const formatter = new Intl.DateTimeFormat('en-CA', {
                        timeZone: 'Asia/Seoul',
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });

                    const isSameDay = dbLastCheck &&
                        formatter.format(today) === formatter.format(dbLastCheck);

                    console.log('ğŸ“… ë‚ ì§œ ë¹„êµ ë¶„ì„:', {
                        dbCompletedToday,
                        dbLastCheck: data.last_check,
                        today: today.toISOString(),
                        isSameDay,
                        todayDate: `${today.getFullYear()}-${today.getMonth()}-${today.getDate()}`,
                        dbDate: dbLastCheck ? `${dbLastCheck.getFullYear()}-${dbLastCheck.getMonth()}-${dbLastCheck.getDate()}` : 'null'
                    });

                    // ì˜¤ëŠ˜ ë‚ ì§œì˜ ë°ì´í„°ì¸ ê²½ìš°ì—ë§Œ completedToday ìœ ì§€
                    if (isSameDay) {
                        userData.completedToday = dbCompletedToday;
                        console.log('âœ… ì˜¤ëŠ˜ ë‚ ì§œì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒíƒœ ë³µì›:', dbCompletedToday);
                    } else {
                        // ë‚ ì§œê°€ ë‹¤ë¥¸ ê²½ìš° ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”
                        userData.completedToday = [];
                        console.log('ğŸ”„ ë‹¤ë¥¸ ë‚ ì§œì˜ ë°ì´í„°: ì²´í¬ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”');
                    }

                    // ë‹¤ë¥¸ í•„ë“œë“¤ì€ DB ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ í•„ë“œë§Œ ì‚¬ìš©)
                    userData.attendanceCount = data.streak || 0; // streak ì»¬ëŸ¼ì„ attendanceCountë¡œ ì‚¬ìš©
                    userData.level = data.level || 1;
                    userData.points = data.points || 0;
                    userData.lastCheck = data.last_check;
                    userData.totalPoints = data.total_points || 0;
                    userData.lastAttendanceDate = data.start_date; // start_dateê°€ ë§ˆì§€ë§‰ ì¶œì„ì¼
                    userData.attendancePoints = 0; // attendance_points ì»¬ëŸ¼ì´ ì—†ìœ¼ë¯€ë¡œ 0ìœ¼ë¡œ ì´ˆê¸°í™”
                    userData.breathingPoints = data.breathing_points || 0; // breathing_points ì»¬ëŸ¼ì—ì„œ ê°’ ë¡œë“œ
                    userData.lastBreathingTime = data.last_breathing_time; // í˜¸í¡ë²• ë§ˆì§€ë§‰ ì‹¤í–‰ ì‹œê°„ ë¡œë“œ
                    // ì¼ì¼ í˜¸í¡ë²• íšŸìˆ˜ì™€ ë‚ ì§œëŠ” í¬ì¸íŠ¸ ë‚´ì—­ í…Œì´ë¸”ì—ì„œ ì¡°íšŒí•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì´ˆê¸°í™”
                    userData.dailyBreathingCount = 0;
                    userData.lastBreathingDate = null;

                    console.log('âœ… DBì—ì„œ ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', {
                        attendanceCount: userData.attendanceCount,
                        points: userData.points,
                        level: userData.level,
                        totalPoints: userData.totalPoints,
                        completedToday: userData.completedToday,
                        breathingPoints: userData.breathingPoints
                    });

                } else {
                    console.log('ğŸ†• DBì— ë°ì´í„° ì—†ìŒ - ìƒˆ ì‚¬ìš©ì ë°ì´í„° ìƒì„± ì‹œì‘');
                    await saveUserData();
                }

                console.log('âœ… loadUserData ì™„ë£Œ - ìµœì¢… userData ìƒíƒœ:', {
                    attendanceCount: userData.attendanceCount,
                    level: userData.level,
                    points: userData.points,
                    totalPoints: userData.totalPoints,
                    completedToday: userData.completedToday
                });

            } catch (error) {
                console.error('âŒ ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                console.error('âŒ ì—ëŸ¬ ìŠ¤íƒ:', error.stack);
            }

            // ì˜¤ëŠ˜ íšë“ í¬ì¸íŠ¸ UI ì—…ë°ì´íŠ¸
            updateDailyPoints();

            // ì˜¤ëŠ˜ì˜ í˜¸í¡ë²• í¬ì¸íŠ¸ ìºì‹œ ì´ˆê¸°í™” ë° ì—…ë°ì´íŠ¸
            window.todaysBreathingPointsCache = undefined;
            updateTodaysBreathingPointsCache();

            // ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ UI ì—…ë°ì´íŠ¸
            updateChecklistSection();

            // ì¶œì„ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateAttendanceButton();

            console.groupEnd();
        }

    
        // loadUserDataì˜ ë³„ì¹­ í•¨ìˆ˜ (í˜¸í™˜ì„± ìœ ì§€)
        async function loadUserDataFromSupabase() {
            return await loadUserData();
        }

        // í¬ì¸íŠ¸ ë‚´ì—­ ì €ì¥ í•¨ìˆ˜
        async function savePointHistory(pointType, points, description = '') {
            console.log('ğŸ¯ í¬ì¸íŠ¸ ë‚´ì—­ ì €ì¥ ì‹œì‘:', {
                pointType,
                points,
                description,
                currentUser: !!currentUser,
                supabaseClient: !!supabaseClient
            });

            if (!currentUser || !supabaseClient) {
                console.log('âŒ í¬ì¸íŠ¸ ë‚´ì—­ ì €ì¥ ì¤‘ë‹¨: ë¡œê·¸ì¸ ë˜ëŠ” Supabase ë¯¸ì—°ê²°');
                return;
            }

            try {
                console.log('ğŸ“¤ point_history í…Œì´ë¸”ì— ë°ì´í„° ì‚½ì… ì‹œë„...');
                const { data, error } = await supabaseClient
                    .from('point_history')
                    .insert([{
                        user_id: currentUser.id,
                        point_type: pointType,
                        points: points,
                        description: description
                    }]);

                if (error) {
                    console.error('âŒ í¬ì¸íŠ¸ ë‚´ì—­ ì €ì¥ ì˜¤ë¥˜:', error);
                    console.error('ì˜¤ë¥˜ ìƒì„¸:', {
                        message: error.message,
                        code: error.code,
                        details: error.details,
                        hint: error.hint
                    });
                } else {
                    console.log(`âœ… í¬ì¸íŠ¸ ë‚´ì—­ ì €ì¥ ì„±ê³µ: ${pointType}, ${points}ì `);
                    console.log('ì €ì¥ëœ ë°ì´í„°:', data);
                }
            } catch (error) {
                console.error('âŒ í¬ì¸íŠ¸ ë‚´ì—­ ì €ì¥ ì˜ˆì™¸ ì˜¤ë¥˜:', error);
            }
        }

        // ì˜¤ëŠ˜ì˜ í˜¸í¡ë²• íšŸìˆ˜ ì¡°íšŒ í•¨ìˆ˜
        async function getTodayBreathingCount() {
            if (!currentUser || !supabaseClient) {
                return 0;
            }

            try {
                // ì˜¤ëŠ˜ì˜ ì‹œì‘ ì‹œê°„ (KST)
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayString = today.toISOString();

                // ì˜¤ëŠ˜ì˜ í˜¸í¡ë²• ê´€ë ¨ í¬ì¸íŠ¸ ë‚´ì—­ë§Œ ì¡°íšŒ
                const { data, error } = await supabaseClient
                    .from('point_history')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .gte('created_at', todayString)
                    .in('point_type', ['ë¡œê·¸ì¸ ëª…ìƒ í˜¸í¡ ì™„ë£Œ', 'ëª…ìƒ í˜¸í¡ ì™„ë£Œ']);

                if (error) {
                    console.error('ì˜¤ëŠ˜ì˜ í˜¸í¡ë²• íšŸìˆ˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
                    return 0;
                }

                return data?.length || 0;
            } catch (error) {
                console.error('ì˜¤ëŠ˜ì˜ í˜¸í¡ë²• íšŸìˆ˜ ì¡°íšŒ ì˜ˆì™¸ ì˜¤ë¥˜:', error);
                return 0;
            }
        }

        // í¬ì¸íŠ¸ ë‚´ì—­ ì¡°íšŒ í•¨ìˆ˜
        async function getPointHistory() {
            console.log('ğŸ” í¬ì¸íŠ¸ ë‚´ì—­ ì¡°íšŒ ì‹œì‘:', {
                currentUser: !!currentUser,
                supabaseClient: !!supabaseClient
            });

            if (!currentUser || !supabaseClient) {
                console.log('âŒ í¬ì¸íŠ¸ ë‚´ì—­ ì¡°íšŒ ì¤‘ë‹¨: ë¡œê·¸ì¸ ë˜ëŠ” Supabase ë¯¸ì—°ê²°');
                return [];
            }

            try {
                // ì˜¤ëŠ˜ì˜ ì‹œì‘ ì‹œê°„ (KST)
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayString = today.toISOString();

                console.log('ğŸ“… ì¡°íšŒ ì¡°ê±´:', {
                    userId: currentUser.id,
                    todayStart: todayString,
                    todayKST: today.toLocaleString('ko-KR')
                });

                console.log('ğŸ“¤ point_history í…Œì´ë¸” ì¡°íšŒ ì¿¼ë¦¬ ì‹¤í–‰...');
                const { data, error } = await supabaseClient
                    .from('point_history')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .gte('created_at', todayString)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('âŒ í¬ì¸íŠ¸ ë‚´ì—­ ì¡°íšŒ ì˜¤ë¥˜:', error);
                    console.error('ì˜¤ë¥˜ ìƒì„¸:', {
                        message: error.message,
                        code: error.code,
                        details: error.details,
                        hint: error.hint
                    });
                    return [];
                }

                console.log(`âœ… í¬ì¸íŠ¸ ë‚´ì—­ ì¡°íšŒ ì„±ê³µ: ${data?.length || 0}ê°œ í•­ëª©`);
                if (data && data.length > 0) {
                    console.log('ì¡°íšŒëœ ë‚´ì—­:', data);
                }

                return data || [];
            } catch (error) {
                console.error('âŒ í¬ì¸íŠ¸ ë‚´ì—­ ì¡°íšŒ ì˜ˆì™¸ ì˜¤ë¥˜:', error);
                return [];
            }
        }

        // í¬ì¸íŠ¸ ë‚´ì—­ íŒì—… í‘œì‹œ í•¨ìˆ˜
        async function showPointHistory() {
            if (!currentUser || !supabaseClient) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!');
                return;
            }

            // í¬ì¸íŠ¸ ë‚´ì—­ ì¡°íšŒ
            const history = await getPointHistory();

            // íŒì—… ëª¨ë‹¬ ìƒì„±
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 20000;
                display: flex;
                justify-content: center;
                align-items: center;
                animation: fadeIn 0.3s ease-out;
            `;

            // ë‚´ìš© ì»¨í…Œì´ë„ˆ
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 30px;
                max-width: 90vw;
                width: min(600px, 90vw);
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                animation: slideUp 0.3s ease-out;
            `;

            // í•œêµ­ì–´ íƒ€ì… ë³€í™˜ í•¨ìˆ˜
            function getKoreanType(type) {
                const typeMap = {
                    'ì¶œì„ì™„ë£Œ': 'ì¶œì„ì™„ë£Œ',
                    'ì²´í¬ë¦¬ìŠ¤íŠ¸ ì‹¤í–‰': 'ì²´í¬ë¦¬ìŠ¤íŠ¸ ì‹¤í–‰',
                    'ë¡œê·¸ì¸ ëª…ìƒ í˜¸í¡ ì™„ë£Œ': 'ë¡œê·¸ì¸ ëª…ìƒ í˜¸í¡ ì™„ë£Œ',
                    'ëª…ìƒ í˜¸í¡ ì™„ë£Œ': 'ëª…ìƒ í˜¸í¡ ì™„ë£Œ',
                    'ë ˆë²¨ì—…': 'ë ˆë²¨ì—…',
                    'ëª¨ë“  í›ˆë ¨ ì™„ë£Œ': 'ëª¨ë“  í›ˆë ¨ ì™„ë£Œ'
                };
                return typeMap[type] || type;
            }

            // ì‹œê°„ í¬ë§· í•¨ìˆ˜
            function formatTime(dateString) {
                const date = new Date(dateString);
                return date.toLocaleTimeString('ko-KR', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            }

            // ì´ì  ê³„ì‚°
            const totalPoints = history.reduce((sum, item) => sum + item.points, 0);

            let historyHTML = `
                <div style="text-align: center; margin-bottom: 25px;">
                    <h2 style="margin: 0 0 10px 0; color: #333; font-size: 1.5rem;">
                        ğŸ“Š ì˜¤ëŠ˜ì˜ í¬ì¸íŠ¸ ë‚´ì—­
                    </h2>
                    <div style="color: #666; font-size: 1.1rem;">
                        ì´ ${totalPoints}ì  íšë“
                    </div>
                </div>
            `;

            if (history.length === 0) {
                historyHTML += `
                    <div style="text-align: center; padding: 40px 20px; color: #999;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ“</div>
                        <div style="font-size: 1.1rem;">ì•„ì§ íšë“í•œ í¬ì¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                        <div style="font-size: 0.9rem; margin-top: 5px;">ì¶œì„ì´ë‚˜ í›ˆë ¨ì„ í†µí•´ í¬ì¸íŠ¸ë¥¼ íšë“í•´ ë³´ì„¸ìš”!</div>
                    </div>
                `;
            } else {
                historyHTML += `
                    <div style="border-top: 2px solid #f0f0f0; margin-bottom: 15px;"></div>
                `;

                history.forEach((item, index) => {
                    historyHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f0f0f0;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: #333; margin-bottom: 3px;">
                                    ${getKoreanType(item.point_type)}
                                </div>
                                <div style="font-size: 0.85rem; color: #666;">
                                    ${item.description || ''}
                                </div>
                                <div style="font-size: 0.8rem; color: #999;">
                                    ${formatTime(item.created_at)}
                                </div>
                            </div>
                            <div style="text-align: right; margin-left: 20px;">
                                <div style="font-size: 1.3rem; font-weight: bold; color: #4CAF50;">
                                    +${item.points}
                                </div>
                                <div style="font-size: 0.8rem; color: #666;">í¬ì¸íŠ¸</div>
                            </div>
                        </div>
                    `;
                });
            }

            historyHTML += `
                <div style="text-align: center; margin-top: 25px;">
                    <button id="closePointHistory" style="
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        color: white;
                        border: none;
                        padding: 12px 30px;
                        border-radius: 25px;
                        font-size: 1rem;
                        cursor: pointer;
                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                        transition: all 0.3s ease;
                    ">
                        ë‹«ê¸°
                    </button>
                </div>
            `;

            content.innerHTML = historyHTML;
            modal.appendChild(content);
            document.body.appendChild(modal);

            // ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ ì¶”ê°€
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideUp {
                    from { transform: translateY(50px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
                @keyframes fadeOut {
                    from { opacity: 1; }
                    to { opacity: 0; }
                }
                @keyframes slideDown {
                    from { transform: translateY(0); opacity: 1; }
                    to { transform: translateY(50px); opacity: 0; }
                }
            `;
            document.head.appendChild(style);

            // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
            document.getElementById('closePointHistory').addEventListener('click', () => {
                modal.style.animation = 'fadeOut 0.3s ease-out forwards';
                content.style.animation = 'slideDown 0.3s ease-out forwards';
                setTimeout(() => {
                    modal.remove();
                    style.remove();
                }, 300);
            });

            // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.getElementById('closePointHistory').click();
                }
            });
        }

        // ì‚¬ìš©ì ë°ì´í„° ì €ì¥ (Supabase) - ë°ì´í„°ë¥¼ ì¸ìë¡œ ë°›ì•„ ëª…ì‹œì ìœ¼ë¡œ ì €ì¥
        async function saveUserDataToSupabase(dataToSave) {
            if (!currentUser || !supabaseClient) {
                console.log('saveUserDataToSupabase: ë¡œê·¸ì¸í•˜ì§€ ì•ŠìŒ ë˜ëŠ” Supabase í´ë¼ì´ì–¸íŠ¸ ì—†ìŒ');
                return;
            }

            try {
                console.log('ë°ì´í„° ì €ì¥ ì‹œì‘:', dataToSave);

                const saveData = {
                    user_id: currentUser.id,
                    streak: dataToSave.attendanceCount,
                    level: dataToSave.level,
                    points: dataToSave.points,
                    last_check: dataToSave.lastCheck,
                    completed_today: dataToSave.completedToday,
                    total_points: dataToSave.totalPoints,
                    start_date: dataToSave.lastAttendanceDate,
                    breathing_points: dataToSave.breathingPoints || 0,
                    last_breathing_time: dataToSave.lastBreathingTime,
                    updated_at: new Date().toISOString()
                };

                const { data, error } = await supabaseClient
                    .from('user_data')
                    .upsert(saveData, { onConflict: 'user_id' });

                if (error) {
                    console.error('ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:', error);
                    // íƒ€ì„ì•„ì›ƒ ë“±ì˜ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¥¼ ëŒ€ë¹„í•´ ì—ëŸ¬ë¥¼ throw
                    throw error;
                } else {
                    console.log('ë°ì´í„° ì €ì¥ ì„±ê³µ');
                }

            } catch (error) {
                console.error('ì‚¬ìš©ì ë°ì´í„° ì €ì¥ ì¤‘ ì˜ˆì™¸ ë°œìƒ:', error);
                // í˜¸ì¶œí•œ ìª½ì—ì„œ ì—ëŸ¬ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ ë‹¤ì‹œ throw
                throw error;
            }
        }
        
        // ìŠ¤ë§ˆíŠ¸í° í™˜ê²½ ê°ì§€
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // ìŠ¤ë§ˆíŠ¸í°ì—ì„œì˜ ì‚¬ìš©ì„± ê°œì„ 
        if (isMobile) {
            document.body.classList.add('mobile-view');
        }

        // í™”ë©´ ì—…ë°ì´íŠ¸
        function updateUI() {
            // ì¶œì„ ì¼ìˆ˜ í‘œì‹œ (ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ë§Œ ì—…ë°ì´íŠ¸)
            if (userData.attendanceCount !== undefined) {
                document.getElementById('attendanceCount').textContent = userData.attendanceCount;
            }
            if (userData.level !== undefined) {
                document.getElementById('level').textContent = userData.level;
            }
            if (userData.points !== undefined) {
                document.getElementById('points').textContent = userData.points;
            }

            // ì¶œì„ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateAttendanceButton();

            // ë ˆë²¨ ì§„í–‰ë„ í‘œì‹œ ì—…ë°ì´íŠ¸
            updateLevelProgress();

            // ì˜¤ëŠ˜ íšë“ í¬ì¸íŠ¸ í‘œì‹œ
            updateDailyPoints();

            // ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒíƒœ ë³µì› (ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¤‘ë³µ ì¶”ê°€ ë°©ì§€)
            document.querySelectorAll('.check-input').forEach(checkbox => {
                const isChecked = userData.completedToday.includes(checkbox.id);
                checkbox.checked = isChecked;

                // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì„¤ì •
                if (!currentUser || !supabaseClient) {
                    // ë¹„ë¡œê·¸ì¸ ìƒíƒœ: ëª¨ë“  ì²´í¬ë°•ìŠ¤ ë¹„í™œì„±í™”
                    checkbox.disabled = true;
                    checkbox.checked = false;
                    checkbox.setAttribute('title', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
                    checkbox.parentElement.classList.remove('completed');
                } else {
                    // ë¡œê·¸ì¸ ìƒíƒœ: ì²´í¬ëœ í•­ëª©ë§Œ ë¹„í™œì„±í™”
                    if (isChecked) {
                        checkbox.disabled = true;
                        checkbox.setAttribute('title', 'ì˜¤ëŠ˜ì€ ë‹¤ì‹œ í•´ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                        checkbox.parentElement.classList.add('completed');
                    } else {
                        checkbox.disabled = false;
                        checkbox.removeAttribute('title');
                        checkbox.parentElement.classList.remove('completed');
                    }
                }

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆê°€ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì¶”ê°€
                if (!checkbox.hasAttribute('data-event-added')) {
                    checkbox.addEventListener('change', handleCheck);
                    checkbox.setAttribute('data-event-added', 'true');
                }
            });

            updateProgress();
            updateBadges();
            displayDiaries();
        }

        // ë ˆë²¨ì—… ì²´í¬ ë° ì²˜ë¦¬
        async function checkAndHandleLevelUp() {
            let leveledUp = false;
            // ì—¬ëŸ¬ ë ˆë²¨ì—…ì„ í•œ ë²ˆì— ì²˜ë¦¬í•˜ê¸° ìœ„í•´ while ë£¨í”„ ì‚¬ìš©
            while (userData.points >= userData.level * 100) {
                userData.level++;
                leveledUp = true;
                console.log('ğŸ‰ ë ˆë²¨ì—…! ìƒˆë¡œìš´ ë ˆë²¨:', userData.level);

                // ë ˆë²¨ì—… ë©”ì‹œì§€ë¥¼ setTimeoutìœ¼ë¡œ í‘œì‹œí•˜ì—¬ ëª…ì–¸ íŒì—…ê³¼ ê²¹ì¹˜ì§€ ì•Šë„ë¡ í•¨
                setTimeout(() => {
                    alert(`ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! í‰ì˜¨ ë ˆë²¨ ${userData.level}ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!`);
                }, 1000);

                // ë™ê¸°ë¶€ì—¬ ë©”ì‹œì§€ë„ ì•½ê°„ì˜ ë”œë ˆì´ë¥¼ ì£¼ê³  í‘œì‹œ
                setTimeout(() => {
                    showMotivationalMessage('levelUp');
                }, 3000);
            }

            if (leveledUp) {
                // ë ˆë²¨ì´ ë³€ê²½ëœ ê²½ìš°, UIë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
                document.getElementById('level').textContent = userData.level;
                await saveUserDataToSupabase(userData);
            }
            // í•­ìƒ ë ˆë²¨ ì§„í–‰ë„ UIë¥¼ ì—…ë°ì´íŠ¸
            updateLevelProgress();
        }

        // ì²´í¬ ì´ë²¤íŠ¸ ì²˜ë¦¬
        async function handleCheck(e) {
            if (!currentUser || !supabaseClient) {
                e.target.checked = false;
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!');
                return;
            }

            const id = e.target.id;
            const parent = e.target.parentElement;

            if (e.target.checked) {
                if (userData.completedToday.includes(id)) {
                    e.target.checked = false;
                    alert('â° ì˜¤ëŠ˜ì€ ì´ë¯¸ ì²´í¬í•œ í•­ëª©ì…ë‹ˆë‹¤.');
                    return;
                }

                // 1. Create a temporary updatedData object
                const updatedData = { ...userData };
                updatedData.completedToday = [...userData.completedToday, id]; // Add new item
                updatedData.points += 10;
                updatedData.totalPoints = (updatedData.totalPoints || 0) + 10;
                // KST ê¸°ì¤€ í˜„ì¬ ë‚ ì§œ ì €ì¥
                const now = new Date();
                const formatter = new Intl.DateTimeFormat('en-CA', {
                    timeZone: 'Asia/Seoul',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                updatedData.lastCheck = formatter.format(now); // Update last activity time

                try {
                    // 2. Save the explicit data object
                    await saveUserDataToSupabase(updatedData);

                    // 3. If successful, update the global state
                    Object.assign(userData, updatedData);

                    // Save point history
                    savePointHistory('ì²´í¬ë¦¬ìŠ¤íŠ¸ ì‹¤í–‰', 10, `ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì™„ë£Œ: ${id}`);

                    // UI updates
                    parent.classList.add('completed');
                    e.target.disabled = true;
                    e.target.setAttribute('title', 'ì˜¤ëŠ˜ì€ ë‹¤ì‹œ í•´ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    showMotivationalMessage('points');

                    // Final UI sync
                    await updateProgress();
                    updateBadges();
                    updateDailyPoints();
                    document.getElementById('points').textContent = userData.points;
                    await checkAndHandleLevelUp();

                } catch (error) {
                    console.error('ì²´í¬ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                    // Revert the checkbox state on failure
                    e.target.checked = false;
                    alert('ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }

            } else {
                // Prevent unchecking
                if (userData.completedToday.includes(id)) {
                    e.target.checked = true;
                    alert('â° í•œ ë²ˆ ì²´í¬í•œ í•­ëª©ì€ ì˜¤ëŠ˜ í•˜ë£¨ ë™ì•ˆ í•´ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            }
        }
        
        // ì‚¬ìš©ì ë°ì´í„° ì €ì¥ (ë°ì´í„°ë² ì´ìŠ¤ ì „ìš©)
        async function saveUserData() {
            console.log('saveUserData í˜¸ì¶œë¨:', {
                currentUser: !!currentUser,
                supabaseClient: !!supabaseClient,
                email: currentUser?.email
            });

            if (currentUser && supabaseClient) {
                console.log('Supabaseì— ë°ì´í„° ì €ì¥ ì‹œë„...');
                try {
                    await saveUserDataToSupabase(userData); // Pass the global userData object
                    console.log('Supabase ë°ì´í„° ì €ì¥ ì™„ë£Œ');
                } catch (saveError) {
                    console.error('Supabase ì €ì¥ ì‹¤íŒ¨:', saveError);
                    alert('ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            } else {
                console.log('ë¹„ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” ë°ì´í„°ë¥¼ ì €ì¥í•˜ì§€ ì•ŠìŒ');
            }
        }
        
      
        // ë ˆë²¨ ì§„í–‰ë„ ì—…ë°ì´íŠ¸
        function updateLevelProgress() {
            const pointsNeeded = userData.level * 100;
            const pointsRemaining = Math.max(0, pointsNeeded - userData.points);
            const progressPercentage = userData.points >= pointsNeeded ? 100 : (userData.points / pointsNeeded) * 100;

            // ì•ë©´ì—ì„œëŠ” ë ˆë²¨ ì§„í–‰ë„ í‘œì‹œ ì œê±° (ë’·ë©´ì—ì„œë§Œ í‘œì‹œ)
        }

        // ë ˆë²¨ ì§„í–‰ë„ ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateLevelProgressDisplay() {
            const pointsNeeded = userData.level * 100;
            const pointsRemaining = Math.max(0, pointsNeeded - userData.points);

            document.getElementById('levelProgressDisplay').textContent = `ë‹¤ìŒ ë ˆë²¨ê¹Œì§€: ${pointsRemaining}í¬ì¸íŠ¸`;
        }

        // ì˜¤ëŠ˜ íšë“ í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
        function updateDailyPoints() {
            const checklistPoints = userData.completedToday.length * 10;
            const breathingPoints = getTodaysBreathingPoints(); // ì˜¤ëŠ˜ì˜ í˜¸í¡ë²• í¬ì¸íŠ¸ë§Œ ê³„ì‚°
            const attendancePoints = checkIfAttendedToday() ? (userData.attendancePoints || 0) : 0;
            const totalDailyPoints = checklistPoints + breathingPoints + attendancePoints;

            // ê¸°ì¡´ ì˜¤ëŠ˜ íšë“ í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸ (ìš”ì†Œ ì œê±°ë¨)
            // document.getElementById('dailyPoints').textContent = totalDailyPoints;

            // ìƒì„¸ ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('checklistPoints').textContent = checklistPoints;
            document.getElementById('breathingPointsDisplay').textContent = breathingPoints;
            document.getElementById('totalDailyPoints').textContent = totalDailyPoints;

            // ì„¸ë¶€ ë‚´ìš© í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            const completedCount = userData.completedToday.length;
            const breathingCount = breathingPoints / 5; // í˜¸í¡ë²• ì™„ë£Œ íšŸìˆ˜ (5ì ë‹¹ 1íšŒ)
            const attendanceBonus = checkIfAttendedToday() ? (calculateAttendanceBonus()) : 0;
            document.getElementById('dailyBreakdown').textContent =
                `ì²´í¬ë¦¬ìŠ¤íŠ¸ ${completedCount}ê°œ ì™„ë£Œ (${checklistPoints}ì ) + ê¸´ê¸‰í˜¸í¡ë²• ${breathingCount}íšŒ ì™„ë£Œ (${breathingPoints}ì ) + ì¶œì„ ë³´ìƒ (${attendanceBonus}ì ) = ì´ ${totalDailyPoints}ì `;
        }

        // ê¸°ì¡´ ì—°ì†ì¼ìˆ˜ ì¹´ë“œ ë’¤ì§‘ê¸° í•¨ìˆ˜ëŠ” ì‚­ì œë¨ (ì¶œì„ ì¼ìˆ˜ ì¹´ë“œë¡œ ëŒ€ì²´)

        // í‰ì˜¨ë ˆë²¨ ì¹´ë“œ ë’¤ì§‘ê¸° í•¨ìˆ˜
        function flipLevelCard() {
            const card = document.getElementById('levelCard');
            card.classList.toggle('flipped');

            // ë’·ë©´ì´ ë³´ì¼ ë•Œ ë ˆë²¨ ì§„í–‰ë„ ì •ë³´ ì—…ë°ì´íŠ¸
            if (card.classList.contains('flipped')) {
                updateLevelProgressDisplay();
            }
        }

        // í‰ì˜¨í¬ì¸íŠ¸ ì¹´ë“œ ë’¤ì§‘ê¸° í•¨ìˆ˜
        function flipPointsCard() {
            const card = document.getElementById('pointsCard');
            card.classList.toggle('flipped');
        }

        // ì¶œì„ ì¼ìˆ˜ ì¹´ë“œ ë’¤ì§‘ê¸° í•¨ìˆ˜
        function flipAttendanceCard() {
            const card = document.getElementById('attendanceCard');
            card.classList.toggle('flipped');

            // ë’·ë©´ì´ ë³´ì¼ ë•Œ ì¶œì„ ì •ë³´ ì—…ë°ì´íŠ¸
            if (card.classList.contains('flipped')) {
                updateAttendanceDisplay();
            }
        }

        // ì¶œì„ ì •ë³´ í‘œì‹œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateAttendanceDisplay() {
            const lastAttendanceDate = document.getElementById('lastAttendanceDate');

            if (!lastAttendanceDate) return; // ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ

            if (userData.lastAttendanceDate) {
                const lastDate = new Date(userData.lastAttendanceDate);
                const formattedDate = lastDate.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                lastAttendanceDate.textContent = `ë§ˆì§€ë§‰ ì¶œì„: ${formattedDate}`;
            } else {
                lastAttendanceDate.textContent = 'ë§ˆì§€ë§‰ ì¶œì„: ì—†ìŒ';
            }
        }

        // ì˜¤ëŠ˜ì˜ í˜¸í¡ë²• í¬ì¸íŠ¸ ê³„ì‚° í•¨ìˆ˜
        function getTodaysBreathingPoints() {
            if (!currentUser || !supabaseClient) {
                return 0;
            }

            // ìºì‹œëœ ê°’ì´ ìˆìœ¼ë©´ ì‚¬ìš© (í˜¸í¡ë²• ì‹¤í–‰ ì‹œë§ˆë‹¤ ì—…ë°ì´íŠ¸ë¨)
            if (window.todaysBreathingPointsCache !== undefined) {
                return window.todaysBreathingPointsCache;
            }

            // ìºì‹œê°€ ì—†ìœ¼ë©´ 0 ë°˜í™˜ (í˜¸í¡ë²• ì‹¤í–‰ ì‹œ ì´ˆê¸°í™”ë¨)
            return 0;
        }

        // ì˜¤ëŠ˜ì˜ í˜¸í¡ë²• í¬ì¸íŠ¸ ìºì‹œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateTodaysBreathingPointsCache() {
            if (!currentUser || !supabaseClient) {
                return;
            }

            // ì˜¤ëŠ˜ì˜ ì‹œì‘ ì‹œê°„ (KST)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayString = today.toISOString();

            // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì˜¤ëŠ˜ì˜ í˜¸í¡ë²• í¬ì¸íŠ¸ ì¡°íšŒ
            supabaseClient
                .from('point_history')
                .select('points')
                .eq('user_id', currentUser.id)
                .gte('created_at', todayString)
                .in('point_type', ['ë¡œê·¸ì¸ ëª…ìƒ í˜¸í¡ ì™„ë£Œ', 'ëª…ìƒ í˜¸í¡ ì™„ë£Œ'])
                .then(({ data, error }) => {
                    if (error) {
                        console.error('ì˜¤ëŠ˜ì˜ í˜¸í¡ë²• í¬ì¸íŠ¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
                        window.todaysBreathingPointsCache = 0;
                    } else {
                        const todayPoints = data?.reduce((sum, record) => sum + record.points, 0) || 0;
                        window.todaysBreathingPointsCache = todayPoints;
                        console.log('ì˜¤ëŠ˜ì˜ í˜¸í¡ë²• í¬ì¸íŠ¸ ìºì‹œ ì—…ë°ì´íŠ¸:', todayPoints);

                        // UI ì—…ë°ì´íŠ¸
                        updateDailyPoints();
                    }
                })
                .catch(error => {
                    console.error('ì˜¤ëŠ˜ì˜ í˜¸í¡ë²• í¬ì¸íŠ¸ ì¡°íšŒ ì˜ˆì™¸ ì˜¤ë¥˜:', error);
                    window.todaysBreathingPointsCache = 0;
                });
        }

        // ë‚ ì§œ ë³€ê²½ ì‹œ ì˜¤ëŠ˜ì˜ í˜¸í¡ë²• í¬ì¸íŠ¸ ì´ˆê¸°í™” í•¨ìˆ˜
        function resetDailyBreathingPointsIfNeeded() {
            const now = new Date();

            const formatter = new Intl.DateTimeFormat('en-CA', {
                timeZone: 'Asia/Seoul',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });

            const todayKST = formatter.format(now);
            const isSameDay = userData.lastCheck && todayKST === userData.lastCheck;

            if (!isSameDay) {
                // ë‚ ì§œê°€ ë³€ê²½ëœ ê²½ìš°: ì˜¤ëŠ˜ì˜ í˜¸í¡ë²• í¬ì¸íŠ¸ ì´ˆê¸°í™”
                userData.breathingPoints = 0;
                // ë°ì´í„°ë² ì´ìŠ¤ì—ë„ ì¦‰ì‹œ ì €ì¥
                if (currentUser && supabaseClient) {
                    saveUserDataToSupabase();
                }
            }
        }

        // ì¶œì„ ë³´ìƒ ê³„ì‚° í•¨ìˆ˜
        function calculateAttendanceBonus() {
            return 10; // ê¸°ë³¸ 10ì 
        }

        // ì¶œì„ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateAttendanceButton() {
            const attendanceBtn = document.getElementById('attendanceBtn');
            if (!attendanceBtn) return;

            const isTodayAttended = checkIfAttendedToday();

            if (isTodayAttended) {
                attendanceBtn.textContent = 'âœ… ì¶œì„ ì™„ë£Œ';
                attendanceBtn.disabled = true;
                attendanceBtn.style.background = '#95a5a6';
                attendanceBtn.style.cursor = 'not-allowed';
            } else {
                attendanceBtn.textContent = 'âœ… ì¶œì„í•˜ê¸°';
                attendanceBtn.disabled = false;
                attendanceBtn.style.background = '#00B894';
                attendanceBtn.style.cursor = 'pointer';
            }
        }

        // ì˜¤ëŠ˜ ì¶œì„ ì—¬ë¶€ í™•ì¸ í•¨ìˆ˜
        function checkIfAttendedToday() {
            if (!userData.lastAttendanceDate) {
                return false;
            }

            const today = new Date();

            // 'en-CA' ë¡œì¼€ì¼ì€ 'YYYY-MM-DD' í˜•ì‹ì˜ ì¶œë ¥ì„ ì œê³µí•©ë‹ˆë‹¤.
            const formatter = new Intl.DateTimeFormat('en-CA', {
                timeZone: 'Asia/Seoul',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });

            const todayKST = formatter.format(today);

            console.log('ì˜¤ëŠ˜ ì¶œì„ í™•ì¸ (KST):', {
                lastAttendanceDate: userData.lastAttendanceDate,
                todayKST: todayKST,
                isSameDay: todayKST === userData.lastAttendanceDate
            });

            return todayKST === userData.lastAttendanceDate;
        }

        // ì¶œì„ ì²˜ë¦¬ í•¨ìˆ˜
        async function attend(event) {
            event.stopPropagation(); // ì¹´ë“œ ë’¤ì§‘ê¸° ì´ë²¤íŠ¸ ë°©ì§€

            if (!currentUser || !supabaseClient) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!');
                return;
            }

            if (checkIfAttendedToday()) {
                alert('ì˜¤ëŠ˜ì€ ì´ë¯¸ ì¶œì„í–ˆìŠµë‹ˆë‹¤!');
                return;
            }

            // KST ê¸°ì¤€ í˜„ì¬ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì €ì¥
            const today = new Date();
            const formatter = new Intl.DateTimeFormat('en-CA', {
                timeZone: 'Asia/Seoul',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            const todayKST = formatter.format(today);
            const bonus = calculateAttendanceBonus();

            // 1. Create a temporary updatedData object by cloning the current userData
            const updatedData = { ...userData };

            // 2. Apply all changes to the temporary object
            updatedData.attendanceCount += 1;
            updatedData.lastAttendanceDate = todayKST;
            updatedData.lastCheck = todayKST; // Also update last activity time
            updatedData.points += bonus;
            updatedData.totalPoints = (updatedData.totalPoints || 0) + bonus;
            updatedData.attendancePoints = (updatedData.attendancePoints || 0) + bonus;

            try {
                // 3. Save the explicit data object to the database
                await saveUserDataToSupabase(updatedData);

                // 4. If save is successful, update the global state
                Object.assign(userData, updatedData);

                // Save point history
                await savePointHistory('ì¶œì„ì™„ë£Œ', bonus, `${userData.attendanceCount}ì¼ì°¨ ì¶œì„ ë³´ë„ˆìŠ¤`);

                // UI updates and popups
                updateAttendanceButton();
                showWisdomQuote();
                setTimeout(() => {
                    alert(`âœ… ì¶œì„ ì™„ë£Œ!\nì¶œì„ ì¼ìˆ˜: ${userData.attendanceCount}ì¼\níšë“ í¬ì¸íŠ¸: ${bonus}ì `);
                }, 26000);
                setTimeout(() => {
                    showMotivationalMessage('attendance');
                }, 29000);

                // Final UI sync
                updateUI();
                updateAttendanceDisplay();
                updateDailyPoints();
                await checkAndHandleLevelUp();

            } catch (error) {
                console.error('ì¶œì„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                // No need for manual rollback as global userData was not modified
                let errorMessage = 'ì¶œì„ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                if (error.message && error.message.includes('timeout')) {
                    errorMessage = 'ì„œë²„ ì—°ê²°ì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                } else if (error.message && error.message.includes('network')) {
                    errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                }
                alert(errorMessage);
            }
        }

        // ê¸°ì¡´ ì—°ì† ì¼ìˆ˜ ê´€ë ¨ í•¨ìˆ˜ëŠ” ì‚­ì œë¨

        // ì§„í–‰ë„ ì—…ë°ì´íŠ¸
        async function updateProgress() {
            const total = document.querySelectorAll('.check-input').length;
            const completed = userData.completedToday.length;
            const percentage = (completed / total) * 100;
            document.getElementById('dailyProgress').style.width = percentage + '%';

            // ì—°ì† ì¼ìˆ˜ ê¸°ëŠ¥ì€ ì¶œì„ ì¼ìˆ˜ë¡œ ëŒ€ì²´ë¨
        }

        // ë±ƒì§€ ì—…ë°ì´íŠ¸
        function updateBadges() {
            const badgesContainer = document.getElementById('badges');
            badgesContainer.innerHTML = '';
            
            // ì¶œì„ ê´€ë ¨ ë°°ì§€
            if(userData.attendanceCount >= 1) {
                badgesContainer.innerHTML += '<span class="badge">ğŸŒ± ì²« ê±¸ìŒ</span>';
            }
            if(userData.attendanceCount >= 3) {
                badgesContainer.innerHTML += '<span class="badge">ğŸ”¥ 3ì¼ ì¶œì„</span>';
            }
            if(userData.attendanceCount >= 7) {
                badgesContainer.innerHTML += '<span class="badge">â­ ì¶œì„ ìˆ˜í˜¸ì</span>';
            }
            if(userData.attendanceCount >= 14) {
                badgesContainer.innerHTML += '<span class="badge">ğŸŒŸ 2ì£¼ ë‹¬ì„±</span>';
            }
            if(userData.attendanceCount >= 30) {
                badgesContainer.innerHTML += '<span class="badge">ğŸ‘‘ í•œ ë‹¬ ì •ë³µ</span>';
            }
            
            // ë ˆë²¨ ê´€ë ¨ ë°°ì§€
            if(userData.level >= 2) {
                badgesContainer.innerHTML += '<span class="badge">ğŸ“ˆ ì„±ì¥ ì¤‘</span>';
            }
            if(userData.level >= 3) {
                badgesContainer.innerHTML += '<span class="badge">ğŸ›¡ï¸ ì •ì‹ ì˜ ë°©íŒ¨</span>';
            }
            if(userData.level >= 5) {
                badgesContainer.innerHTML += '<span class="badge">âš¡ í‰ì˜¨ ë§ˆìŠ¤í„°</span>';
            }
            if(userData.level >= 10) {
                badgesContainer.innerHTML += '<span class="badge">ğŸ† ì „ì„¤ì˜ í‰ì˜¨</span>';
            }
            
            // í¬ì¸íŠ¸ ê´€ë ¨ ë°°ì§€
            if(userData.totalPoints >= 100) {
                badgesContainer.innerHTML += '<span class="badge">ğŸ’¯ 100ì  í´ëŸ½</span>';
            }
            if(userData.totalPoints >= 500) {
                badgesContainer.innerHTML += '<span class="badge">ğŸ’ 500ì  ì—˜ë¦¬íŠ¸</span>';
            }
            if(userData.totalPoints >= 1000) {
                badgesContainer.innerHTML += '<span class="badge">ğŸ‘‘ 1000ì  ì™•</span>';
            }
            
            // í˜¸í¡ë²• ê´€ë ¨ ë°°ì§€
            const breathingCount = userData.breathingPoints / 5; // 5ì ë‹¹ 1íšŒ
            if(breathingCount >= 1) {
                badgesContainer.innerHTML += '<span class="badge">ğŸ§˜ í˜¸í¡ ì‹œì‘</span>';
            }
            if(breathingCount >= 3) {
                badgesContainer.innerHTML += '<span class="badge">ğŸŒ¬ï¸ í˜¸í¡ì˜ ë‹¬ì¸</span>';
            }
            if(breathingCount >= 5) {
                badgesContainer.innerHTML += '<span class="badge">ğŸ•Šï¸ í‰ì˜¨ì˜ í˜¸í¡</span>';
            }
            
            // ë³´ìƒ ë©”ì‹œì§€
            const total = document.querySelectorAll('.check-input').length;
            const completed = userData.completedToday.length;
            if(completed === total) {
                document.getElementById('rewardText').innerHTML =
                    `ğŸ‰ ì™„ë£Œ! ì˜¤ëŠ˜ì˜ ë³´ìƒ: <strong>${getRandomReward()}</strong>`;
                showMotivationalMessage('allChecklists');
            }
        }

        // ëª…ì–¸ ë°°ì—´
        const wisdomQuotes = [
            "ë§ˆìŒì˜ í‰ì˜¨ì€ ë‚´ë©´ì—ì„œ ì˜¨ë‹¤. ë°–ì—ì„œ ì°¾ì§€ ë§ë¼.",
            "ê³¼ê±°ì— ë¨¸ë¬´ë¥´ì§€ ë§ê³ , ë¯¸ë˜ë¥¼ ê¿ˆê¾¸ì§€ë„ ë§ë¼. í˜„ì¬ì— ë§ˆìŒì„ ì§‘ì¤‘í•˜ë¼.",
            "ìš°ë¦¬ëŠ” ìš°ë¦¬ê°€ ìƒê°í•˜ëŠ” ë°”ê°€ ëœë‹¤.",
            "í–‰ë³µì— ì´ë¥´ëŠ” ê¸¸ì€ ì—†ë‹¤. í–‰ë³µ ê·¸ ìì²´ê°€ ê¸¸ì´ë‹¤.",
            "ì§„ì •í•œ í–‰ë³µì€ ë°–ì— ìˆëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ë‚´ë©´ì— ìˆë‹¤.",
            "ìì‹ ì„ ì •ë³µí•˜ëŠ” ê²ƒì´ ì²œ ë²ˆì˜ ì „íˆ¬ì—ì„œ ì´ê¸°ëŠ” ê²ƒë³´ë‹¤ ë” í° ê³¼ì—…ì´ë‹¤.",
            "ë¯¸ì›€ì€ ë¯¸ì›€ìœ¼ë¡œ ì—†ì–´ì§€ì§€ ì•ŠëŠ”ë‹¤. ì˜¤ì§ ì‚¬ë‘ìœ¼ë¡œë§Œ ì‚¬ë¼ì§„ë‹¤. ì´ê²ƒì´ ì˜ì›í•œ ë²•ì¹™ì´ë‹¤.",
            "ë§ˆìŒì˜ í‰ì •ì€ íƒ€ì¸ì„ ë°”ê¾¸ë ¤ í•˜ì§€ ì•ŠëŠ” ë°ì„œ ì˜¨ë‹¤.",
            "ë‹¹ì‹  ìì‹ ì´ ê°€ì¥ í° ìŠ¤ìŠ¹ì´ë‹¤.",
            "ê³ ìš”í•œ ë§ˆìŒì€ ì§€í˜œì˜ ê·¼ì›ì´ë‹¤.",
            "ë„ˆë¥¼ í™”ë‚˜ê²Œ í•  ìˆ˜ ìˆëŠ” ì‚¬ëŒì€ ëˆ„êµ¬ë“  ë„ˆì˜ ì£¼ì¸ì´ ëœë‹¤.",
            "ìŠ¤ìŠ¤ë¡œì˜ ì£¼ì¸ì´ ë˜ì§€ ì•ŠëŠ” ìëŠ” ììœ ë¡­ì§€ ëª»í•˜ë‹¤.",
            "ìš°ë¦¬ì—ê²Œ ì¼ì–´ë‚˜ëŠ” ì¼ì´ ì¤‘ìš”í•œ ê²ƒì´ ì•„ë‹ˆë¼, ê·¸ê²ƒì— ë°˜ì‘í•˜ëŠ” ë°©ì‹ì´ ì¤‘ìš”í•˜ë‹¤.",
            "ê³ í†µì€ ë‹¹ì‹ ì˜ ìƒê°ì´ ë§Œë“¤ì–´ë‚¸ ê²ƒì´ë‹¤.",
            "í˜„ëª…í•œ ì‚¬ëŒì€ ìê¸° ìì‹ ìœ¼ë¡œ ë§Œì¡±í•œë‹¤.",
            "ì¤‘ìš”í•œ ê²ƒì€ ë¬´ì—‡ì„ ê²¬ë””ëŠëƒê°€ ì•„ë‹ˆë¼, ì–´ë–»ê²Œ ê²¬ë””ëŠëƒë‹¤.",
            "ë•Œë¡œëŠ” ì‚¬ëŠ” ê²ƒ ìì²´ê°€ ìš©ê¸°ì˜ í–‰ìœ„ë‹¤.",
            "ìš°ë¦¬ëŠ” í˜„ì‹¤ì—ì„œë³´ë‹¤ ìƒìƒì—ì„œ ë” ìì£¼ ê³ í†µë°›ëŠ”ë‹¤.",
            "ì¸ìƒì€ ê¸¸ë‹¤, ë‹¹ì‹ ì´ ì–´ë–»ê²Œ ì“°ëŠëƒë¥¼ ì•ˆë‹¤ë©´.",
            "ë‹¹ì‹ ì„ ê´´ë¡­íˆëŠ” ê²ƒë“¤ì—ì„œ ë„ë§ì¹˜ê³  ì‹¶ë‹¤ë©´, ë‹¤ë¥¸ ì¥ì†Œì— ê°€ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ë‹¤ë¥¸ ì‚¬ëŒì´ ë˜ì–´ì•¼ í•œë‹¤."
        ];

        // ëœë¤ ëª…ì–¸ í‘œì‹œ í•¨ìˆ˜
        function displayRandomQuote() {
            const randomQuoteElement = document.getElementById('randomQuote');
            if (randomQuoteElement) {
                const randomQuote = wisdomQuotes[Math.floor(Math.random() * wisdomQuotes.length)];
                randomQuoteElement.textContent = `"${randomQuote}"`;
            }
        }

        // ëª…ì–¸ íŒì—…ìš© í˜¸í¡ë²• íƒ€ì´ë¨¸ í•¨ìˆ˜
        function startWisdomBreathing() {
            const phases = [
                { name: 'ì¤€ë¹„', duration: 3, color: '#87CEEB' },
                { name: 'ë“¤ì´ë§ˆì‹œê¸°', duration: 4, color: '#4169E1' },
                { name: 'ì°¸ê¸°', duration: 7, color: '#FFD700' },
                { name: 'ë‚´ì‰¬ê¸°', duration: 8, color: '#32CD32' }
            ];

            let currentPhase = 0;
            let countdownInterval;
            let isBreathingCompleted = false;

            // íƒ€ì´ë¨¸ ì°¸ì¡° ì €ì¥
            window.wisdomBreathingInterval = null;

            function startPhase(phaseIndex) {
                const phase = phases[phaseIndex];
                const phaseElement = document.getElementById('breathingPhase');
                const countdownElement = document.getElementById('breathingCountdown');
                const progressElement = document.getElementById('breathingProgressBar');

                if (!phaseElement || !countdownElement || !progressElement) return;

                // í˜„ì¬ ë‹¨ê³„ ì„¤ì •
                phaseElement.textContent = phase.name;
                countdownElement.style.color = phase.color;
                countdownElement.textContent = phase.duration;

                // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì´ˆê¸°í™”
                progressElement.style.width = '0%';
                progressElement.style.background = phase.color;

                let timeLeft = phase.duration;
                const totalDuration = phase.duration;

                // ì¹´ìš´íŠ¸ë‹¤ìš´ íƒ€ì´ë¨¸
                countdownInterval = setInterval(() => {
                    timeLeft--;
                    countdownElement.textContent = timeLeft;

                    // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸
                    const progress = ((totalDuration - timeLeft) / totalDuration) * 100;
                    progressElement.style.width = progress + '%';

                    if (timeLeft <= 0) {
                        clearInterval(countdownInterval);
                        currentPhase++;

                        if (currentPhase < phases.length) {
                            // ë‹¤ìŒ ë‹¨ê³„ ì‹œì‘
                            setTimeout(() => startPhase(currentPhase), 500);
                        } else {
                            // ëª¨ë“  ë‹¨ê³„ ì™„ë£Œ
                            phaseElement.textContent = 'ì™„ë£Œ!';
                            countdownElement.textContent = 'âœ…';
                            progressElement.style.width = '100%';
                            progressElement.style.background = '#32CD32';

                            // í˜¸í¡ë²• ì™„ë£Œ ì²˜ë¦¬
                            if (!isBreathingCompleted) {
                                isBreathingCompleted = true;
                                handleBreathingComplete('wisdom');
                            }
                        }
                    }
                }, 1000);

                // íƒ€ì´ë¨¸ ì°¸ì¡° ì €ì¥
                window.wisdomBreathingInterval = countdownInterval;
            }

            // ì²« ë‹¨ê³„ ì‹œì‘
            startPhase(0);
        }

        // ëª…ì–¸ íŒì—… í‘œì‹œ í•¨ìˆ˜
        function showWisdomQuote() {
            const randomQuote = wisdomQuotes[Math.floor(Math.random() * wisdomQuotes.length)];

            // ëª…ì–¸ íŒì—… ëª¨ë‹¬ ìƒì„±
            const wisdomModal = document.createElement('div');
            wisdomModal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 15px 35px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
                font-size: 1.2rem;
                max-width: 90vw;
                width: min(520px, 90vw);
                line-height: 1.5;
                animation: wisdomSlideIn 0.6s ease-out;
            `;

            // ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
            const style = document.createElement('style');
            style.textContent = `
                @keyframes wisdomSlideIn {
                    0% { transform: translate(-50%, -50%) scale(0.3); opacity: 0; }
                    60% { transform: translate(-50%, -50%) scale(1.05); }
                    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                }
                @keyframes wisdomSlideOut {
                    0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                    100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
                }
            `;
            document.head.appendChild(style);

            wisdomModal.innerHTML = `
                <div style="position: absolute; top: 10px; right: 10px;">
                    <button onclick="closeWisdomPopup()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; opacity: 0.7; transition: opacity 0.3s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">Ã—</button>
                </div>
                <div style="margin-bottom: 15px; font-size: 1.4rem;">ğŸ“œ ì˜¤ëŠ˜ì˜ ì§€í˜œ</div>
                <div style="font-style: italic; margin-bottom: 15px; line-height: 1.6;">"${randomQuote}"</div>
                <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 20px;">ì´ ëª…ì–¸ì´ ë‹¹ì‹ ì˜ í•˜ë£¨ë¥¼ ë°í˜€ì£¼ê¸¸</div>

                <!-- í˜¸í¡ë²• íƒ€ì´ë¨¸ ì˜ì—­ -->
                <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin-top: 10px;">
                    <div style="font-size: 1.1rem; margin-bottom: 10px;">ğŸŒ¬ï¸ ëª…ìƒ í˜¸í¡ë²•</div>
                    <div id="breathingPhase" style="font-size: 1rem; margin-bottom: 8px; font-weight: bold;">ì¤€ë¹„ ì¤‘...</div>
                    <div id="breathingCountdown" style="font-size: 2rem; font-weight: bold; color: #FFD700;">3</div>
                    <div id="breathingProgress" style="width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin-top: 8px; overflow: hidden;">
                        <div id="breathingProgressBar" style="width: 0%; height: 100%; background: #FFD700; transition: width 0.1s linear;"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(wisdomModal);

            // í˜¸í¡ë²• ì‹œì‘
            startWisdomBreathing();

            // íƒ€ì´ë¨¸ ID ì €ì¥
            window.wisdomModalTimer = setTimeout(() => {
                wisdomModal.style.animation = 'wisdomSlideOut 0.5s ease-in forwards';
                setTimeout(() => {
                    wisdomModal.remove();
                    style.remove();
                }, 500);
            }, 25000);

            // íŒì—… ì°¸ì¡° ì €ì¥
            window.wisdomModalRef = wisdomModal;
            window.wisdomModalStyleRef = style;
        }

        // ë¡œê·¸ì¸ ëª…ì–¸ íŒì—… í‘œì‹œ í•¨ìˆ˜
        function showLoginWisdomQuote() {
            const randomQuote = wisdomQuotes[Math.floor(Math.random() * wisdomQuotes.length)];

            // ë¡œê·¸ì¸ ëª…ì–¸ íŒì—… ëª¨ë‹¬ ìƒì„±
            const loginWisdomModal = document.createElement('div');
            loginWisdomModal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 15px 35px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
                font-size: 1.2rem;
                max-width: 90vw;
                width: min(520px, 90vw);
                line-height: 1.5;
                animation: wisdomSlideIn 0.6s ease-out;
            `;

            // ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€ (ì´ë¯¸ ìˆë‹¤ë©´ ì¬ì‚¬ìš©)
            if (!document.querySelector('style[data-wisdom-animations]')) {
                const style = document.createElement('style');
                style.setAttribute('data-wisdom-animations', 'true');
                style.textContent = `
                    @keyframes wisdomSlideIn {
                        0% { transform: translate(-50%, -50%) scale(0.3); opacity: 0; }
                        60% { transform: translate(-50%, -50%) scale(1.05); }
                        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                    }
                    @keyframes wisdomSlideOut {
                        0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                        100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }

            loginWisdomModal.innerHTML = `
                <div style="position: absolute; top: 10px; right: 10px;">
                    <button onclick="closeLoginWisdomPopup()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; opacity: 0.7; transition: opacity 0.3s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">Ã—</button>
                </div>
                <div style="margin-bottom: 15px; font-size: 1.4rem;">ğŸŒŸ í™˜ì˜í•©ë‹ˆë‹¤!</div>
                <div style="font-style: italic; margin-bottom: 15px; line-height: 1.6;">"${randomQuote}"</div>
                <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 20px;">í‰ì˜¨í•œ í•˜ë£¨ì˜ ì‹œì‘ì„ ì‘ì›í•©ë‹ˆë‹¤</div>

                <!-- í˜¸í¡ë²• íƒ€ì´ë¨¸ ì˜ì—­ -->
                <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin-top: 10px;">
                    <div style="font-size: 1.1rem; margin-bottom: 10px;">ğŸŒ¬ï¸ ëª…ìƒ í˜¸í¡ë²•</div>
                    <div id="loginBreathingPhase" style="font-size: 1rem; margin-bottom: 8px; font-weight: bold;">ì¤€ë¹„ ì¤‘...</div>
                    <div id="loginBreathingCountdown" style="font-size: 2rem; font-weight: bold; color: #FFD700;">3</div>
                    <div id="loginBreathingProgress" style="width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin-top: 8px; overflow: hidden;">
                        <div id="loginBreathingProgressBar" style="width: 0%; height: 100%; background: #FFD700; transition: width 0.1s linear;"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(loginWisdomModal);

            // ë¡œê·¸ì¸ìš© í˜¸í¡ë²• ì‹œì‘
            startLoginBreathing();

            // íƒ€ì´ë¨¸ ID ì €ì¥
            window.loginWisdomModalTimer = setTimeout(() => {
                loginWisdomModal.style.animation = 'wisdomSlideOut 0.5s ease-in forwards';
                setTimeout(() => {
                    loginWisdomModal.remove();
                }, 500);
            }, 25000);

            // íŒì—… ì°¸ì¡° ì €ì¥
            window.loginWisdomModalRef = loginWisdomModal;
        }

        // ë¡œê·¸ì¸ ëª…ì–¸ íŒì—…ìš© í˜¸í¡ë²• íƒ€ì´ë¨¸ í•¨ìˆ˜
        function startLoginBreathing() {
            const phases = [
                { name: 'ì¤€ë¹„', duration: 3, color: '#87CEEB' },
                { name: 'ë“¤ì´ë§ˆì‹œê¸°', duration: 4, color: '#4169E1' },
                { name: 'ì°¸ê¸°', duration: 7, color: '#FFD700' },
                { name: 'ë‚´ì‰¬ê¸°', duration: 8, color: '#32CD32' }
            ];

            let currentPhase = 0;
            let countdownInterval;
            let isBreathingCompleted = false;

            // íƒ€ì´ë¨¸ ì°¸ì¡° ì €ì¥
            window.loginBreathingInterval = null;

            function startPhase(phaseIndex) {
                const phase = phases[phaseIndex];
                const phaseElement = document.getElementById('loginBreathingPhase');
                const countdownElement = document.getElementById('loginBreathingCountdown');
                const progressElement = document.getElementById('loginBreathingProgressBar');

                if (!phaseElement || !countdownElement || !progressElement) return;

                // í˜„ì¬ ë‹¨ê³„ ì„¤ì •
                phaseElement.textContent = phase.name;
                countdownElement.style.color = phase.color;
                countdownElement.textContent = phase.duration;

                // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì´ˆê¸°í™”
                progressElement.style.width = '0%';
                progressElement.style.background = phase.color;

                let timeLeft = phase.duration;
                const totalDuration = phase.duration;

                // ì¹´ìš´íŠ¸ë‹¤ìš´ íƒ€ì´ë¨¸
                countdownInterval = setInterval(() => {
                    timeLeft--;
                    countdownElement.textContent = timeLeft;

                    // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸
                    const progress = ((totalDuration - timeLeft) / totalDuration) * 100;
                    progressElement.style.width = progress + '%';

                    if (timeLeft <= 0) {
                        clearInterval(countdownInterval);
                        currentPhase++;

                        if (currentPhase < phases.length) {
                            // ë‹¤ìŒ ë‹¨ê³„ ì‹œì‘
                            setTimeout(() => startPhase(currentPhase), 500);
                        } else {
                            // ëª¨ë“  ë‹¨ê³„ ì™„ë£Œ
                            phaseElement.textContent = 'ì™„ë£Œ!';
                            countdownElement.textContent = 'âœ…';
                            progressElement.style.width = '100%';
                            progressElement.style.background = '#32CD32';

                            // í˜¸í¡ë²• ì™„ë£Œ ì²˜ë¦¬
                            if (!isBreathingCompleted) {
                                isBreathingCompleted = true;
                                handleBreathingComplete('login');
                            }
                        }
                    }
                }, 1000);

                // íƒ€ì´ë¨¸ ì°¸ì¡° ì €ì¥
                window.loginBreathingInterval = countdownInterval;
            }

            // ì²« ë‹¨ê³„ ì‹œì‘
            startPhase(0);
        }

        // í˜¸í¡ë²• ì™„ë£Œ ì²˜ë¦¬ í•¨ìˆ˜
        async function handleBreathingComplete(type) {
            // ë¹„ë¡œê·¸ì¸ ìƒíƒœì´ë©´ íŒ¨ìŠ¤
            if (!currentUser) {
                return;
            }

            const today = new Date().toDateString();
            const lastBreathingDate = userData.lastBreathingDate ? new Date(userData.lastBreathingDate).toDateString() : null;

            try {
                // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì˜¤ëŠ˜ì˜ ì‹¤ì œ í˜¸í¡ë²• íšŸìˆ˜ ì¡°íšŒ
                const currentCount = await getTodayBreathingCount();
                const todayBreathingCount = currentCount + 1; // ì´ë²ˆ í˜¸í¡ë²• í¬í•¨

                userData.dailyBreathingCount = todayBreathingCount;
                userData.lastBreathingDate = new Date().toISOString();

                // íšŸìˆ˜ë³„ í¬ì¸íŠ¸ ë° ë©”ì‹œì§€ ê³„ì‚°
                let breathingBonus = 0;
                let motivationMessage = '';

                if (type === 'wisdom') {
                    // ëª…ì–¸ íŒì—… í˜¸í¡ë²• (ì¶œì„ ì‹œ): í•­ìƒ 5ì 
                    breathingBonus = 5;

                    if (todayBreathingCount === 1) {
                        motivationMessage = 'ğŸŒŸ ì²« ëª…ìƒ í˜¸í¡ë²•! ë§ˆìŒì´ ì°¨ë¶„í•´ì§€ê³  ìˆì–´ìš”.';
                    } else if (todayBreathingCount === 3) {
                        motivationMessage = 'ğŸ”¥ ì˜¤ëŠ˜ 3ë²ˆì§¸ í˜¸í¡ë²•! ê¾¸ì¤€í•¨ì´ ëŒ€ë‹¨í•´ìš”!';
                    } else if (todayBreathingCount === 5) {
                        motivationMessage = 'ğŸ† ì˜¤ëŠ˜ 5ë²ˆì§¸ í˜¸í¡ë²•! ëª…ìƒì˜ ë‹¬ì¸ì´ ë˜ì—ˆì–´ìš”!';
                    } else if (todayBreathingCount === 10) {
                        motivationMessage = 'ğŸ’ ì˜¤ëŠ˜ 10ë²ˆì§¸ í˜¸í¡ë²•! ë‹¹ì‹ ì˜ ì •ì‹ ë ¥ì€ ì´ˆì¸ì ì´ì—ìš”!';
                    } else {
                        const messages = [
                            'ğŸŒ¬ï¸ í˜¸í¡ë²• ì™„ë£Œ! ë§ˆìŒì´ í•œê²° ì°¨ë¶„í•´ì¡Œì–´ìš”.',
                            'ğŸ§˜ í˜¸í¡ë²• ì„±ê³µ! ë‚´ë©´ì˜ í‰í™”ë¥¼ ì°¾ê³  ìˆì–´ìš”.',
                            'âœ¨ í˜¸í¡ë²• ì™„ë£Œ! ê¾¸ì¤€í•œ ì—°ìŠµì´ ë¹›ì„ ë°œí•˜ê³  ìˆì–´ìš”.'
                        ];
                        motivationMessage = messages[Math.floor(Math.random() * messages.length)];
                    }
                } else {
                    // ë¡œê·¸ì¸ í˜¸í¡ë²•: í•­ìƒ 3ì 
                    breathingBonus = 3;

                    if (todayBreathingCount === 1) {
                        motivationMessage = 'ğŸŒŸ ì˜¤ëŠ˜ì˜ ì²« í˜¸í¡ë²•! ì¢‹ì€ ì‹œì‘ì´ì—ìš”.';
                    } else if (todayBreathingCount === 3) {
                        motivationMessage = 'ğŸ”¥ ì˜¤ëŠ˜ 3ë²ˆì§¸ í˜¸í¡ë²•! ë©‹ì§„ ìŠµê´€ì´êµ°ìš”!';
                    } else {
                        motivationMessage = 'ğŸŒ¬ï¸ í˜¸í¡ë²• ì™„ë£Œ! ê¾¸ì¤€í•¨ì´ ìë‘ìŠ¤ëŸ¬ì›Œìš”.';
                    }
                }

                // 1. Create a temporary updatedData object
                const updatedData = { ...userData };

                // 2. Apply changes to the temporary object
                updatedData.dailyBreathingCount = todayBreathingCount;
                updatedData.lastBreathingDate = new Date().toISOString();
                updatedData.breathingPoints = (updatedData.breathingPoints || 0) + breathingBonus;
                updatedData.points += breathingBonus;
                updatedData.totalPoints = (updatedData.totalPoints || 0) + breathingBonus;
                updatedData.lastBreathingTime = new Date().toISOString();

                // 3. Save the explicit data object
                await saveUserDataToSupabase(updatedData);

                // 4. If successful, update the global state
                Object.assign(userData, updatedData);

                // 5. Update UI and save history
                if (window.todaysBreathingPointsCache !== undefined) {
                    window.todaysBreathingPointsCache += breathingBonus;
                }
                const breathingType = type === 'wisdom' ? 'ë¡œê·¸ì¸ ëª…ìƒ í˜¸í¡ ì™„ë£Œ' : 'ëª…ìƒ í˜¸í¡ ì™„ë£Œ';
                const breathingDescription = type === 'wisdom' ? 'ë¡œê·¸ì¸ ëª…ìƒ í˜¸í¡ë²•' : 'ëª…ìƒ í˜¸í¡ë²•';
                await savePointHistory(breathingType, breathingBonus, `${breathingDescription} ì™„ë£Œ`);

                updateUI();
                updateDailyPoints();
                updateTodaysBreathingPointsCache();

                // ë™ê¸°ë¶€ì—¬ ë©”ì‹œì§€ í‘œì‹œ
                if (motivationMessage) {
                    setTimeout(() => {
                        showBreathingMotivation(motivationMessage, breathingBonus, todayBreathingCount);
                    }, 500);
                }

                console.log(`í˜¸í¡ë²• ì™„ë£Œ! ${breathingBonus}ì  íšë“ (ì˜¤ëŠ˜ ${todayBreathingCount}ë²ˆì§¸)`);

            } catch (error) {
                console.error('í˜¸í¡ë²• í¬ì¸íŠ¸ ì €ì¥ ì˜¤ë¥˜:', error);
            }
        }

        // í˜¸í¡ë²• ë™ê¸°ë¶€ì—¬ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showBreathingMotivation(message, points, count) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 60%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10001; // ëª…ì–¸ íŒì—…ë³´ë‹¤ ìœ„ì— í‘œì‹œ
                text-align: center;
                font-size: 1rem;
                max-width: 300px;
                animation: breathingMotivationPop 0.5s ease-out;
            `;

            // ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
            const style = document.createElement('style');
            style.textContent = `
                @keyframes breathingMotivationPop {
                    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
                    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                }
                @keyframes breathingMotivationSlideOut {
                    0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                    100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
                }
            `;
            document.head.appendChild(style);

            modal.innerHTML = `
                <div style="font-size: 1.2rem; margin-bottom: 10px;">ğŸŒ¬ï¸ í˜¸í¡ë²• ì™„ë£Œ!</div>
                <div style="margin-bottom: 8px;">${message}</div>
                <div style="font-size: 0.9rem; opacity: 0.9;">
                    ${points}ì  íšë“ (ì˜¤ëŠ˜ ${count}ë²ˆì§¸)
                </div>
            `;
            document.body.appendChild(modal);

            // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ì œê±°
            setTimeout(() => {
                modal.style.animation = 'breathingMotivationSlideOut 0.3s ease-in forwards';
                setTimeout(() => {
                    modal.remove();
                    style.remove();
                }, 300);
            }, 3000);
        }

        // ë™ê¸°ë¶€ì—¬ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showMotivationalMessage(type) {
            const messages = {
                attendance: [
                    "ğŸ‰ ì¶œì„ ì™„ë£Œ! ê¾¸ì¤€í•¨ì´ ë‹¹ì‹ ì„ ë” ê°•í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤!",
                    "âœ¨ ì˜¤ëŠ˜ë„ ì¶œì„! ë‹¹ì‹ ì˜ í‰ì˜¨í•œ ì—¬ì •ì´ ê³„ì†ë˜ê³  ìˆì–´ìš”!",
                    "ğŸŒŸ ì¶œì„ ì„±ê³µ! ì‘ì€ ìŠµê´€ì´ í° ë³€í™”ë¥¼ ë§Œë“­ë‹ˆë‹¤!",
                    "ğŸ’ª ì¶œì„ ì™„ë£Œ! ë‹¹ì‹ ì˜ ì˜ì§€ê°€ ëŒ€ë‹¨í•´ìš”!",
                    "ğŸ”¥ ì¶œì„ ì„±ê³µ! í‰ì˜¨í•œ í•˜ë£¨ì˜ ì‹œì‘ì´ì—ìš”!"
                ],
                breathing: [
                    "ğŸŒ¬ï¸ í˜¸í¡ë²• ì™„ë£Œ! ë§ˆìŒì´ ì°¨ë¶„í•´ì§€ê³  ìˆì–´ìš”.",
                    "ğŸ§˜ í˜¸í¡ ì„±ê³µ! ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ì¤„ì–´ë“¤ê³  ìˆì–´ìš”.",
                    "ğŸ•Šï¸ í˜¸í¡ ì™„ë£Œ! í‰ì˜¨í•¨ì´ ì°¾ì•„ì˜¤ê³  ìˆì–´ìš”.",
                    "ğŸ’¨ í˜¸í¡ë²• ì„±ê³µ! ë§ˆìŒì˜ ì•ˆì •ì„ ë˜ì°¾ì•˜ì–´ìš”.",
                    "ğŸŒ¿ í˜¸í¡ ì™„ë£Œ! ë‚´ë©´ì˜ í‰í™”ë¥¼ ëŠë¼ì„¸ìš”."
                ],
                levelUp: [
                    "ğŸ‰ ë ˆë²¨ì—…! ë‹¹ì‹ ì˜ í‰ì˜¨í•¨ì´ í•œ ë‹¨ê³„ ì„±ì¥í–ˆì–´ìš”!",
                    "âœ¨ ë ˆë²¨ì—…! ì •ì„œì  ë…ë¦½ì— í•œ ê±¸ìŒ ë” ê°€ê¹Œì›Œì¡Œì–´ìš”!",
                    "ğŸŒŸ ë ˆë²¨ì—…! ë‹¹ì‹ ì˜ ë…¸ë ¥ì´ ë¹›ì„ ë°œí•˜ê³  ìˆì–´ìš”!",
                    "ğŸ’ª ë ˆë²¨ì—…! í‰ì˜¨í•œ ì‚¶ì˜ ì „ë¬¸ê°€ê°€ ë˜ì–´ê°€ê³  ìˆì–´ìš”!",
                    "ğŸ† ë ˆë²¨ì—…! ë‹¹ì‹ ì˜ ì¸ë‚´ì‹¬ì´ ê²°ì‹¤ì„ ë§ºì—ˆì–´ìš”!"
                ],
                points: [
                    "ğŸ’° í¬ì¸íŠ¸ íšë“! ë‹¹ì‹ ì˜ ë…¸ë ¥ì´ ë³´ìƒë°›ê³  ìˆì–´ìš”!",
                    "âœ¨ í¬ì¸íŠ¸ íšë“! ì‘ì€ ì„±ê³µì´ ëª¨ì—¬ í° ì„±ê³¼ë¥¼ ë§Œë“­ë‹ˆë‹¤!",
                    "ğŸŒŸ í¬ì¸íŠ¸ íšë“! ë‹¹ì‹ ì˜ ê¾¸ì¤€í•¨ì´ ë¹›ë‚˜ê³  ìˆì–´ìš”!",
                    "ğŸ’ í¬ì¸íŠ¸ íšë“! í‰ì˜¨í•œ ì‚¶ì˜ íˆ¬ìê°€ ë˜ê³  ìˆì–´ìš”!",
                    "ğŸ† í¬ì¸íŠ¸ íšë“! ë‹¹ì‹ ì˜ ì„±ì¥ì´ ëˆˆì— ë„ë„¤ìš”!"
                ],
                allChecklists: [
                    "ğŸ‰ ëª¨ë“  ì²´í¬ë¦¬ìŠ¤íŠ¸ ì™„ë£Œ! ì˜¤ëŠ˜ ë‹¹ì‹ ì€ ì •ë§ ëŒ€ë‹¨í•´ìš”!",
                    "âœ¨ ì™„ë²½í•œ í•˜ë£¨! ë‹¹ì‹ ì˜ í‰ì˜¨í•¨ì´ ë¹›ë‚˜ê³  ìˆì–´ìš”!",
                    "ğŸŒŸ ëª¨ë“  í›ˆë ¨ ì™„ë£Œ! ë‹¹ì‹ ì˜ ì˜ì§€ê°€ ì •ë§ ëŒ€ë‹¨í•´ìš”!",
                    "ğŸ’ª ì „ë¶€ ì„±ê³µ! í‰ì˜¨í•œ ì‚¶ì˜ ì£¼ì¸ê³µì´ ë˜ì—ˆì–´ìš”!",
                    "ğŸ† ì™„ë²½í•œ ì„±ê³¼! ë‹¹ì‹ ì˜ ë…¸ë ¥ì´ ê²°ì‹¤ì„ ë§ºì—ˆì–´ìš”!"
                ]
            };

            const messageList = messages[type] || [];
            if (messageList.length > 0) {
                const randomMessage = messageList[Math.floor(Math.random() * messageList.length)];
                
                // ë©”ì‹œì§€ í‘œì‹œë¥¼ ìœ„í•œ ëª¨ë‹¬ ìƒì„±
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    color: white;
                    padding: 20px;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    z-index: 9999; // ëª…ì–¸ íŒì—…(10000)ë³´ë‹¤ ë‚®ê²Œ ì„¤ì •
                    text-align: center;
                    font-size: 1.1rem;
                    max-width: 300px;
                    animation: motivationPop 0.5s ease-out;
                `;

                // ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes motivationPop {
                        0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
                        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);

                modal.innerHTML = randomMessage;
                document.body.appendChild(modal);

                // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ì œê±°
                setTimeout(() => {
                    modal.remove();
                    style.remove();
                }, 3000);
            }
        }

        // ëœë¤ ë³´ìƒ
        function getRandomReward() {
            const rewards = [
                "ë”°ëœ»í•œ ì°¨ í•œì”ì˜ ì—¬ìœ ",
                "ì¢‹ì•„í•˜ëŠ” ë…¸ë˜ 3ê³¡ ë“£ê¸°",
                "15ë¶„ ì¶”ê°€ íœ´ì‹",
                "ì‘ì€ ê°„ì‹ ë¨¹ê¸°",
                "ì˜¤ëŠ˜ì€ ì¹­ì°¬ ì¼ê¸° ì“°ì§€ ì•Šê¸°"
            ];
            return rewards[Math.floor(Math.random() * rewards.length)];
        }

        // í˜¸í¡ë²• í•¸ë“¤ëŸ¬
        function handleBreathing() {
            // ë¹„ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” ì‚¬ìš© ë¶ˆê°€
            if (!currentUser || !supabaseClient) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!');
                return;
            }

            // ë¡œê·¸ì¸ í˜¸í¡ë²• íŒì—… í‘œì‹œ
            showLoginWisdomQuote();
        }

        // í˜¸í¡ë²• íƒ€ì´ë¨¸
        function startBreathing() {
            alert("ğŸŒ¬ï¸ 4ì´ˆ ë“¤ì´ë§ˆì‹œê¸° â†’ 7ì´ˆ ì°¸ê¸° â†’ 8ì´ˆ ë‚´ì‰¬ê¸°\n\nì§€ê¸ˆ ì‹œì‘í•©ë‹ˆë‹¤. í™”ë©´ì„ ë³´ë©° ë”°ë¼í•´ì£¼ì„¸ìš”!");

            const steps = [
                { text: "ë“¤ì´ë§ˆì‹œê¸° (4ì´ˆ)", duration: 4000 },
                { text: "ì°¸ê¸° (7ì´ˆ)", duration: 7000 },
                { text: "ë‚´ì‰¬ê¸° (8ì´ˆ)", duration: 8000 }
            ];
            let stepIndex = -1;

            function nextStep() {
                stepIndex++;
                if (stepIndex < steps.length) {
                    const currentStep = steps[stepIndex];
                    alert(currentStep.text);
                    setTimeout(nextStep, currentStep.duration);
                } else {
                    // í˜¸í¡ë²• ì™„ë£Œ
                    const breathingReward = 5;
                    alert(`âœ… í˜¸í¡ë²• ì™„ë£Œ! í‰ì˜¨ í¬ì¸íŠ¸ ${breathingReward}ì  íšë“!\nì´ì œ ì¡°ê¸ˆ ë” í‰ì˜¨í•´ì§€ì…¨ë‚˜ìš”?`);
                    showMotivationalMessage('breathing');

                    (async () => {
                        const updatedData = { ...userData };
                        updatedData.points += breathingReward;
                        updatedData.totalPoints = (updatedData.totalPoints || 0) + breathingReward;
                        updatedData.breathingPoints = (updatedData.breathingPoints || 0) + breathingReward;
                        updatedData.lastBreathingTime = new Date().toISOString();

                        try {
                            await saveUserDataToSupabase(updatedData);
                            Object.assign(userData, updatedData); // ì„±ê³µ ì‹œì—ë§Œ ì „ì—­ ìƒíƒœ ì—…ë°ì´íŠ¸

                            await savePointHistory('ëª…ìƒ í˜¸í¡ ì™„ë£Œ', breathingReward, 'ëª…ìƒ í˜¸í¡ë²• ì™„ë£Œ');
                            updateUI();
                            updateDailyPoints();
                            await checkAndHandleLevelUp();
                        } catch (error) {
                            console.error("í˜¸í¡ë²• í¬ì¸íŠ¸ ì €ì¥ ì˜¤ë¥˜:", error);
                            alert("ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                        }
                    })();
                }
            }
            nextStep();
        }

        // ê°ì • ì¼ê¸° ì €ì¥
        async function saveDiary() {
            if (!currentUser || !supabaseClient) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!');
                return;
            }

            const otherPersonAction = document.getElementById('otherPersonAction').value;
            const myReaction = document.getElementById('myReaction').value;
            const reinterpretation = document.getElementById('reinterpretation').value;

            if(!otherPersonAction || !myReaction || !reinterpretation) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”!');
                return;
            }

            try {
                // Supabaseì— ì¼ê¸° ì €ì¥
                const { data, error } = await supabaseClient
                    .from('emotion_diaries')
                    .insert([{
                        user_id: currentUser.id,
                        other_person_action: otherPersonAction,
                        my_reaction: myReaction,
                        reinterpretation: reinterpretation
                    }])
                    .select()
                    .single();

                if (error) {
                    console.error('ì¼ê¸° ì €ì¥ ì˜¤ë¥˜:', error);
                    alert('ì¼ê¸° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }

                console.log('ì¼ê¸° ì €ì¥ ì„±ê³µ:', data);

                // ì²´í¬ë°•ìŠ¤ ìë™ ì™„ë£Œ
                document.getElementById('evening2').checked = true;
                await handleCheck({target: document.getElementById('evening2')});

                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('otherPersonAction').value = '';
                document.getElementById('myReaction').value = '';
                document.getElementById('reinterpretation').value = '';

                // ì¼ê¸° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadDiaries();
                alert('âœ… ê°ì • ì¼ê¸°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');

            } catch (error) {
                console.error('ì¼ê¸° ì €ì¥ ì‹œìŠ¤í…œ ì˜¤ë¥˜:', error);
                alert('ì¼ê¸° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì¼ê¸° ëª©ë¡ í‘œì‹œ
        function displayDiaries() {
            const diaryList = document.getElementById('diaryList');
            diaryList.innerHTML = '';

            console.log('displayDiaries í˜¸ì¶œë¨, diaries ê¸¸ì´:', diaries.length);
            console.log('diaries ë‚´ìš©:', diaries);

            if(diaries.length === 0) {
                diaryList.innerHTML = '<p style="color: #666;">ì €ì¥ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            // ìµœê·¼ 3ê°œë§Œ í‘œì‹œ
            const visibleDiaries = diaries.slice(0, 3);
            const hiddenDiaries = diaries.slice(3);

            visibleDiaries.forEach(diary => {
                const diaryItem = createDiaryItem(diary);
                diaryList.appendChild(diaryItem);
            });

            // ìˆ¨ê²¨ì§„ ì¼ê¸°ë“¤ì„ ìœ„í•œ ì»¨í…Œì´ë„ˆ
            const hiddenContainer = document.createElement('div');
            hiddenContainer.id = 'hiddenDiariesContainer';
            hiddenContainer.style.display = 'none';

            hiddenDiaries.forEach(diary => {
                const diaryItem = createDiaryItem(diary);
                hiddenContainer.appendChild(diaryItem);
            });

            diaryList.appendChild(hiddenContainer);

            // ë”ë³´ê¸° ë²„íŠ¼ ì¶”ê°€ (3ê°œ ì´ˆê³¼ ì‹œì—ë§Œ)
            if (hiddenDiaries.length > 0) {
                const moreButton = document.createElement('button');
                moreButton.className = 'btn';
                moreButton.id = 'showMoreDiariesBtn';
                moreButton.textContent = `ë”ë³´ê¸° (${hiddenDiaries.length}ê°œ)`;
                moreButton.style.width = '100%';
                moreButton.style.marginTop = '10px';
                moreButton.onclick = toggleMoreDiaries;
                diaryList.appendChild(moreButton);
            }
        }

        // ì¼ê¸° ì•„ì´í…œ ìƒì„± í•¨ìˆ˜
        function createDiaryItem(diary) {
            const diaryItem = document.createElement('div');
            diaryItem.className = 'diary-item';

            // ë‚ ì§œì™€ ì‚­ì œ ë²„íŠ¼ì„ ìœ„í•œ ì»¨í…Œì´ë„ˆ
            const headerDiv = document.createElement('div');
            headerDiv.style.display = 'flex';
            headerDiv.style.justifyContent = 'space-between';
            headerDiv.style.alignItems = 'flex-start';
            headerDiv.style.marginBottom = '8px';

            // ë‚ ì§œ í‘œì‹œ
            const dateDiv = document.createElement('div');
            dateDiv.style.fontSize = '0.8rem';
            dateDiv.style.color = '#666';
            dateDiv.textContent = `ğŸ“… ${diary.date}`;

            // ì‚­ì œ ë²„íŠ¼
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.title = 'ì¼ê¸° ì‚­ì œ';
            deleteBtn.textContent = 'ğŸ—‘ï¸';
            deleteBtn.onclick = function() {
                deleteDiary(diary.id);
            };

            headerDiv.appendChild(dateDiv);
            headerDiv.appendChild(deleteBtn);

            // ë‚´ìš© ì¶”ê°€
            const contentDiv1 = document.createElement('div');
            contentDiv1.innerHTML = `<strong>ğŸ‘¥ íƒ€ì¸:</strong> ${diary.otherPersonAction}`;

            const contentDiv2 = document.createElement('div');
            contentDiv2.innerHTML = `<strong>ğŸ‘¨ ë‚˜:</strong> ${diary.myReaction}`;

            const contentDiv3 = document.createElement('div');
            contentDiv3.innerHTML = `<strong>ğŸ’¡ ì¬í•´ì„:</strong> <span style="color: var(--success);">${diary.reinterpretation}</span>`;

            diaryItem.appendChild(headerDiv);
            diaryItem.appendChild(contentDiv1);
            diaryItem.appendChild(contentDiv2);
            diaryItem.appendChild(contentDiv3);

            return diaryItem;
        }

        // ë”ë³´ê¸°/ì ‘ê¸° í† ê¸€ í•¨ìˆ˜
        function toggleMoreDiaries() {
            const hiddenContainer = document.getElementById('hiddenDiariesContainer');
            const moreButton = document.getElementById('showMoreDiariesBtn');
            
            if (hiddenContainer.style.display === 'none') {
                hiddenContainer.style.display = 'block';
                moreButton.textContent = 'ì ‘ê¸°';
            } else {
                hiddenContainer.style.display = 'none';
                const hiddenCount = diaries.length - 3;
                moreButton.textContent = `ë”ë³´ê¸° (${hiddenCount}ê°œ)`;
            }
        }

        // ê°œë³„ ì¼ê¸° ì‚­ì œ
        async function deleteDiary(diaryId) {
            if(!confirm('ì •ë§ ì´ ê°ì • ì¼ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            if (currentUser && supabaseClient) {
                // DBì—ì„œ í•´ë‹¹ ì¼ê¸° ì‚­ì œ
                try {
                    const { error } = await supabaseClient
                        .from('emotion_diaries')
                        .delete()
                        .eq('id', diaryId)
                        .eq('user_id', currentUser.id); // ë³´ì•ˆ: ìì‹ ì˜ ì¼ê¸°ë§Œ ì‚­ì œ ê°€ëŠ¥

                    if (error) {
                        console.error('ì¼ê¸° ì‚­ì œ ì˜¤ë¥˜:', error);
                        alert('ì¼ê¸° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        return;
                    }
                } catch (error) {
                    console.error('ì¼ê¸° ì‚­ì œ ì‹œìŠ¤í…œ ì˜¤ë¥˜:', error);
                    alert('ì¼ê¸° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
            }

            // ë°°ì—´ì—ì„œ í•´ë‹¹ ì¼ê¸° ì œê±°
            diaries = diaries.filter(diary => diary.id !== diaryId);
            displayDiaries();
            alert('ì¼ê¸°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ì¼ê¸° ì‚­ì œ
        async function clearDiaries() {
            if(confirm('ì •ë§ ëª¨ë“  ê°ì • ì¼ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                if (currentUser && supabaseClient) {
                    // DBì—ì„œ ì¼ê¸° ì‚­ì œ
                    try {
                        const { error } = await supabaseClient
                            .from('emotion_diaries')
                            .delete()
                            .eq('user_id', currentUser.id);

                        if (error) {
                            console.error('ì¼ê¸° ì‚­ì œ ì˜¤ë¥˜:', error);
                            alert('ì¼ê¸° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                            return;
                        }
                    } catch (error) {
                        console.error('ì¼ê¸° ì‚­ì œ ì‹œìŠ¤í…œ ì˜¤ë¥˜:', error);
                        alert('ì¼ê¸° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        return;
                    }
                }
                diaries = [];
                displayDiaries();
                alert('ëª¨ë“  ì¼ê¸°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëª¨ë“  í¬ì¸íŠ¸ì™€ ë ˆë²¨ ë¦¬ì…‹ í•¨ìˆ˜
        async function resetAllPointsAndLevels() {
            if (confirm('ì •ë§ ëª¨ë“  í¬ì¸íŠ¸ì™€ ë ˆë²¨ì„ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                const updatedData = { ...userData };

                // ëª¨ë“  í¬ì¸íŠ¸ì™€ ë ˆë²¨ì„ 0ìœ¼ë¡œ ì´ˆê¸°í™”
                updatedData.points = 0;
                updatedData.totalPoints = 0;
                updatedData.level = 1;
                updatedData.breathingPoints = 0;
                updatedData.completedToday = [];
                updatedData.lastCheck = null;

                if (currentUser && supabaseClient) {
                    try {
                        await saveUserDataToSupabase(updatedData);
                        Object.assign(userData, updatedData); // ì„±ê³µ ì‹œì—ë§Œ ì „ì—­ ìƒíƒœ ì—…ë°ì´íŠ¸

                        // UI ì—…ë°ì´íŠ¸
                        updateUI();
                        updateLevelProgress();
                        updateDailyPoints();
                        alert('âœ… ëª¨ë“  í¬ì¸íŠ¸ì™€ ë ˆë²¨ì´ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤.\nì˜¤ëŠ˜ë¶€í„° ìƒˆë¡œ ì‹œì‘í•˜ì„¸ìš”!');
                    } catch (error) {
                        console.error("ë¦¬ì…‹ ì˜¤ë¥˜:", error);
                        alert("ë°ì´í„° ë¦¬ì…‹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    }
                }
            }
        }

        
        
        // ë‚ ì§œ ë³€ê²½ í™•ì¸ ë° completedToday ë°°ì—´ ì´ˆê¸°í™”
        async function checkDateChangeAndReset() {
            const today = new Date();

            const formatter = new Intl.DateTimeFormat('en-CA', {
                timeZone: 'Asia/Seoul',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });

            const todayKST = formatter.format(today);
            const isSameDay = userData.lastCheck && todayKST === userData.lastCheck;

            if (userData.lastCheck && !isSameDay) {
                const updatedData = { ...userData };
                updatedData.completedToday = [];
                updatedData.breathingPoints = 0;

                if (currentUser && supabaseClient) {
                    try {
                        await saveUserDataToSupabase(updatedData);
                        Object.assign(userData, updatedData);

                        document.querySelectorAll('.check-input').forEach(checkbox => {
                            checkbox.disabled = false;
                            checkbox.checked = false;
                            checkbox.removeAttribute('title');
                            checkbox.parentElement.classList.remove('completed');
                        });

                        updateUI();
                        console.log('ë‚ ì§œ ë³€ê²½ìœ¼ë¡œ completedToday ë°°ì—´ì´ ì´ˆê¸°í™”ë˜ê³  ëª¨ë“  ì²´í¬ë°•ìŠ¤ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } catch (error) {
                        console.error("ì¼ì¼ ë°ì´í„° ë¦¬ì…‹ ì˜¤ë¥˜:", error);
                    }
                }
            } else {
                console.log('ì˜¤ëŠ˜ ë‚ ì§œì´ê±°ë‚˜ ì²« ì‚¬ìš©ì…ë‹ˆë‹¤. ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒíƒœë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.');
            }
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            // í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.getElementById('loginFormElement')?.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('ë¡œê·¸ì¸ í¼ ì œì¶œë¨');
                login();
            });

            document.getElementById('signupFormElement')?.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('íšŒì›ê°€ì… í¼ ì œì¶œë¨');
                signup();
            });

            // Supabase ì´ˆê¸°í™”
            const supabaseInitialized = await initializeSupabase();
            if (!supabaseInitialized) {
                console.error('Supabase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸ì¦ ê¸°ëŠ¥ì´ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }

            // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ë¹„í™œì„±í™” - checkAuthStateë§Œìœ¼ë¡œ ì²˜ë¦¬
            // onAuthStateChange ë¦¬ìŠ¤ë„ˆëŠ” í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œ ë°ì´í„° ë¦¬ì…‹ ë¬¸ì œë¥¼ ì¼ìœ¼í‚´

            // ì´ˆê¸° ì¸ì¦ ìƒíƒœ í™•ì¸ (ë‚´ë¶€ì—ì„œ UI ì—…ë°ì´íŠ¸ ì²˜ë¦¬)
            await checkAuthState();

            // ì¶œì„ ìƒíƒœ ìµœì¢… í™•ì¸ ë° UI ë™ê¸°í™”
            if (currentUser && supabaseClient) {
                console.log('ğŸ” í˜ì´ì§€ ë¡œë“œ ì‹œ ì¶œì„ ìƒíƒœ ìµœì¢… í™•ì¸');
                // ë°ì´í„° ë¡œë“œ í›„ ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  ì¶œì„ ìƒíƒœ ì¬í™•ì¸
                setTimeout(() => {
                    updateAttendanceButton();
                    console.log('âœ… ì¶œì„ ë²„íŠ¼ ìƒíƒœ ë™ê¸°í™” ì™„ë£Œ');
                }, 500);
            }

            // ì˜¤ëŠ˜ì˜ í˜¸í¡ë²• í¬ì¸íŠ¸ ìºì‹œ ì´ˆê¸°í™”
            window.todaysBreathingPointsCache = undefined;

            // ì¼ê¸° ì„¹ì…˜ ì´ˆê¸° UI ì„¤ì •
            const diaryLoginPrompt = document.getElementById('diaryLoginPrompt');
            const diaryForm = document.getElementById('diaryForm');
            const recentDiarySection = document.getElementById('recentDiarySection');
            if (currentUser && supabaseClient) {
                diaryLoginPrompt.style.display = 'none';
                diaryForm.style.display = 'block';
                // ìµœê·¼ ê°ì • ì¼ê¸° ì„¹ì…˜ í‘œì‹œ
                if (recentDiarySection) recentDiarySection.style.display = 'block';
            } else {
                diaryLoginPrompt.style.display = 'block';
                diaryForm.style.display = 'none';
                // ìµœê·¼ ê°ì • ì¼ê¸° ì„¹ì…˜ ìˆ¨ê¸°ê¸°
                if (recentDiarySection) recentDiarySection.style.display = 'none';
            }

            // ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ ì´ˆê¸° UI ì„¤ì •
            const isLoggedIn = currentUser && supabaseClient;
            const checklistMessage = document.getElementById('checklistMessage');
            const checkboxes = document.querySelectorAll('.check-input');
            const emergencyBtn = document.querySelector('.emergency-btn');

            if (checklistMessage) {
                if (isLoggedIn) {
                    checklistMessage.style.display = 'none';
                } else {
                    checklistMessage.innerHTML = 'ğŸ”’ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>ëª¨ë“  ë°ì´í„°ëŠ” ì•ˆì „í•˜ê²Œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë©ë‹ˆë‹¤.';
                    checklistMessage.style.display = 'block';
                }
            }

            checkboxes.forEach(checkbox => {
                checkbox.disabled = !isLoggedIn;
                if (!isLoggedIn) {
                    checkbox.checked = false;
                    checkbox.setAttribute('title', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
                    checkbox.parentElement.classList.remove('completed');
                }
            });

            if (emergencyBtn) {
                emergencyBtn.disabled = !isLoggedIn;
            }
        });

        // ì¸ì¦ ìƒíƒœ í™•ì¸
        async function checkAuthState() {
            console.group('ğŸ” ì¸ì¦ ìƒíƒœ í™•ì¸ ì‹œì‘');

            if (!supabaseClient || !supabaseClient.auth) {
                console.error('âŒ Supabase í´ë¼ì´ì–¸íŠ¸ ë˜ëŠ” auth ëª¨ë“ˆì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ');
                return;
            }

            try {
                console.log('ğŸ“‹ ì„¸ì…˜ ì¡°íšŒ ì‹œì‘...');
                const { data: { session }, error } = await supabaseClient.auth.getSession();

                if (error) {
                    console.error('âŒ ì„¸ì…˜ ì¡°íšŒ ì‹¤íŒ¨:', error.message);
                    return;
                }

                console.log('ğŸ“‹ ì„¸ì…˜ ì¡°íšŒ ê²°ê³¼:', session ? 'ì„¸ì…˜ ìˆìŒ' : 'ì„¸ì…˜ ì—†ìŒ');

                if (session && session.user) {
                    console.log('âœ… ìœ íš¨í•œ ì„¸ì…˜ ë°œê²¬:', {
                        userId: session.user.id,
                        email: session.user.email,
                        expiresAt: new Date(session.expires_at * 1000)
                    });

                    // ì„¸ì…˜ì´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ë°ì´í„° ë¡œë“œ (ìƒˆë¡œê³ ì¹¨ ì‹œ ë°ì´í„° ìœ ì§€)
                    currentUser = session.user;
                    document.getElementById('userEmail').textContent = session.user.email;
                    document.getElementById('userSection').style.display = 'flex';
                    document.getElementById('loginSection').style.display = 'none';

                    try {
                        console.log('ğŸ”„ ì‚¬ìš©ì ë°ì´í„° ìë™ ë¡œë“œ ì‹œì‘...');

                        // ë°ì´í„° ë¡œë“œ ì „ ìƒíƒœ ê¸°ë¡
                        console.log('ğŸ“Š ë°ì´í„° ë¡œë“œ ì „:', {
                            attendanceCount: userData.attendanceCount,
                            level: userData.level,
                            points: userData.points,
                            completedToday: userData.completedToday
                        });

                        await loadUserData();
                        await loadDiaries();

                        // ë°ì´í„° ë¡œë“œ í›„ ìƒíƒœ ê¸°ë¡
                        console.log('ğŸ“Š ë°ì´í„° ë¡œë“œ í›„:', {
                            attendanceCount: userData.attendanceCount,
                            level: userData.level,
                            points: userData.points,
                            completedToday: userData.completedToday
                        });

                        console.log('âœ… UI ì—…ë°ì´íŠ¸ ì‹œì‘...');
                        updateUI();

                        // ìë™ ë¡œê·¸ì¸ ì‹œì—ë„ ëª…ì–¸ íŒì—… í‘œì‹œ
                        showLoginWisdomQuote();

                        console.log('âœ… ì„¸ì…˜ í™•ì¸ ë° ë°ì´í„° ìë™ ë¡œë“œ ì™„ë£Œ:', session.user.email);

                    } catch (error) {
                        console.error('âŒ ë°ì´í„° ìë™ ë¡œë“œ ì‹¤íŒ¨:', error);
                        console.error('ì—ëŸ¬ ìƒì„¸:', error.stack);
                        // ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ì‹œì—ë„ ì„¸ì…˜ì€ ìœ ì§€
                        showMessage('loginMessage', 'ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                    }
                } else {
                    console.log('âš ï¸ ì„¸ì…˜ ì—†ìŒ - ë¹„ë¡œê·¸ì¸ ìƒíƒœë¡œ ì´ˆê¸°í™”');
                    // ë¹„ë¡œê·¸ì¸ ìƒíƒœì¸ ê²½ìš° UIë§Œ ì´ˆê¸°í™” (ë°ì´í„°ëŠ” ë³´ì¡´)
                    currentUser = null;
                    document.getElementById('userSection').style.display = 'none';
                    document.getElementById('loginSection').style.display = 'block';

                    // userDataë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
                    Object.assign(userData, {
                        attendanceCount: 0,
                        level: 1,
                        points: 0,
                        lastCheck: null,
                        completedToday: [],
                        totalPoints: 0,
                        lastAttendanceDate: null,
                        attendancePoints: 0,
                        breathingPoints: 0
                    });

                    console.log('ğŸ”„ ë¹„ë¡œê·¸ì¸ ìƒíƒœ UI ì—…ë°ì´íŠ¸');
                    updateUI();
                    console.log('âœ… ë¹„ë¡œê·¸ì¸ ìƒíƒœ ì´ˆê¸°í™” ì™„ë£Œ');
                }
            } catch (error) {
                console.error('âŒ ì¸ì¦ ìƒíƒœ í™•ì¸ ì‹œìŠ¤í…œ ì˜¤ë¥˜:', error);
                console.error('ì—ëŸ¬ ìƒì„¸:', error.stack);
            }

            console.groupEnd();
        }

        // ëª…ì–¸ íŒì—… ë‹«ê¸° í•¨ìˆ˜
        function closeWisdomPopup() {
            // íƒ€ì´ë¨¸ ì •ë¦¬
            if (window.wisdomModalTimer) {
                clearTimeout(window.wisdomModalTimer);
                window.wisdomModalTimer = null;
            }

            // í˜¸í¡ë²• íƒ€ì´ë¨¸ ì •ë¦¬
            if (window.wisdomBreathingInterval) {
                clearInterval(window.wisdomBreathingInterval);
                window.wisdomBreathingInterval = null;
            }

            // íŒì—… ì œê±°
            if (window.wisdomModalRef) {
                window.wisdomModalRef.style.animation = 'wisdomSlideOut 0.3s ease-in forwards';
                setTimeout(() => {
                    if (window.wisdomModalRef) {
                        window.wisdomModalRef.remove();
                        window.wisdomModalRef = null;
                    }
                    if (window.wisdomModalStyleRef) {
                        window.wisdomModalStyleRef.remove();
                        window.wisdomModalStyleRef = null;
                    }
                }, 300);
            }
        }

        // ë¡œê·¸ì¸ ëª…ì–¸ íŒì—… ë‹«ê¸° í•¨ìˆ˜
        function closeLoginWisdomPopup() {
            // íƒ€ì´ë¨¸ ì •ë¦¬
            if (window.loginWisdomModalTimer) {
                clearTimeout(window.loginWisdomModalTimer);
                window.loginWisdomModalTimer = null;
            }

            // í˜¸í¡ë²• íƒ€ì´ë¨¸ ì •ë¦¬
            if (window.loginBreathingInterval) {
                clearInterval(window.loginBreathingInterval);
                window.loginBreathingInterval = null;
            }

            // íŒì—… ì œê±°
            if (window.loginWisdomModalRef) {
                window.loginWisdomModalRef.style.animation = 'wisdomSlideOut 0.3s ease-in forwards';
                setTimeout(() => {
                    if (window.loginWisdomModalRef) {
                        window.loginWisdomModalRef.remove();
                        window.loginWisdomModalRef = null;
                    }
                }, 300);
            }
        }

        // ë‚ ì§œ ë° ì‹œê°„ í‘œì‹œ
        function updateDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const date = now.getDate();
            const day = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][now.getDay()];
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            const datetimeString = `${year}ë…„ ${month}ì›” ${date}ì¼ ${day}ìš”ì¼ ${hours}:${minutes}:${seconds}`;
            document.getElementById('datetime').textContent = datetimeString;
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);

            // Display a random quote on page load
            displayRandomQuote();
        });
    </script>
</body>
</html>
