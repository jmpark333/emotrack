<!--
// 수정 정보: 2025-09-14 20:16:05 KST
// 배포내용: fix: 로그인 시 네트워크 테스트 오류 수정
// 커밋ID: ba6ab89
// 복구 방법: git revert ba6ab89
-->
<!DOCTYPE html>
<html>
<head>
    <title>정서적 독립 트래커</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7?v=1.4.1"></script>
    <script>
        // Supabase SDK 로딩 확인
        console.log('Supabase SDK 로딩 상태:', typeof supabase);
        console.log('Supabase SDK 상세 정보:', supabase);

        // SDK가 로드될 때까지 대기
        function waitForSupabase(callback, maxAttempts = 50) {
            let attempts = 0;

            function check() {
                attempts++;
                console.log(`Supabase SDK 확인 시도 ${attempts}/${maxAttempts}:`, typeof supabase);

                if (typeof supabase !== 'undefined') {
                    console.log('✅ Supabase SDK 로드 완료');
                    console.log('Supabase 버전:', supabase.version);
                    console.log('Supabase auth 객체:', supabase.auth);
                    console.log('Supabase createClient 함수:', typeof supabase.createClient);
                    callback();
                } else if (attempts < maxAttempts) {
                    setTimeout(check, 100);
                } else {
                    console.error('❌ Supabase SDK 로드 실패');
                }
            }

            check();
        }
    </script>
    <style>
        :root {
            --primary: #6C5CE7;
            --secondary: #A29BFE;
            --success: #00B894;
            --warning: #FDCB6E;
            --danger: #FF7675;
            --light: #DFE6E9;
            --dark: #2D3436;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            color: var(--dark);
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            color: var(--primary);
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        #datetime {
            background-color: var(--light);
            color: var(--dark);
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            margin-bottom: 10px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            flex: 1;
            margin: 0 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.6s, box-shadow 0.2s;
            transform-style: preserve-3d;
            position: relative;
            height: 120px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-card.flipped {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 15px;
            padding: 15px;
            box-sizing: border-box;
        }

        .card-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            padding: 10px;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .check-item {
            background: var(--light);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        .check-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .check-item.completed {
            background: rgba(0,184,148,0.1);
            border-left: 5px solid var(--success);
        }
        .check-input {
            margin-right: 10px;
            transform: scale(1.3);
        }
        .emergency-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            margin: 15px 0;
            transition: all 0.3s;
        }
        .emergency-btn:hover {
            background: #e84393;
            transform: scale(1.02);
        }
        .progress-bar {
            height: 8px;
            background: var(--light);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--warning));
            transition: width 0.5s;
        }
        .diary-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(108,92,231,0.1);
            border-radius: 15px;
        }
        .diary-input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 0.9rem;
        }
        .diary-label {
            display: block;
            font-size: 0.8rem;
            color: #666;
            margin-top: 10px;
            margin-bottom: 2px;
        }
        .diary-item {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            font-size: 0.85rem;
        }
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 5px 0;
        }
        .btn-danger {
            background: var(--danger);
        }

        .delete-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1rem;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
            opacity: 0.6;
        }

        .delete-btn:hover {
            background: var(--danger);
            color: white;
            opacity: 1;
            transform: scale(1.1);
        }
        .badge {
            display: inline-block;
            background: var(--warning);
            color: var(--dark);
            padding: 3px 10px;
            border-radius: 15px;
            margin: 3px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        /* 모바일 뷰를 위한 추가 스타일 */
        body.mobile-view {
            padding: 10px;
        }
        
        body.mobile-view .container {
            padding: 15px;
        }
        
        body.mobile-view .header h1 {
            font-size: 1.5rem;
        }
        
        body.mobile-view .stat-card {
            padding: 12px 8px;
            margin: 0 3px;
        }
        
        body.mobile-view .stat-value {
            font-size: 1.2rem;
        }
        
        body.mobile-view .check-item {
            padding: 10px;
            margin-bottom: 6px;
        }
        
        body.mobile-view .check-input {
            transform: scale(1.2);
        }
        
        body.mobile-view .diary-input {
            font-size: 1rem;
            padding: 10px;
        }
        
        body.mobile-view .btn, body.mobile-view .emergency-btn {
            padding: 12px 15px;
            font-size: 1rem;
        }
        
        body.mobile-view .diary-item {
            font-size: 0.9rem;
            padding: 12px;
        }
        
        /* 홈 화면 아이콘 추가를 위한 메타 태그 */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #8B7CF6;
                --secondary: #A29BFE;
            }
        }

        /* 인증 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .close {
            position: absolute;
            right: 15px;
            top: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .close:hover {
            color: #000;
        }

        #authTabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--light);
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: bold;
        }

        .auth-form {
            text-align: center;
        }

        .auth-form h2 {
            margin-bottom: 20px;
            color: var(--dark);
        }

        .auth-form input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .auth-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .auth-btn:hover {
            background: var(--secondary);
        }

        .auth-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .auth-message.success {
            background: var(--success);
            color: white;
        }

        .auth-message.error {
            background: var(--danger);
            color: white;
        }

        #userSection {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }

        #loginSection {
            text-align: center;
            margin-top: 10px;
        }
    </style>
    
    <!-- 홈 화면에 추가하기 위한 설정 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="정서적 독립 트래커">
    <meta name="mobile-web-app-capable" content="yes">
    </head>
<body>
    <div class="container">
        <!-- 로그인/회원가입 모달 -->
        <div id="authModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeAuthModal()">&times;</span>
                <div id="authTabs">
                    <button class="tab-btn active" onclick="switchTab('login')">로그인</button>
                    <button class="tab-btn" onclick="switchTab('signup')">회원가입</button>
                </div>

                <!-- 로그인 폼 -->
                <div id="loginForm" class="auth-form">
                    <h2>로그인</h2>
                    <form id="loginFormElement">
                        <label for="loginEmail">이메일</label>
                        <input type="email" id="loginEmail" placeholder="이메일" required autocomplete="email">
                        <label for="loginPassword">비밀번호</label>
                        <input type="password" id="loginPassword" placeholder="비밀번호" required autocomplete="current-password">
                        <button type="submit" class="auth-btn">로그인</button>
                    </form>
                    <div id="loginMessage" class="auth-message"></div>
                </div>

                <!-- 회원가입 폼 -->
                <div id="signupForm" class="auth-form" style="display: none;">
                    <h2>회원가입</h2>
                    <form id="signupFormElement">
                        <label for="signupEmail">이메일</label>
                        <input type="email" id="signupEmail" placeholder="이메일" required autocomplete="email">
                        <label for="signupPassword">비밀번호 (6자 이상)</label>
                        <input type="password" id="signupPassword" placeholder="비밀번호 (6자 이상)" required autocomplete="new-password">
                        <label for="signupConfirmPassword">비밀번호 확인</label>
                        <input type="password" id="signupConfirmPassword" placeholder="비밀번호 확인" required autocomplete="new-password">
                        <button type="submit" class="auth-btn">회원가입</button>
                    </form>
                    <div id="signupMessage" class="auth-message"></div>
                </div>
            </div>
        </div>

        <div class="header">
            <h1>🧘‍♂️ 정서적 독립 트래커</h1>
            <p id="datetime"></p>
            <p id="randomQuote" style="font-weight: bold; font-size: 1rem; color: white; background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 12px; border-radius: 10px; margin-bottom: 15px; cursor: pointer;" onclick="displayRandomQuote()"></p>
            <p>평온한 하루의 시작을 응원합니다</p>
            <div id="userSection" style="display: none;">
                <span id="userEmail"></span>
                <button onclick="logout()" style="margin-left: 10px; padding: 5px 10px; background: var(--danger); color: white; border: none; border-radius: 5px; cursor: pointer;">로그아웃</button>
            </div>
            <div id="loginSection">
                <button onclick="openAuthModal()" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">로그인/회원가입</button>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card" id="attendanceCard" onclick="flipAttendanceCard()" title="클릭하여 출석 정보 확인">
                <div class="card-front">
                    <div class="stat-value" id="attendanceCount" style="margin-bottom: 8px;">0</div>
                    <div style="font-size: 0.9rem; margin-bottom: 8px;">출석 일수</div>
                    <button id="attendanceBtn" onclick="attend(event)" style="background: #00B894; color: white; border: none; padding: 6px 10px; border-radius: 5px; font-size: 0.7rem; cursor: pointer; transition: background 0.2s; margin-top: 5px;" onmouseover="this.style.background='#00a085'" onmouseout="this.style.background='#00B894'">
                        ✅ 출석하기
                    </button>
                </div>
                <div class="card-back">
                    <div id="lastAttendanceDate" style="font-size: 1.0rem;">마지막 출석: 없음</div>
                </div>
            </div>
            <div class="stat-card" id="levelCard" onclick="flipLevelCard()" title="클릭하여 레벨 진행도 확인">
                <div class="card-front">
                    <div class="stat-value" id="level" style="margin-bottom: 5px;">1</div>
                    <div style="font-size: 0.9rem;">평온 레벨</div>
                </div>
                <div class="card-back">
                    <div id="levelProgressDisplay" style="font-size: 1.0rem; font-weight: bold;">다음 레벨까지: 100포인트</div>
                </div>
            </div>
            <div class="stat-card" id="pointsCard" onclick="flipPointsCard()" title="클릭하여 포인트 정보 확인">
                <div class="card-front">
                    <div class="stat-value" id="points" style="margin-bottom: 5px;">0</div>
                    <div style="font-size: 0.9rem;">평온 포인트</div>
                </div>
                <div class="card-back">
                    <div style="font-size: 1.0rem; font-weight: bold; margin-bottom: 10px;">📈 평온 포인트</div>
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.9);">
                        총 획득 포인트
                    </div>
                </div>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress" id="dailyProgress" style="width: 0%"></div>
        </div>
        
        <h3>🌅 아침 훈련</h3>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="morning1">
            <label for="morning1">감정 분리 선언 ("오늘 타인의 감정은 나의 것이 아님" 3번)</label>
        </div>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="morning2">
            <label for="morning2">오늘 지킬 핵심 가치 선택 (평온/존중/자존감)</label>
        </div>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="morning3">
            <label for="morning3">오늘의 '나만의 30분' 계획 세우기</label>
        </div>
        
        <h3>🌞 점심 훈련</h3>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="noon1">
            <label for="noon1">비판적 말 들었을 때 "이건 사실인가?" 필터링</label>
        </div>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="noon2">
            <label for="noon2">"지금은 어렵다"고 말하기 (아니오 연습)</label>
        </div>
        
        <h3>🌙 저녁 훈련</h3>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="evening1">
            <label for="evening1">감정 폭발 시 4-7-8 호흡법 3회</label>
        </div>
        
        <div class="check-item">
            <input type="checkbox" class="check-input" id="evening2">
            <label for="evening2">📖 감정 일기 작성</label>
            <div id="diarySection" style="margin-top: 10px;">
                <!-- 로그인하지 않은 경우 표시될 메시지 -->
                <div id="diaryLoginPrompt" style="color: #666; padding: 10px; background: #f5f5f5; border-radius: 5px; margin-bottom: 10px;">
                    감정 일기를 작성하려면 로그인이 필요합니다.
                </div>
                <!-- 로그인한 경우 표시될 일기 입력 폼 -->
                <div id="diaryForm" style="display: none;">
                    <label for="otherPersonAction" class="diary-label">타인의 행동</label>
                    <input type="text" id="otherPersonAction" class="diary-input" placeholder="타인의 행동 (예: 고성 질문)" aria-label="타인의 행동">
                    <label for="myReaction" class="diary-label">내 첫 반응</label>
                    <input type="text" id="myReaction" class="diary-input" placeholder="내 첫 반응 (예: 죄책감 + 분노)" aria-label="내 첫 반응">
                    <label for="reinterpretation" class="diary-label">재해석</label>
                    <input type="text" id="reinterpretation" class="diary-input" placeholder="재해석 (예: 그녀는 불안해서 그런 거야)" aria-label="재해석">
                    <button class="btn" onclick="saveDiary()">💾 저장하고 체크 완료</button>
                </div>
            </div>
        </div>
        
        <div class="check-item">
            <input type="checkbox" class="check-input" id="evening3">
            <label for="evening3">오늘 나를 지킨 행동 1가지 칭찬하기</label>
        </div>
        
        <button class="emergency-btn" onclick="handleBreathing()">
            🌬️ 명상 호흡법 시작 (4-7-8)
        </button>
        
        <div class="diary-section" id="recentDiarySection">
            <h3>📚 최근 감정 일기</h3>
            <div id="diaryList"></div>
            <button class="btn btn-danger" onclick="clearDiaries()">🗑️ 모든 일기 삭제</button>
        </div>
        
        <div class="reward">
            <h3>🏆 지금까지 획득한 보상</h3>
            <div id="badges"></div>
            <p id="rewardText">모든 체크리스트를 완료하면 보상이 열립니다!</p>

            <!-- 리셋 버튼 추가 -->
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="resetAllPointsAndLevels()" style="background: var(--danger); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">
                    🔄 모든 포인트와 레벨 리셋
                </button>
            </div>
        </div>

        <!-- 오늘 획득 포인트 상세 정보 -->
        <div class="daily-points-summary" style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 10px; border: 2px solid #dee2e6;">
            <h4 style="margin: 0 0 15px 0; text-align: center; color: #495057; font-size: 1.1rem;">
                📊 오늘 획득 포인트 요약
            </h4>
            <div style="display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div style="text-align: center; min-width: 120px;">
                    <div style="font-size: 1.5rem; margin-bottom: 5px;">📋</div>
                    <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">체크 완료</div>
                    <div style="font-size: 1.3rem; font-weight: bold; color: #28a745;" id="checklistPoints">0</div>
                    <div style="font-size: 0.8rem; color: #6c757d;">포인트</div>
                </div>
                <div style="text-align: center; min-width: 120px;">
                    <div style="font-size: 1.5rem; margin-bottom: 5px;">🧘</div>
                    <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">명상 호흡법</div>
                    <div style="font-size: 1.3rem; font-weight: bold; color: #17a2b8;" id="breathingPointsDisplay">0</div>
                    <div style="font-size: 0.8rem; color: #6c757d;">포인트</div>
                </div>
                <div style="text-align: center; min-width: 120px; background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 10px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);"
                   onclick="showPointHistory()"
                   onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 123, 255, 0.4)'"
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 123, 255, 0.3)'">
                    <div style="font-size: 1.8rem; margin-bottom: 5px;">🏆</div>
                    <div style="font-size: 0.9rem; margin-bottom: 5px;">총 획득 포인트</div>
                    <div style="font-size: 1.5rem; font-weight: bold;" id="totalDailyPoints">0</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">포인트</div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 15px; font-size: 0.85rem; color: #6c757d;">
                <span id="dailyBreakdown">체크리스트 0개 완료 (0점) + 긴급호흡법 0회 완료 (0점) = 총 0점</span>
                <div style="margin-top: 5px; font-style: italic; opacity: 0.7;">
                    💡 총 획득 포인트를 클릭하면 상세 내역을 볼 수 있습니다
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase 클라이언트 (전역 변수)
        let supabaseClient = null;
        let currentUser = null;

        // Netlify 환경 변수에서 Supabase 설정 가져오기
        async function getSupabaseConfig() {
            try {
                const response = await fetch('/.netlify/functions/get-supabase-config');
                if (!response.ok) {
                    throw new Error(`Netlify 함수 호출 실패: ${response.statusText}`);
                }
                const config = await response.json();
                console.log('Supabase 설정 로드 성공:', config);
                return config;
            } catch (error) {
                console.error('Supabase 설정 로드 오류:', error);
                alert('앱 설정을 불러오는 데 실패했습니다. 페이지를 새로고침하거나 관리자에게 문의하세요.');
                return null;
            }
        }

        // Supabase 초기화 함수
        async function initializeSupabase() {
            const config = await getSupabaseConfig();
            if (!config || !config.supabaseUrl || !config.supabaseAnonKey) {
                console.error('Supabase 설정이 유효하지 않습니다.');
                return false;
            }

            const supabaseUrl = config.supabaseUrl;
            const supabaseKey = config.supabaseAnonKey;

            return new Promise((resolve) => {
                waitForSupabase(() => {
                    try {
                        // Supabase v2 올바른 초기화 방식
                        const { createClient } = supabase;
                        supabaseClient = createClient(supabaseUrl, supabaseKey);

                        console.log('Supabase 클라이언트 초기화 성공');
                        console.log('클라이언트 타입:', typeof supabaseClient);
                        console.log('클라이언트 전체 구조:', Object.keys(supabaseClient));
                        console.log('from 메소드 존재 여부:', 'from' in supabaseClient);
                        console.log('from 메소드 타입:', typeof supabaseClient.from);
                        console.log('클라이언트 auth 객체:', supabaseClient.auth);
                        console.log('클라이언트 auth 타입:', typeof supabaseClient.auth);

                        resolve(true);
                    } catch (error) {
                        console.error('Supabase 클라이언트 초기화 실패:', error);
                        resolve(false);
                    }
                });
            });
        }

        // 데이터 초기화 - 데이터베이스 전용
        let userData = {
            attendanceCount: 0,
            level: 1,
            points: 0,
            lastCheck: null,
            completedToday: [],
            totalPoints: 0,
            lastAttendanceDate: null,
            attendancePoints: 0,
            breathingPoints: 0, // breathing_points가 오늘의 호흡법 포인트 (일일 초기화)
            lastBreathingTime: null
        };

        let diaries = []; // 데이터베이스 전용

        // ================ 인증 관련 함수 ================ 

        // 인증 모달 열기
        function openAuthModal() {
            document.getElementById('authModal').style.display = 'block';
        }

        // 인증 모달 닫기
        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            clearMessages();
        }

        // 탭 전환
        function switchTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const tabBtns = document.querySelectorAll('.tab-btn');

            tabBtns.forEach(btn => btn.classList.remove('active'));

            if (tab === 'login') {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
                tabBtns[0].classList.add('active');
            } else {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
                tabBtns[1].classList.add('active');
            }

            clearMessages();
        }

        // 메시지 지우기
        function clearMessages() {
            document.getElementById('loginMessage').textContent = '';
            document.getElementById('loginMessage').className = 'auth-message';
            document.getElementById('signupMessage').textContent = '';
            document.getElementById('signupMessage').className = 'auth-message';
        }

        // 메시지 표시
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `auth-message ${type}`;
        }

        // 회원가입
        async function signup() {
            if (!supabaseClient) {
                showMessage('signupMessage', 'Supabase가 설정되지 않았습니다. 관리자에게 문의해주세요.', 'error');
                return;
            }

            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;

            if (!email || !password || !confirmPassword) {
                showMessage('signupMessage', '모든 필드를 입력해주세요.', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('signupMessage', '비밀번호는 6자 이상이어야 합니다.', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showMessage('signupMessage', '비밀번호가 일치하지 않습니다.', 'error');
                return;
            }

            try {
                console.log('📝 회원가입 시도:', { email, passwordLength: password.length });

                // auth 객체 다시 확인
                if (!supabaseClient || !supabaseClient.auth) {
                    throw new Error('Supabase 클라이언트가 초기화되지 않았습니다.');
                }

                console.log('auth 객체 상태:', {
                    exists: !!supabaseClient.auth,
                    hasSignUp: typeof supabaseClient.auth.signUp === 'function',
                    signUpFunction: supabaseClient.auth.signUp
                });

                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password
                });

                console.log('📋 Supabase 응답:', { data, error });

                if (error) {
                    console.error('❌ Supabase 회원가입 오류:', error);
                    showMessage('signupMessage', `오류: ${error.message}`, 'error');
                    return;
                }

                if (data && data.user && !data.user.email_confirmed_at) {
                    console.log('✅ 회원가입 성공 (이메일 확인 필요)');
                    showMessage('signupMessage', '회원가입이 완료되었습니다. 이메일을 확인해주세요.', 'success');
                } else if (data && data.user) {
                    console.log('✅ 회원가입 성공 (즉시 로그인)');
                    showMessage('signupMessage', '회원가입이 완료되었습니다.', 'success');
                } else {
                    console.log('⚠️ 응답 데이터 없음');
                    showMessage('signupMessage', '회원가입이 처리되었습니다.', 'success');
                }

                // 3초 후 로그인 탭으로 전환
                setTimeout(() => {
                    switchTab('login');
                    document.getElementById('loginEmail').value = email;
                }, 3000);

            } catch (error) {
                console.error('💥 회원가입 시스템 오류:', error);
                showMessage('signupMessage', `시스템 오류: ${error.message}`, 'error');
            }
        }

        // 로그인
        async function login() {
            if (!supabaseClient) {
                showMessage('loginMessage', 'Supabase가 설정되지 않았습니다. 관리자에게 문의해주세요.', 'error');
                return;
            }

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showMessage('loginMessage', '이메일과 비밀번호를 입력해주세요.', 'error');
                return;
            }

            try {
                console.log('🔐 로그인 시도:', { email });

                // Supabase 클라이언트 상태 확인
                console.log('로그인 전 클라이언트 상태:', {
                    supabaseClient: !!supabaseClient,
                    auth: !!supabaseClient?.auth,
                    signInWithPassword: typeof supabaseClient?.auth?.signInWithPassword
                });

                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                console.log('로그인 응답:', { data, error });

                if (error) {
                    showMessage('loginMessage', error.message, 'error');
                    return;
                }

                currentUser = data.user;

                // 로그인 성공 - UI 업데이트
                document.getElementById('userEmail').textContent = email;
                document.getElementById('userSection').style.display = 'flex';
                document.getElementById('loginSection').style.display = 'none';
                closeAuthModal();

                // 로그인 명언 팝업 표시
                showLoginWisdomQuote();

                // 데이터 로드 (동기적으로 처리 - 실패 시 로그아웃)
                try {
                    await loadUserData();
                    console.log('데이터 로드 성공');
                    updateUI();
                    await loadDiaries(); // 로그인 후 감정일기 로드
                    updateDiarySection(); // 일기 섹션 UI 업데이트
                    updateChecklistSection(); // 체크리스트 섹션 UI 업데이트
                } catch (loadError) {
                    console.error('데이터 로드 실패:', loadError);
                    alert('데이터 로드에 실패했습니다. 다시 로그인해주세요.');

                    // 로그아웃 처리
                    currentUser = null;
                    document.getElementById('userSection').style.display = 'none';
                    document.getElementById('loginSection').style.display = 'block';
                    showMessage('loginMessage', '로그인 실패: 서버 연결 오류', 'error');
                }

            } catch (error) {
                console.error('💥 로그인 시스템 오류:', error);
                showMessage('loginMessage', `시스템 오류: ${error.message}`, 'error');
            }
        }

        // 새 사용자 데이터 생성
        async function createNewUserData() {
            if (!currentUser || !supabaseClient) return;

            try {
                const newUserData = {
                    user_id: currentUser.id,
                    streak: 0, // attendance_count 대신 streak 사용
                    level: 1,
                    points: 0,
                    last_check: null,
                    completed_today: [],
                    total_points: 0,
                    start_date: null // last_attendance_date 대신 start_date 사용
                    // attendance_points와 breathing_points 컬럼이 없으므로 제외
                };

                const { data, error } = await supabaseClient
                    .from('user_data')
                    .insert([newUserData])
                    .select()
                    .single();

                if (error) {
                    console.error('사용자 데이터 생성 오류:', error);
                    return;
                }

                console.log('새 사용자 데이터 생성 성공:', data);

                // userData 업데이트 (기존 컬럼만 사용)
                userData = {
                    attendanceCount: data.streak || 0, // streak를 attendanceCount로 사용
                    level: data.level || 1,
                    points: data.points || 0,
                    lastCheck: data.last_check,
                    completedToday: data.completed_today || [],
                    totalPoints: data.total_points || 0,
                    lastAttendanceDate: data.start_date, // start_date를 lastAttendanceDate로 사용
                    attendancePoints: 0, // attendance_points 컬럼이 없으므로 0으로 초기화
                    breathingPoints: data.breathing_points || 0, // breathing_points 컬럼에서 값 로드
                    lastBreathingTime: data.last_breathing_time // 호흡법 마지막 실행 시간 로드
                };

                updateUI();
            } catch (error) {
                console.error('사용자 데이터 생성 중 예외 오류:', error);
            }
        }

        // 로그아웃
        async function logout() {
            console.log('logout 함수 호출됨');

            // 로그아웃 버튼 비활성화 (중복 클릭 방지)
            const logoutBtn = document.querySelector('button[onclick="logout()"]');
            if (logoutBtn) {
                logoutBtn.disabled = true;
                logoutBtn.textContent = '로그아웃 중...';
            }

            try {
                // Supabase 로그아웃 시도
                if (supabaseClient && supabaseClient.auth) {
                    await supabaseClient.auth.signOut();
                    console.log('Supabase signOut 완료');
                }
            } catch (error) {
                console.error('Supabase 로그아웃 오류:', error);
            } finally {
                // 항상 로컬 데이터 초기화
                performLocalLogout();
            }
        }

        // 로컬 로그아웃 수행 함수
        function performLocalLogout() {
            console.log('로컬 로그아웃 수행 시작');

            // 데이터 초기화
            currentUser = null;
            userData = {
                attendanceCount: 0,
                level: 1,
                points: 0,
                lastCheck: null,
                completedToday: [],
                totalPoints: 0,
                lastAttendanceDate: null,
                attendancePoints: 0,
                breathingPoints: 0
            };
            diaries = [];

            // UI 업데이트 (데이터 저장 호출 없이 직접 업데이트)
            document.getElementById('userSection').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';

            // 일기 섹션 직접 업데이트
            const diaryLoginPrompt = document.getElementById('diaryLoginPrompt');
            const diaryForm = document.getElementById('diaryForm');
            const recentDiarySection = document.getElementById('recentDiarySection');
            if (diaryLoginPrompt) diaryLoginPrompt.style.display = 'block';
            if (diaryForm) diaryForm.style.display = 'none';
            // 최근 감정 일기 섹션만 숨기기
            if (recentDiarySection) recentDiarySection.style.display = 'none';

            // 체크리스트 섹션 직접 업데이트
            const checklistMessage = document.getElementById('checklistMessage');
            if (checklistMessage) {
                checklistMessage.innerHTML = '🔒 체크리스트를 사용하려면 로그인이 필요합니다.<br>모든 데이터는 안전하게 데이터베이스에 저장됩니다.';
                checklistMessage.style.display = 'block';
            }

            // 모든 체크박스 직접 업데이트
            document.querySelectorAll('.check-input').forEach(checkbox => {
                checkbox.disabled = true;
                checkbox.checked = false;
                checkbox.setAttribute('title', '로그인이 필요합니다');
                checkbox.parentElement.classList.remove('completed');
            });

            // 통계 카드 직접 초기화
            document.getElementById('attendanceCount').textContent = '0';
            document.getElementById('level').textContent = '1';
            document.getElementById('points').textContent = '0';
            // document.getElementById('dailyPoints').textContent = '0'; // 요소 제거됨
            const progressBar = document.getElementById('progressBar');
            if (progressBar) progressBar.style.width = '0%';

            // 일기 목록 직접 비우기
            const diariesList = document.getElementById('diariesList');
            if (diariesList) diariesList.innerHTML = '';

            // 로그아웃 버튼 상태 복원
            const logoutBtn = document.querySelector('button[onclick="logout()"]');
            if (logoutBtn) {
                logoutBtn.disabled = false;
                logoutBtn.textContent = '로그아웃';
            }

            console.log('로그아웃 완료 - 모든 데이터 초기화됨');
            alert('로그아웃이 완료되었습니다.');
    }

        // 일기 섹션 UI 업데이트
        function updateDiarySection() {
            const loginPrompt = document.getElementById('diaryLoginPrompt');
            const diaryForm = document.getElementById('diaryForm');
            const recentDiarySection = document.getElementById('recentDiarySection');

            if (currentUser && supabaseClient) {
                loginPrompt.style.display = 'none';
                diaryForm.style.display = 'block';
                // 최근 감정 일기 섹션 표시
                if (recentDiarySection) recentDiarySection.style.display = 'block';
            } else {
                loginPrompt.style.display = 'block';
                diaryForm.style.display = 'none';
                // 최근 감정 일기 섹션 숨기기
                if (recentDiarySection) recentDiarySection.style.display = 'none';
            }
        }

        // 체크리스트 섹션 UI 업데이트
        function updateChecklistSection() {
            const isLoggedIn = currentUser && supabaseClient;
            const checkboxes = document.querySelectorAll('.check-input');
            const emergencyBtn = document.querySelector('.emergency-btn');

            console.log('updateChecklistSection 호출:', {
                isLoggedIn,
                completedToday: userData.completedToday,
                checkboxCount: checkboxes.length
            });

            checkboxes.forEach(checkbox => {
                checkbox.disabled = !isLoggedIn;

                if (!isLoggedIn) {
                    checkbox.checked = false;
                } else {
                    // 로그인 상태에서는 completedToday 배열에 있는 항목들 체크
                    const checklistId = checkbox.id;
                    const isChecked = userData.completedToday && userData.completedToday.includes(checklistId);
                    checkbox.checked = isChecked;

                    console.log(`체크박스 ${checklistId}:`, {
                        checked: isChecked,
                        inCompletedToday: userData.completedToday.includes(checklistId)
                    });
                }
            });

            if (emergencyBtn) {
                emergencyBtn.disabled = !isLoggedIn;
            }

            // 비로그인 상태 메시지 표시
            let checklistMessage = document.getElementById('checklistMessage');
            if (!checklistMessage) {
                checklistMessage = document.createElement('div');
                checklistMessage.id = 'checklistMessage';
                checklistMessage.style.cssText = 'color: #666; padding: 15px; background: #f5f5f5; border-radius: 8px; margin-bottom: 20px; text-align: center;';

                const checklistContainer = document.querySelector('.checklist');
                if (checklistContainer) {
                    checklistContainer.parentNode.insertBefore(checklistMessage, checklistContainer);
                }
            }

            if (isLoggedIn) {
                checklistMessage.style.display = 'none';
            } else {
                checklistMessage.innerHTML = '🔒 체크리스트를 사용하려면 로그인이 필요합니다.<br>모든 데이터는 안전하게 데이터베이스에 저장됩니다.';
                checklistMessage.style.display = 'block';
            }
        }

        // 일기 데이터 로드 (데이터베이스 전용)
        async function loadDiaries() {
            if (!currentUser || !supabaseClient) {
                diaries = [];
                displayDiaries();
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('emotion_diaries')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('일기 로드 오류:', error);
                    diaries = [];
                } else {
                    // 데이터베이스 형식을 기존 형식으로 변환 (하위 호환성 지원)
                    diaries = (data || []).map(diary => ({
                        id: diary.id, // 일기 ID 추가
                        date: new Date(diary.created_at).toLocaleString(),
                        otherPersonAction: diary.other_person_action,
                        myReaction: diary.my_reaction,
                        reinterpretation: diary.reinterpretation
                    }));
                    console.log('데이터베이스에서 로드된 일기:', diaries.length, '개');
                }

                displayDiaries();
            } catch (error) {
                console.error('일기 로드 시스템 오류:', error);
                diaries = [];
                displayDiaries();
            }
        }

        // 사용자 데이터 로드
        async function loadUserData() {
            console.group('📥 사용자 데이터 로드 시작');

            console.log('loadUserData 함수 호출 시작:', {
                currentUser: !!currentUser,
                userId: currentUser?.id,
                supabaseClient: !!supabaseClient
            });

            if (!currentUser || !supabaseClient) {
                // 로그인하지 않은 경우 - 데이터 초기화는 checkAuthState에서 처리
                console.log('❌ 로그인하지 않은 상태 - 데이터 로드 중단');
                console.groupEnd();
                return;
            }

            try {
                console.log('🔍 사용자 데이터 조회 시작:', {
                    userId: currentUser.id,
                    email: currentUser.email
                });
                console.log('🔧 Supabase 클라이언트 상태:', {
                    supabaseClient: !!supabaseClient,
                    auth: !!supabaseClient?.auth,
                    from: typeof supabaseClient?.from
                });

                // 쿼리 실행 전 상세 로깅
                console.log('📋 DB 쿼리 실행 직전 - user_id:', currentUser.id);
                console.log('📋 쿼리 파라미터 확인:', {
                    table: 'user_data',
                    userId: currentUser.id,
                    userIdType: typeof currentUser.id
                });

                const queryStartTime = Date.now();
                console.log('⏱️ 쿼리 시작 시간:', queryStartTime);

                // 쿼리 최적화: 존재하는 필드만 선택 (컬럼 누락 문제 해결)
                const optimizedQuery = supabaseClient
                    .from('user_data')
                    .select('streak, level, points, last_check, completed_today, total_points, start_date, breathing_points, last_breathing_time')
                    .eq('user_id', currentUser.id)
                    .single();

                // 간단한 타임아웃 처리 - 재시도 없이 바로 실패 처리
                let data, error;
                try {
                    console.log('🚀 데이터베이스 쿼리 시작');

                    // 타임아웃 메커니즘
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => {
                            reject(new Error('Database query timeout after 10 seconds'));
                        }, 10000); // 10초 타임아웃
                    });

                    const result = await Promise.race([optimizedQuery, timeoutPromise]);
                    data = result.data;
                    error = result.error;

                    if (error) {
                        throw error;
                    }

                    console.log('✅ 쿼리 성공');

                } catch (queryError) {
                    console.error('❌ 데이터베이스 쿼리 실패:', queryError);
                    if (queryError.message && queryError.message.includes('timeout')) {
                        error = { code: 'TIMEOUT', message: 'Database query timeout' };
                    } else {
                        error = queryError;
                    }
                    data = null;
                }

                const queryEndTime = Date.now();
                console.log('⏱️ 쿼리 완료 시간:', queryEndTime);
                console.log('⏱️ 쿼리 소요 시간:', queryEndTime - queryStartTime, 'ms');
                console.log('📊 데이터 조회 결과:', {
                    hasData: !!data,
                    error: error?.message || 'No error'
                });

                if (data) {
                    console.log('📋 조회된 데이터 필드:', Object.keys(data));
                    console.log('📋 breathing_points 필드:', data.breathing_points);
                    console.log('📋 completed_today 필드:', data.completed_today);
                }

                if (error && error.code !== 'PGRST116') { // PGRST116: 데이터 없음
                    console.error('❌ 데이터 로드 오류:', error);

                    // 데이터베이스 타임아웃 에러 처리
                    if (error.code === 'TIMEOUT') {
                        console.error('❌ 데이터베이스 연결 타임아웃:', error);
                        alert('서버 연결이 불안정합니다. 잠시 후 다시 로그인해주세요.');

                        // 로그아웃 처리
                        currentUser = null;
                        document.getElementById('userSection').style.display = 'none';
                        document.getElementById('loginSection').style.display = 'block';
                        closeAuthModal();
                        console.groupEnd();
                        return;
                    }

                    // 406 오류인 경우 새 사용자 데이터 생성
                    if (error.code === '406') {
                        console.log('🆕 새 사용자 데이터 생성...');
                        await createNewUserData();
                    }
                    console.groupEnd();
                    return;
                }

                if (data) {
                    console.log('✅ DB에서 사용자 데이터 발견 - 업데이트 시작');

                    // DB에서 가져온 데이터로 업데이트 (완전히 덮어쓰지 않음)
                    const dbCompletedToday = data.completed_today || [];
                    const today = new Date();
                    const dbLastCheck = data.last_check ? new Date(data.last_check) : null;

                    const formatter = new Intl.DateTimeFormat('en-CA', {
                        timeZone: 'Asia/Seoul',
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });

                    const isSameDay = dbLastCheck &&
                        formatter.format(today) === formatter.format(dbLastCheck);

                    console.log('📅 날짜 비교 분석:', {
                        dbCompletedToday,
                        dbLastCheck: data.last_check,
                        today: today.toISOString(),
                        isSameDay,
                        todayDate: `${today.getFullYear()}-${today.getMonth()}-${today.getDate()}`,
                        dbDate: dbLastCheck ? `${dbLastCheck.getFullYear()}-${dbLastCheck.getMonth()}-${dbLastCheck.getDate()}` : 'null'
                    });

                    // 오늘 날짜의 데이터인 경우에만 completedToday 유지
                    if (isSameDay) {
                        userData.completedToday = dbCompletedToday;
                        console.log('✅ 오늘 날짜의 체크리스트 상태 복원:', dbCompletedToday);
                    } else {
                        // 날짜가 다른 경우 빈 배열로 초기화
                        userData.completedToday = [];
                        console.log('🔄 다른 날짜의 데이터: 체크리스트 초기화');
                    }

                    // 다른 필드들은 DB 데이터로 업데이트 (기존 필드만 사용)
                    userData.attendanceCount = data.streak || 0; // streak 컬럼을 attendanceCount로 사용
                    userData.level = data.level || 1;
                    userData.points = data.points || 0;
                    userData.lastCheck = data.last_check;
                    userData.totalPoints = data.total_points || 0;
                    userData.lastAttendanceDate = data.start_date; // start_date가 마지막 출석일
                    userData.attendancePoints = 0; // attendance_points 컬럼이 없으므로 0으로 초기화
                    userData.breathingPoints = data.breathing_points || 0; // breathing_points 컬럼에서 값 로드
                    userData.lastBreathingTime = data.last_breathing_time; // 호흡법 마지막 실행 시간 로드
                    // 일일 호흡법 횟수와 날짜는 포인트 내역 테이블에서 조회하므로 여기서는 초기화
                    userData.dailyBreathingCount = 0;
                    userData.lastBreathingDate = null;

                    console.log('✅ DB에서 사용자 데이터 로드 완료:', {
                        attendanceCount: userData.attendanceCount,
                        points: userData.points,
                        level: userData.level,
                        totalPoints: userData.totalPoints,
                        completedToday: userData.completedToday,
                        breathingPoints: userData.breathingPoints
                    });

                } else {
                    console.log('🆕 DB에 데이터 없음 - 새 사용자 데이터 생성 시작');
                    await saveUserData();
                }

                console.log('✅ loadUserData 완료 - 최종 userData 상태:', {
                    attendanceCount: userData.attendanceCount,
                    level: userData.level,
                    points: userData.points,
                    totalPoints: userData.totalPoints,
                    completedToday: userData.completedToday
                });

            } catch (error) {
                console.error('❌ 사용자 데이터 로드 오류:', error);
                console.error('❌ 에러 스택:', error.stack);
            }

            // 오늘 획득 포인트 UI 업데이트
            updateDailyPoints();

            // 오늘의 호흡법 포인트 캐시 초기화 및 업데이트
            window.todaysBreathingPointsCache = undefined;
            updateTodaysBreathingPointsCache();

            // 체크리스트 섹션 UI 업데이트
            updateChecklistSection();

            // 출석 버튼 상태 업데이트
            updateAttendanceButton();

            console.groupEnd();
        }

    
        // loadUserData의 별칭 함수 (호환성 유지)
        async function loadUserDataFromSupabase() {
            return await loadUserData();
        }

        // 포인트 내역 저장 함수
        async function savePointHistory(pointType, points, description = '') {
            console.log('🎯 포인트 내역 저장 시작:', {
                pointType,
                points,
                description,
                currentUser: !!currentUser,
                supabaseClient: !!supabaseClient
            });

            if (!currentUser || !supabaseClient) {
                console.log('❌ 포인트 내역 저장 중단: 로그인 또는 Supabase 미연결');
                return;
            }

            try {
                console.log('📤 point_history 테이블에 데이터 삽입 시도...');
                const { data, error } = await supabaseClient
                    .from('point_history')
                    .insert([{
                        user_id: currentUser.id,
                        point_type: pointType,
                        points: points,
                        description: description
                    }]);

                if (error) {
                    console.error('❌ 포인트 내역 저장 오류:', error);
                    console.error('오류 상세:', {
                        message: error.message,
                        code: error.code,
                        details: error.details,
                        hint: error.hint
                    });
                } else {
                    console.log(`✅ 포인트 내역 저장 성공: ${pointType}, ${points}점`);
                    console.log('저장된 데이터:', data);
                }
            } catch (error) {
                console.error('❌ 포인트 내역 저장 예외 오류:', error);
            }
        }

        // 오늘의 호흡법 횟수 조회 함수
        async function getTodayBreathingCount() {
            if (!currentUser || !supabaseClient) {
                return 0;
            }

            try {
                // 오늘의 시작 시간 (KST)
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayString = today.toISOString();

                // 오늘의 호흡법 관련 포인트 내역만 조회
                const { data, error } = await supabaseClient
                    .from('point_history')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .gte('created_at', todayString)
                    .in('point_type', ['로그인 명상 호흡 완료', '명상 호흡 완료']);

                if (error) {
                    console.error('오늘의 호흡법 횟수 조회 오류:', error);
                    return 0;
                }

                return data?.length || 0;
            } catch (error) {
                console.error('오늘의 호흡법 횟수 조회 예외 오류:', error);
                return 0;
            }
        }

        // 포인트 내역 조회 함수
        async function getPointHistory() {
            console.log('🔍 포인트 내역 조회 시작:', {
                currentUser: !!currentUser,
                supabaseClient: !!supabaseClient
            });

            if (!currentUser || !supabaseClient) {
                console.log('❌ 포인트 내역 조회 중단: 로그인 또는 Supabase 미연결');
                return [];
            }

            try {
                // 오늘의 시작 시간 (KST)
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayString = today.toISOString();

                console.log('📅 조회 조건:', {
                    userId: currentUser.id,
                    todayStart: todayString,
                    todayKST: today.toLocaleString('ko-KR')
                });

                console.log('📤 point_history 테이블 조회 쿼리 실행...');
                const { data, error } = await supabaseClient
                    .from('point_history')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .gte('created_at', todayString)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('❌ 포인트 내역 조회 오류:', error);
                    console.error('오류 상세:', {
                        message: error.message,
                        code: error.code,
                        details: error.details,
                        hint: error.hint
                    });
                    return [];
                }

                console.log(`✅ 포인트 내역 조회 성공: ${data?.length || 0}개 항목`);
                if (data && data.length > 0) {
                    console.log('조회된 내역:', data);
                }

                return data || [];
            } catch (error) {
                console.error('❌ 포인트 내역 조회 예외 오류:', error);
                return [];
            }
        }

        // 포인트 내역 팝업 표시 함수
        async function showPointHistory() {
            if (!currentUser || !supabaseClient) {
                alert('로그인이 필요합니다!');
                return;
            }

            // 포인트 내역 조회
            const history = await getPointHistory();

            // 팝업 모달 생성
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 20000;
                display: flex;
                justify-content: center;
                align-items: center;
                animation: fadeIn 0.3s ease-out;
            `;

            // 내용 컨테이너
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 30px;
                max-width: 90vw;
                width: min(600px, 90vw);
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                animation: slideUp 0.3s ease-out;
            `;

            // 한국어 타입 변환 함수
            function getKoreanType(type) {
                const typeMap = {
                    '출석완료': '출석완료',
                    '체크리스트 실행': '체크리스트 실행',
                    '로그인 명상 호흡 완료': '로그인 명상 호흡 완료',
                    '명상 호흡 완료': '명상 호흡 완료',
                    '레벨업': '레벨업',
                    '모든 훈련 완료': '모든 훈련 완료'
                };
                return typeMap[type] || type;
            }

            // 시간 포맷 함수
            function formatTime(dateString) {
                const date = new Date(dateString);
                return date.toLocaleTimeString('ko-KR', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            }

            // 총점 계산
            const totalPoints = history.reduce((sum, item) => sum + item.points, 0);

            let historyHTML = `
                <div style="text-align: center; margin-bottom: 25px;">
                    <h2 style="margin: 0 0 10px 0; color: #333; font-size: 1.5rem;">
                        📊 오늘의 포인트 내역
                    </h2>
                    <div style="color: #666; font-size: 1.1rem;">
                        총 ${totalPoints}점 획득
                    </div>
                </div>
            `;

            if (history.length === 0) {
                historyHTML += `
                    <div style="text-align: center; padding: 40px 20px; color: #999;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">📝</div>
                        <div style="font-size: 1.1rem;">아직 획득한 포인트가 없습니다.</div>
                        <div style="font-size: 0.9rem; margin-top: 5px;">출석이나 훈련을 통해 포인트를 획득해 보세요!</div>
                    </div>
                `;
            } else {
                historyHTML += `
                    <div style="border-top: 2px solid #f0f0f0; margin-bottom: 15px;"></div>
                `;

                history.forEach((item, index) => {
                    historyHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f0f0f0;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: #333; margin-bottom: 3px;">
                                    ${getKoreanType(item.point_type)}
                                </div>
                                <div style="font-size: 0.85rem; color: #666;">
                                    ${item.description || ''}
                                </div>
                                <div style="font-size: 0.8rem; color: #999;">
                                    ${formatTime(item.created_at)}
                                </div>
                            </div>
                            <div style="text-align: right; margin-left: 20px;">
                                <div style="font-size: 1.3rem; font-weight: bold; color: #4CAF50;">
                                    +${item.points}
                                </div>
                                <div style="font-size: 0.8rem; color: #666;">포인트</div>
                            </div>
                        </div>
                    `;
                });
            }

            historyHTML += `
                <div style="text-align: center; margin-top: 25px;">
                    <button id="closePointHistory" style="
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        color: white;
                        border: none;
                        padding: 12px 30px;
                        border-radius: 25px;
                        font-size: 1rem;
                        cursor: pointer;
                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                        transition: all 0.3s ease;
                    ">
                        닫기
                    </button>
                </div>
            `;

            content.innerHTML = historyHTML;
            modal.appendChild(content);
            document.body.appendChild(modal);

            // 애니메이션 스타일 추가
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideUp {
                    from { transform: translateY(50px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
                @keyframes fadeOut {
                    from { opacity: 1; }
                    to { opacity: 0; }
                }
                @keyframes slideDown {
                    from { transform: translateY(0); opacity: 1; }
                    to { transform: translateY(50px); opacity: 0; }
                }
            `;
            document.head.appendChild(style);

            // 닫기 버튼 이벤트
            document.getElementById('closePointHistory').addEventListener('click', () => {
                modal.style.animation = 'fadeOut 0.3s ease-out forwards';
                content.style.animation = 'slideDown 0.3s ease-out forwards';
                setTimeout(() => {
                    modal.remove();
                    style.remove();
                }, 300);
            });

            // 배경 클릭 시 닫기
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.getElementById('closePointHistory').click();
                }
            });
        }

        // 사용자 데이터 저장 (Supabase) - 데이터를 인자로 받아 명시적으로 저장
        async function saveUserDataToSupabase(dataToSave) {
            if (!currentUser || !supabaseClient) {
                console.log('saveUserDataToSupabase: 로그인하지 않음 또는 Supabase 클라이언트 없음');
                return;
            }

            try {
                console.log('데이터 저장 시작:', dataToSave);

                const saveData = {
                    user_id: currentUser.id,
                    streak: dataToSave.attendanceCount,
                    level: dataToSave.level,
                    points: dataToSave.points,
                    last_check: dataToSave.lastCheck,
                    completed_today: dataToSave.completedToday,
                    total_points: dataToSave.totalPoints,
                    start_date: dataToSave.lastAttendanceDate,
                    breathing_points: dataToSave.breathingPoints || 0,
                    last_breathing_time: dataToSave.lastBreathingTime,
                    updated_at: new Date().toISOString()
                };

                const { data, error } = await supabaseClient
                    .from('user_data')
                    .upsert(saveData, { onConflict: 'user_id' });

                if (error) {
                    console.error('데이터 저장 오류:', error);
                    // 타임아웃 등의 네트워크 오류를 대비해 에러를 throw
                    throw error;
                } else {
                    console.log('데이터 저장 성공');
                }

            } catch (error) {
                console.error('사용자 데이터 저장 중 예외 발생:', error);
                // 호출한 쪽에서 에러를 처리할 수 있도록 다시 throw
                throw error;
            }
        }
        
        // 스마트폰 환경 감지
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // 스마트폰에서의 사용성 개선
        if (isMobile) {
            document.body.classList.add('mobile-view');
        }

        // 화면 업데이트
        function updateUI() {
            // 출석 일수 표시 (데이터가 있는 경우만 업데이트)
            if (userData.attendanceCount !== undefined) {
                document.getElementById('attendanceCount').textContent = userData.attendanceCount;
            }
            if (userData.level !== undefined) {
                document.getElementById('level').textContent = userData.level;
            }
            if (userData.points !== undefined) {
                document.getElementById('points').textContent = userData.points;
            }

            // 출석 버튼 상태 업데이트
            updateAttendanceButton();

            // 레벨 진행도 표시 업데이트
            updateLevelProgress();

            // 오늘 획득 포인트 표시
            updateDailyPoints();

            // 체크리스트 상태 복원 (이벤트 리스너 중복 추가 방지)
            document.querySelectorAll('.check-input').forEach(checkbox => {
                const isChecked = userData.completedToday.includes(checkbox.id);
                checkbox.checked = isChecked;

                // 로그인 상태 확인 및 체크박스 상태 설정
                if (!currentUser || !supabaseClient) {
                    // 비로그인 상태: 모든 체크박스 비활성화
                    checkbox.disabled = true;
                    checkbox.checked = false;
                    checkbox.setAttribute('title', '로그인이 필요합니다');
                    checkbox.parentElement.classList.remove('completed');
                } else {
                    // 로그인 상태: 체크된 항목만 비활성화
                    if (isChecked) {
                        checkbox.disabled = true;
                        checkbox.setAttribute('title', '오늘은 다시 해제할 수 없습니다');
                        checkbox.parentElement.classList.add('completed');
                    } else {
                        checkbox.disabled = false;
                        checkbox.removeAttribute('title');
                        checkbox.parentElement.classList.remove('completed');
                    }
                }

                // 이벤트 리스너가 없는 경우에만 추가
                if (!checkbox.hasAttribute('data-event-added')) {
                    checkbox.addEventListener('change', handleCheck);
                    checkbox.setAttribute('data-event-added', 'true');
                }
            });

            updateProgress();
            updateBadges();
            displayDiaries();
        }

        // 레벨업 체크 및 처리
        async function checkAndHandleLevelUp() {
            let leveledUp = false;
            // 여러 레벨업을 한 번에 처리하기 위해 while 루프 사용
            while (userData.points >= userData.level * 100) {
                userData.level++;
                leveledUp = true;
                console.log('🎉 레벨업! 새로운 레벨:', userData.level);

                // 레벨업 메시지를 setTimeout으로 표시하여 명언 팝업과 겹치지 않도록 함
                setTimeout(() => {
                    alert(`🎉 축하합니다! 평온 레벨 ${userData.level}에 도달했습니다!`);
                }, 1000);

                // 동기부여 메시지도 약간의 딜레이를 주고 표시
                setTimeout(() => {
                    showMotivationalMessage('levelUp');
                }, 3000);
            }

            if (leveledUp) {
                // 레벨이 변경된 경우, UI를 업데이트하고 데이터베이스에 저장
                document.getElementById('level').textContent = userData.level;
                await saveUserDataToSupabase(userData);
            }
            // 항상 레벨 진행도 UI를 업데이트
            updateLevelProgress();
        }

        // 체크 이벤트 처리
        async function handleCheck(e) {
            if (!currentUser || !supabaseClient) {
                e.target.checked = false;
                alert('로그인이 필요합니다!');
                return;
            }

            const id = e.target.id;
            const parent = e.target.parentElement;

            if (e.target.checked) {
                if (userData.completedToday.includes(id)) {
                    e.target.checked = false;
                    alert('⏰ 오늘은 이미 체크한 항목입니다.');
                    return;
                }

                // 1. Create a temporary updatedData object
                const updatedData = { ...userData };
                updatedData.completedToday = [...userData.completedToday, id]; // Add new item
                updatedData.points += 10;
                updatedData.totalPoints = (updatedData.totalPoints || 0) + 10;
                // KST 기준 현재 날짜 저장
                const now = new Date();
                const formatter = new Intl.DateTimeFormat('en-CA', {
                    timeZone: 'Asia/Seoul',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                updatedData.lastCheck = formatter.format(now); // Update last activity time

                try {
                    // 2. Save the explicit data object
                    await saveUserDataToSupabase(updatedData);

                    // 3. If successful, update the global state
                    Object.assign(userData, updatedData);

                    // Save point history
                    savePointHistory('체크리스트 실행', 10, `체크리스트 항목 완료: ${id}`);

                    // UI updates
                    parent.classList.add('completed');
                    e.target.disabled = true;
                    e.target.setAttribute('title', '오늘은 다시 해제할 수 없습니다');
                    showMotivationalMessage('points');

                    // Final UI sync
                    await updateProgress();
                    updateBadges();
                    updateDailyPoints();
                    document.getElementById('points').textContent = userData.points;
                    await checkAndHandleLevelUp();

                } catch (error) {
                    console.error('체크리스트 업데이트 오류:', error);
                    // Revert the checkbox state on failure
                    e.target.checked = false;
                    alert('데이터 저장에 실패했습니다. 다시 시도해주세요.');
                }

            } else {
                // Prevent unchecking
                if (userData.completedToday.includes(id)) {
                    e.target.checked = true;
                    alert('⏰ 한 번 체크한 항목은 오늘 하루 동안 해제할 수 없습니다.');
                }
            }
        }
        
        // 사용자 데이터 저장 (데이터베이스 전용)
        async function saveUserData() {
            console.log('saveUserData 호출됨:', {
                currentUser: !!currentUser,
                supabaseClient: !!supabaseClient,
                email: currentUser?.email
            });

            if (currentUser && supabaseClient) {
                console.log('Supabase에 데이터 저장 시도...');
                try {
                    await saveUserDataToSupabase(userData); // Pass the global userData object
                    console.log('Supabase 데이터 저장 완료');
                } catch (saveError) {
                    console.error('Supabase 저장 실패:', saveError);
                    alert('데이터 저장에 실패했습니다. 서버 연결을 확인해주세요.');
                }
            } else {
                console.log('비로그인 상태에서는 데이터를 저장하지 않음');
            }
        }
        
      
        // 레벨 진행도 업데이트
        function updateLevelProgress() {
            const pointsNeeded = userData.level * 100;
            const pointsRemaining = Math.max(0, pointsNeeded - userData.points);
            const progressPercentage = userData.points >= pointsNeeded ? 100 : (userData.points / pointsNeeded) * 100;

            // 앞면에서는 레벨 진행도 표시 제거 (뒷면에서만 표시)
        }

        // 레벨 진행도 디스플레이 업데이트 함수
        function updateLevelProgressDisplay() {
            const pointsNeeded = userData.level * 100;
            const pointsRemaining = Math.max(0, pointsNeeded - userData.points);

            document.getElementById('levelProgressDisplay').textContent = `다음 레벨까지: ${pointsRemaining}포인트`;
        }

        // 오늘 획득 포인트 업데이트
        function updateDailyPoints() {
            const checklistPoints = userData.completedToday.length * 10;
            const breathingPoints = getTodaysBreathingPoints(); // 오늘의 호흡법 포인트만 계산
            const attendancePoints = checkIfAttendedToday() ? (userData.attendancePoints || 0) : 0;
            const totalDailyPoints = checklistPoints + breathingPoints + attendancePoints;

            // 기존 오늘 획득 포인트 표시 업데이트 (요소 제거됨)
            // document.getElementById('dailyPoints').textContent = totalDailyPoints;

            // 상세 정보 업데이트
            document.getElementById('checklistPoints').textContent = checklistPoints;
            document.getElementById('breathingPointsDisplay').textContent = breathingPoints;
            document.getElementById('totalDailyPoints').textContent = totalDailyPoints;

            // 세부 내용 텍스트 업데이트
            const completedCount = userData.completedToday.length;
            const breathingCount = breathingPoints / 5; // 호흡법 완료 횟수 (5점당 1회)
            const attendanceBonus = checkIfAttendedToday() ? (calculateAttendanceBonus()) : 0;
            document.getElementById('dailyBreakdown').textContent =
                `체크리스트 ${completedCount}개 완료 (${checklistPoints}점) + 긴급호흡법 ${breathingCount}회 완료 (${breathingPoints}점) + 출석 보상 (${attendanceBonus}점) = 총 ${totalDailyPoints}점`;
        }

        // 기존 연속일수 카드 뒤집기 함수는 삭제됨 (출석 일수 카드로 대체)

        // 평온레벨 카드 뒤집기 함수
        function flipLevelCard() {
            const card = document.getElementById('levelCard');
            card.classList.toggle('flipped');

            // 뒷면이 보일 때 레벨 진행도 정보 업데이트
            if (card.classList.contains('flipped')) {
                updateLevelProgressDisplay();
            }
        }

        // 평온포인트 카드 뒤집기 함수
        function flipPointsCard() {
            const card = document.getElementById('pointsCard');
            card.classList.toggle('flipped');
        }

        // 출석 일수 카드 뒤집기 함수
        function flipAttendanceCard() {
            const card = document.getElementById('attendanceCard');
            card.classList.toggle('flipped');

            // 뒷면이 보일 때 출석 정보 업데이트
            if (card.classList.contains('flipped')) {
                updateAttendanceDisplay();
            }
        }

        // 출석 정보 표시 업데이트 함수
        function updateAttendanceDisplay() {
            const lastAttendanceDate = document.getElementById('lastAttendanceDate');

            if (!lastAttendanceDate) return; // 요소가 없으면 종료

            if (userData.lastAttendanceDate) {
                const lastDate = new Date(userData.lastAttendanceDate);
                const formattedDate = lastDate.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                lastAttendanceDate.textContent = `마지막 출석: ${formattedDate}`;
            } else {
                lastAttendanceDate.textContent = '마지막 출석: 없음';
            }
        }

        // 오늘의 호흡법 포인트 계산 함수
        function getTodaysBreathingPoints() {
            if (!currentUser || !supabaseClient) {
                return 0;
            }

            // 캐시된 값이 있으면 사용 (호흡법 실행 시마다 업데이트됨)
            if (window.todaysBreathingPointsCache !== undefined) {
                return window.todaysBreathingPointsCache;
            }

            // 캐시가 없으면 0 반환 (호흡법 실행 시 초기화됨)
            return 0;
        }

        // 오늘의 호흡법 포인트 캐시 업데이트 함수
        function updateTodaysBreathingPointsCache() {
            if (!currentUser || !supabaseClient) {
                return;
            }

            // 오늘의 시작 시간 (KST)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayString = today.toISOString();

            // 데이터베이스에서 오늘의 호흡법 포인트 조회
            supabaseClient
                .from('point_history')
                .select('points')
                .eq('user_id', currentUser.id)
                .gte('created_at', todayString)
                .in('point_type', ['로그인 명상 호흡 완료', '명상 호흡 완료'])
                .then(({ data, error }) => {
                    if (error) {
                        console.error('오늘의 호흡법 포인트 조회 오류:', error);
                        window.todaysBreathingPointsCache = 0;
                    } else {
                        const todayPoints = data?.reduce((sum, record) => sum + record.points, 0) || 0;
                        window.todaysBreathingPointsCache = todayPoints;
                        console.log('오늘의 호흡법 포인트 캐시 업데이트:', todayPoints);

                        // UI 업데이트
                        updateDailyPoints();
                    }
                })
                .catch(error => {
                    console.error('오늘의 호흡법 포인트 조회 예외 오류:', error);
                    window.todaysBreathingPointsCache = 0;
                });
        }

        // 날짜 변경 시 오늘의 호흡법 포인트 초기화 함수
        function resetDailyBreathingPointsIfNeeded() {
            const now = new Date();

            const formatter = new Intl.DateTimeFormat('en-CA', {
                timeZone: 'Asia/Seoul',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });

            const todayKST = formatter.format(now);
            const isSameDay = userData.lastCheck && todayKST === userData.lastCheck;

            if (!isSameDay) {
                // 날짜가 변경된 경우: 오늘의 호흡법 포인트 초기화
                userData.breathingPoints = 0;
                // 데이터베이스에도 즉시 저장
                if (currentUser && supabaseClient) {
                    saveUserDataToSupabase();
                }
            }
        }

        // 출석 보상 계산 함수
        function calculateAttendanceBonus() {
            return 10; // 기본 10점
        }

        // 출석 버튼 상태 업데이트 함수
        function updateAttendanceButton() {
            const attendanceBtn = document.getElementById('attendanceBtn');
            if (!attendanceBtn) return;

            const isTodayAttended = checkIfAttendedToday();

            if (isTodayAttended) {
                attendanceBtn.textContent = '✅ 출석 완료';
                attendanceBtn.disabled = true;
                attendanceBtn.style.background = '#95a5a6';
                attendanceBtn.style.cursor = 'not-allowed';
            } else {
                attendanceBtn.textContent = '✅ 출석하기';
                attendanceBtn.disabled = false;
                attendanceBtn.style.background = '#00B894';
                attendanceBtn.style.cursor = 'pointer';
            }
        }

        // 오늘 출석 여부 확인 함수
        function checkIfAttendedToday() {
            if (!userData.lastAttendanceDate) {
                return false;
            }

            const today = new Date();

            // 'en-CA' 로케일은 'YYYY-MM-DD' 형식의 출력을 제공합니다.
            const formatter = new Intl.DateTimeFormat('en-CA', {
                timeZone: 'Asia/Seoul',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });

            const todayKST = formatter.format(today);

            console.log('오늘 출석 확인 (KST):', {
                lastAttendanceDate: userData.lastAttendanceDate,
                todayKST: todayKST,
                isSameDay: todayKST === userData.lastAttendanceDate
            });

            return todayKST === userData.lastAttendanceDate;
        }

        // 출석 처리 함수
        async function attend(event) {
            event.stopPropagation(); // 카드 뒤집기 이벤트 방지

            if (!currentUser || !supabaseClient) {
                alert('로그인이 필요합니다!');
                return;
            }

            if (checkIfAttendedToday()) {
                alert('오늘은 이미 출석했습니다!');
                return;
            }

            // KST 기준 현재 날짜를 YYYY-MM-DD 형식으로 저장
            const today = new Date();
            const formatter = new Intl.DateTimeFormat('en-CA', {
                timeZone: 'Asia/Seoul',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            const todayKST = formatter.format(today);
            const bonus = calculateAttendanceBonus();

            // 1. Create a temporary updatedData object by cloning the current userData
            const updatedData = { ...userData };

            // 2. Apply all changes to the temporary object
            updatedData.attendanceCount += 1;
            updatedData.lastAttendanceDate = todayKST;
            updatedData.lastCheck = todayKST; // Also update last activity time
            updatedData.points += bonus;
            updatedData.totalPoints = (updatedData.totalPoints || 0) + bonus;
            updatedData.attendancePoints = (updatedData.attendancePoints || 0) + bonus;

            try {
                // 3. Save the explicit data object to the database
                await saveUserDataToSupabase(updatedData);

                // 4. If save is successful, update the global state
                Object.assign(userData, updatedData);

                // Save point history
                await savePointHistory('출석완료', bonus, `${userData.attendanceCount}일차 출석 보너스`);

                // UI updates and popups
                updateAttendanceButton();
                showWisdomQuote();
                setTimeout(() => {
                    alert(`✅ 출석 완료!\n출석 일수: ${userData.attendanceCount}일\n획득 포인트: ${bonus}점`);
                }, 26000);
                setTimeout(() => {
                    showMotivationalMessage('attendance');
                }, 29000);

                // Final UI sync
                updateUI();
                updateAttendanceDisplay();
                updateDailyPoints();
                await checkAndHandleLevelUp();

            } catch (error) {
                console.error('출석 처리 중 오류:', error);
                // No need for manual rollback as global userData was not modified
                let errorMessage = '출석 처리에 실패했습니다. 다시 시도해주세요.';
                if (error.message && error.message.includes('timeout')) {
                    errorMessage = '서버 연결이 지연되고 있습니다. 잠시 후 다시 시도해주세요.';
                } else if (error.message && error.message.includes('network')) {
                    errorMessage = '네트워크 연결을 확인해주세요.';
                }
                alert(errorMessage);
            }
        }

        // 기존 연속 일수 관련 함수는 삭제됨

        // 진행도 업데이트
        async function updateProgress() {
            const total = document.querySelectorAll('.check-input').length;
            const completed = userData.completedToday.length;
            const percentage = (completed / total) * 100;
            document.getElementById('dailyProgress').style.width = percentage + '%';

            // 연속 일수 기능은 출석 일수로 대체됨
        }

        // 뱃지 업데이트
        function updateBadges() {
            const badgesContainer = document.getElementById('badges');
            badgesContainer.innerHTML = '';
            
            // 출석 관련 배지
            if(userData.attendanceCount >= 1) {
                badgesContainer.innerHTML += '<span class="badge">🌱 첫 걸음</span>';
            }
            if(userData.attendanceCount >= 3) {
                badgesContainer.innerHTML += '<span class="badge">🔥 3일 출석</span>';
            }
            if(userData.attendanceCount >= 7) {
                badgesContainer.innerHTML += '<span class="badge">⭐ 출석 수호자</span>';
            }
            if(userData.attendanceCount >= 14) {
                badgesContainer.innerHTML += '<span class="badge">🌟 2주 달성</span>';
            }
            if(userData.attendanceCount >= 30) {
                badgesContainer.innerHTML += '<span class="badge">👑 한 달 정복</span>';
            }
            
            // 레벨 관련 배지
            if(userData.level >= 2) {
                badgesContainer.innerHTML += '<span class="badge">📈 성장 중</span>';
            }
            if(userData.level >= 3) {
                badgesContainer.innerHTML += '<span class="badge">🛡️ 정신의 방패</span>';
            }
            if(userData.level >= 5) {
                badgesContainer.innerHTML += '<span class="badge">⚡ 평온 마스터</span>';
            }
            if(userData.level >= 10) {
                badgesContainer.innerHTML += '<span class="badge">🏆 전설의 평온</span>';
            }
            
            // 포인트 관련 배지
            if(userData.totalPoints >= 100) {
                badgesContainer.innerHTML += '<span class="badge">💯 100점 클럽</span>';
            }
            if(userData.totalPoints >= 500) {
                badgesContainer.innerHTML += '<span class="badge">💎 500점 엘리트</span>';
            }
            if(userData.totalPoints >= 1000) {
                badgesContainer.innerHTML += '<span class="badge">👑 1000점 왕</span>';
            }
            
            // 호흡법 관련 배지
            const breathingCount = userData.breathingPoints / 5; // 5점당 1회
            if(breathingCount >= 1) {
                badgesContainer.innerHTML += '<span class="badge">🧘 호흡 시작</span>';
            }
            if(breathingCount >= 3) {
                badgesContainer.innerHTML += '<span class="badge">🌬️ 호흡의 달인</span>';
            }
            if(breathingCount >= 5) {
                badgesContainer.innerHTML += '<span class="badge">🕊️ 평온의 호흡</span>';
            }
            
            // 보상 메시지
            const total = document.querySelectorAll('.check-input').length;
            const completed = userData.completedToday.length;
            if(completed === total) {
                document.getElementById('rewardText').innerHTML =
                    `🎉 완료! 오늘의 보상: <strong>${getRandomReward()}</strong>`;
                showMotivationalMessage('allChecklists');
            }
        }

        // 명언 배열
        const wisdomQuotes = [
            "마음의 평온은 내면에서 온다. 밖에서 찾지 말라.",
            "과거에 머무르지 말고, 미래를 꿈꾸지도 말라. 현재에 마음을 집중하라.",
            "우리는 우리가 생각하는 바가 된다.",
            "행복에 이르는 길은 없다. 행복 그 자체가 길이다.",
            "진정한 행복은 밖에 있는 것이 아니라, 내면에 있다.",
            "자신을 정복하는 것이 천 번의 전투에서 이기는 것보다 더 큰 과업이다.",
            "미움은 미움으로 없어지지 않는다. 오직 사랑으로만 사라진다. 이것이 영원한 법칙이다.",
            "마음의 평정은 타인을 바꾸려 하지 않는 데서 온다.",
            "당신 자신이 가장 큰 스승이다.",
            "고요한 마음은 지혜의 근원이다.",
            "너를 화나게 할 수 있는 사람은 누구든 너의 주인이 된다.",
            "스스로의 주인이 되지 않는 자는 자유롭지 못하다.",
            "우리에게 일어나는 일이 중요한 것이 아니라, 그것에 반응하는 방식이 중요하다.",
            "고통은 당신의 생각이 만들어낸 것이다.",
            "현명한 사람은 자기 자신으로 만족한다.",
            "중요한 것은 무엇을 견디느냐가 아니라, 어떻게 견디느냐다.",
            "때로는 사는 것 자체가 용기의 행위다.",
            "우리는 현실에서보다 상상에서 더 자주 고통받는다.",
            "인생은 길다, 당신이 어떻게 쓰느냐를 안다면.",
            "당신을 괴롭히는 것들에서 도망치고 싶다면, 다른 장소에 가는 것이 아니라 다른 사람이 되어야 한다."
        ];

        // 랜덤 명언 표시 함수
        function displayRandomQuote() {
            const randomQuoteElement = document.getElementById('randomQuote');
            if (randomQuoteElement) {
                const randomQuote = wisdomQuotes[Math.floor(Math.random() * wisdomQuotes.length)];
                randomQuoteElement.textContent = `"${randomQuote}"`;
            }
        }

        // 명언 팝업용 호흡법 타이머 함수
        function startWisdomBreathing() {
            const phases = [
                { name: '준비', duration: 3, color: '#87CEEB' },
                { name: '들이마시기', duration: 4, color: '#4169E1' },
                { name: '참기', duration: 7, color: '#FFD700' },
                { name: '내쉬기', duration: 8, color: '#32CD32' }
            ];

            let currentPhase = 0;
            let countdownInterval;
            let isBreathingCompleted = false;

            // 타이머 참조 저장
            window.wisdomBreathingInterval = null;

            function startPhase(phaseIndex) {
                const phase = phases[phaseIndex];
                const phaseElement = document.getElementById('breathingPhase');
                const countdownElement = document.getElementById('breathingCountdown');
                const progressElement = document.getElementById('breathingProgressBar');

                if (!phaseElement || !countdownElement || !progressElement) return;

                // 현재 단계 설정
                phaseElement.textContent = phase.name;
                countdownElement.style.color = phase.color;
                countdownElement.textContent = phase.duration;

                // 프로그레스 바 초기화
                progressElement.style.width = '0%';
                progressElement.style.background = phase.color;

                let timeLeft = phase.duration;
                const totalDuration = phase.duration;

                // 카운트다운 타이머
                countdownInterval = setInterval(() => {
                    timeLeft--;
                    countdownElement.textContent = timeLeft;

                    // 프로그레스 바 업데이트
                    const progress = ((totalDuration - timeLeft) / totalDuration) * 100;
                    progressElement.style.width = progress + '%';

                    if (timeLeft <= 0) {
                        clearInterval(countdownInterval);
                        currentPhase++;

                        if (currentPhase < phases.length) {
                            // 다음 단계 시작
                            setTimeout(() => startPhase(currentPhase), 500);
                        } else {
                            // 모든 단계 완료
                            phaseElement.textContent = '완료!';
                            countdownElement.textContent = '✅';
                            progressElement.style.width = '100%';
                            progressElement.style.background = '#32CD32';

                            // 호흡법 완료 처리
                            if (!isBreathingCompleted) {
                                isBreathingCompleted = true;
                                handleBreathingComplete('wisdom');
                            }
                        }
                    }
                }, 1000);

                // 타이머 참조 저장
                window.wisdomBreathingInterval = countdownInterval;
            }

            // 첫 단계 시작
            startPhase(0);
        }

        // 명언 팝업 표시 함수
        function showWisdomQuote() {
            const randomQuote = wisdomQuotes[Math.floor(Math.random() * wisdomQuotes.length)];

            // 명언 팝업 모달 생성
            const wisdomModal = document.createElement('div');
            wisdomModal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 15px 35px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
                font-size: 1.2rem;
                max-width: 90vw;
                width: min(520px, 90vw);
                line-height: 1.5;
                animation: wisdomSlideIn 0.6s ease-out;
            `;

            // 애니메이션 추가
            const style = document.createElement('style');
            style.textContent = `
                @keyframes wisdomSlideIn {
                    0% { transform: translate(-50%, -50%) scale(0.3); opacity: 0; }
                    60% { transform: translate(-50%, -50%) scale(1.05); }
                    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                }
                @keyframes wisdomSlideOut {
                    0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                    100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
                }
            `;
            document.head.appendChild(style);

            wisdomModal.innerHTML = `
                <div style="position: absolute; top: 10px; right: 10px;">
                    <button onclick="closeWisdomPopup()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; opacity: 0.7; transition: opacity 0.3s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">×</button>
                </div>
                <div style="margin-bottom: 15px; font-size: 1.4rem;">📜 오늘의 지혜</div>
                <div style="font-style: italic; margin-bottom: 15px; line-height: 1.6;">"${randomQuote}"</div>
                <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 20px;">이 명언이 당신의 하루를 밝혀주길</div>

                <!-- 호흡법 타이머 영역 -->
                <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin-top: 10px;">
                    <div style="font-size: 1.1rem; margin-bottom: 10px;">🌬️ 명상 호흡법</div>
                    <div id="breathingPhase" style="font-size: 1rem; margin-bottom: 8px; font-weight: bold;">준비 중...</div>
                    <div id="breathingCountdown" style="font-size: 2rem; font-weight: bold; color: #FFD700;">3</div>
                    <div id="breathingProgress" style="width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin-top: 8px; overflow: hidden;">
                        <div id="breathingProgressBar" style="width: 0%; height: 100%; background: #FFD700; transition: width 0.1s linear;"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(wisdomModal);

            // 호흡법 시작
            startWisdomBreathing();

            // 타이머 ID 저장
            window.wisdomModalTimer = setTimeout(() => {
                wisdomModal.style.animation = 'wisdomSlideOut 0.5s ease-in forwards';
                setTimeout(() => {
                    wisdomModal.remove();
                    style.remove();
                }, 500);
            }, 25000);

            // 팝업 참조 저장
            window.wisdomModalRef = wisdomModal;
            window.wisdomModalStyleRef = style;
        }

        // 로그인 명언 팝업 표시 함수
        function showLoginWisdomQuote() {
            const randomQuote = wisdomQuotes[Math.floor(Math.random() * wisdomQuotes.length)];

            // 로그인 명언 팝업 모달 생성
            const loginWisdomModal = document.createElement('div');
            loginWisdomModal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 15px 35px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
                font-size: 1.2rem;
                max-width: 90vw;
                width: min(520px, 90vw);
                line-height: 1.5;
                animation: wisdomSlideIn 0.6s ease-out;
            `;

            // 애니메이션 추가 (이미 있다면 재사용)
            if (!document.querySelector('style[data-wisdom-animations]')) {
                const style = document.createElement('style');
                style.setAttribute('data-wisdom-animations', 'true');
                style.textContent = `
                    @keyframes wisdomSlideIn {
                        0% { transform: translate(-50%, -50%) scale(0.3); opacity: 0; }
                        60% { transform: translate(-50%, -50%) scale(1.05); }
                        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                    }
                    @keyframes wisdomSlideOut {
                        0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                        100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }

            loginWisdomModal.innerHTML = `
                <div style="position: absolute; top: 10px; right: 10px;">
                    <button onclick="closeLoginWisdomPopup()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; opacity: 0.7; transition: opacity 0.3s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">×</button>
                </div>
                <div style="margin-bottom: 15px; font-size: 1.4rem;">🌟 환영합니다!</div>
                <div style="font-style: italic; margin-bottom: 15px; line-height: 1.6;">"${randomQuote}"</div>
                <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 20px;">평온한 하루의 시작을 응원합니다</div>

                <!-- 호흡법 타이머 영역 -->
                <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin-top: 10px;">
                    <div style="font-size: 1.1rem; margin-bottom: 10px;">🌬️ 명상 호흡법</div>
                    <div id="loginBreathingPhase" style="font-size: 1rem; margin-bottom: 8px; font-weight: bold;">준비 중...</div>
                    <div id="loginBreathingCountdown" style="font-size: 2rem; font-weight: bold; color: #FFD700;">3</div>
                    <div id="loginBreathingProgress" style="width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin-top: 8px; overflow: hidden;">
                        <div id="loginBreathingProgressBar" style="width: 0%; height: 100%; background: #FFD700; transition: width 0.1s linear;"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(loginWisdomModal);

            // 로그인용 호흡법 시작
            startLoginBreathing();

            // 타이머 ID 저장
            window.loginWisdomModalTimer = setTimeout(() => {
                loginWisdomModal.style.animation = 'wisdomSlideOut 0.5s ease-in forwards';
                setTimeout(() => {
                    loginWisdomModal.remove();
                }, 500);
            }, 25000);

            // 팝업 참조 저장
            window.loginWisdomModalRef = loginWisdomModal;
        }

        // 로그인 명언 팝업용 호흡법 타이머 함수
        function startLoginBreathing() {
            const phases = [
                { name: '준비', duration: 3, color: '#87CEEB' },
                { name: '들이마시기', duration: 4, color: '#4169E1' },
                { name: '참기', duration: 7, color: '#FFD700' },
                { name: '내쉬기', duration: 8, color: '#32CD32' }
            ];

            let currentPhase = 0;
            let countdownInterval;
            let isBreathingCompleted = false;

            // 타이머 참조 저장
            window.loginBreathingInterval = null;

            function startPhase(phaseIndex) {
                const phase = phases[phaseIndex];
                const phaseElement = document.getElementById('loginBreathingPhase');
                const countdownElement = document.getElementById('loginBreathingCountdown');
                const progressElement = document.getElementById('loginBreathingProgressBar');

                if (!phaseElement || !countdownElement || !progressElement) return;

                // 현재 단계 설정
                phaseElement.textContent = phase.name;
                countdownElement.style.color = phase.color;
                countdownElement.textContent = phase.duration;

                // 프로그레스 바 초기화
                progressElement.style.width = '0%';
                progressElement.style.background = phase.color;

                let timeLeft = phase.duration;
                const totalDuration = phase.duration;

                // 카운트다운 타이머
                countdownInterval = setInterval(() => {
                    timeLeft--;
                    countdownElement.textContent = timeLeft;

                    // 프로그레스 바 업데이트
                    const progress = ((totalDuration - timeLeft) / totalDuration) * 100;
                    progressElement.style.width = progress + '%';

                    if (timeLeft <= 0) {
                        clearInterval(countdownInterval);
                        currentPhase++;

                        if (currentPhase < phases.length) {
                            // 다음 단계 시작
                            setTimeout(() => startPhase(currentPhase), 500);
                        } else {
                            // 모든 단계 완료
                            phaseElement.textContent = '완료!';
                            countdownElement.textContent = '✅';
                            progressElement.style.width = '100%';
                            progressElement.style.background = '#32CD32';

                            // 호흡법 완료 처리
                            if (!isBreathingCompleted) {
                                isBreathingCompleted = true;
                                handleBreathingComplete('login');
                            }
                        }
                    }
                }, 1000);

                // 타이머 참조 저장
                window.loginBreathingInterval = countdownInterval;
            }

            // 첫 단계 시작
            startPhase(0);
        }

        // 호흡법 완료 처리 함수
        async function handleBreathingComplete(type) {
            // 비로그인 상태이면 패스
            if (!currentUser) {
                return;
            }

            const today = new Date().toDateString();
            const lastBreathingDate = userData.lastBreathingDate ? new Date(userData.lastBreathingDate).toDateString() : null;

            try {
                // 데이터베이스에서 오늘의 실제 호흡법 횟수 조회
                const currentCount = await getTodayBreathingCount();
                const todayBreathingCount = currentCount + 1; // 이번 호흡법 포함

                userData.dailyBreathingCount = todayBreathingCount;
                userData.lastBreathingDate = new Date().toISOString();

                // 횟수별 포인트 및 메시지 계산
                let breathingBonus = 0;
                let motivationMessage = '';

                if (type === 'wisdom') {
                    // 명언 팝업 호흡법 (출석 시): 항상 5점
                    breathingBonus = 5;

                    if (todayBreathingCount === 1) {
                        motivationMessage = '🌟 첫 명상 호흡법! 마음이 차분해지고 있어요.';
                    } else if (todayBreathingCount === 3) {
                        motivationMessage = '🔥 오늘 3번째 호흡법! 꾸준함이 대단해요!';
                    } else if (todayBreathingCount === 5) {
                        motivationMessage = '🏆 오늘 5번째 호흡법! 명상의 달인이 되었어요!';
                    } else if (todayBreathingCount === 10) {
                        motivationMessage = '💎 오늘 10번째 호흡법! 당신의 정신력은 초인적이에요!';
                    } else {
                        const messages = [
                            '🌬️ 호흡법 완료! 마음이 한결 차분해졌어요.',
                            '🧘 호흡법 성공! 내면의 평화를 찾고 있어요.',
                            '✨ 호흡법 완료! 꾸준한 연습이 빛을 발하고 있어요.'
                        ];
                        motivationMessage = messages[Math.floor(Math.random() * messages.length)];
                    }
                } else {
                    // 로그인 호흡법: 항상 3점
                    breathingBonus = 3;

                    if (todayBreathingCount === 1) {
                        motivationMessage = '🌟 오늘의 첫 호흡법! 좋은 시작이에요.';
                    } else if (todayBreathingCount === 3) {
                        motivationMessage = '🔥 오늘 3번째 호흡법! 멋진 습관이군요!';
                    } else {
                        motivationMessage = '🌬️ 호흡법 완료! 꾸준함이 자랑스러워요.';
                    }
                }

                // 1. Create a temporary updatedData object
                const updatedData = { ...userData };

                // 2. Apply changes to the temporary object
                updatedData.dailyBreathingCount = todayBreathingCount;
                updatedData.lastBreathingDate = new Date().toISOString();
                updatedData.breathingPoints = (updatedData.breathingPoints || 0) + breathingBonus;
                updatedData.points += breathingBonus;
                updatedData.totalPoints = (updatedData.totalPoints || 0) + breathingBonus;
                updatedData.lastBreathingTime = new Date().toISOString();

                // 3. Save the explicit data object
                await saveUserDataToSupabase(updatedData);

                // 4. If successful, update the global state
                Object.assign(userData, updatedData);

                // 5. Update UI and save history
                if (window.todaysBreathingPointsCache !== undefined) {
                    window.todaysBreathingPointsCache += breathingBonus;
                }
                const breathingType = type === 'wisdom' ? '로그인 명상 호흡 완료' : '명상 호흡 완료';
                const breathingDescription = type === 'wisdom' ? '로그인 명상 호흡법' : '명상 호흡법';
                await savePointHistory(breathingType, breathingBonus, `${breathingDescription} 완료`);

                updateUI();
                updateDailyPoints();
                updateTodaysBreathingPointsCache();

                // 동기부여 메시지 표시
                if (motivationMessage) {
                    setTimeout(() => {
                        showBreathingMotivation(motivationMessage, breathingBonus, todayBreathingCount);
                    }, 500);
                }

                console.log(`호흡법 완료! ${breathingBonus}점 획득 (오늘 ${todayBreathingCount}번째)`);

            } catch (error) {
                console.error('호흡법 포인트 저장 오류:', error);
            }
        }

        // 호흡법 동기부여 메시지 표시 함수
        function showBreathingMotivation(message, points, count) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 60%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10001; // 명언 팝업보다 위에 표시
                text-align: center;
                font-size: 1rem;
                max-width: 300px;
                animation: breathingMotivationPop 0.5s ease-out;
            `;

            // 애니메이션 추가
            const style = document.createElement('style');
            style.textContent = `
                @keyframes breathingMotivationPop {
                    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
                    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                }
                @keyframes breathingMotivationSlideOut {
                    0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                    100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
                }
            `;
            document.head.appendChild(style);

            modal.innerHTML = `
                <div style="font-size: 1.2rem; margin-bottom: 10px;">🌬️ 호흡법 완료!</div>
                <div style="margin-bottom: 8px;">${message}</div>
                <div style="font-size: 0.9rem; opacity: 0.9;">
                    ${points}점 획득 (오늘 ${count}번째)
                </div>
            `;
            document.body.appendChild(modal);

            // 3초 후 자동으로 제거
            setTimeout(() => {
                modal.style.animation = 'breathingMotivationSlideOut 0.3s ease-in forwards';
                setTimeout(() => {
                    modal.remove();
                    style.remove();
                }, 300);
            }, 3000);
        }

        // 동기부여 메시지 표시 함수
        function showMotivationalMessage(type) {
            const messages = {
                attendance: [
                    "🎉 출석 완료! 꾸준함이 당신을 더 강하게 만듭니다!",
                    "✨ 오늘도 출석! 당신의 평온한 여정이 계속되고 있어요!",
                    "🌟 출석 성공! 작은 습관이 큰 변화를 만듭니다!",
                    "💪 출석 완료! 당신의 의지가 대단해요!",
                    "🔥 출석 성공! 평온한 하루의 시작이에요!"
                ],
                breathing: [
                    "🌬️ 호흡법 완료! 마음이 차분해지고 있어요.",
                    "🧘 호흡 성공! 스트레스가 줄어들고 있어요.",
                    "🕊️ 호흡 완료! 평온함이 찾아오고 있어요.",
                    "💨 호흡법 성공! 마음의 안정을 되찾았어요.",
                    "🌿 호흡 완료! 내면의 평화를 느끼세요."
                ],
                levelUp: [
                    "🎉 레벨업! 당신의 평온함이 한 단계 성장했어요!",
                    "✨ 레벨업! 정서적 독립에 한 걸음 더 가까워졌어요!",
                    "🌟 레벨업! 당신의 노력이 빛을 발하고 있어요!",
                    "💪 레벨업! 평온한 삶의 전문가가 되어가고 있어요!",
                    "🏆 레벨업! 당신의 인내심이 결실을 맺었어요!"
                ],
                points: [
                    "💰 포인트 획득! 당신의 노력이 보상받고 있어요!",
                    "✨ 포인트 획득! 작은 성공이 모여 큰 성과를 만듭니다!",
                    "🌟 포인트 획득! 당신의 꾸준함이 빛나고 있어요!",
                    "💎 포인트 획득! 평온한 삶의 투자가 되고 있어요!",
                    "🏆 포인트 획득! 당신의 성장이 눈에 띄네요!"
                ],
                allChecklists: [
                    "🎉 모든 체크리스트 완료! 오늘 당신은 정말 대단해요!",
                    "✨ 완벽한 하루! 당신의 평온함이 빛나고 있어요!",
                    "🌟 모든 훈련 완료! 당신의 의지가 정말 대단해요!",
                    "💪 전부 성공! 평온한 삶의 주인공이 되었어요!",
                    "🏆 완벽한 성과! 당신의 노력이 결실을 맺었어요!"
                ]
            };

            const messageList = messages[type] || [];
            if (messageList.length > 0) {
                const randomMessage = messageList[Math.floor(Math.random() * messageList.length)];
                
                // 메시지 표시를 위한 모달 생성
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    color: white;
                    padding: 20px;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    z-index: 9999; // 명언 팝업(10000)보다 낮게 설정
                    text-align: center;
                    font-size: 1.1rem;
                    max-width: 300px;
                    animation: motivationPop 0.5s ease-out;
                `;

                // 애니메이션 추가
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes motivationPop {
                        0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
                        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);

                modal.innerHTML = randomMessage;
                document.body.appendChild(modal);

                // 3초 후 자동으로 제거
                setTimeout(() => {
                    modal.remove();
                    style.remove();
                }, 3000);
            }
        }

        // 랜덤 보상
        function getRandomReward() {
            const rewards = [
                "따뜻한 차 한잔의 여유",
                "좋아하는 노래 3곡 듣기",
                "15분 추가 휴식",
                "작은 간식 먹기",
                "오늘은 칭찬 일기 쓰지 않기"
            ];
            return rewards[Math.floor(Math.random() * rewards.length)];
        }

        // 호흡법 핸들러
        function handleBreathing() {
            // 비로그인 상태에서는 사용 불가
            if (!currentUser || !supabaseClient) {
                alert('로그인이 필요합니다!');
                return;
            }

            // 로그인 호흡법 팝업 표시
            showLoginWisdomQuote();
        }

        // 호흡법 타이머
        function startBreathing() {
            alert("🌬️ 4초 들이마시기 → 7초 참기 → 8초 내쉬기\n\n지금 시작합니다. 화면을 보며 따라해주세요!");

            const steps = [
                { text: "들이마시기 (4초)", duration: 4000 },
                { text: "참기 (7초)", duration: 7000 },
                { text: "내쉬기 (8초)", duration: 8000 }
            ];
            let stepIndex = -1;

            function nextStep() {
                stepIndex++;
                if (stepIndex < steps.length) {
                    const currentStep = steps[stepIndex];
                    alert(currentStep.text);
                    setTimeout(nextStep, currentStep.duration);
                } else {
                    // 호흡법 완료
                    const breathingReward = 5;
                    alert(`✅ 호흡법 완료! 평온 포인트 ${breathingReward}점 획득!\n이제 조금 더 평온해지셨나요?`);
                    showMotivationalMessage('breathing');

                    (async () => {
                        const updatedData = { ...userData };
                        updatedData.points += breathingReward;
                        updatedData.totalPoints = (updatedData.totalPoints || 0) + breathingReward;
                        updatedData.breathingPoints = (updatedData.breathingPoints || 0) + breathingReward;
                        updatedData.lastBreathingTime = new Date().toISOString();

                        try {
                            await saveUserDataToSupabase(updatedData);
                            Object.assign(userData, updatedData); // 성공 시에만 전역 상태 업데이트

                            await savePointHistory('명상 호흡 완료', breathingReward, '명상 호흡법 완료');
                            updateUI();
                            updateDailyPoints();
                            await checkAndHandleLevelUp();
                        } catch (error) {
                            console.error("호흡법 포인트 저장 오류:", error);
                            alert("데이터 저장에 실패했습니다. 다시 시도해주세요.");
                        }
                    })();
                }
            }
            nextStep();
        }

        // 감정 일기 저장
        async function saveDiary() {
            if (!currentUser || !supabaseClient) {
                alert('로그인이 필요합니다!');
                return;
            }

            const otherPersonAction = document.getElementById('otherPersonAction').value;
            const myReaction = document.getElementById('myReaction').value;
            const reinterpretation = document.getElementById('reinterpretation').value;

            if(!otherPersonAction || !myReaction || !reinterpretation) {
                alert('모든 필드를 작성해주세요!');
                return;
            }

            try {
                // Supabase에 일기 저장
                const { data, error } = await supabaseClient
                    .from('emotion_diaries')
                    .insert([{
                        user_id: currentUser.id,
                        other_person_action: otherPersonAction,
                        my_reaction: myReaction,
                        reinterpretation: reinterpretation
                    }])
                    .select()
                    .single();

                if (error) {
                    console.error('일기 저장 오류:', error);
                    alert('일기 저장에 실패했습니다.');
                    return;
                }

                console.log('일기 저장 성공:', data);

                // 체크박스 자동 완료
                document.getElementById('evening2').checked = true;
                await handleCheck({target: document.getElementById('evening2')});

                // 입력 필드 초기화
                document.getElementById('otherPersonAction').value = '';
                document.getElementById('myReaction').value = '';
                document.getElementById('reinterpretation').value = '';

                // 일기 목록 새로고침
                await loadDiaries();
                alert('✅ 감정 일기가 저장되었습니다!');

            } catch (error) {
                console.error('일기 저장 시스템 오류:', error);
                alert('일기 저장에 실패했습니다.');
            }
        }

        // 일기 목록 표시
        function displayDiaries() {
            const diaryList = document.getElementById('diaryList');
            diaryList.innerHTML = '';

            console.log('displayDiaries 호출됨, diaries 길이:', diaries.length);
            console.log('diaries 내용:', diaries);

            if(diaries.length === 0) {
                diaryList.innerHTML = '<p style="color: #666;">저장된 일기가 없습니다</p>';
                return;
            }

            // 최근 3개만 표시
            const visibleDiaries = diaries.slice(0, 3);
            const hiddenDiaries = diaries.slice(3);

            visibleDiaries.forEach(diary => {
                const diaryItem = createDiaryItem(diary);
                diaryList.appendChild(diaryItem);
            });

            // 숨겨진 일기들을 위한 컨테이너
            const hiddenContainer = document.createElement('div');
            hiddenContainer.id = 'hiddenDiariesContainer';
            hiddenContainer.style.display = 'none';

            hiddenDiaries.forEach(diary => {
                const diaryItem = createDiaryItem(diary);
                hiddenContainer.appendChild(diaryItem);
            });

            diaryList.appendChild(hiddenContainer);

            // 더보기 버튼 추가 (3개 초과 시에만)
            if (hiddenDiaries.length > 0) {
                const moreButton = document.createElement('button');
                moreButton.className = 'btn';
                moreButton.id = 'showMoreDiariesBtn';
                moreButton.textContent = `더보기 (${hiddenDiaries.length}개)`;
                moreButton.style.width = '100%';
                moreButton.style.marginTop = '10px';
                moreButton.onclick = toggleMoreDiaries;
                diaryList.appendChild(moreButton);
            }
        }

        // 일기 아이템 생성 함수
        function createDiaryItem(diary) {
            const diaryItem = document.createElement('div');
            diaryItem.className = 'diary-item';

            // 날짜와 삭제 버튼을 위한 컨테이너
            const headerDiv = document.createElement('div');
            headerDiv.style.display = 'flex';
            headerDiv.style.justifyContent = 'space-between';
            headerDiv.style.alignItems = 'flex-start';
            headerDiv.style.marginBottom = '8px';

            // 날짜 표시
            const dateDiv = document.createElement('div');
            dateDiv.style.fontSize = '0.8rem';
            dateDiv.style.color = '#666';
            dateDiv.textContent = `📅 ${diary.date}`;

            // 삭제 버튼
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.title = '일기 삭제';
            deleteBtn.textContent = '🗑️';
            deleteBtn.onclick = function() {
                deleteDiary(diary.id);
            };

            headerDiv.appendChild(dateDiv);
            headerDiv.appendChild(deleteBtn);

            // 내용 추가
            const contentDiv1 = document.createElement('div');
            contentDiv1.innerHTML = `<strong>👥 타인:</strong> ${diary.otherPersonAction}`;

            const contentDiv2 = document.createElement('div');
            contentDiv2.innerHTML = `<strong>👨 나:</strong> ${diary.myReaction}`;

            const contentDiv3 = document.createElement('div');
            contentDiv3.innerHTML = `<strong>💡 재해석:</strong> <span style="color: var(--success);">${diary.reinterpretation}</span>`;

            diaryItem.appendChild(headerDiv);
            diaryItem.appendChild(contentDiv1);
            diaryItem.appendChild(contentDiv2);
            diaryItem.appendChild(contentDiv3);

            return diaryItem;
        }

        // 더보기/접기 토글 함수
        function toggleMoreDiaries() {
            const hiddenContainer = document.getElementById('hiddenDiariesContainer');
            const moreButton = document.getElementById('showMoreDiariesBtn');
            
            if (hiddenContainer.style.display === 'none') {
                hiddenContainer.style.display = 'block';
                moreButton.textContent = '접기';
            } else {
                hiddenContainer.style.display = 'none';
                const hiddenCount = diaries.length - 3;
                moreButton.textContent = `더보기 (${hiddenCount}개)`;
            }
        }

        // 개별 일기 삭제
        async function deleteDiary(diaryId) {
            if(!confirm('정말 이 감정 일기를 삭제하시겠습니까?')) {
                return;
            }

            if (currentUser && supabaseClient) {
                // DB에서 해당 일기 삭제
                try {
                    const { error } = await supabaseClient
                        .from('emotion_diaries')
                        .delete()
                        .eq('id', diaryId)
                        .eq('user_id', currentUser.id); // 보안: 자신의 일기만 삭제 가능

                    if (error) {
                        console.error('일기 삭제 오류:', error);
                        alert('일기 삭제에 실패했습니다.');
                        return;
                    }
                } catch (error) {
                    console.error('일기 삭제 시스템 오류:', error);
                    alert('일기 삭제에 실패했습니다.');
                    return;
                }
            }

            // 배열에서 해당 일기 제거
            diaries = diaries.filter(diary => diary.id !== diaryId);
            displayDiaries();
            alert('일기가 삭제되었습니다.');
        }

        // 일기 삭제
        async function clearDiaries() {
            if(confirm('정말 모든 감정 일기를 삭제하시겠습니까?')) {
                if (currentUser && supabaseClient) {
                    // DB에서 일기 삭제
                    try {
                        const { error } = await supabaseClient
                            .from('emotion_diaries')
                            .delete()
                            .eq('user_id', currentUser.id);

                        if (error) {
                            console.error('일기 삭제 오류:', error);
                            alert('일기 삭제에 실패했습니다.');
                            return;
                        }
                    } catch (error) {
                        console.error('일기 삭제 시스템 오류:', error);
                        alert('일기 삭제에 실패했습니다.');
                        return;
                    }
                }
                diaries = [];
                displayDiaries();
                alert('모든 일기가 삭제되었습니다.');
            }
        }

        // 모든 포인트와 레벨 리셋 함수
        async function resetAllPointsAndLevels() {
            if (confirm('정말 모든 포인트와 레벨을 리셋하시겠습니까?\n⚠️ 이 작업은 되돌릴 수 없습니다.')) {
                const updatedData = { ...userData };

                // 모든 포인트와 레벨을 0으로 초기화
                updatedData.points = 0;
                updatedData.totalPoints = 0;
                updatedData.level = 1;
                updatedData.breathingPoints = 0;
                updatedData.completedToday = [];
                updatedData.lastCheck = null;

                if (currentUser && supabaseClient) {
                    try {
                        await saveUserDataToSupabase(updatedData);
                        Object.assign(userData, updatedData); // 성공 시에만 전역 상태 업데이트

                        // UI 업데이트
                        updateUI();
                        updateLevelProgress();
                        updateDailyPoints();
                        alert('✅ 모든 포인트와 레벨이 리셋되었습니다.\n오늘부터 새로 시작하세요!');
                    } catch (error) {
                        console.error("리셋 오류:", error);
                        alert("데이터 리셋에 실패했습니다. 다시 시도해주세요.");
                    }
                }
            }
        }

        
        
        // 날짜 변경 확인 및 completedToday 배열 초기화
        async function checkDateChangeAndReset() {
            const today = new Date();

            const formatter = new Intl.DateTimeFormat('en-CA', {
                timeZone: 'Asia/Seoul',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });

            const todayKST = formatter.format(today);
            const isSameDay = userData.lastCheck && todayKST === userData.lastCheck;

            if (userData.lastCheck && !isSameDay) {
                const updatedData = { ...userData };
                updatedData.completedToday = [];
                updatedData.breathingPoints = 0;

                if (currentUser && supabaseClient) {
                    try {
                        await saveUserDataToSupabase(updatedData);
                        Object.assign(userData, updatedData);

                        document.querySelectorAll('.check-input').forEach(checkbox => {
                            checkbox.disabled = false;
                            checkbox.checked = false;
                            checkbox.removeAttribute('title');
                            checkbox.parentElement.classList.remove('completed');
                        });

                        updateUI();
                        console.log('날짜 변경으로 completedToday 배열이 초기화되고 모든 체크박스가 활성화되었습니다.');
                    } catch (error) {
                        console.error("일일 데이터 리셋 오류:", error);
                    }
                }
            } else {
                console.log('오늘 날짜이거나 첫 사용입니다. 체크리스트 상태를 유지합니다.');
            }
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', async function() {
            // 폼 이벤트 리스너 추가
            document.getElementById('loginFormElement')?.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('로그인 폼 제출됨');
                login();
            });

            document.getElementById('signupFormElement')?.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('회원가입 폼 제출됨');
                signup();
            });

            // Supabase 초기화
            const supabaseInitialized = await initializeSupabase();
            if (!supabaseInitialized) {
                console.error('Supabase 초기화에 실패했습니다. 인증 기능이 작동하지 않을 수 있습니다.');
            }

            // 인증 상태 변경 리스너 비활성화 - checkAuthState만으로 처리
            // onAuthStateChange 리스너는 페이지 새로고침 시 데이터 리셋 문제를 일으킴

            // 초기 인증 상태 확인 (내부에서 UI 업데이트 처리)
            await checkAuthState();

            // 출석 상태 최종 확인 및 UI 동기화
            if (currentUser && supabaseClient) {
                console.log('🔍 페이지 로드 시 출석 상태 최종 확인');
                // 데이터 로드 후 약간의 지연을 두고 출석 상태 재확인
                setTimeout(() => {
                    updateAttendanceButton();
                    console.log('✅ 출석 버튼 상태 동기화 완료');
                }, 500);
            }

            // 오늘의 호흡법 포인트 캐시 초기화
            window.todaysBreathingPointsCache = undefined;

            // 일기 섹션 초기 UI 설정
            const diaryLoginPrompt = document.getElementById('diaryLoginPrompt');
            const diaryForm = document.getElementById('diaryForm');
            const recentDiarySection = document.getElementById('recentDiarySection');
            if (currentUser && supabaseClient) {
                diaryLoginPrompt.style.display = 'none';
                diaryForm.style.display = 'block';
                // 최근 감정 일기 섹션 표시
                if (recentDiarySection) recentDiarySection.style.display = 'block';
            } else {
                diaryLoginPrompt.style.display = 'block';
                diaryForm.style.display = 'none';
                // 최근 감정 일기 섹션 숨기기
                if (recentDiarySection) recentDiarySection.style.display = 'none';
            }

            // 체크리스트 섹션 초기 UI 설정
            const isLoggedIn = currentUser && supabaseClient;
            const checklistMessage = document.getElementById('checklistMessage');
            const checkboxes = document.querySelectorAll('.check-input');
            const emergencyBtn = document.querySelector('.emergency-btn');

            if (checklistMessage) {
                if (isLoggedIn) {
                    checklistMessage.style.display = 'none';
                } else {
                    checklistMessage.innerHTML = '🔒 체크리스트를 사용하려면 로그인이 필요합니다.<br>모든 데이터는 안전하게 데이터베이스에 저장됩니다.';
                    checklistMessage.style.display = 'block';
                }
            }

            checkboxes.forEach(checkbox => {
                checkbox.disabled = !isLoggedIn;
                if (!isLoggedIn) {
                    checkbox.checked = false;
                    checkbox.setAttribute('title', '로그인이 필요합니다');
                    checkbox.parentElement.classList.remove('completed');
                }
            });

            if (emergencyBtn) {
                emergencyBtn.disabled = !isLoggedIn;
            }
        });

        // 인증 상태 확인
        async function checkAuthState() {
            console.group('🔐 인증 상태 확인 시작');

            if (!supabaseClient || !supabaseClient.auth) {
                console.error('❌ Supabase 클라이언트 또는 auth 모듈을 사용할 수 없음');
                return;
            }

            try {
                console.log('📋 세션 조회 시작...');
                const { data: { session }, error } = await supabaseClient.auth.getSession();

                if (error) {
                    console.error('❌ 세션 조회 실패:', error.message);
                    return;
                }

                console.log('📋 세션 조회 결과:', session ? '세션 있음' : '세션 없음');

                if (session && session.user) {
                    console.log('✅ 유효한 세션 발견:', {
                        userId: session.user.id,
                        email: session.user.email,
                        expiresAt: new Date(session.expires_at * 1000)
                    });

                    // 세션이 있으면 자동으로 데이터 로드 (새로고침 시 데이터 유지)
                    currentUser = session.user;
                    document.getElementById('userEmail').textContent = session.user.email;
                    document.getElementById('userSection').style.display = 'flex';
                    document.getElementById('loginSection').style.display = 'none';

                    try {
                        console.log('🔄 사용자 데이터 자동 로드 시작...');

                        // 데이터 로드 전 상태 기록
                        console.log('📊 데이터 로드 전:', {
                            attendanceCount: userData.attendanceCount,
                            level: userData.level,
                            points: userData.points,
                            completedToday: userData.completedToday
                        });

                        await loadUserData();
                        await loadDiaries();

                        // 데이터 로드 후 상태 기록
                        console.log('📊 데이터 로드 후:', {
                            attendanceCount: userData.attendanceCount,
                            level: userData.level,
                            points: userData.points,
                            completedToday: userData.completedToday
                        });

                        console.log('✅ UI 업데이트 시작...');
                        updateUI();

                        // 자동 로그인 시에도 명언 팝업 표시
                        showLoginWisdomQuote();

                        console.log('✅ 세션 확인 및 데이터 자동 로드 완료:', session.user.email);

                    } catch (error) {
                        console.error('❌ 데이터 자동 로드 실패:', error);
                        console.error('에러 상세:', error.stack);
                        // 데이터 로드 실패시에도 세션은 유지
                        showMessage('loginMessage', '데이터 로드에 실패했습니다. 다시 시도해주세요.', 'error');
                    }
                } else {
                    console.log('⚠️ 세션 없음 - 비로그인 상태로 초기화');
                    // 비로그인 상태인 경우 UI만 초기화 (데이터는 보존)
                    currentUser = null;
                    document.getElementById('userSection').style.display = 'none';
                    document.getElementById('loginSection').style.display = 'block';

                    // userData를 기본값으로 초기화
                    Object.assign(userData, {
                        attendanceCount: 0,
                        level: 1,
                        points: 0,
                        lastCheck: null,
                        completedToday: [],
                        totalPoints: 0,
                        lastAttendanceDate: null,
                        attendancePoints: 0,
                        breathingPoints: 0
                    });

                    console.log('🔄 비로그인 상태 UI 업데이트');
                    updateUI();
                    console.log('✅ 비로그인 상태 초기화 완료');
                }
            } catch (error) {
                console.error('❌ 인증 상태 확인 시스템 오류:', error);
                console.error('에러 상세:', error.stack);
            }

            console.groupEnd();
        }

        // 명언 팝업 닫기 함수
        function closeWisdomPopup() {
            // 타이머 정리
            if (window.wisdomModalTimer) {
                clearTimeout(window.wisdomModalTimer);
                window.wisdomModalTimer = null;
            }

            // 호흡법 타이머 정리
            if (window.wisdomBreathingInterval) {
                clearInterval(window.wisdomBreathingInterval);
                window.wisdomBreathingInterval = null;
            }

            // 팝업 제거
            if (window.wisdomModalRef) {
                window.wisdomModalRef.style.animation = 'wisdomSlideOut 0.3s ease-in forwards';
                setTimeout(() => {
                    if (window.wisdomModalRef) {
                        window.wisdomModalRef.remove();
                        window.wisdomModalRef = null;
                    }
                    if (window.wisdomModalStyleRef) {
                        window.wisdomModalStyleRef.remove();
                        window.wisdomModalStyleRef = null;
                    }
                }, 300);
            }
        }

        // 로그인 명언 팝업 닫기 함수
        function closeLoginWisdomPopup() {
            // 타이머 정리
            if (window.loginWisdomModalTimer) {
                clearTimeout(window.loginWisdomModalTimer);
                window.loginWisdomModalTimer = null;
            }

            // 호흡법 타이머 정리
            if (window.loginBreathingInterval) {
                clearInterval(window.loginBreathingInterval);
                window.loginBreathingInterval = null;
            }

            // 팝업 제거
            if (window.loginWisdomModalRef) {
                window.loginWisdomModalRef.style.animation = 'wisdomSlideOut 0.3s ease-in forwards';
                setTimeout(() => {
                    if (window.loginWisdomModalRef) {
                        window.loginWisdomModalRef.remove();
                        window.loginWisdomModalRef = null;
                    }
                }, 300);
            }
        }

        // 날짜 및 시간 표시
        function updateDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const date = now.getDate();
            const day = ['일', '월', '화', '수', '목', '금', '토'][now.getDay()];
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            const datetimeString = `${year}년 ${month}월 ${date}일 ${day}요일 ${hours}:${minutes}:${seconds}`;
            document.getElementById('datetime').textContent = datetimeString;
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);

            // Display a random quote on page load
            displayRandomQuote();
        });
    </script>
</body>
</html>
