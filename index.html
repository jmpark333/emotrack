<!DOCTYPE html>
<!--
  ì •ì„œì  ë…ë¦½ íŠ¸ë˜ì»¤ v1.4.1
  - ëª¨ë“  ë¡œê·¸ì¸ ì„±ê³µ ë©”ì‹œì§€ ì œê±° ì™„ë£Œ
  - ë¡œê·¸ì¸ ì„±ê³µ! ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... ë©”ì‹œì§€ ì œê±°ë¨
-->
<html>
<head>
    <title>ì •ì„œì  ë…ë¦½ íŠ¸ë˜ì»¤</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7?v=1.4.1"></script>
    <script>
        // Supabase SDK ë¡œë”© í™•ì¸
        console.log('Supabase SDK ë¡œë”© ìƒíƒœ:', typeof supabase);
        console.log('Supabase SDK ìƒì„¸ ì •ë³´:', supabase);

        // SDKê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
        function waitForSupabase(callback, maxAttempts = 50) {
            let attempts = 0;

            function check() {
                attempts++;
                console.log(`Supabase SDK í™•ì¸ ì‹œë„ ${attempts}/${maxAttempts}:`, typeof supabase);

                if (typeof supabase !== 'undefined') {
                    console.log('âœ… Supabase SDK ë¡œë“œ ì™„ë£Œ');
                    console.log('Supabase ë²„ì „:', supabase.version);
                    console.log('Supabase auth ê°ì²´:', supabase.auth);
                    console.log('Supabase createClient í•¨ìˆ˜:', typeof supabase.createClient);
                    callback();
                } else if (attempts < maxAttempts) {
                    setTimeout(check, 100);
                } else {
                    console.error('âŒ Supabase SDK ë¡œë“œ ì‹¤íŒ¨');
                }
            }

            check();
        }
    </script>
    <style>
        :root {
            --primary: #6C5CE7;
            --secondary: #A29BFE;
            --success: #00B894;
            --warning: #FDCB6E;
            --danger: #FF7675;
            --light: #DFE6E9;
            --dark: #2D3436;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            color: var(--dark);
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            color: var(--primary);
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            flex: 1;
            margin: 0 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.6s, box-shadow 0.2s;
            transform-style: preserve-3d;
            position: relative;
            height: 120px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-card.flipped {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 15px;
            padding: 15px;
            box-sizing: border-box;
        }

        .card-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            padding: 10px;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .check-item {
            background: var(--light);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        .check-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .check-item.completed {
            background: rgba(0,184,148,0.1);
            border-left: 5px solid var(--success);
        }
        .check-input {
            margin-right: 10px;
            transform: scale(1.3);
        }
        .emergency-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            margin: 15px 0;
            transition: all 0.3s;
        }
        .emergency-btn:hover {
            background: #e84393;
            transform: scale(1.02);
        }
        .progress-bar {
            height: 8px;
            background: var(--light);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--warning));
            transition: width 0.5s;
        }
        .diary-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(108,92,231,0.1);
            border-radius: 15px;
        }
        .diary-input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 0.9rem;
        }
        .diary-label {
            display: block;
            font-size: 0.8rem;
            color: #666;
            margin-top: 10px;
            margin-bottom: 2px;
        }
        .diary-item {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            font-size: 0.85rem;
        }
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 5px 0;
        }
        .btn-danger {
            background: var(--danger);
        }

        .delete-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1rem;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
            opacity: 0.6;
        }

        .delete-btn:hover {
            background: var(--danger);
            color: white;
            opacity: 1;
            transform: scale(1.1);
        }
        .badge {
            display: inline-block;
            background: var(--warning);
            color: var(--dark);
            padding: 3px 10px;
            border-radius: 15px;
            margin: 3px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        /* ëª¨ë°”ì¼ ë·°ë¥¼ ìœ„í•œ ì¶”ê°€ ìŠ¤íƒ€ì¼ */
        body.mobile-view {
            padding: 10px;
        }
        
        body.mobile-view .container {
            padding: 15px;
        }
        
        body.mobile-view .header h1 {
            font-size: 1.5rem;
        }
        
        body.mobile-view .stat-card {
            padding: 12px 8px;
            margin: 0 3px;
        }
        
        body.mobile-view .stat-value {
            font-size: 1.2rem;
        }
        
        body.mobile-view .check-item {
            padding: 10px;
            margin-bottom: 6px;
        }
        
        body.mobile-view .check-input {
            transform: scale(1.2);
        }
        
        body.mobile-view .diary-input {
            font-size: 1rem;
            padding: 10px;
        }
        
        body.mobile-view .btn, body.mobile-view .emergency-btn {
            padding: 12px 15px;
            font-size: 1rem;
        }
        
        body.mobile-view .diary-item {
            font-size: 0.9rem;
            padding: 12px;
        }
        
        /* í™ˆ í™”ë©´ ì•„ì´ì½˜ ì¶”ê°€ë¥¼ ìœ„í•œ ë©”íƒ€ íƒœê·¸ */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #8B7CF6;
                --secondary: #A29BFE;
            }
        }

        /* ì¸ì¦ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .close {
            position: absolute;
            right: 15px;
            top: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .close:hover {
            color: #000;
        }

        #authTabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--light);
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: bold;
        }

        .auth-form {
            text-align: center;
        }

        .auth-form h2 {
            margin-bottom: 20px;
            color: var(--dark);
        }

        .auth-form input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .auth-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .auth-btn:hover {
            background: var(--secondary);
        }

        .auth-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .auth-message.success {
            background: var(--success);
            color: white;
        }

        .auth-message.error {
            background: var(--danger);
            color: white;
        }

        #userSection {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }

        #loginSection {
            text-align: center;
            margin-top: 10px;
        }
    </style>
    
    <!-- í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ê¸° ìœ„í•œ ì„¤ì • -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ì •ì„œì  ë…ë¦½ íŠ¸ë˜ì»¤">
    <meta name="mobile-web-app-capable" content="yes">
    </head>
<body>
    <div class="container">
        <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… ëª¨ë‹¬ -->
        <div id="authModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeAuthModal()">&times;</span>
                <div id="authTabs">
                    <button class="tab-btn active" onclick="switchTab('login')">ë¡œê·¸ì¸</button>
                    <button class="tab-btn" onclick="switchTab('signup')">íšŒì›ê°€ì…</button>
                </div>

                <!-- ë¡œê·¸ì¸ í¼ -->
                <div id="loginForm" class="auth-form">
                    <h2>ë¡œê·¸ì¸</h2>
                    <form id="loginFormElement">
                        <label for="loginEmail">ì´ë©”ì¼</label>
                        <input type="email" id="loginEmail" placeholder="ì´ë©”ì¼" required autocomplete="email">
                        <label for="loginPassword">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" required autocomplete="current-password">
                        <button type="submit" class="auth-btn">ë¡œê·¸ì¸</button>
                    </form>
                    <div id="loginMessage" class="auth-message"></div>
                </div>

                <!-- íšŒì›ê°€ì… í¼ -->
                <div id="signupForm" class="auth-form" style="display: none;">
                    <h2>íšŒì›ê°€ì…</h2>
                    <form id="signupFormElement">
                        <label for="signupEmail">ì´ë©”ì¼</label>
                        <input type="email" id="signupEmail" placeholder="ì´ë©”ì¼" required autocomplete="email">
                        <label for="signupPassword">ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label>
                        <input type="password" id="signupPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" required autocomplete="new-password">
                        <label for="signupConfirmPassword">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <input type="password" id="signupConfirmPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" required autocomplete="new-password">
                        <button type="submit" class="auth-btn">íšŒì›ê°€ì…</button>
                    </form>
                    <div id="signupMessage" class="auth-message"></div>
                </div>
            </div>
        </div>

        <div class="header">
            <h1>ğŸ§˜â€â™‚ï¸ ì •ì„œì  ë…ë¦½ íŠ¸ë˜ì»¤</h1>
            <p>ì˜¤ëŠ˜ë„ ë‹¹ì‹ ì˜ í‰ì˜¨í•¨ì„ ì§€í‚¤ëŠ” í•˜ë£¨ê°€ ë˜ê¸¸</p>
            <div id="userSection" style="display: none;">
                <span id="userEmail"></span>
                <button onclick="logout()" style="margin-left: 10px; padding: 5px 10px; background: var(--danger); color: white; border: none; border-radius: 5px; cursor: pointer;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <div id="loginSection">
                <button onclick="openAuthModal()" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">ë¡œê·¸ì¸/íšŒì›ê°€ì…</button>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card" id="streakCard" onclick="flipCard()" title="í´ë¦­í•˜ì—¬ ì‹œì‘ì¼ í™•ì¸">
                <div class="card-front">
                    <div class="stat-value" id="streak" style="margin-bottom: 5px;">0</div>
                    <div style="font-size: 0.9rem;">ì—°ì† ì¼ìˆ˜</div>
                </div>
                <div class="card-back">
                    <div style="font-size: 0.9rem; font-weight: bold; margin-bottom: 8px;">ğŸ“… ì‹œì‘ì¼</div>
                    <div id="startDateDisplay" style="font-size: 0.8rem; margin-bottom: 10px;">ì‹œì‘ì¼ ì—†ìŒ</div>
                    <button onclick="resetStreak(event)" style="background: #ff6b6b; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.7rem; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#ff5252'" onmouseout="this.style.background='#ff6b6b'">
                        ğŸ”„ ë¦¬ì…‹
                    </button>
                </div>
            </div>
            <div class="stat-card" id="levelCard" onclick="flipLevelCard()" title="í´ë¦­í•˜ì—¬ ë ˆë²¨ ì§„í–‰ë„ í™•ì¸">
                <div class="card-front">
                    <div class="stat-value" id="level" style="margin-bottom: 5px;">1</div>
                    <div style="font-size: 0.9rem;">í‰ì˜¨ ë ˆë²¨</div>
                </div>
                <div class="card-back">
                    <div id="levelProgressDisplay" style="font-size: 1.0rem; font-weight: bold;">ë‹¤ìŒ ë ˆë²¨ê¹Œì§€: 100í¬ì¸íŠ¸</div>
                </div>
            </div>
            <div class="stat-card" id="pointsCard" onclick="flipPointsCard()" title="í´ë¦­í•˜ì—¬ í¬ì¸íŠ¸ ì •ë³´ í™•ì¸">
                <div class="card-front">
                    <div class="stat-value" id="points" style="margin-bottom: 5px;">0</div>
                    <div style="font-size: 0.9rem;">í‰ì˜¨ í¬ì¸íŠ¸</div>
                </div>
                <div class="card-back">
                    <div style="font-size: 1.0rem; font-weight: bold; margin-bottom: 10px;">ğŸ“ˆ í‰ì˜¨ í¬ì¸íŠ¸</div>
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.9);">
                        ì´ íšë“ í¬ì¸íŠ¸
                    </div>
                </div>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress" id="dailyProgress" style="width: 0%"></div>
        </div>
        
        <h3>ğŸŒ… ì•„ì¹¨ í›ˆë ¨</h3>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="morning1">
            <label for="morning1">ê°ì • ë¶„ë¦¬ ì„ ì–¸ ("ì˜¤ëŠ˜ íƒ€ì¸ì˜ ê°ì •ì€ ë‚˜ì˜ ê²ƒì´ ì•„ë‹˜" 3ë²ˆ)</label>
        </div>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="morning2">
            <label for="morning2">ì˜¤ëŠ˜ ì§€í‚¬ í•µì‹¬ ê°€ì¹˜ ì„ íƒ (í‰ì˜¨/ì¡´ì¤‘/ìì¡´ê°)</label>
        </div>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="morning3">
            <label for="morning3">ì˜¤ëŠ˜ì˜ 'ë‚˜ë§Œì˜ 30ë¶„' ê³„íš ì„¸ìš°ê¸°</label>
        </div>
        
        <h3>ğŸŒ ì ì‹¬ í›ˆë ¨</h3>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="noon1">
            <label for="noon1">ë¹„íŒì  ë§ ë“¤ì—ˆì„ ë•Œ "ì´ê±´ ì‚¬ì‹¤ì¸ê°€?" í•„í„°ë§</label>
        </div>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="noon2">
            <label for="noon2">"ì§€ê¸ˆì€ ì–´ë µë‹¤"ê³  ë§í•˜ê¸° (ì•„ë‹ˆì˜¤ ì—°ìŠµ)</label>
        </div>
        
        <h3>ğŸŒ™ ì €ë… í›ˆë ¨</h3>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="evening1">
            <label for="evening1">ê°ì • í­ë°œ ì‹œ 4-7-8 í˜¸í¡ë²• 3íšŒ</label>
        </div>
        
        <div class="check-item">
            <input type="checkbox" class="check-input" id="evening2">
            <label for="evening2">ğŸ“– ê°ì • ì¼ê¸° ì‘ì„±</label>
            <div id="diarySection" style="margin-top: 10px;">
                <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° í‘œì‹œë  ë©”ì‹œì§€ -->
                <div id="diaryLoginPrompt" style="color: #666; padding: 10px; background: #f5f5f5; border-radius: 5px; margin-bottom: 10px;">
                    ê°ì • ì¼ê¸°ë¥¼ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
                </div>
                <!-- ë¡œê·¸ì¸í•œ ê²½ìš° í‘œì‹œë  ì¼ê¸° ì…ë ¥ í¼ -->
                <div id="diaryForm" style="display: none;">
                    <label for="otherPersonAction" class="diary-label">íƒ€ì¸ì˜ í–‰ë™</label>
                    <input type="text" id="otherPersonAction" class="diary-input" placeholder="íƒ€ì¸ì˜ í–‰ë™ (ì˜ˆ: ê³ ì„± ì§ˆë¬¸)" aria-label="íƒ€ì¸ì˜ í–‰ë™">
                    <label for="myReaction" class="diary-label">ë‚´ ì²« ë°˜ì‘</label>
                    <input type="text" id="myReaction" class="diary-input" placeholder="ë‚´ ì²« ë°˜ì‘ (ì˜ˆ: ì£„ì±…ê° + ë¶„ë…¸)" aria-label="ë‚´ ì²« ë°˜ì‘">
                    <label for="reinterpretation" class="diary-label">ì¬í•´ì„</label>
                    <input type="text" id="reinterpretation" class="diary-input" placeholder="ì¬í•´ì„ (ì˜ˆ: ê·¸ë…€ëŠ” ë¶ˆì•ˆí•´ì„œ ê·¸ëŸ° ê±°ì•¼)" aria-label="ì¬í•´ì„">
                    <button class="btn" onclick="saveDiary()">ğŸ’¾ ì €ì¥í•˜ê³  ì²´í¬ ì™„ë£Œ</button>
                </div>
            </div>
        </div>
        
        <div class="check-item">
            <input type="checkbox" class="check-input" id="evening3">
            <label for="evening3">ì˜¤ëŠ˜ ë‚˜ë¥¼ ì§€í‚¨ í–‰ë™ 1ê°€ì§€ ì¹­ì°¬í•˜ê¸°</label>
        </div>
        
        <button class="emergency-btn" onclick="handleBreathing()">
            ğŸš¨ ê¸´ê¸‰ í˜¸í¡ë²• ì‹œì‘ (4-7-8)
        </button>
        
        <div class="diary-section" id="recentDiarySection">
            <h3>ğŸ“š ìµœê·¼ ê°ì • ì¼ê¸°</h3>
            <div id="diaryList"></div>
            <button class="btn btn-danger" onclick="clearDiaries()">ğŸ—‘ï¸ ëª¨ë“  ì¼ê¸° ì‚­ì œ</button>
        </div>
        
        <div class="reward">
            <h3>ğŸ† ì˜¤ëŠ˜ì˜ ë³´ìƒ</h3>
            <div id="badges"></div>
            <p id="rewardText">ëª¨ë“  ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ì™„ë£Œí•˜ë©´ ë³´ìƒì´ ì—´ë¦½ë‹ˆë‹¤!</p>

            <!-- ë¦¬ì…‹ ë²„íŠ¼ ì¶”ê°€ -->
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="resetAllPointsAndLevels()" style="background: var(--danger); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">
                    ğŸ”„ ëª¨ë“  í¬ì¸íŠ¸ì™€ ë ˆë²¨ ë¦¬ì…‹
                </button>
            </div>
        </div>

        <!-- ì˜¤ëŠ˜ íšë“ í¬ì¸íŠ¸ ìƒì„¸ ì •ë³´ -->
        <div class="daily-points-summary" style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 10px; border: 2px solid #dee2e6;">
            <h4 style="margin: 0 0 15px 0; text-align: center; color: #495057; font-size: 1.1rem;">
                ğŸ“Š ì˜¤ëŠ˜ íšë“ í¬ì¸íŠ¸ ìš”ì•½
            </h4>
            <div style="display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div style="text-align: center; min-width: 120px;">
                    <div style="font-size: 1.5rem; margin-bottom: 5px;">ğŸ“‹</div>
                    <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">ì²´í¬ ì™„ë£Œ</div>
                    <div style="font-size: 1.3rem; font-weight: bold; color: #28a745;" id="checklistPoints">0</div>
                    <div style="font-size: 0.8rem; color: #6c757d;">í¬ì¸íŠ¸</div>
                </div>
                <div style="text-align: center; min-width: 120px;">
                    <div style="font-size: 1.5rem; margin-bottom: 5px;">ğŸ§˜</div>
                    <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">ê¸´ê¸‰ í˜¸í¡ë²•</div>
                    <div style="font-size: 1.3rem; font-weight: bold; color: #17a2b8;" id="breathingPointsDisplay">0</div>
                    <div style="font-size: 0.8rem; color: #6c757d;">í¬ì¸íŠ¸</div>
                </div>
                <div style="text-align: center; min-width: 120px; background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 10px; border-radius: 8px;">
                    <div style="font-size: 1.8rem; margin-bottom: 5px;">ğŸ†</div>
                    <div style="font-size: 0.9rem; margin-bottom: 5px;">ì´ íšë“ í¬ì¸íŠ¸</div>
                    <div style="font-size: 1.5rem; font-weight: bold;" id="totalDailyPoints">0</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">í¬ì¸íŠ¸</div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 15px; font-size: 0.85rem; color: #6c757d;">
                <span id="dailyBreakdown">ì²´í¬ë¦¬ìŠ¤íŠ¸ 0ê°œ ì™„ë£Œ (0ì ) + ê¸´ê¸‰í˜¸í¡ë²• 0íšŒ ì™„ë£Œ (0ì ) = ì´ 0ì </span>
            </div>
        </div>
    </div>

    <script>
        // Supabase í´ë¼ì´ì–¸íŠ¸ (ì „ì—­ ë³€ìˆ˜)
        let supabaseClient = null;
        let currentUser = null;

        // Netlify í™˜ê²½ ë³€ìˆ˜ì—ì„œ Supabase ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        async function getSupabaseConfig() {
            try {
                const response = await fetch('/.netlify/functions/get-supabase-config');
                if (!response.ok) {
                    throw new Error(`Netlify í•¨ìˆ˜ í˜¸ì¶œ ì‹¤íŒ¨: ${response.statusText}`);
                }
                const config = await response.json();
                console.log('Supabase ì„¤ì • ë¡œë“œ ì„±ê³µ:', config);
                return config;
            } catch (error) {
                console.error('Supabase ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì•± ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                return null;
            }
        }

        // Supabase ì´ˆê¸°í™” í•¨ìˆ˜
        async function initializeSupabase() {
            const config = await getSupabaseConfig();
            if (!config || !config.supabaseUrl || !config.supabaseAnonKey) {
                console.error('Supabase ì„¤ì •ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return false;
            }

            const supabaseUrl = config.supabaseUrl;
            const supabaseKey = config.supabaseAnonKey;

            return new Promise((resolve) => {
                waitForSupabase(() => {
                    try {
                        // Supabase v2 ì˜¬ë°”ë¥¸ ì´ˆê¸°í™” ë°©ì‹
                        const { createClient } = supabase;
                        supabaseClient = createClient(supabaseUrl, supabaseKey);

                        console.log('Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì„±ê³µ');
                        console.log('í´ë¼ì´ì–¸íŠ¸ íƒ€ì…:', typeof supabaseClient);
                        console.log('í´ë¼ì´ì–¸íŠ¸ ì „ì²´ êµ¬ì¡°:', Object.keys(supabaseClient));
                        console.log('from ë©”ì†Œë“œ ì¡´ì¬ ì—¬ë¶€:', 'from' in supabaseClient);
                        console.log('from ë©”ì†Œë“œ íƒ€ì…:', typeof supabaseClient.from);
                        console.log('í´ë¼ì´ì–¸íŠ¸ auth ê°ì²´:', supabaseClient.auth);
                        console.log('í´ë¼ì´ì–¸íŠ¸ auth íƒ€ì…:', typeof supabaseClient.auth);

                        resolve(true);
                    } catch (error) {
                        console.error('Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                        resolve(false);
                    }
                });
            });
        }

        // ë°ì´í„° ì´ˆê¸°í™” - ë°ì´í„°ë² ì´ìŠ¤ ì „ìš©
        let userData = {
            streak: 0,
            level: 1,
            points: 0,
            lastCheck: null,
            completedToday: [],
            totalPoints: 0,
            startDate: null,
            lastCompletedDate: null,
            breathingPoints: 0
        };

        let diaries = []; // ë°ì´í„°ë² ì´ìŠ¤ ì „ìš©

        // ================ ì¸ì¦ ê´€ë ¨ í•¨ìˆ˜ ================

        // ì¸ì¦ ëª¨ë‹¬ ì—´ê¸°
        function openAuthModal() {
            document.getElementById('authModal').style.display = 'block';
        }

        // ì¸ì¦ ëª¨ë‹¬ ë‹«ê¸°
        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            clearMessages();
        }

        // íƒ­ ì „í™˜
        function switchTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const tabBtns = document.querySelectorAll('.tab-btn');

            tabBtns.forEach(btn => btn.classList.remove('active'));

            if (tab === 'login') {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
                tabBtns[0].classList.add('active');
            } else {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
                tabBtns[1].classList.add('active');
            }

            clearMessages();
        }

        // ë©”ì‹œì§€ ì§€ìš°ê¸°
        function clearMessages() {
            document.getElementById('loginMessage').textContent = '';
            document.getElementById('loginMessage').className = 'auth-message';
            document.getElementById('signupMessage').textContent = '';
            document.getElementById('signupMessage').className = 'auth-message';
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `auth-message ${type}`;
        }

        // íšŒì›ê°€ì…
        async function signup() {
            if (!supabaseClient) {
                showMessage('signupMessage', 'Supabaseê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;

            if (!email || !password || !confirmPassword) {
                showMessage('signupMessage', 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('signupMessage', 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showMessage('signupMessage', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            try {
                console.log('ğŸ“ íšŒì›ê°€ì… ì‹œë„:', { email, passwordLength: password.length });

                // auth ê°ì²´ ë‹¤ì‹œ í™•ì¸
                if (!supabaseClient || !supabaseClient.auth) {
                    throw new Error('Supabase í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }

                console.log('auth ê°ì²´ ìƒíƒœ:', {
                    exists: !!supabaseClient.auth,
                    hasSignUp: typeof supabaseClient.auth.signUp === 'function',
                    signUpFunction: supabaseClient.auth.signUp
                });

                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password
                });

                console.log('ğŸ“‹ Supabase ì‘ë‹µ:', { data, error });

                if (error) {
                    console.error('âŒ Supabase íšŒì›ê°€ì… ì˜¤ë¥˜:', error);
                    showMessage('signupMessage', `ì˜¤ë¥˜: ${error.message}`, 'error');
                    return;
                }

                if (data && data.user && !data.user.email_confirmed_at) {
                    console.log('âœ… íšŒì›ê°€ì… ì„±ê³µ (ì´ë©”ì¼ í™•ì¸ í•„ìš”)');
                    showMessage('signupMessage', 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'success');
                } else if (data && data.user) {
                    console.log('âœ… íšŒì›ê°€ì… ì„±ê³µ (ì¦‰ì‹œ ë¡œê·¸ì¸)');
                    showMessage('signupMessage', 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } else {
                    console.log('âš ï¸ ì‘ë‹µ ë°ì´í„° ì—†ìŒ');
                    showMessage('signupMessage', 'íšŒì›ê°€ì…ì´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                }

                // 3ì´ˆ í›„ ë¡œê·¸ì¸ íƒ­ìœ¼ë¡œ ì „í™˜
                setTimeout(() => {
                    switchTab('login');
                    document.getElementById('loginEmail').value = email;
                }, 3000);

            } catch (error) {
                console.error('ğŸ’¥ íšŒì›ê°€ì… ì‹œìŠ¤í…œ ì˜¤ë¥˜:', error);
                showMessage('signupMessage', `ì‹œìŠ¤í…œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ë¡œê·¸ì¸
        async function login() {
            if (!supabaseClient) {
                showMessage('loginMessage', 'Supabaseê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showMessage('loginMessage', 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                console.log('ğŸ” ë¡œê·¸ì¸ ì‹œë„:', { email });

                // Supabase í´ë¼ì´ì–¸íŠ¸ ìƒíƒœ í™•ì¸
                console.log('ë¡œê·¸ì¸ ì „ í´ë¼ì´ì–¸íŠ¸ ìƒíƒœ:', {
                    supabaseClient: !!supabaseClient,
                    auth: !!supabaseClient?.auth,
                    signInWithPassword: typeof supabaseClient?.auth?.signInWithPassword
                });

                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                console.log('ë¡œê·¸ì¸ ì‘ë‹µ:', { data, error });

                if (error) {
                    showMessage('loginMessage', error.message, 'error');
                    return;
                }

                currentUser = data.user;

                // ë¡œê·¸ì¸ ì„±ê³µ - UI ì—…ë°ì´íŠ¸
                document.getElementById('userEmail').textContent = email;
                document.getElementById('userSection').style.display = 'flex';
                document.getElementById('loginSection').style.display = 'none';
                closeAuthModal();

                // ë°ì´í„° ë¡œë“œ (ë™ê¸°ì ìœ¼ë¡œ ì²˜ë¦¬ - ì‹¤íŒ¨ ì‹œ ë¡œê·¸ì•„ì›ƒ)
                try {
                    await loadUserData();
                    console.log('ë°ì´í„° ë¡œë“œ ì„±ê³µ');
                    updateUI();
                    await loadDiaries(); // ë¡œê·¸ì¸ í›„ ê°ì •ì¼ê¸° ë¡œë“œ
                    updateDiarySection(); // ì¼ê¸° ì„¹ì…˜ UI ì—…ë°ì´íŠ¸
                    updateChecklistSection(); // ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ UI ì—…ë°ì´íŠ¸
                } catch (loadError) {
                    console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', loadError);
                    alert('ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');

                    // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
                    currentUser = null;
                    document.getElementById('userSection').style.display = 'none';
                    document.getElementById('loginSection').style.display = 'block';
                    showMessage('loginMessage', 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ì„œë²„ ì—°ê²° ì˜¤ë¥˜', 'error');
                }

            } catch (error) {
                console.error('ğŸ’¥ ë¡œê·¸ì¸ ì‹œìŠ¤í…œ ì˜¤ë¥˜:', error);
                showMessage('loginMessage', `ì‹œìŠ¤í…œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ìƒˆ ì‚¬ìš©ì ë°ì´í„° ìƒì„±
        async function createNewUserData() {
            if (!currentUser || !supabaseClient) return;

            try {
                const newUserData = {
                    user_id: currentUser.id,
                    streak: 0,
                    level: 1,
                    points: 0,
                    last_check: null,
                    completed_today: [],
                    total_points: 0,
                    start_date: null,
                    last_completed_date: null,
                    breathing_points: 0
                };

                const { data, error } = await supabaseClient
                    .from('user_data')
                    .insert([newUserData])
                    .select()
                    .single();

                if (error) {
                    console.error('ì‚¬ìš©ì ë°ì´í„° ìƒì„± ì˜¤ë¥˜:', error);
                    return;
                }

                console.log('ìƒˆ ì‚¬ìš©ì ë°ì´í„° ìƒì„± ì„±ê³µ:', data);

                // userData ì—…ë°ì´íŠ¸
                userData = {
                    streak: data.streak || 0,
                    level: data.level || 1,
                    points: data.points || 0,
                    lastCheck: data.last_check,
                    completedToday: data.completed_today || [],
                    totalPoints: data.total_points || 0,
                    startDate: data.start_date,
                    lastCompletedDate: data.last_completed_date
                };

                updateUI();
            } catch (error) {
                console.error('ì‚¬ìš©ì ë°ì´í„° ìƒì„± ì¤‘ ì˜ˆì™¸ ì˜¤ë¥˜:', error);
            }
        }

        // ë¡œê·¸ì•„ì›ƒ
        async function logout() {
            console.log('logout í•¨ìˆ˜ í˜¸ì¶œë¨');

            // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
            const logoutBtn = document.querySelector('button[onclick="logout()"]');
            if (logoutBtn) {
                logoutBtn.disabled = true;
                logoutBtn.textContent = 'ë¡œê·¸ì•„ì›ƒ ì¤‘...';
            }

            try {
                // Supabase ë¡œê·¸ì•„ì›ƒ ì‹œë„
                if (supabaseClient && supabaseClient.auth) {
                    await supabaseClient.auth.signOut();
                    console.log('Supabase signOut ì™„ë£Œ');
                }
            } catch (error) {
                console.error('Supabase ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
            } finally {
                // í•­ìƒ ë¡œì»¬ ë°ì´í„° ì´ˆê¸°í™”
                performLocalLogout();
            }
        }

        // ë¡œì»¬ ë¡œê·¸ì•„ì›ƒ ìˆ˜í–‰ í•¨ìˆ˜
        function performLocalLogout() {
            console.log('ë¡œì»¬ ë¡œê·¸ì•„ì›ƒ ìˆ˜í–‰ ì‹œì‘');

            // ë°ì´í„° ì´ˆê¸°í™”
            currentUser = null;
            userData = {
                streak: 0,
                level: 1,
                points: 0,
                lastCheck: null,
                completedToday: [],
                totalPoints: 0,
                startDate: null,
                lastCompletedDate: null,
                breathingPoints: 0
            };
            diaries = [];

            // UI ì—…ë°ì´íŠ¸ (ë°ì´í„° ì €ì¥ í˜¸ì¶œ ì—†ì´ ì§ì ‘ ì—…ë°ì´íŠ¸)
            document.getElementById('userSection').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';

            // ì¼ê¸° ì„¹ì…˜ ì§ì ‘ ì—…ë°ì´íŠ¸
            const diaryLoginPrompt = document.getElementById('diaryLoginPrompt');
            const diaryForm = document.getElementById('diaryForm');
            const recentDiarySection = document.getElementById('recentDiarySection');
            if (diaryLoginPrompt) diaryLoginPrompt.style.display = 'block';
            if (diaryForm) diaryForm.style.display = 'none';
            // ìµœê·¼ ê°ì • ì¼ê¸° ì„¹ì…˜ë§Œ ìˆ¨ê¸°ê¸°
            if (recentDiarySection) recentDiarySection.style.display = 'none';

            // ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ ì§ì ‘ ì—…ë°ì´íŠ¸
            const checklistMessage = document.getElementById('checklistMessage');
            if (checklistMessage) {
                checklistMessage.innerHTML = 'ğŸ”’ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>ëª¨ë“  ë°ì´í„°ëŠ” ì•ˆì „í•˜ê²Œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë©ë‹ˆë‹¤.';
                checklistMessage.style.display = 'block';
            }

            // ëª¨ë“  ì²´í¬ë°•ìŠ¤ ì§ì ‘ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.check-input').forEach(checkbox => {
                checkbox.disabled = true;
                checkbox.checked = false;
                checkbox.setAttribute('title', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
                checkbox.parentElement.classList.remove('completed');
            });

            // í†µê³„ ì¹´ë“œ ì§ì ‘ ì´ˆê¸°í™”
            document.getElementById('streak').textContent = '0';
            document.getElementById('level').textContent = '1';
            document.getElementById('points').textContent = '0';
            // document.getElementById('dailyPoints').textContent = '0'; // ìš”ì†Œ ì œê±°ë¨
            const progressBar = document.getElementById('progressBar');
            if (progressBar) progressBar.style.width = '0%';

            // ì¼ê¸° ëª©ë¡ ì§ì ‘ ë¹„ìš°ê¸°
            const diariesList = document.getElementById('diariesList');
            if (diariesList) diariesList.innerHTML = '';

            // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ìƒíƒœ ë³µì›
            const logoutBtn = document.querySelector('button[onclick="logout()"]');
            if (logoutBtn) {
                logoutBtn.disabled = false;
                logoutBtn.textContent = 'ë¡œê·¸ì•„ì›ƒ';
            }

            console.log('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ - ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”ë¨');
            alert('ë¡œê·¸ì•„ì›ƒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

        // ì¼ê¸° ì„¹ì…˜ UI ì—…ë°ì´íŠ¸
        function updateDiarySection() {
            const loginPrompt = document.getElementById('diaryLoginPrompt');
            const diaryForm = document.getElementById('diaryForm');
            const recentDiarySection = document.getElementById('recentDiarySection');

            if (currentUser && supabaseClient) {
                loginPrompt.style.display = 'none';
                diaryForm.style.display = 'block';
                // ìµœê·¼ ê°ì • ì¼ê¸° ì„¹ì…˜ í‘œì‹œ
                if (recentDiarySection) recentDiarySection.style.display = 'block';
            } else {
                loginPrompt.style.display = 'block';
                diaryForm.style.display = 'none';
                // ìµœê·¼ ê°ì • ì¼ê¸° ì„¹ì…˜ ìˆ¨ê¸°ê¸°
                if (recentDiarySection) recentDiarySection.style.display = 'none';
            }
        }

        // ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ UI ì—…ë°ì´íŠ¸
        function updateChecklistSection() {
            const isLoggedIn = currentUser && supabaseClient;
            const checkboxes = document.querySelectorAll('.check-input');
            const emergencyBtn = document.querySelector('.emergency-btn');

            checkboxes.forEach(checkbox => {
                checkbox.disabled = !isLoggedIn;
                if (!isLoggedIn) {
                    checkbox.checked = false;
                }
            });

            if (emergencyBtn) {
                emergencyBtn.disabled = !isLoggedIn;
            }

            // ë¹„ë¡œê·¸ì¸ ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
            let checklistMessage = document.getElementById('checklistMessage');
            if (!checklistMessage) {
                checklistMessage = document.createElement('div');
                checklistMessage.id = 'checklistMessage';
                checklistMessage.style.cssText = 'color: #666; padding: 15px; background: #f5f5f5; border-radius: 8px; margin-bottom: 20px; text-align: center;';

                const checklistContainer = document.querySelector('.checklist');
                if (checklistContainer) {
                    checklistContainer.parentNode.insertBefore(checklistMessage, checklistContainer);
                }
            }

            if (isLoggedIn) {
                checklistMessage.style.display = 'none';
            } else {
                checklistMessage.innerHTML = 'ğŸ”’ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>ëª¨ë“  ë°ì´í„°ëŠ” ì•ˆì „í•˜ê²Œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë©ë‹ˆë‹¤.';
                checklistMessage.style.display = 'block';
            }
        }

        // ì¼ê¸° ë°ì´í„° ë¡œë“œ (ë°ì´í„°ë² ì´ìŠ¤ ì „ìš©)
        async function loadDiaries() {
            if (!currentUser || !supabaseClient) {
                diaries = [];
                displayDiaries();
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('emotion_diaries')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('ì¼ê¸° ë¡œë“œ ì˜¤ë¥˜:', error);
                    diaries = [];
                } else {
                    // ë°ì´í„°ë² ì´ìŠ¤ í˜•ì‹ì„ ê¸°ì¡´ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (í•˜ìœ„ í˜¸í™˜ì„± ì§€ì›)
                    diaries = (data || []).map(diary => ({
                        id: diary.id, // ì¼ê¸° ID ì¶”ê°€
                        date: new Date(diary.created_at).toLocaleString(),
                        otherPersonAction: diary.other_person_action,
                        myReaction: diary.my_reaction,
                        reinterpretation: diary.reinterpretation
                    }));
                    console.log('ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë¡œë“œëœ ì¼ê¸°:', diaries.length, 'ê°œ');
                }

                displayDiaries();
            } catch (error) {
                console.error('ì¼ê¸° ë¡œë“œ ì‹œìŠ¤í…œ ì˜¤ë¥˜:', error);
                diaries = [];
                displayDiaries();
            }
        }

        // ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ
        async function loadUserData() {
            if (!currentUser || !supabaseClient) {
                // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° - ë°ì´í„° ì´ˆê¸°í™”ëŠ” checkAuthStateì—ì„œ ì²˜ë¦¬
                console.log('loadUserData: ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ìƒíƒœ');
                return;
            }

            try {
                console.log('ì‚¬ìš©ì ë°ì´í„° ì¡°íšŒ ì‹œì‘:', { userId: currentUser.id, email: currentUser.email });
                console.log('Supabase í´ë¼ì´ì–¸íŠ¸ ìƒíƒœ:', {
                    supabaseClient: !!supabaseClient,
                    auth: !!supabaseClient?.auth,
                    from: typeof supabaseClient?.from
                });

                // ì¿¼ë¦¬ ì‹¤í–‰ ì „ ìƒì„¸ ë¡œê¹…
                console.log('DB ì¿¼ë¦¬ ì‹¤í–‰ ì§ì „ - user_id:', currentUser.id);
                console.log('ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° í™•ì¸:', {
                    table: 'user_data',
                    userId: currentUser.id,
                    userIdType: typeof currentUser.id
                });

                // ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„± í…ŒìŠ¤íŠ¸
                console.log('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„± í…ŒìŠ¤íŠ¸ ì‹œì‘...');
                try {
                    const networkTest = await fetch('https://hpejebnqhgojfxttfbal.supabase.co/rest/v1/', {
                        method: 'GET',
                        headers: {
                            'apikey': supabaseKey,
                            'Authorization': `Bearer ${supabaseKey}`
                        }
                    });
                    console.log('ë„¤íŠ¸ì›Œí¬ í…ŒìŠ¤íŠ¸ ê²°ê³¼:', {
                        status: networkTest.status,
                        ok: networkTest.ok,
                        statusText: networkTest.statusText
                    });
                } catch (networkError) {
                    console.error('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„± í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', networkError);
                }

                const queryStartTime = Date.now();
                console.log('ì¿¼ë¦¬ ì‹œì‘ ì‹œê°„:', queryStartTime);

                // ì¿¼ë¦¬ ìµœì í™”: í•„ìš”í•œ í•„ë“œë§Œ ì„ íƒ
                const optimizedQuery = supabaseClient
                    .from('user_data')
                    .select('streak, level, points, last_check, completed_today, total_points, start_date, last_completed_date, breathing_points')
                    .eq('user_id', currentUser.id)
                    .single();

                // ê°„ë‹¨í•œ íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬ - ì¬ì‹œë„ ì—†ì´ ë°”ë¡œ ì‹¤íŒ¨ ì²˜ë¦¬
                let data, error;
                try {
                    console.log('ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ì‹œì‘');

                    // íƒ€ì„ì•„ì›ƒ ë©”ì»¤ë‹ˆì¦˜
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => {
                            reject(new Error('Database query timeout after 10 seconds'));
                        }, 10000); // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
                    });

                    const result = await Promise.race([optimizedQuery, timeoutPromise]);
                    data = result.data;
                    error = result.error;

                    if (error) {
                        throw error;
                    }

                    console.log('ì¿¼ë¦¬ ì„±ê³µ');

                } catch (queryError) {
                    console.error('ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ì‹¤íŒ¨:', queryError);
                    if (queryError.message && queryError.message.includes('timeout')) {
                        error = { code: 'TIMEOUT', message: 'Database query timeout' };
                    } else {
                        error = queryError;
                    }
                    data = null;
                }

                const queryEndTime = Date.now();
                console.log('ì¿¼ë¦¬ ì™„ë£Œ ì‹œê°„:', queryEndTime);
                console.log('ì¿¼ë¦¬ ì†Œìš” ì‹œê°„:', queryEndTime - queryStartTime, 'ms');
                console.log('ë°ì´í„° ì¡°íšŒ ê²°ê³¼:', { data, error });
                console.log('ë°ì´í„° ì¡°íšŒ ì™„ë£Œ - ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰');
                if (data) {
                    console.log('ì¡°íšŒëœ ë°ì´í„° í•„ë“œ:', Object.keys(data));
                    console.log('diaries í•„ë“œ:', data.diaries);
                    console.log('breathing_points í•„ë“œ:', data.breathing_points);
                }

                if (error && error.code !== 'PGRST116') { // PGRST116: ë°ì´í„° ì—†ìŒ
                    console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);

                    // ë°ì´í„°ë² ì´ìŠ¤ íƒ€ì„ì•„ì›ƒ ì—ëŸ¬ ì²˜ë¦¬
                    if (error.code === 'TIMEOUT') {
                        console.error('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° íƒ€ì„ì•„ì›ƒ:', error);
                        alert('ì„œë²„ ì—°ê²°ì´ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');

                        // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
                        currentUser = null;
                        document.getElementById('userSection').style.display = 'none';
                        document.getElementById('loginSection').style.display = 'block';
                        closeAuthModal();
                        return;
                    }

                    // 406 ì˜¤ë¥˜ì¸ ê²½ìš° ìƒˆ ì‚¬ìš©ì ë°ì´í„° ìƒì„±
                    if (error.code === '406') {
                        console.log('ìƒˆ ì‚¬ìš©ì ë°ì´í„° ìƒì„±...');
                        await createNewUserData();
                    }
                    return;
                }

                if (data) {
                    // DBì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸ (ì™„ì „íˆ ë®ì–´ì“°ì§€ ì•ŠìŒ)
                    const dbCompletedToday = data.completed_today || [];
                    const today = new Date();
                    const dbLastCheck = data.last_check ? new Date(data.last_check) : null;

                    const isSameDay = dbLastCheck &&
                        today.getFullYear() === dbLastCheck.getFullYear() &&
                        today.getMonth() === dbLastCheck.getMonth() &&
                        today.getDate() === dbLastCheck.getDate();

                    console.log('DB ë°ì´í„° ë¡œë“œ (ë‚ ì§œ ë¹„êµ):', {
                        dbCompletedToday,
                        dbLastCheck: data.last_check,
                        today: today.toISOString(),
                        isSameDay
                    });

                    // ì˜¤ëŠ˜ ë‚ ì§œì˜ ë°ì´í„°ì¸ ê²½ìš°ì—ë§Œ completedToday ìœ ì§€
                    if (isSameDay) {
                        userData.completedToday = dbCompletedToday;
                        console.log('ì˜¤ëŠ˜ ë‚ ì§œì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒíƒœ ë³µì›:', dbCompletedToday);
                    } else {
                        // ë‚ ì§œê°€ ë‹¤ë¥¸ ê²½ìš° ë¹ˆ ë°°ì—´ìœ¼ë¡œ ì´ˆê¸°í™”
                        userData.completedToday = [];
                        console.log('ë‹¤ë¥¸ ë‚ ì§œì˜ ë°ì´í„°: ì²´í¬ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”');
                    }

                    // ë‹¤ë¥¸ í•„ë“œë“¤ì€ DB ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
                    userData.streak = data.streak || 0;
                    userData.level = data.level || 1;
                    userData.points = data.points || 0;
                    userData.lastCheck = data.last_check;
                    userData.totalPoints = data.total_points || 0;
                    userData.startDate = data.start_date;
                    userData.lastCompletedDate = data.last_completed_date;
                    userData.breathingPoints = data.breathing_points || 0;

                    console.log('DBì—ì„œ ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ì™„ë£Œ');

                    } else {
                    // ìƒˆ ì‚¬ìš©ì ë°ì´í„° ìƒì„±
                    await saveUserData();
                }

            } catch (error) {
                console.error('ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            }

            // ì˜¤ëŠ˜ íšë“ í¬ì¸íŠ¸ UI ì—…ë°ì´íŠ¸
            updateDailyPoints();
        }

        // ì‚¬ìš©ì ë°ì´í„° ì €ì¥ (Supabase)
        async function saveUserDataToSupabase() {
            if (!currentUser || !supabaseClient) {
                console.log('saveUserDataToSupabase: ë¡œê·¸ì¸í•˜ì§€ ì•ŠìŒ ë˜ëŠ” Supabase í´ë¼ì´ì–¸íŠ¸ ì—†ìŒ');
                return;
            }

            try {
                console.log('ë°ì´í„° ì €ì¥ ì‹œì‘:', {
                    userId: currentUser.id,
                    completedToday: userData.completedToday,
                    points: userData.points
                });

                // ì €ì¥ ì¿¼ë¦¬ ì‹¤í–‰ ì „ ìƒì„¸ ë¡œê¹…
                console.log('DB ì €ì¥ ì¿¼ë¦¬ ì‹¤í–‰ ì§ì „');
                console.log('ì €ì¥í•  ë°ì´í„° í™•ì¸:', {
                    user_id: currentUser.id,
                    streak: userData.streak,
                    level: userData.level,
                    points: userData.points,
                    completed_today: userData.completedToday,
                    breathing_points: userData.breathingPoints
                });

                const saveStartTime = Date.now();
                console.log('ì €ì¥ ì¿¼ë¦¬ ì‹œì‘ ì‹œê°„:', saveStartTime);

                // ì €ì¥ ì¿¼ë¦¬ ìµœì í™”: ì‘ì€ ë°ì´í„°ì…‹ìœ¼ë¡œ
                const optimizedSaveQuery = supabaseClient
                    .from('user_data')
                    .upsert({
                        user_id: currentUser.id,
                        streak: userData.streak,
                        level: userData.level,
                        points: userData.points,
                        last_check: userData.lastCheck,
                        completed_today: userData.completedToday,
                        total_points: userData.totalPoints,
                        start_date: userData.startDate,
                        last_completed_date: userData.lastCompletedDate,
                        breathing_points: userData.breathingPoints || 0,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id'
                    });

                // ê°„ë‹¨í•œ íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬ - ì¬ì‹œë„ ì—†ì´ ë°”ë¡œ ì‹¤íŒ¨ ì²˜ë¦¬
                let data, error;
                try {
                    console.log('ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì‹œì‘');

                    // íƒ€ì„ì•„ì›ƒ ë©”ì»¤ë‹ˆì¦˜
                    const saveTimeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => {
                            reject(new Error('Database save timeout after 10 seconds'));
                        }, 10000); // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
                    });

                    const result = await Promise.race([optimizedSaveQuery, saveTimeoutPromise]);
                    data = result.data;
                    error = result.error;

                    if (error) {
                        throw error;
                    }

                    console.log('ì €ì¥ ì„±ê³µ');

                } catch (saveError) {
                    console.error('ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì‹¤íŒ¨:', saveError);
                    if (saveError.message && saveError.message.includes('timeout')) {
                        error = { code: 'TIMEOUT', message: 'Database save timeout' };
                    } else {
                        error = saveError;
                    }
                    data = null;
                }

                const saveEndTime = Date.now();
                console.log('ì €ì¥ ì¿¼ë¦¬ ì™„ë£Œ ì‹œê°„:', saveEndTime);
                console.log('ì €ì¥ ì¿¼ë¦¬ ì†Œìš” ì‹œê°„:', saveEndTime - saveStartTime, 'ms');

                console.log('ë°ì´í„° ì €ì¥ ê²°ê³¼:', { data, error });

                if (error) {
                    console.error('ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:', error);
                    if (error.code === 'TIMEOUT') {
                        throw new Error('Database save timeout');
                    } else {
                        throw error;
                    }
                } else {
                    console.log('ë°ì´í„° ì €ì¥ ì„±ê³µ');
                }

            } catch (error) {
                console.error('ì‚¬ìš©ì ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:', error);
            }
        }
        
        // ìŠ¤ë§ˆíŠ¸í° í™˜ê²½ ê°ì§€
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // ìŠ¤ë§ˆíŠ¸í°ì—ì„œì˜ ì‚¬ìš©ì„± ê°œì„ 
        if (isMobile) {
            document.body.classList.add('mobile-view');
        }

        // í™”ë©´ ì—…ë°ì´íŠ¸
        function updateUI() {
            // ì—°ì† ì¼ìˆ˜ í‘œì‹œ
            document.getElementById('streak').textContent = userData.streak;
            document.getElementById('level').textContent = userData.level;
            document.getElementById('points').textContent = userData.points;

            // ë ˆë²¨ ì§„í–‰ë„ í‘œì‹œ ì—…ë°ì´íŠ¸
            updateLevelProgress();

            // ì˜¤ëŠ˜ íšë“ í¬ì¸íŠ¸ í‘œì‹œ
            updateDailyPoints();

            // ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒíƒœ ë³µì› (ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¤‘ë³µ ì¶”ê°€ ë°©ì§€)
            document.querySelectorAll('.check-input').forEach(checkbox => {
                const isChecked = userData.completedToday.includes(checkbox.id);
                checkbox.checked = isChecked;

                // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì„¤ì •
                if (!currentUser || !supabaseClient) {
                    // ë¹„ë¡œê·¸ì¸ ìƒíƒœ: ëª¨ë“  ì²´í¬ë°•ìŠ¤ ë¹„í™œì„±í™”
                    checkbox.disabled = true;
                    checkbox.checked = false;
                    checkbox.setAttribute('title', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
                    checkbox.parentElement.classList.remove('completed');
                } else {
                    // ë¡œê·¸ì¸ ìƒíƒœ: ì²´í¬ëœ í•­ëª©ë§Œ ë¹„í™œì„±í™”
                    if (isChecked) {
                        checkbox.disabled = true;
                        checkbox.setAttribute('title', 'ì˜¤ëŠ˜ì€ ë‹¤ì‹œ í•´ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                        checkbox.parentElement.classList.add('completed');
                    } else {
                        checkbox.disabled = false;
                        checkbox.removeAttribute('title');
                        checkbox.parentElement.classList.remove('completed');
                    }
                }

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆê°€ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì¶”ê°€
                if (!checkbox.hasAttribute('data-event-added')) {
                    checkbox.addEventListener('change', handleCheck);
                    checkbox.setAttribute('data-event-added', 'true');
                }
            });

            updateProgress();
            updateBadges();
            displayDiaries();
        }

        // ì²´í¬ ì´ë²¤íŠ¸ ì²˜ë¦¬
          async function handleCheck(e) {
            console.log('handleCheck í˜¸ì¶œë¨:', {
                checked: e.target.checked,
                id: e.target.id,
                currentUser: !!currentUser,
                supabaseClient: !!supabaseClient
            });

            // ë¹„ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” ì²´í¬ ë¶ˆê°€
            if (!currentUser || !supabaseClient) {
                e.target.checked = false;
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!');
                return;
            }

            const id = e.target.id;
            const parent = e.target.parentElement;
            console.log('ì²´í¬ í•­ëª© ì •ë³´:', { id, currentUser: currentUser.email });

            if(e.target.checked) {
                // ì´ë¯¸ ì™„ë£Œëœ í•­ëª©ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ í¬ì¸íŠ¸ ì¶”ê°€
                if(!userData.completedToday.includes(id)) {
                    userData.completedToday.push(id);
                    userData.points += 10;
                    userData.totalPoints = (userData.totalPoints || 0) + 10; // ì´ ëˆ„ì  í¬ì¸íŠ¸ ì¦ê°€
                    parent.classList.add('completed');

                    // ì²´í¬ ì™„ë£Œ í›„ ë¹„í™œì„±í™”
                    e.target.disabled = true;
                    e.target.setAttribute('title', 'ì˜¤ëŠ˜ì€ ë‹¤ì‹œ í•´ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');

                    console.log(`ì²´í¬ ì™„ë£Œ: ${id}, í¬ì¸íŠ¸ +10 (í˜„ì¬: ${userData.points})`);
                } else {
                    // ì´ë¯¸ ì²´í¬ëœ í•­ëª©ì„ ë‹¤ì‹œ ì²´í¬í•˜ë ¤ëŠ” ê²½ìš° (ì¤‘ë³µ ë°©ì§€)
                    console.log(`ì´ë¯¸ ì²´í¬ëœ í•­ëª©ì…ë‹ˆë‹¤: ${id}`);
                    e.target.checked = false;
                }
            } else {
                // ì²´í¬ í•´ì œ ë°©ì§€ - í•˜ë£¨ ë™ì•ˆì€ ì²´í¬í•œ í•­ëª©ì„ í•´ì œí•  ìˆ˜ ì—†ìŒ
                if (userData.completedToday.includes(id)) {
                    e.target.checked = true;
                    alert('â° í•œ ë²ˆ ì²´í¬í•œ í•­ëª©ì€ ì˜¤ëŠ˜ í•˜ë£¨ ë™ì•ˆ í•´ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                } else {
                    // ì•„ì§ ì™„ë£Œí•˜ì§€ ì•Šì€ í•­ëª©ì˜ ì²´í¬ í•´ì œëŠ” í—ˆìš©
                    parent.classList.remove('completed');
                    console.log(`ì²´í¬ í•´ì œ í—ˆìš©: ${id} (ì•„ì§ ì™„ë£Œí•˜ì§€ ì•Šì€ í•­ëª©)`);
                }
            }

            // í˜„ì¬ ë‚ ì§œë¥¼ lastCheckì— ì„¤ì •í•˜ì—¬ í•˜ë£¨ ì¤‘ì— ì²´í¬ ìƒíƒœ ìœ ì§€
            userData.lastCheck = new Date().toISOString();

            // ë°ì´í„° ì¦‰ì‹œ ì €ì¥ (ë°ì´í„°ë² ì´ìŠ¤ì— ë°”ë¡œ ì €ì¥)
            await saveUserDataToSupabase(); // ì¦‰ì‹œ DB ì €ì¥
            await updateProgress();
            updateBadges();

            // ì˜¤ëŠ˜ íšë“ í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
            updateDailyPoints();

            // UI ì—…ë°ì´íŠ¸ (í‰ì˜¨í¬ì¸íŠ¸ ì¹´ë“œ í¬í•¨)
            document.getElementById('points').textContent = userData.points;

            // ë ˆë²¨ì—… ì²´í¬
            if(userData.points >= userData.level * 100) {
                userData.level++;
                console.log('ğŸ‰ ë ˆë²¨ì—…! ë ˆë²¨:', userData.level);
                alert(`ğŸ‰ ë ˆë²¨ì—…! í‰ì˜¨ ë ˆë²¨ ${userData.level} ë‹¬ì„±!`);
                await saveUserDataToSupabase(); // ë ˆë²¨ì—… ì‹œ DB ì €ì¥
                updateLevelProgress();
            } else {
                updateLevelProgress();
            }
        }
        
        // ì‚¬ìš©ì ë°ì´í„° ì €ì¥ (ë°ì´í„°ë² ì´ìŠ¤ ì „ìš©)
        async function saveUserData() {
            console.log('saveUserData í˜¸ì¶œë¨:', {
                currentUser: !!currentUser,
                supabaseClient: !!supabaseClient,
                email: currentUser?.email
            });

            // Supabaseì— ì €ì¥ (ë¡œê·¸ì¸í•œ ê²½ìš°ë§Œ)
            if (currentUser && supabaseClient) {
                console.log('Supabaseì— ë°ì´í„° ì €ì¥ ì‹œë„...');
                try {
                    await saveUserDataToSupabase();
                    console.log('Supabase ë°ì´í„° ì €ì¥ ì™„ë£Œ');
                } catch (saveError) {
                    console.error('Supabase ì €ì¥ ì‹¤íŒ¨:', saveError);
                    alert('ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            } else {
                console.log('ë¹„ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” ë°ì´í„°ë¥¼ ì €ì¥í•˜ì§€ ì•ŠìŒ');
            }
        }
        
      
        // ë ˆë²¨ ì§„í–‰ë„ ì—…ë°ì´íŠ¸
        function updateLevelProgress() {
            const pointsNeeded = userData.level * 100;
            const pointsRemaining = Math.max(0, pointsNeeded - userData.points);
            const progressPercentage = userData.points >= pointsNeeded ? 100 : (userData.points / pointsNeeded) * 100;

            // ì•ë©´ì—ì„œëŠ” ë ˆë²¨ ì§„í–‰ë„ í‘œì‹œ ì œê±° (ë’·ë©´ì—ì„œë§Œ í‘œì‹œ)
        }

        // ë ˆë²¨ ì§„í–‰ë„ ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateLevelProgressDisplay() {
            const pointsNeeded = userData.level * 100;
            const pointsRemaining = Math.max(0, pointsNeeded - userData.points);

            document.getElementById('levelProgressDisplay').textContent = `ë‹¤ìŒ ë ˆë²¨ê¹Œì§€: ${pointsRemaining}í¬ì¸íŠ¸`;
        }

        // ì˜¤ëŠ˜ íšë“ í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
        function updateDailyPoints() {
            const checklistPoints = userData.completedToday.length * 10;
            const breathingPoints = userData.breathingPoints || 0;
            const totalDailyPoints = checklistPoints + breathingPoints;

            // ê¸°ì¡´ ì˜¤ëŠ˜ íšë“ í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸ (ìš”ì†Œ ì œê±°ë¨)
            // document.getElementById('dailyPoints').textContent = totalDailyPoints;

            // ìƒì„¸ ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('checklistPoints').textContent = checklistPoints;
            document.getElementById('breathingPointsDisplay').textContent = breathingPoints;
            document.getElementById('totalDailyPoints').textContent = totalDailyPoints;

            // ì„¸ë¶€ ë‚´ìš© í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            const completedCount = userData.completedToday.length;
            const breathingCount = breathingPoints / 5; // í˜¸í¡ë²• ì™„ë£Œ íšŸìˆ˜ (5ì ë‹¹ 1íšŒ)
            document.getElementById('dailyBreakdown').textContent =
                `ì²´í¬ë¦¬ìŠ¤íŠ¸ ${completedCount}ê°œ ì™„ë£Œ (${checklistPoints}ì ) + ê¸´ê¸‰í˜¸í¡ë²• ${breathingCount}íšŒ ì™„ë£Œ (${breathingPoints}ì ) = ì´ ${totalDailyPoints}ì `;
        }

        // ì—°ì†ì¼ìˆ˜ ì¹´ë“œ ë’¤ì§‘ê¸° í•¨ìˆ˜
        function flipCard() {
            const card = document.getElementById('streakCard');
            card.classList.toggle('flipped');

            // ë’·ë©´ì´ ë³´ì¼ ë•Œ ì‹œì‘ì¼ ì •ë³´ ì—…ë°ì´íŠ¸
            if (card.classList.contains('flipped')) {
                updateStartDateDisplay();
            }
        }

        // í‰ì˜¨ë ˆë²¨ ì¹´ë“œ ë’¤ì§‘ê¸° í•¨ìˆ˜
        function flipLevelCard() {
            const card = document.getElementById('levelCard');
            card.classList.toggle('flipped');

            // ë’·ë©´ì´ ë³´ì¼ ë•Œ ë ˆë²¨ ì§„í–‰ë„ ì •ë³´ ì—…ë°ì´íŠ¸
            if (card.classList.contains('flipped')) {
                updateLevelProgressDisplay();
            }
        }

        // í‰ì˜¨í¬ì¸íŠ¸ ì¹´ë“œ ë’¤ì§‘ê¸° í•¨ìˆ˜
        function flipPointsCard() {
            const card = document.getElementById('pointsCard');
            card.classList.toggle('flipped');
        }

        // ì‹œì‘ì¼ í‘œì‹œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateStartDateDisplay() {
            const startDateDisplay = document.getElementById('startDateDisplay');

            if (userData.startDate) {
                const startDate = new Date(userData.startDate);
                const formattedDate = startDate.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                startDateDisplay.textContent = formattedDate;
            } else {
                startDateDisplay.textContent = 'ì‹œì‘ì¼ ì—†ìŒ';
            }
        }

        // ì—°ì†ì¼ìˆ˜ ë¦¬ì…‹ í•¨ìˆ˜
        async function resetStreak(event) {
            event.stopPropagation(); // ì¹´ë“œ ë’¤ì§‘ê¸° ì´ë²¤íŠ¸ ë°©ì§€

            if (confirm('ì—°ì†ì¼ìˆ˜ë¥¼ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\nì‹œì‘ì¼ì´ ì˜¤ëŠ˜ë¡œ ë³€ê²½ë˜ê³  ì—°ì†ì¼ìˆ˜ëŠ” 0ì´ ë©ë‹ˆë‹¤.')) {
                const today = new Date().toISOString();

                // ë°ì´í„° ë¦¬ì…‹ (ì‹œì‘ì¼ì€ ì˜¤ëŠ˜ë¡œ ì„¤ì •)
                userData.startDate = today;
                userData.lastCompletedDate = null;
                userData.streak = 0;
                userData.completedToday = [];
                userData.lastCheck = null;

                // DBì— ì €ì¥
                if (currentUser && supabaseClient) {
                    await saveUserDataToSupabase();
                }

                // UI ì—…ë°ì´íŠ¸
                document.getElementById('streak').textContent = '0';
                updateStartDateDisplay();
                updateProgress();

                // ì¹´ë“œ ì•ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                document.getElementById('streakCard').classList.remove('flipped');

                alert('ì—°ì†ì¼ìˆ˜ê°€ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤.\\nì˜¤ëŠ˜ë¶€í„° ìƒˆë¡œ ì‹œì‘í•©ë‹ˆë‹¤!');
            }
        }

        // ì—°ì† ì¼ìˆ˜ ìë™ ê³„ì‚° í•¨ìˆ˜
        function calculateStreak() {
            if (!userData.startDate) {
                return 0; // ì‹œì‘ì¼ì´ ì—†ìœ¼ë©´ 0 ë°˜í™˜
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const startDate = new Date(userData.startDate);
            startDate.setHours(0, 0, 0, 0);

            // ë‚ ì§œ ì°¨ì´ ê³„ì‚° (ë°€ë¦¬ì´ˆ â†’ ì¼)
            const diffTime = Math.abs(today - startDate);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            // ì—°ì† ì‚¬ìš© í™•ì¸: ë§ˆì§€ë§‰ ì™„ë£Œì¼ë¡œë¶€í„° í•˜ë£¨ê°€ ì§€ë‚¬ëŠ”ì§€ í™•ì¸
            if (userData.lastCompletedDate) {
                const lastCompleted = new Date(userData.lastCompletedDate);
                lastCompleted.setHours(0, 0, 0, 0);
                const daysSinceLastComplete = Math.floor((today - lastCompleted) / (1000 * 60 * 60 * 24));

                // í•˜ë£¨ ì´ìƒ ì§€ë‚¬ìœ¼ë©´ ì—°ì†ì´ ëŠê¹€
                if (daysSinceLastComplete > 1) {
                    return 0;
                }
            }

            return diffDays + 1; // ì‹œì‘ì¼ í¬í•¨
        }

        // ì—°ì† ì¼ìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        async function updateStreak() {
            const today = new Date().toISOString();
            const completed = userData.completedToday.length;
            const total = document.querySelectorAll('.check-input').length;
            const isAllCompleted = completed === total;

            console.log('ğŸ”„ ì—°ì†ì¼ìˆ˜ ì—…ë°ì´íŠ¸:', { today, completed, total, isAllCompleted });

            // ì‹œì‘ì¼ ì„¤ì •
            if (!userData.startDate && isAllCompleted) {
                userData.startDate = today;
                userData.streak = 1;
                console.log('ğŸ¯ ì²« ì „ì²´ ì™„ë£Œ! ì‹œì‘ì¼ ì„¤ì •:', userData.startDate);
            } else if (userData.startDate && isAllCompleted) {
                // ëª¨ë“  í•­ëª© ì™„ë£Œ ì‹œ ë§ˆì§€ë§‰ ì™„ë£Œì¼ ì—…ë°ì´íŠ¸
                userData.lastCompletedDate = today;
            }

            // ìë™ìœ¼ë¡œ ì—°ì†ì¼ìˆ˜ ê³„ì‚°
            if (userData.startDate) {
                userData.streak = calculateStreak();
            }

            // ì—°ì†ì¼ìˆ˜ ë³€ê²½ ì‹œ DBì— ì €ì¥
            console.log('ğŸ’¾ ì—°ì†ì¼ìˆ˜ ë³€ê²½ í›„ DB ì €ì¥:', { streak: userData.streak, startDate: userData.startDate });
            await saveUserDataToSupabase();
        }

        // ì§„í–‰ë„ ì—…ë°ì´íŠ¸
        async function updateProgress() {
            const total = document.querySelectorAll('.check-input').length;
            const completed = userData.completedToday.length;
            const percentage = (completed / total) * 100;
            document.getElementById('dailyProgress').style.width = percentage + '%';

            // ì—°ì† ì¼ìˆ˜ ì—…ë°ì´íŠ¸
            await updateStreak();
        }

        // ë±ƒì§€ ì—…ë°ì´íŠ¸
        function updateBadges() {
            const badgesContainer = document.getElementById('badges');
            badgesContainer.innerHTML = '';
            
            if(userData.streak >= 3) {
                badgesContainer.innerHTML += '<span class="badge">ğŸ”¥ 3ì¼ ì—°ì†</span>';
            }
            if(userData.streak >= 7) {
                badgesContainer.innerHTML += '<span class="badge">â­ í‰ì˜¨ ìˆ˜í˜¸ì</span>';
            }
            if(userData.level >= 3) {
                badgesContainer.innerHTML += '<span class="badge">ğŸ›¡ï¸ ì •ì‹ ì˜ ë°©íŒ¨</span>';
            }
            
            // ë³´ìƒ ë©”ì‹œì§€
            const total = document.querySelectorAll('.check-input').length;
            const completed = userData.completedToday.length;
            if(completed === total) {
                document.getElementById('rewardText').innerHTML = 
                    `ğŸ‰ ì™„ë£Œ! ì˜¤ëŠ˜ì˜ ë³´ìƒ: <strong>${getRandomReward()}</strong>`;
            }
        }

        // ëœë¤ ë³´ìƒ
        function getRandomReward() {
            const rewards = [
                "ë”°ëœ»í•œ ì°¨ í•œì”ì˜ ì—¬ìœ ",
                "ì¢‹ì•„í•˜ëŠ” ë…¸ë˜ 3ê³¡ ë“£ê¸°",
                "15ë¶„ ì¶”ê°€ íœ´ì‹",
                "ì‘ì€ ê°„ì‹ ë¨¹ê¸°",
                "ì˜¤ëŠ˜ì€ ì¹­ì°¬ ì¼ê¸° ì“°ì§€ ì•Šê¸°"
            ];
            return rewards[Math.floor(Math.random() * rewards.length)];
        }

        // í˜¸í¡ë²• í•¸ë“¤ëŸ¬
        function handleBreathing() {
            // ë¹„ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” ì‚¬ìš© ë¶ˆê°€
            if (!currentUser || !supabaseClient) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!');
                return;
            }
            startBreathing();
        }

        // í˜¸í¡ë²• íƒ€ì´ë¨¸
        function startBreathing() {
            alert("ğŸŒ¬ï¸ 4ì´ˆ ë“¤ì´ë§ˆì‹œê¸° â†’ 7ì´ˆ ì°¸ê¸° â†’ 8ì´ˆ ë‚´ì‰¬ê¸°\n\nì§€ê¸ˆ ì‹œì‘í•©ë‹ˆë‹¤. í™”ë©´ì„ ë³´ë©° ë”°ë¼í•´ì£¼ì„¸ìš”!");

            let step = 0;
            const steps = [
                { text: "ë“¤ì´ë§ˆì‹œê¸° (4ì´ˆ)", duration: 4000 },
                { text: "ì°¸ê¸° (7ì´ˆ)", duration: 7000 },
                { text: "ë‚´ì‰¬ê¸° (8ì´ˆ)", duration: 8000 }
            ];

            const interval = setInterval(() => {
                alert(steps[step].text);
                step++;
                if(step >= steps.length) {
                    clearInterval(interval);

                    // í˜¸í¡ë²• ì™„ë£Œ ì‹œ 10í¬ì¸íŠ¸ ì§€ê¸‰
                    userData.points += 10;
                    userData.totalPoints = (userData.totalPoints || 0) + 10; // ì´ ëˆ„ì  í¬ì¸íŠ¸ë„ ì¦ê°€
                    userData.breathingPoints = (userData.breathingPoints || 0) + 10;

                    // DBì— ì €ì¥ (async ì²˜ë¦¬)
                    saveUserDataToSupabase().then(() => {
                        // UI ì—…ë°ì´íŠ¸
                        updateUI();
                        updateLevelProgress();
                        updateDailyPoints();
                    });

                    alert("âœ… í˜¸í¡ë²• ì™„ë£Œ! í‰ì˜¨ í¬ì¸íŠ¸ 10ì  íšë“!\nì´ì œ ì¡°ê¸ˆ ë” í‰ì˜¨í•´ì§€ì…¨ë‚˜ìš”?");
                }
            }, steps[step]?.duration || 0);
        }

        // ê°ì • ì¼ê¸° ì €ì¥
        async function saveDiary() {
            if (!currentUser || !supabaseClient) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!');
                return;
            }

            const otherPersonAction = document.getElementById('otherPersonAction').value;
            const myReaction = document.getElementById('myReaction').value;
            const reinterpretation = document.getElementById('reinterpretation').value;

            if(!otherPersonAction || !myReaction || !reinterpretation) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”!');
                return;
            }

            try {
                // Supabaseì— ì¼ê¸° ì €ì¥
                const { data, error } = await supabaseClient
                    .from('emotion_diaries')
                    .insert([{
                        user_id: currentUser.id,
                        other_person_action: otherPersonAction,
                        my_reaction: myReaction,
                        reinterpretation: reinterpretation
                    }])
                    .select()
                    .single();

                if (error) {
                    console.error('ì¼ê¸° ì €ì¥ ì˜¤ë¥˜:', error);
                    alert('ì¼ê¸° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }

                console.log('ì¼ê¸° ì €ì¥ ì„±ê³µ:', data);

                // ì²´í¬ë°•ìŠ¤ ìë™ ì™„ë£Œ
                document.getElementById('evening2').checked = true;
                await handleCheck({target: document.getElementById('evening2')});

                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('otherPersonAction').value = '';
                document.getElementById('myReaction').value = '';
                document.getElementById('reinterpretation').value = '';

                // ì¼ê¸° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadDiaries();
                alert('âœ… ê°ì • ì¼ê¸°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');

            } catch (error) {
                console.error('ì¼ê¸° ì €ì¥ ì‹œìŠ¤í…œ ì˜¤ë¥˜:', error);
                alert('ì¼ê¸° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì¼ê¸° ëª©ë¡ í‘œì‹œ
        function displayDiaries() {
            const diaryList = document.getElementById('diaryList');
            diaryList.innerHTML = '';

            console.log('displayDiaries í˜¸ì¶œë¨, diaries ê¸¸ì´:', diaries.length);
            console.log('diaries ë‚´ìš©:', diaries);

            if(diaries.length === 0) {
                diaryList.innerHTML = '<p style="color: #666;">ì €ì¥ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            diaries.slice(0, 7).forEach(diary => {
                const diaryItem = document.createElement('div');
                diaryItem.className = 'diary-item';

                // ë‚ ì§œì™€ ì‚­ì œ ë²„íŠ¼ì„ ìœ„í•œ ì»¨í…Œì´ë„ˆ
                const headerDiv = document.createElement('div');
                headerDiv.style.display = 'flex';
                headerDiv.style.justifyContent = 'space-between';
                headerDiv.style.alignItems = 'flex-start';
                headerDiv.style.marginBottom = '8px';

                // ë‚ ì§œ í‘œì‹œ
                const dateDiv = document.createElement('div');
                dateDiv.style.fontSize = '0.8rem';
                dateDiv.style.color = '#666';
                dateDiv.textContent = `ğŸ“… ${diary.date}`;

                // ì‚­ì œ ë²„íŠ¼
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.title = 'ì¼ê¸° ì‚­ì œ';
                deleteBtn.textContent = 'ğŸ—‘ï¸';
                deleteBtn.onclick = function() {
                    deleteDiary(diary.id);
                };

                headerDiv.appendChild(dateDiv);
                headerDiv.appendChild(deleteBtn);

                // ë‚´ìš© ì¶”ê°€
                const contentDiv1 = document.createElement('div');
                contentDiv1.innerHTML = `<strong>ğŸ‘¥ íƒ€ì¸:</strong> ${diary.otherPersonAction}`;

                const contentDiv2 = document.createElement('div');
                contentDiv2.innerHTML = `<strong>ğŸ‘¨ ë‚˜:</strong> ${diary.myReaction}`;

                const contentDiv3 = document.createElement('div');
                contentDiv3.innerHTML = `<strong>ğŸ’¡ ì¬í•´ì„:</strong> <span style="color: var(--success);">${diary.reinterpretation}</span>`;

                diaryItem.appendChild(headerDiv);
                diaryItem.appendChild(contentDiv1);
                diaryItem.appendChild(contentDiv2);
                diaryItem.appendChild(contentDiv3);

                diaryList.appendChild(diaryItem);
            });
        }

        // ê°œë³„ ì¼ê¸° ì‚­ì œ
        async function deleteDiary(diaryId) {
            if(!confirm('ì •ë§ ì´ ê°ì • ì¼ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            if (currentUser && supabaseClient) {
                // DBì—ì„œ í•´ë‹¹ ì¼ê¸° ì‚­ì œ
                try {
                    const { error } = await supabaseClient
                        .from('emotion_diaries')
                        .delete()
                        .eq('id', diaryId)
                        .eq('user_id', currentUser.id); // ë³´ì•ˆ: ìì‹ ì˜ ì¼ê¸°ë§Œ ì‚­ì œ ê°€ëŠ¥

                    if (error) {
                        console.error('ì¼ê¸° ì‚­ì œ ì˜¤ë¥˜:', error);
                        alert('ì¼ê¸° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        return;
                    }
                } catch (error) {
                    console.error('ì¼ê¸° ì‚­ì œ ì‹œìŠ¤í…œ ì˜¤ë¥˜:', error);
                    alert('ì¼ê¸° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
            }

            // ë°°ì—´ì—ì„œ í•´ë‹¹ ì¼ê¸° ì œê±°
            diaries = diaries.filter(diary => diary.id !== diaryId);
            displayDiaries();
            alert('ì¼ê¸°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ì¼ê¸° ì‚­ì œ
        async function clearDiaries() {
            if(confirm('ì •ë§ ëª¨ë“  ê°ì • ì¼ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                if (currentUser && supabaseClient) {
                    // DBì—ì„œ ì¼ê¸° ì‚­ì œ
                    try {
                        const { error } = await supabaseClient
                            .from('emotion_diaries')
                            .delete()
                            .eq('user_id', currentUser.id);

                        if (error) {
                            console.error('ì¼ê¸° ì‚­ì œ ì˜¤ë¥˜:', error);
                            alert('ì¼ê¸° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                            return;
                        }
                    } catch (error) {
                        console.error('ì¼ê¸° ì‚­ì œ ì‹œìŠ¤í…œ ì˜¤ë¥˜:', error);
                        alert('ì¼ê¸° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        return;
                    }
                }
                diaries = [];
                displayDiaries();
                alert('ëª¨ë“  ì¼ê¸°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëª¨ë“  í¬ì¸íŠ¸ì™€ ë ˆë²¨ ë¦¬ì…‹ í•¨ìˆ˜
        async function resetAllPointsAndLevels() {
            if (confirm('ì •ë§ ëª¨ë“  í¬ì¸íŠ¸ì™€ ë ˆë²¨ì„ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                // ëª¨ë“  í¬ì¸íŠ¸ì™€ ë ˆë²¨ì„ 0ìœ¼ë¡œ ì´ˆê¸°í™”
                userData.points = 0;
                userData.totalPoints = 0;
                userData.level = 1;
                userData.breathingPoints = 0;

                // ì²´í¬ë¦¬ìŠ¤íŠ¸ëŠ” ìœ ì§€í•˜ì§€ë§Œ ì˜¤ëŠ˜ì˜ í¬ì¸íŠ¸ëŠ” ì´ˆê¸°í™”
                userData.completedToday = [];
                userData.lastCheck = null;

                // DBì— ì €ì¥
                if (currentUser && supabaseClient) {
                    await saveUserDataToSupabase();
                }

                // UI ì—…ë°ì´íŠ¸
                updateUI();
                updateLevelProgress();
                updateDailyPoints();

                alert('âœ… ëª¨ë“  í¬ì¸íŠ¸ì™€ ë ˆë²¨ì´ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤.\nì˜¤ëŠ˜ë¶€í„° ìƒˆë¡œ ì‹œì‘í•˜ì„¸ìš”!');
            }
        }

        
        
        // ë‚ ì§œ ë³€ê²½ í™•ì¸ ë° completedToday ë°°ì—´ ì´ˆê¸°í™”
        async function checkDateChangeAndReset() {
            const today = new Date();
            const lastCheck = userData.lastCheck ? new Date(userData.lastCheck) : null;

            const isSameDay = lastCheck &&
                today.getFullYear() === lastCheck.getFullYear() &&
                today.getMonth() === lastCheck.getMonth() &&
                today.getDate() === lastCheck.getDate();

            console.log('ë‚ ì§œ ë³€ê²½ í™•ì¸:', {
                today: today.toISOString(),
                lastCheck: userData.lastCheck,
                isSameDay,
                completedToday: userData.completedToday
            });

            if (lastCheck && !isSameDay) {
                // ë‚ ì§œê°€ ë³€ê²½ëœ ê²½ìš°
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);

                const isLastCheckYesterday = lastCheck.getFullYear() === yesterday.getFullYear() &&
                    lastCheck.getMonth() === yesterday.getMonth() &&
                    lastCheck.getDate() === yesterday.getDate();

                console.log('ë‚ ì§œ ë³€ê²½ ê°ì§€:', { isLastCheckYesterday });

                if (!isLastCheckYesterday) {
                    // ë§ˆì§€ë§‰ ì²´í¬ê°€ ì–´ì œê°€ ì•„ë‹ˆë©´ ì—°ì† ê¸°ë¡ ì´ˆê¸°í™”
                    userData.streak = 0;
                    userData.startDate = null; // ì‹œì‘ì¼ë„ ë¦¬ì…‹
                    console.log('ì—°ì† ê¸°ë¡ì´ ëŠê²¼ìŠµë‹ˆë‹¤. ì—°ì† ì¼ìˆ˜ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.');
                }

                // completedToday ë°°ì—´ê³¼ ì˜¤ëŠ˜ì˜ í¬ì¸íŠ¸ ì´ˆê¸°í™”
                userData.completedToday = [];
                userData.breathingPoints = 0;

                // ëª¨ë“  ì²´í¬ë°•ìŠ¤ í™œì„±í™” ë° ìƒíƒœ ì´ˆê¸°í™”
                document.querySelectorAll('.check-input').forEach(checkbox => {
                    checkbox.disabled = false;
                    checkbox.checked = false;
                    checkbox.removeAttribute('title');
                    checkbox.parentElement.classList.remove('completed');
                });

                // ë³€ê²½ëœ ë°ì´í„° ì €ì¥
                if (currentUser && supabaseClient) {
                    await saveUserDataToSupabase();
                }

                // UI ì—…ë°ì´íŠ¸
                updateUI();

                console.log('ë‚ ì§œ ë³€ê²½ìœ¼ë¡œ completedToday ë°°ì—´ì´ ì´ˆê¸°í™”ë˜ê³  ëª¨ë“  ì²´í¬ë°•ìŠ¤ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                console.log('ì˜¤ëŠ˜ ë‚ ì§œì´ê±°ë‚˜ ì²« ì‚¬ìš©ì…ë‹ˆë‹¤. ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒíƒœë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.');
            }
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            // í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.getElementById('loginFormElement')?.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('ë¡œê·¸ì¸ í¼ ì œì¶œë¨');
                login();
            });

            document.getElementById('signupFormElement')?.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('íšŒì›ê°€ì… í¼ ì œì¶œë¨');
                signup();
            });

            // Supabase ì´ˆê¸°í™”
            const supabaseInitialized = await initializeSupabase();
            if (!supabaseInitialized) {
                console.error('Supabase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸ì¦ ê¸°ëŠ¥ì´ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }

            // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ë¹„í™œì„±í™” - checkAuthStateë§Œìœ¼ë¡œ ì²˜ë¦¬
            // onAuthStateChange ë¦¬ìŠ¤ë„ˆëŠ” í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œ ë°ì´í„° ë¦¬ì…‹ ë¬¸ì œë¥¼ ì¼ìœ¼í‚´

            // ì´ˆê¸° ì¸ì¦ ìƒíƒœ í™•ì¸
            await checkAuthState();

            // ìµœì¢… UI ì—…ë°ì´íŠ¸ (ë°ì´í„° ì €ì¥ í˜¸ì¶œ ì—†ì´ ì§ì ‘ ì—…ë°ì´íŠ¸)
            if (currentUser && supabaseClient) {
                // ë¡œê·¸ì¸ ìƒíƒœ: í˜„ì¬ ë°ì´í„°ë¡œ UI ì—…ë°ì´íŠ¸
                document.getElementById('streak').textContent = userData.streak;
                document.getElementById('level').textContent = userData.level;
                document.getElementById('points').textContent = userData.points;
                // document.getElementById('dailyPoints').textContent = '0'; // ìš”ì†Œ ì œê±°ë¨
                updateLevelProgress();
            } else {
                // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ: ê¸°ë³¸ê°’ìœ¼ë¡œ UI ì—…ë°ì´íŠ¸
                document.getElementById('streak').textContent = '0';
                document.getElementById('level').textContent = '1';
                document.getElementById('points').textContent = '0';
                // document.getElementById('dailyPoints').textContent = '0'; // ìš”ì†Œ ì œê±°ë¨
                const progressBar = document.getElementById('progressBar');
                if (progressBar) progressBar.style.width = '0%';
            }

            // ì¼ê¸° ì„¹ì…˜ ì´ˆê¸° UI ì„¤ì •
            const diaryLoginPrompt = document.getElementById('diaryLoginPrompt');
            const diaryForm = document.getElementById('diaryForm');
            const recentDiarySection = document.getElementById('recentDiarySection');
            if (currentUser && supabaseClient) {
                diaryLoginPrompt.style.display = 'none';
                diaryForm.style.display = 'block';
                // ìµœê·¼ ê°ì • ì¼ê¸° ì„¹ì…˜ í‘œì‹œ
                if (recentDiarySection) recentDiarySection.style.display = 'block';
            } else {
                diaryLoginPrompt.style.display = 'block';
                diaryForm.style.display = 'none';
                // ìµœê·¼ ê°ì • ì¼ê¸° ì„¹ì…˜ ìˆ¨ê¸°ê¸°
                if (recentDiarySection) recentDiarySection.style.display = 'none';
            }

            // ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ ì´ˆê¸° UI ì„¤ì •
            const isLoggedIn = currentUser && supabaseClient;
            const checklistMessage = document.getElementById('checklistMessage');
            const checkboxes = document.querySelectorAll('.check-input');
            const emergencyBtn = document.querySelector('.emergency-btn');

            if (checklistMessage) {
                if (isLoggedIn) {
                    checklistMessage.style.display = 'none';
                } else {
                    checklistMessage.innerHTML = 'ğŸ”’ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>ëª¨ë“  ë°ì´í„°ëŠ” ì•ˆì „í•˜ê²Œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë©ë‹ˆë‹¤.';
                    checklistMessage.style.display = 'block';
                }
            }

            checkboxes.forEach(checkbox => {
                checkbox.disabled = !isLoggedIn;
                if (!isLoggedIn) {
                    checkbox.checked = false;
                    checkbox.setAttribute('title', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
                    checkbox.parentElement.classList.remove('completed');
                }
            });

            if (emergencyBtn) {
                emergencyBtn.disabled = !isLoggedIn;
            }
        });

        // ì¸ì¦ ìƒíƒœ í™•ì¸
        async function checkAuthState() {
            if (!supabaseClient || !supabaseClient.auth) {
                console.log('Supabase í´ë¼ì´ì–¸íŠ¸ ë˜ëŠ” auth ëª¨ë“ˆì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ');
                return;
            }

            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();

                if (error) {
                    console.log('ì¸ì¦ëœ ì‚¬ìš©ì ì—†ìŒ:', error.message);
                    return;
                }

                if (session && session.user) {
                    // ì„¸ì…˜ì´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ë°ì´í„° ë¡œë“œ (ìƒˆë¡œê³ ì¹¨ ì‹œ ë°ì´í„° ìœ ì§€)
                    currentUser = session.user;
                    document.getElementById('userEmail').textContent = session.user.email;
                    document.getElementById('userSection').style.display = 'flex';
                    document.getElementById('loginSection').style.display = 'none';

                    try {
                        await loadUserData();
                        await loadDiaries();
                        updateUI();
                        console.log('ì„¸ì…˜ í™•ì¸ ë° ë°ì´í„° ìë™ ë¡œë“œ ì™„ë£Œ:', session.user.email);
                    } catch (error) {
                        console.error('ë°ì´í„° ìë™ ë¡œë“œ ì‹¤íŒ¨:', error);
                        // ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ì‹œì—ë„ ì„¸ì…˜ì€ ìœ ì§€
                        showMessage('loginMessage', 'ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                    }
                } else {
                    // ë¹„ë¡œê·¸ì¸ ìƒíƒœì¸ ê²½ìš° UIë§Œ ì´ˆê¸°í™” (ë°ì´í„°ëŠ” ë³´ì¡´)
                    currentUser = null;
                    document.getElementById('userSection').style.display = 'none';
                    document.getElementById('loginSection').style.display = 'block';
                    console.log('ë¹„ë¡œê·¸ì¸ ìƒíƒœ: UI ì´ˆê¸°í™”ë¨');
                }
            } catch (error) {
                console.error('ì¸ì¦ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
            }
        }
    </script>

<!--
ê°œë³„ ê°ì •ì¼ê¸° ì‚­ì œ ê¸°ëŠ¥ ì¶”ê°€ - 2025-09-14

ìˆ˜ì •í•œ ë‚´ìš©:
1. loadDiaries() í•¨ìˆ˜ (1095-1131ë²ˆ ë¼ì¸): ì¼ê¸° ID ì €ì¥ ê¸°ëŠ¥ ì¶”ê°€
2. displayDiaries() í•¨ìˆ˜ (1887-1914ë²ˆ ë¼ì¸): ê°œë³„ ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
3. deleteDiary(diaryId) í•¨ìˆ˜ (1916-1947ë²ˆ ë¼ì¸): ê°œë³„ ì‚­ì œ ë¡œì§ êµ¬í˜„
4. CSS ìŠ¤íƒ€ì¼ (222-239ë²ˆ ë¼ì¸): ì‚­ì œ ë²„íŠ¼ ë””ìì¸ ì¶”ê°€

ì›ë˜ëŒ€ë¡œ ë³µêµ¬í•˜ëŠ” ë°©ë²•:
1. 1116ë²ˆ ë¼ì¸ì—ì„œ "id: diary.id," ì œê±°
2. 1903-1907ë²ˆ ë¼ì¸ ì‚­ì œ ë²„íŠ¼ HTML ì½”ë“œ ì œê±°
3. 1916-1947ë²ˆ ë¼ì¸ deleteDiary í•¨ìˆ˜ ì „ì²´ ì‚­ì œ
4. 222-239ë²ˆ ë¼ì¸ .delete-btn CSS ìŠ¤íƒ€ì¼ ì „ì²´ ì‚­ì œ
5. displayDiaries() í•¨ìˆ˜ë¥¼ ì›ë˜ í˜•íƒœë¡œ ë³µì›:
   diaries.slice(0, 7).forEach(diary => {
       const diaryItem = document.createElement('div');
       diaryItem.className = 'diary-item';
       diaryItem.innerHTML = `
           <div style="font-size: 0.8rem; color: #666; margin-bottom: 5px;">ğŸ“… ${diary.date}</div>
           <div><strong>ğŸ‘¥ íƒ€ì¸:</strong> ${diary.otherPersonAction}</div>
           <div><strong>ğŸ‘¨ ë‚˜:</strong> ${diary.myReaction}</div>
           <div><strong>ğŸ’¡ ì¬í•´ì„:</strong> <span style="color: var(--success);">${diary.reinterpretation}</span></div>
       `;
       diaryList.appendChild(diaryItem);
   });
-->
</body>
</html>