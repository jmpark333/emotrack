<!DOCTYPE html>
<html>
<head>
    <title>ì •ì„œì  ë…ë¦½ íŠ¸ë˜ì»¤</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7"></script>
    <style>
        :root {
            --primary: #6C5CE7;
            --secondary: #A29BFE;
            --success: #00B894;
            --warning: #FDCB6E;
            --danger: #FF7675;
            --light: #DFE6E9;
            --dark: #2D3436;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            color: var(--dark);
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            color: var(--primary);
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            flex: 1;
            margin: 0 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.6s, box-shadow 0.2s;
            transform-style: preserve-3d;
            position: relative;
            height: 120px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-card.flipped {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 15px;
            padding: 15px;
            box-sizing: border-box;
        }

        .card-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            padding: 10px;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .check-item {
            background: var(--light);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        .check-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .check-item.completed {
            background: rgba(0,184,148,0.1);
            border-left: 5px solid var(--success);
        }
        .check-input {
            margin-right: 10px;
            transform: scale(1.3);
        }
        .emergency-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            margin: 15px 0;
            transition: all 0.3s;
        }
        .emergency-btn:hover {
            background: #e84393;
            transform: scale(1.02);
        }
        .progress-bar {
            height: 8px;
            background: var(--light);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--warning));
            transition: width 0.5s;
        }
        .diary-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(108,92,231,0.1);
            border-radius: 15px;
        }
        .diary-input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 0.9rem;
        }
        .diary-label {
            display: block;
            font-size: 0.8rem;
            color: #666;
            margin-top: 10px;
            margin-bottom: 2px;
        }
        .diary-item {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            font-size: 0.85rem;
        }
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 5px 0;
        }
        .btn-danger {
            background: var(--danger);
        }
        .badge {
            display: inline-block;
            background: var(--warning);
            color: var(--dark);
            padding: 3px 10px;
            border-radius: 15px;
            margin: 3px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        /* ëª¨ë°”ì¼ ë·°ë¥¼ ìœ„í•œ ì¶”ê°€ ìŠ¤íƒ€ì¼ */
        body.mobile-view {
            padding: 10px;
        }
        
        body.mobile-view .container {
            padding: 15px;
        }
        
        body.mobile-view .header h1 {
            font-size: 1.5rem;
        }
        
        body.mobile-view .stat-card {
            padding: 12px 8px;
            margin: 0 3px;
        }
        
        body.mobile-view .stat-value {
            font-size: 1.2rem;
        }
        
        body.mobile-view .check-item {
            padding: 10px;
            margin-bottom: 6px;
        }
        
        body.mobile-view .check-input {
            transform: scale(1.2);
        }
        
        body.mobile-view .diary-input {
            font-size: 1rem;
            padding: 10px;
        }
        
        body.mobile-view .btn, body.mobile-view .emergency-btn {
            padding: 12px 15px;
            font-size: 1rem;
        }
        
        body.mobile-view .diary-item {
            font-size: 0.9rem;
            padding: 12px;
        }
        
        /* í™ˆ í™”ë©´ ì•„ì´ì½˜ ì¶”ê°€ë¥¼ ìœ„í•œ ë©”íƒ€ íƒœê·¸ */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #8B7CF6;
                --secondary: #A29BFE;
            }
        }

        /* ì¸ì¦ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .close {
            position: absolute;
            right: 15px;
            top: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .close:hover {
            color: #000;
        }

        #authTabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--light);
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: bold;
        }

        .auth-form {
            text-align: center;
        }

        .auth-form h2 {
            margin-bottom: 20px;
            color: var(--dark);
        }

        .auth-form input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .auth-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .auth-btn:hover {
            background: var(--secondary);
        }

        .auth-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .auth-message.success {
            background: var(--success);
            color: white;
        }

        .auth-message.error {
            background: var(--danger);
            color: white;
        }

        #userSection {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }

        #loginSection {
            text-align: center;
            margin-top: 10px;
        }
    </style>
    
    <!-- í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ê¸° ìœ„í•œ ì„¤ì • -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ì •ì„œì  ë…ë¦½ íŠ¸ë˜ì»¤">
    <meta name="mobile-web-app-capable" content="yes">
    </head>
<body>
    <div class="container">
        <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… ëª¨ë‹¬ -->
        <div id="authModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeAuthModal()">&times;</span>
                <div id="authTabs">
                    <button class="tab-btn active" onclick="switchTab('login')">ë¡œê·¸ì¸</button>
                    <button class="tab-btn" onclick="switchTab('signup')">íšŒì›ê°€ì…</button>
                </div>

                <!-- ë¡œê·¸ì¸ í¼ -->
                <div id="loginForm" class="auth-form">
                    <h2>ë¡œê·¸ì¸</h2>
                    <form onsubmit="login(); return false;">
                        <label for="loginEmail">ì´ë©”ì¼</label>
                        <input type="email" id="loginEmail" placeholder="ì´ë©”ì¼" required autocomplete="email">
                        <label for="loginPassword">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" required autocomplete="current-password">
                        <button type="submit" class="auth-btn">ë¡œê·¸ì¸</button>
                    </form>
                    <div id="loginMessage" class="auth-message"></div>
                </div>

                <!-- íšŒì›ê°€ì… í¼ -->
                <div id="signupForm" class="auth-form" style="display: none;">
                    <h2>íšŒì›ê°€ì…</h2>
                    <form onsubmit="signup(); return false;">
                        <label for="signupEmail">ì´ë©”ì¼</label>
                        <input type="email" id="signupEmail" placeholder="ì´ë©”ì¼" required autocomplete="email">
                        <label for="signupPassword">ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label>
                        <input type="password" id="signupPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" required autocomplete="new-password">
                        <label for="signupConfirmPassword">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <input type="password" id="signupConfirmPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" required autocomplete="new-password">
                        <button type="submit" class="auth-btn">íšŒì›ê°€ì…</button>
                    </form>
                    <div id="signupMessage" class="auth-message"></div>
                </div>
            </div>
        </div>

        <div class="header">
            <h1>ğŸ§˜â€â™‚ï¸ ì •ì„œì  ë…ë¦½ íŠ¸ë˜ì»¤</h1>
            <p>ì˜¤ëŠ˜ë„ ë‹¹ì‹ ì˜ í‰ì˜¨í•¨ì„ ì§€í‚¤ëŠ” í•˜ë£¨ê°€ ë˜ê¸¸</p>
            <div id="userSection" style="display: none;">
                <span id="userEmail"></span>
                <button onclick="logout()" style="margin-left: 10px; padding: 5px 10px; background: var(--danger); color: white; border: none; border-radius: 5px; cursor: pointer;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <div id="loginSection">
                <button onclick="openAuthModal()" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">ë¡œê·¸ì¸/íšŒì›ê°€ì…</button>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card" id="streakCard" onclick="flipCard()" title="í´ë¦­í•˜ì—¬ ì‹œì‘ì¼ í™•ì¸">
                <div class="card-front">
                    <div class="stat-value" id="streak" style="margin-bottom: 5px;">0</div>
                    <div style="font-size: 0.9rem;">ì—°ì† ì¼ìˆ˜</div>
                </div>
                <div class="card-back">
                    <div style="font-size: 0.9rem; font-weight: bold; margin-bottom: 8px;">ğŸ“… ì‹œì‘ì¼</div>
                    <div id="startDateDisplay" style="font-size: 0.8rem; margin-bottom: 10px;">ì‹œì‘ì¼ ì—†ìŒ</div>
                    <button onclick="resetStreak(event)" style="background: #ff6b6b; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.7rem; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#ff5252'" onmouseout="this.style.background='#ff6b6b'">
                        ğŸ”„ ë¦¬ì…‹
                    </button>
                </div>
            </div>
            <div class="stat-card" id="levelCard" onclick="flipLevelCard()" title="í´ë¦­í•˜ì—¬ ë ˆë²¨ ì§„í–‰ë„ í™•ì¸">
                <div class="card-front">
                    <div class="stat-value" id="level" style="margin-bottom: 5px;">1</div>
                    <div style="font-size: 0.9rem;">í‰ì˜¨ ë ˆë²¨</div>
                </div>
                <div class="card-back">
                    <div id="levelProgressDisplay" style="font-size: 1.0rem; font-weight: bold;">ë‹¤ìŒ ë ˆë²¨ê¹Œì§€: 100í¬ì¸íŠ¸</div>
                </div>
            </div>
            <div class="stat-card" id="pointsCard" onclick="flipPointsCard()" title="í´ë¦­í•˜ì—¬ í¬ì¸íŠ¸ ì •ë³´ í™•ì¸">
                <div class="card-front">
                    <div class="stat-value" id="points" style="margin-bottom: 5px;">0</div>
                    <div style="font-size: 0.9rem;">í‰ì˜¨ í¬ì¸íŠ¸</div>
                </div>
                <div class="card-back">
                    <div style="font-size: 1.0rem; font-weight: bold; margin-bottom: 10px;">ğŸ“ˆ í‰ì˜¨ í¬ì¸íŠ¸</div>
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.9);">
                        ì´ íšë“ í¬ì¸íŠ¸
                    </div>
                </div>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress" id="dailyProgress" style="width: 0%"></div>
        </div>
        
        <h3>ğŸŒ… ì•„ì¹¨ í›ˆë ¨</h3>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="morning1">
            <label for="morning1">ê°ì • ë¶„ë¦¬ ì„ ì–¸ ("ì˜¤ëŠ˜ ì•„ë‚´ì˜ ê°ì •ì€ ë‚˜ì˜ ê²ƒì´ ì•„ë‹˜" 3ë²ˆ)</label>
        </div>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="morning2">
            <label for="morning2">ì˜¤ëŠ˜ ì§€í‚¬ í•µì‹¬ ê°€ì¹˜ ì„ íƒ (í‰ì˜¨/ì¡´ì¤‘/ìì¡´ê°)</label>
        </div>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="morning3">
            <label for="morning3">ì˜¤ëŠ˜ì˜ 'ë‚˜ë§Œì˜ 30ë¶„' ê³„íš ì„¸ìš°ê¸°</label>
        </div>
        
        <h3>ğŸŒ ì ì‹¬ í›ˆë ¨</h3>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="noon1">
            <label for="noon1">ë¹„íŒì  ë§ ë“¤ì—ˆì„ ë•Œ "ì´ê±´ ì‚¬ì‹¤ì¸ê°€?" í•„í„°ë§</label>
        </div>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="noon2">
            <label for="noon2">"ì§€ê¸ˆì€ ì–´ë µë‹¤"ê³  ë§í•˜ê¸° (ì•„ë‹ˆì˜¤ ì—°ìŠµ)</label>
        </div>
        
        <h3>ğŸŒ™ ì €ë… í›ˆë ¨</h3>
        <div class="check-item">
            <input type="checkbox" class="check-input" id="evening1">
            <label for="evening1">ê°ì • í­ë°œ ì‹œ 4-7-8 í˜¸í¡ë²• 3íšŒ</label>
        </div>
        
        <div class="check-item">
            <input type="checkbox" class="check-input" id="evening2">
            <label for="evening2">ğŸ“– ê°ì • ì¼ê¸° ì‘ì„±</label>
            <label for="wifeAction" class="diary-label">ì•„ë‚´ì˜ í–‰ë™</label>
            <input type="text" id="wifeAction" class="diary-input" placeholder="ì•„ë‚´ì˜ í–‰ë™ (ì˜ˆ: ê³ ì„± ì§ˆë¬¸)" aria-label="ì•„ë‚´ì˜ í–‰ë™">
            <label for="myReaction" class="diary-label">ë‚´ ì²« ë°˜ì‘</label>
            <input type="text" id="myReaction" class="diary-input" placeholder="ë‚´ ì²« ë°˜ì‘ (ì˜ˆ: ì£„ì±…ê° + ë¶„ë…¸)" aria-label="ë‚´ ì²« ë°˜ì‘">
            <label for="reinterpretation" class="diary-label">ì¬í•´ì„</label>
            <input type="text" id="reinterpretation" class="diary-input" placeholder="ì¬í•´ì„ (ì˜ˆ: ê·¸ë…€ëŠ” ë¶ˆì•ˆí•´ì„œ ê·¸ëŸ° ê±°ì•¼)" aria-label="ì¬í•´ì„">
            <button class="btn" onclick="saveDiary()">ğŸ’¾ ì €ì¥í•˜ê³  ì²´í¬ ì™„ë£Œ</button>
        </div>
        
        <div class="check-item">
            <input type="checkbox" class="check-input" id="evening3">
            <label for="evening3">ì˜¤ëŠ˜ ë‚˜ë¥¼ ì§€í‚¨ í–‰ë™ 1ê°€ì§€ ì¹­ì°¬í•˜ê¸°</label>
        </div>
        
        <button class="emergency-btn" onclick="startBreathing()">
            ğŸš¨ ê¸´ê¸‰ í˜¸í¡ë²• ì‹œì‘ (4-7-8)
        </button>
        
        <div class="diary-section">
            <h3>ğŸ“š ìµœê·¼ ê°ì • ì¼ê¸°</h3>
            <div id="diaryList"></div>
            <button class="btn btn-danger" onclick="clearDiaries()">ğŸ—‘ï¸ ëª¨ë“  ì¼ê¸° ì‚­ì œ</button>
        </div>
        
        <div class="reward">
            <h3>ğŸ† ì˜¤ëŠ˜ì˜ ë³´ìƒ</h3>
            <div id="badges"></div>
            <div style="text-align: center; margin: 10px 0;">
                <div style="font-size: 0.9rem; color: #666;">ì˜¤ëŠ˜ íšë“ í¬ì¸íŠ¸</div>
                <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary);" id="dailyPoints">0</div>
            </div>
            <p id="rewardText">ëª¨ë“  ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ì™„ë£Œí•˜ë©´ ë³´ìƒì´ ì—´ë¦½ë‹ˆë‹¤!</p>
        </div>
    </div>

    <script>
        // Supabase í´ë¼ì´ì–¸íŠ¸ (ì „ì—­ ë³€ìˆ˜)
        let supabaseClient = null;
        let currentUser = null;

        // Supabase ì´ˆê¸°í™” í•¨ìˆ˜
        function initializeSupabase() {
            // Supabase SDK ë¡œë”© í™•ì¸
            if (typeof supabase === 'undefined') {
                console.error('Supabase SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. CDNì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return false;
            }

            // Supabase ì´ˆê¸°í™”
            const supabaseUrl = 'https://hpejebnqhgojfxttfbal.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwZWplYm5xaGdvamZ4dHRmYmFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NTA4MTIsImV4cCI6MjA3MzMyNjgxMn0.AibxZdVe1INo5e3voeA6lVkdI9nY46_MuWJWFl2_JAg';

            try {
                supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                console.log('Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì„±ê³µ');
                return true;
            } catch (error) {
                console.error('Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                return false;
            }
        }

        // ë°ì´í„° ì´ˆê¸°í™”
        let userData = JSON.parse(localStorage.getItem('emotionalIndependence')) || {
            streak: 0,
            level: 1,
            points: 0,
            lastCheck: null,
            completedToday: [],
            totalPoints: 0,  // ì´ ëˆ„ì  í¬ì¸íŠ¸ ì¶”ê°€
            startDate: null,  // ì—°ì† ì‚¬ìš© ì‹œì‘ì¼ ì¶”ê°€
            lastCompletedDate: null  // ë§ˆì§€ë§‰ìœ¼ë¡œ ëª¨ë“  í•­ëª©ì„ ì™„ë£Œí•œ ë‚ ì§œ
        };

        let diaries = JSON.parse(localStorage.getItem('emotionDiaries')) || [];

        // ================ ì¸ì¦ ê´€ë ¨ í•¨ìˆ˜ ================

        // ì¸ì¦ ëª¨ë‹¬ ì—´ê¸°
        function openAuthModal() {
            document.getElementById('authModal').style.display = 'block';
        }

        // ì¸ì¦ ëª¨ë‹¬ ë‹«ê¸°
        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            clearMessages();
        }

        // íƒ­ ì „í™˜
        function switchTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const tabBtns = document.querySelectorAll('.tab-btn');

            tabBtns.forEach(btn => btn.classList.remove('active'));

            if (tab === 'login') {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
                tabBtns[0].classList.add('active');
            } else {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
                tabBtns[1].classList.add('active');
            }

            clearMessages();
        }

        // ë©”ì‹œì§€ ì§€ìš°ê¸°
        function clearMessages() {
            document.getElementById('loginMessage').textContent = '';
            document.getElementById('loginMessage').className = 'auth-message';
            document.getElementById('signupMessage').textContent = '';
            document.getElementById('signupMessage').className = 'auth-message';
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `auth-message ${type}`;
        }

        // íšŒì›ê°€ì…
        async function signup() {
            if (!supabaseClient) {
                showMessage('signupMessage', 'Supabaseê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;

            if (!email || !password || !confirmPassword) {
                showMessage('signupMessage', 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('signupMessage', 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showMessage('signupMessage', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            try {
                console.log('ğŸ“ íšŒì›ê°€ì… ì‹œë„:', { email, passwordLength: password.length });

                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password
                });

                console.log('ğŸ“‹ Supabase ì‘ë‹µ:', { data, error });

                if (error) {
                    console.error('âŒ Supabase íšŒì›ê°€ì… ì˜¤ë¥˜:', error);
                    showMessage('signupMessage', `ì˜¤ë¥˜: ${error.message}`, 'error');
                    return;
                }

                if (data && data.user && !data.user.email_confirmed_at) {
                    console.log('âœ… íšŒì›ê°€ì… ì„±ê³µ (ì´ë©”ì¼ í™•ì¸ í•„ìš”)');
                    showMessage('signupMessage', 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'success');
                } else if (data && data.user) {
                    console.log('âœ… íšŒì›ê°€ì… ì„±ê³µ (ì¦‰ì‹œ ë¡œê·¸ì¸)');
                    showMessage('signupMessage', 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } else {
                    console.log('âš ï¸ ì‘ë‹µ ë°ì´í„° ì—†ìŒ');
                    showMessage('signupMessage', 'íšŒì›ê°€ì…ì´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                }

                // 3ì´ˆ í›„ ë¡œê·¸ì¸ íƒ­ìœ¼ë¡œ ì „í™˜
                setTimeout(() => {
                    switchTab('login');
                    document.getElementById('loginEmail').value = email;
                }, 3000);

            } catch (error) {
                console.error('ğŸ’¥ íšŒì›ê°€ì… ì‹œìŠ¤í…œ ì˜¤ë¥˜:', error);
                showMessage('signupMessage', `ì‹œìŠ¤í…œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ë¡œê·¸ì¸
        async function login() {
            if (!supabaseClient) {
                showMessage('loginMessage', 'Supabaseê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showMessage('loginMessage', 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    showMessage('loginMessage', error.message, 'error');
                    return;
                }

                currentUser = data.user;
                await loadUserData();

                // UI ì—…ë°ì´íŠ¸
                document.getElementById('userEmail').textContent = email;
                document.getElementById('userSection').style.display = 'flex';
                document.getElementById('loginSection').style.display = 'none';

                closeAuthModal();
                updateUI();

            } catch (error) {
                showMessage('loginMessage', 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ë¡œê·¸ì•„ì›ƒ
        async function logout() {
            if (!supabase) return;

            try {
                await supabase.auth.signOut();
                currentUser = null;

                // UI ì—…ë°ì´íŠ¸
                document.getElementById('userSection').style.display = 'none';
                document.getElementById('loginSection').style.display = 'block';

                // ê¸°ë³¸ ë°ì´í„°ë¡œ ì´ˆê¸°í™”
                userData = {
                    streak: 0,
                    level: 1,
                    points: 0,
                    lastCheck: null,
                    completedToday: [],
                    totalPoints: 0,
                    startDate: null,
                    lastCompletedDate: null
                };

                updateUI();

            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
            }
        }

        // ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ
        async function loadUserData() {
            if (!currentUser || !supabaseClient) {
                // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° localStorageì—ì„œ ë¡œë“œ
                userData = JSON.parse(localStorage.getItem('emotionalIndependence')) || {
                    streak: 0,
                    level: 1,
                    points: 0,
                    lastCheck: null,
                    completedToday: [],
                    totalPoints: 0,
                    startDate: null,
                    lastCompletedDate: null
                };
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('user_data')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116: ë°ì´í„° ì—†ìŒ
                    console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                    return;
                }

                if (data) {
                    userData = {
                        streak: data.streak || 0,
                        level: data.level || 1,
                        points: data.points || 0,
                        lastCheck: data.last_check,
                        completedToday: data.completed_today || [],
                        totalPoints: data.total_points || 0,
                        startDate: data.start_date,
                        lastCompletedDate: data.last_completed_date
                    };
                } else {
                    // ìƒˆ ì‚¬ìš©ì ë°ì´í„° ìƒì„±
                    await saveUserData();
                }

            } catch (error) {
                console.error('ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ì‚¬ìš©ì ë°ì´í„° ì €ì¥ (Supabase)
        async function saveUserDataToSupabase() {
            if (!currentUser || !supabase) return;

            try {
                const { data, error } = await supabase
                    .from('user_data')
                    .upsert({
                        user_id: currentUser.id,
                        streak: userData.streak,
                        level: userData.level,
                        points: userData.points,
                        last_check: userData.lastCheck,
                        completed_today: userData.completedToday,
                        total_points: userData.totalPoints,
                        start_date: userData.startDate,
                        last_completed_date: userData.lastCompletedDate,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id'
                    });

                if (error) {
                    console.error('ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:', error);
                }

            } catch (error) {
                console.error('ì‚¬ìš©ì ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:', error);
            }
        }
        
        // ìŠ¤ë§ˆíŠ¸í° í™˜ê²½ ê°ì§€
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // ìŠ¤ë§ˆíŠ¸í°ì—ì„œì˜ ì‚¬ìš©ì„± ê°œì„ 
        if (isMobile) {
            document.body.classList.add('mobile-view');
        }

        // í™”ë©´ ì—…ë°ì´íŠ¸
        function updateUI() {
            // ì—°ì† ì¼ìˆ˜ í‘œì‹œ
            document.getElementById('streak').textContent = userData.streak;
            document.getElementById('level').textContent = userData.level;
            document.getElementById('points').textContent = userData.points;

            // ë ˆë²¨ ì§„í–‰ë„ í‘œì‹œ ì—…ë°ì´íŠ¸
            updateLevelProgress();

            // ì˜¤ëŠ˜ íšë“ í¬ì¸íŠ¸ í‘œì‹œ
            updateDailyPoints();

            // ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒíƒœ ë³µì›
            document.querySelectorAll('.check-input').forEach(checkbox => {
                checkbox.checked = userData.completedToday.includes(checkbox.id);
                checkbox.addEventListener('change', handleCheck);
            });

            updateProgress();
            updateBadges();
            displayDiaries();
        }

        // ì²´í¬ ì´ë²¤íŠ¸ ì²˜ë¦¬
        function handleCheck(e) {
            const id = e.target.id;
            const parent = e.target.parentElement;
            
            if(e.target.checked) {
                if(!userData.completedToday.includes(id)) {
                    userData.completedToday.push(id);
                    userData.points += 10;
                    userData.totalPoints = (userData.totalPoints || 0) + 10; // ì´ ëˆ„ì  í¬ì¸íŠ¸ ì¦ê°€
                    parent.classList.add('completed');
                }
            } else {
                userData.completedToday = userData.completedToday.filter(item => item !== id);
                userData.points -= 10;
                parent.classList.remove('completed');
            }
            
            // í˜„ì¬ ë‚ ì§œë¥¼ lastCheckì— ì„¤ì •í•˜ì—¬ í•˜ë£¨ ì¤‘ì— ì²´í¬ ìƒíƒœ ìœ ì§€
            userData.lastCheck = new Date().toDateString();
            
            // ë°ì´í„° ì €ì¥ ë° ë°±ì—…
            saveUserData();
            updateProgress();
            updateBadges();

            // ì˜¤ëŠ˜ íšë“ í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
            updateDailyPoints();

            // ë ˆë²¨ì—… ì²´í¬
            if(userData.points >= userData.level * 100) {
                userData.level++;
                alert(`ğŸ‰ ë ˆë²¨ì—…! í‰ì˜¨ ë ˆë²¨ ${userData.level} ë‹¬ì„±!`);
                saveUserData();
                updateLevelProgress();
            } else {
                updateLevelProgress();
            }
        }
        
        // ì‚¬ìš©ì ë°ì´í„° ì €ì¥ (í†µí•© í•¨ìˆ˜)
        async function saveUserData() {
            // localStorageì—ë„ ì €ì¥ (í˜¸í™˜ì„± ìœ ì§€)
            localStorage.setItem('emotionalIndependence', JSON.stringify(userData));

            // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ë„ ë°±ì—… (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ê°€ í´ë¦¬ì–´ë˜ëŠ” ê²½ìš° ëŒ€ë¹„)
            try {
                sessionStorage.setItem('emotionalIndependence_backup', JSON.stringify(userData));
            } catch (e) {
                console.log('ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ë°±ì—… ì‹¤íŒ¨:', e);
            }

            // Supabaseì— ì €ì¥ (ë¡œê·¸ì¸í•œ ê²½ìš°)
            if (currentUser && supabaseClient) {
                await saveUserDataToSupabase();
            }
        }

        // ì‚¬ìš©ì ë°ì´í„° ì €ì¥ ë° ë°±ì—… (ë¡œì»¬ ì „ìš©)
        function saveUserDataLocal() {
            localStorage.setItem('emotionalIndependence', JSON.stringify(userData));

            // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ë„ ë°±ì—… (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ê°€ í´ë¦¬ì–´ë˜ëŠ” ê²½ìš° ëŒ€ë¹„)
            try {
                sessionStorage.setItem('emotionalIndependence_backup', JSON.stringify(userData));
            } catch (e) {
                console.log('ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ë°±ì—… ì‹¤íŒ¨:', e);
            }
        }
        
        // ë°ì´í„° ë³µêµ¬ í•¨ìˆ˜
        function recoverUserData() {
            try {
                const backup = sessionStorage.getItem('emotionalIndependence_backup');
                if (backup && !localStorage.getItem('emotionalIndependence')) {
                    localStorage.setItem('emotionalIndependence', backup);
                    return JSON.parse(backup);
                }
            } catch (e) {
                console.log('ë°ì´í„° ë³µêµ¬ ì‹¤íŒ¨:', e);
            }
            return null;
        }

        // ë ˆë²¨ ì§„í–‰ë„ ì—…ë°ì´íŠ¸
        function updateLevelProgress() {
            const pointsNeeded = userData.level * 100;
            const pointsRemaining = Math.max(0, pointsNeeded - userData.points);
            const progressPercentage = userData.points >= pointsNeeded ? 100 : (userData.points / pointsNeeded) * 100;

            // ì•ë©´ì—ì„œëŠ” ë ˆë²¨ ì§„í–‰ë„ í‘œì‹œ ì œê±° (ë’·ë©´ì—ì„œë§Œ í‘œì‹œ)
        }

        // ë ˆë²¨ ì§„í–‰ë„ ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateLevelProgressDisplay() {
            const pointsNeeded = userData.level * 100;
            const pointsRemaining = Math.max(0, pointsNeeded - userData.points);

            document.getElementById('levelProgressDisplay').textContent = `ë‹¤ìŒ ë ˆë²¨ê¹Œì§€: ${pointsRemaining}í¬ì¸íŠ¸`;
        }

        // ì˜¤ëŠ˜ íšë“ í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
        function updateDailyPoints() {
            const dailyPoints = userData.completedToday.length * 10;
            document.getElementById('dailyPoints').textContent = dailyPoints;
        }

        // ì—°ì†ì¼ìˆ˜ ì¹´ë“œ ë’¤ì§‘ê¸° í•¨ìˆ˜
        function flipCard() {
            const card = document.getElementById('streakCard');
            card.classList.toggle('flipped');

            // ë’·ë©´ì´ ë³´ì¼ ë•Œ ì‹œì‘ì¼ ì •ë³´ ì—…ë°ì´íŠ¸
            if (card.classList.contains('flipped')) {
                updateStartDateDisplay();
            }
        }

        // í‰ì˜¨ë ˆë²¨ ì¹´ë“œ ë’¤ì§‘ê¸° í•¨ìˆ˜
        function flipLevelCard() {
            const card = document.getElementById('levelCard');
            card.classList.toggle('flipped');

            // ë’·ë©´ì´ ë³´ì¼ ë•Œ ë ˆë²¨ ì§„í–‰ë„ ì •ë³´ ì—…ë°ì´íŠ¸
            if (card.classList.contains('flipped')) {
                updateLevelProgressDisplay();
            }
        }

        // í‰ì˜¨í¬ì¸íŠ¸ ì¹´ë“œ ë’¤ì§‘ê¸° í•¨ìˆ˜
        function flipPointsCard() {
            const card = document.getElementById('pointsCard');
            card.classList.toggle('flipped');
        }

        // ì‹œì‘ì¼ í‘œì‹œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateStartDateDisplay() {
            const startDateDisplay = document.getElementById('startDateDisplay');

            if (userData.startDate) {
                const startDate = new Date(userData.startDate);
                const formattedDate = startDate.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                startDateDisplay.textContent = formattedDate;
            } else {
                startDateDisplay.textContent = 'ì‹œì‘ì¼ ì—†ìŒ';
            }
        }

        // ì—°ì†ì¼ìˆ˜ ë¦¬ì…‹ í•¨ìˆ˜
        function resetStreak(event) {
            event.stopPropagation(); // ì¹´ë“œ ë’¤ì§‘ê¸° ì´ë²¤íŠ¸ ë°©ì§€

            if (confirm('ì—°ì†ì¼ìˆ˜ë¥¼ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\nì‹œì‘ì¼ì´ ì˜¤ëŠ˜ë¡œ ë³€ê²½ë˜ê³  ì—°ì†ì¼ìˆ˜ëŠ” 0ì´ ë©ë‹ˆë‹¤.')) {
                const today = new Date().toDateString();

                // ë°ì´í„° ë¦¬ì…‹ (ì‹œì‘ì¼ì€ ì˜¤ëŠ˜ë¡œ ì„¤ì •)
                userData.startDate = today;
                userData.lastCompletedDate = null;
                userData.streak = 0;
                userData.completedToday = [];
                userData.lastCheck = null;

                // localStorageì— ì €ì¥
                localStorage.setItem('emotrack-data', JSON.stringify(userData));

                // UI ì—…ë°ì´íŠ¸
                document.getElementById('streak').textContent = '0';
                updateStartDateDisplay();
                updateProgress();

                // ì¹´ë“œ ì•ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                document.getElementById('streakCard').classList.remove('flipped');

                alert('ì—°ì†ì¼ìˆ˜ê°€ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤.\\nì˜¤ëŠ˜ë¶€í„° ìƒˆë¡œ ì‹œì‘í•©ë‹ˆë‹¤!');
            }
        }

        // ì—°ì† ì¼ìˆ˜ ìë™ ê³„ì‚° í•¨ìˆ˜
        function calculateStreak() {
            if (!userData.startDate) {
                return 0; // ì‹œì‘ì¼ì´ ì—†ìœ¼ë©´ 0 ë°˜í™˜
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const startDate = new Date(userData.startDate);
            startDate.setHours(0, 0, 0, 0);

            // ë‚ ì§œ ì°¨ì´ ê³„ì‚° (ë°€ë¦¬ì´ˆ â†’ ì¼)
            const diffTime = Math.abs(today - startDate);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            // ì—°ì† ì‚¬ìš© í™•ì¸: ë§ˆì§€ë§‰ ì™„ë£Œì¼ë¡œë¶€í„° í•˜ë£¨ê°€ ì§€ë‚¬ëŠ”ì§€ í™•ì¸
            if (userData.lastCompletedDate) {
                const lastCompleted = new Date(userData.lastCompletedDate);
                lastCompleted.setHours(0, 0, 0, 0);
                const daysSinceLastComplete = Math.floor((today - lastCompleted) / (1000 * 60 * 60 * 24));

                // í•˜ë£¨ ì´ìƒ ì§€ë‚¬ìœ¼ë©´ ì—°ì†ì´ ëŠê¹€
                if (daysSinceLastComplete > 1) {
                    return 0;
                }
            }

            return diffDays + 1; // ì‹œì‘ì¼ í¬í•¨
        }

        // ì—°ì† ì¼ìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateStreak() {
            const today = new Date().toDateString();
            const completed = userData.completedToday.length;
            const total = document.querySelectorAll('.check-input').length;
            const isAllCompleted = completed === total;

            // ì‹œì‘ì¼ ì„¤ì •
            if (!userData.startDate && isAllCompleted) {
                userData.startDate = today;
                userData.streak = 1;
            } else if (userData.startDate && isAllCompleted) {
                // ëª¨ë“  í•­ëª© ì™„ë£Œ ì‹œ ë§ˆì§€ë§‰ ì™„ë£Œì¼ ì—…ë°ì´íŠ¸
                userData.lastCompletedDate = today;
            }

            // ìë™ìœ¼ë¡œ ì—°ì†ì¼ìˆ˜ ê³„ì‚°
            if (userData.startDate) {
                userData.streak = calculateStreak();
            }
        }

        // ì§„í–‰ë„ ì—…ë°ì´íŠ¸
        function updateProgress() {
            const total = document.querySelectorAll('.check-input').length;
            const completed = userData.completedToday.length;
            const percentage = (completed / total) * 100;
            document.getElementById('dailyProgress').style.width = percentage + '%';

            // ì—°ì† ì¼ìˆ˜ ì—…ë°ì´íŠ¸
            updateStreak();
        }

        // ë±ƒì§€ ì—…ë°ì´íŠ¸
        function updateBadges() {
            const badgesContainer = document.getElementById('badges');
            badgesContainer.innerHTML = '';
            
            if(userData.streak >= 3) {
                badgesContainer.innerHTML += '<span class="badge">ğŸ”¥ 3ì¼ ì—°ì†</span>';
            }
            if(userData.streak >= 7) {
                badgesContainer.innerHTML += '<span class="badge">â­ í‰ì˜¨ ìˆ˜í˜¸ì</span>';
            }
            if(userData.level >= 3) {
                badgesContainer.innerHTML += '<span class="badge">ğŸ›¡ï¸ ì •ì‹ ì˜ ë°©íŒ¨</span>';
            }
            
            // ë³´ìƒ ë©”ì‹œì§€
            const total = document.querySelectorAll('.check-input').length;
            const completed = userData.completedToday.length;
            if(completed === total) {
                document.getElementById('rewardText').innerHTML = 
                    `ğŸ‰ ì™„ë£Œ! ì˜¤ëŠ˜ì˜ ë³´ìƒ: <strong>${getRandomReward()}</strong>`;
            }
        }

        // ëœë¤ ë³´ìƒ
        function getRandomReward() {
            const rewards = [
                "ë”°ëœ»í•œ ì°¨ í•œì”ì˜ ì—¬ìœ ",
                "ì¢‹ì•„í•˜ëŠ” ë…¸ë˜ 3ê³¡ ë“£ê¸°",
                "15ë¶„ ì¶”ê°€ íœ´ì‹",
                "ì‘ì€ ê°„ì‹ ë¨¹ê¸°",
                "ì˜¤ëŠ˜ì€ ì¹­ì°¬ ì¼ê¸° ì“°ì§€ ì•Šê¸°"
            ];
            return rewards[Math.floor(Math.random() * rewards.length)];
        }

        // í˜¸í¡ë²• íƒ€ì´ë¨¸
        function startBreathing() {
            alert("ğŸŒ¬ï¸ 4ì´ˆ ë“¤ì´ë§ˆì‹œê¸° â†’ 7ì´ˆ ì°¸ê¸° â†’ 8ì´ˆ ë‚´ì‰¬ê¸°\n\nì§€ê¸ˆ ì‹œì‘í•©ë‹ˆë‹¤. í™”ë©´ì„ ë³´ë©° ë”°ë¼í•´ì£¼ì„¸ìš”!");
            
            let step = 0;
            const steps = [
                { text: "ë“¤ì´ë§ˆì‹œê¸° (4ì´ˆ)", duration: 4000 },
                { text: "ì°¸ê¸° (7ì´ˆ)", duration: 7000 },
                { text: "ë‚´ì‰¬ê¸° (8ì´ˆ)", duration: 8000 }
            ];
            
            const interval = setInterval(() => {
                alert(steps[step].text);
                step++;
                if(step >= steps.length) {
                    clearInterval(interval);
                    alert("âœ… í˜¸í¡ë²• ì™„ë£Œ! ì´ì œ ì¡°ê¸ˆ ë” í‰ì˜¨í•´ì§€ì…¨ë‚˜ìš”?");
                }
            }, steps[step]?.duration || 0);
        }

        // ê°ì • ì¼ê¸° ì €ì¥
        function saveDiary() {
            const wifeAction = document.getElementById('wifeAction').value;
            const myReaction = document.getElementById('myReaction').value;
            const reinterpretation = document.getElementById('reinterpretation').value;
            
            if(!wifeAction || !myReaction || !reinterpretation) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const diary = {
                date: new Date().toLocaleString(),
                wifeAction,
                myReaction,
                reinterpretation
            };
            
            diaries.unshift(diary);
            localStorage.setItem('emotionDiaries', JSON.stringify(diaries));
            
            // ì¼ê¸° ë°ì´í„° ë°±ì—…
            try {
                sessionStorage.setItem('emotionDiaries_backup', JSON.stringify(diaries));
            } catch (e) {
                console.log('ì¼ê¸° ë°±ì—… ì‹¤íŒ¨:', e);
            }
            
            // ì²´í¬ë°•ìŠ¤ ìë™ ì™„ë£Œ
            document.getElementById('evening2').checked = true;
            handleCheck({target: document.getElementById('evening2')});
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('wifeAction').value = '';
            document.getElementById('myReaction').value = '';
            document.getElementById('reinterpretation').value = '';
            
            displayDiaries();
            alert('âœ… ê°ì • ì¼ê¸°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // ì¼ê¸° ëª©ë¡ í‘œì‹œ
        function displayDiaries() {
            const diaryList = document.getElementById('diaryList');
            diaryList.innerHTML = '';
            
            if(diaries.length === 0) {
                diaryList.innerHTML = '<p style="color: #666;">ì €ì¥ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }
            
            diaries.slice(0, 7).forEach(diary => {
                const diaryItem = document.createElement('div');
                diaryItem.className = 'diary-item';
                diaryItem.innerHTML = `
                    <div style="font-size: 0.8rem; color: #666; margin-bottom: 5px;">ğŸ“… ${diary.date}</div>
                    <div><strong>ğŸ‘© ì•„ë‚´:</strong> ${diary.wifeAction}</div>
                    <div><strong>ğŸ‘¨ ë‚˜:</strong> ${diary.myReaction}</div>
                    <div><strong>ğŸ’¡ ì¬í•´ì„:</strong> <span style="color: var(--success);">${diary.reinterpretation}</span></div>
                `;
                diaryList.appendChild(diaryItem);
            });
        }

        // ì¼ê¸° ì‚­ì œ
        function clearDiaries() {
            if(confirm('ì •ë§ ëª¨ë“  ê°ì • ì¼ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                diaries = [];
                localStorage.setItem('emotionDiaries', JSON.stringify(diaries));
                displayDiaries();
                alert('ëª¨ë“  ì¼ê¸°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        
        
        // ë‚ ì§œ ë³€ê²½ í™•ì¸ ë° completedToday ë°°ì—´ ì´ˆê¸°í™”
        function checkDateChangeAndReset() {
            const today = new Date().toDateString();
            const lastCheck = userData.lastCheck;

            if (lastCheck && lastCheck !== today) {
                // ë‚ ì§œê°€ ë³€ê²½ëœ ê²½ìš°
                const yesterday = new Date(lastCheck);
                const currentDate = new Date(today);
                const daysDiff = Math.floor((currentDate - yesterday) / (1000 * 60 * 60 * 24));

                if (daysDiff === 1) {
                    // í•˜ë£¨ê°€ ì§€ë‚œ ê²½ìš°: ì–´ì œ í™œë™í–ˆìœ¼ë©´ ì—°ì† ìœ ì§€
                    if (userData.lastCompletedDate === lastCheck) {
                        console.log('ì—°ì† ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.');
                    } else {
                        // ì–´ì œ ëª¨ë“  í•­ëª©ì„ ì™„ë£Œí•˜ì§€ ì•Šì•˜ìœ¼ë©´ ì—°ì† ì´ˆê¸°í™”
                        userData.startDate = today;
                        userData.streak = 0;
                        console.log('ì–´ì œ ëª¨ë“  í•­ëª©ì„ ì™„ë£Œí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì—°ì†ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.');
                    }
                } else if (daysDiff > 1) {
                    // ì—¬ëŸ¬ ë‚ ì´ ì§€ë‚œ ê²½ìš°: ì—°ì† ì´ˆê¸°í™”
                    userData.startDate = null;
                    userData.streak = 0;
                    userData.lastCompletedDate = null;
                    console.log('ì—¬ëŸ¬ ë‚ ì´ ì§€ë‚¬ìŠµë‹ˆë‹¤. ì—°ì†ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.');
                }

                // completedToday ë°°ì—´ ì´ˆê¸°í™”
                userData.completedToday = [];
                userData.points = 0; // ë§¤ì¼ í¬ì¸íŠ¸ë„ ì´ˆê¸°í™”

                // ë³€ê²½ëœ ë°ì´í„° ì €ì¥
                saveUserData();

                // UI ì—…ë°ì´íŠ¸
                updateUI();

                console.log('completedToday ë°°ì—´ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else if (!lastCheck && userData.completedToday.length > 0) {
                // lastCheckê°€ ì—†ì§€ë§Œ completedTodayì— ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°
                // ì˜¤ëŠ˜ ë‚ ì§œë¡œ lastCheck ì„¤ì •í•˜ì—¬ ë°ì´í„° ìœ ì§€
                userData.lastCheck = today;
                saveUserData();
                console.log('lastCheckë¥¼ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // Supabase ì´ˆê¸°í™”
            if (!initializeSupabase()) {
                console.error('Supabase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸ì¦ ê¸°ëŠ¥ì´ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }

            // ë°ì´í„° ë³µêµ¬ ì‹œë„
            const recoveredData = recoverUserData();
            if (recoveredData) {
                userData = recoveredData;
                console.log('ë°ì´í„°ê°€ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
            
            // ì¼ê¸° ë°ì´í„° ë³µêµ¬ ì‹œë„
            try {
                const diaryBackup = sessionStorage.getItem('emotionDiaries_backup');
                if (diaryBackup && diaries.length === 0) {
                    diaries = JSON.parse(diaryBackup);
                    console.log('ì¼ê¸° ë°ì´í„°ê°€ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            } catch (e) {
                console.log('ì¼ê¸° ë°ì´í„° ë³µêµ¬ ì‹¤íŒ¨:', e);
            }
            
            // ë‚ ì§œ ë³€ê²½ í™•ì¸ ë° ì´ˆê¸°í™”
            checkDateChangeAndReset();

            // Supabase ì¸ì¦ ìƒíƒœ í™•ì¸ (ì„ì‹œë¡œ ë¹„í™œì„±í™”)
            checkAuthState();

            updateUI();
        });

        // ì¸ì¦ ìƒíƒœ í™•ì¸
        async function checkAuthState() {
            if (!supabaseClient || !supabaseClient.auth) {
                console.log('Supabase í´ë¼ì´ì–¸íŠ¸ ë˜ëŠ” auth ëª¨ë“ˆì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ');
                return;
            }

            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();

                if (error) {
                    console.log('ì¸ì¦ëœ ì‚¬ìš©ì ì—†ìŒ:', error.message);
                    return;
                }

                if (session && session.user) {
                    currentUser = session.user;
                    document.getElementById('userEmail').textContent = session.user.email;
                    document.getElementById('userSection').style.display = 'flex';
                    document.getElementById('loginSection').style.display = 'none';

                    await loadUserData();
                    console.log('ì‚¬ìš©ì ë¡œê·¸ì¸ë¨:', user.email);
                }
            } catch (error) {
                console.error('ì¸ì¦ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
            }
        }
    </script>
</body>
</html>